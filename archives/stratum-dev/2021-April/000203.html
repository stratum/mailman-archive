<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [stratum-dev] Question about building stratum standalone
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:stratum-dev%40lists.stratumproject.org?Subject=Re%3A%20%5Bstratum-dev%5D%20Question%20about%20building%20stratum%20standalone&In-Reply-To=%3CCAM-ym_f%2BwDgAKikFwRtPByN%3Dkf9YFuCRyx5WTzJ2Qi0SPhrV0A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000202.html">
   <LINK REL="Next"  HREF="000204.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[stratum-dev] Question about building stratum standalone</H1>
    <B>A Sydney</B> 
    <A HREF="mailto:stratum-dev%40lists.stratumproject.org?Subject=Re%3A%20%5Bstratum-dev%5D%20Question%20about%20building%20stratum%20standalone&In-Reply-To=%3CCAM-ym_f%2BwDgAKikFwRtPByN%3Dkf9YFuCRyx5WTzJ2Qi0SPhrV0A%40mail.gmail.com%3E"
       TITLE="[stratum-dev] Question about building stratum standalone">asydney007 at gmail.com
       </A><BR>
    <I>Wed Apr  7 17:34:44 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000202.html">[stratum-dev] [stratum-announce] Stratum 2021-03-31 release is	available!
</A></li>
        <LI>Next message (by thread): <A HREF="000204.html">[stratum-dev] Query about accessing P4Runtime shell
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#203">[ date ]</a>
              <a href="thread.html#203">[ thread ]</a>
              <a href="subject.html#203">[ subject ]</a>
              <a href="author.html#203">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update:
I was able to install the Stratum BMv2 switch as a standalone instance on a
VM. I've attempted to clean up the instructions (i.e. these instructions
have been updated and are not exactly what was was executed on the command
line) for folks who would like to attempt the same (Note: There may be more
elegant ways of setting this up :) )

# Create BMV2 package for a VM Running Debian 10

Note: &quot;host&gt;&quot; is the host system which will be used to generate the Stratum
BMv2 Debian package. &quot;stratum_dev&gt;&quot; is the Stratum development docker
container.
&quot;vm&gt;&quot; is a Debian 10 VM which will be converted into the Stratum BMv2
switch.

1. Clone the stratum repo on your host system:
 host&gt; mkdir repos &amp;&amp; cd repos
 host&gt; git clone <A HREF="https://lists.stratumproject.org/listinfo/stratum-dev">git at github.com</A>:stratum/stratum.git

2. Change dependency version for boost from libboost1.55-all-dev to
libboost1.67-all-dev (Since Debian 10 does not ship with
libboost1.55-all-dev):
 host&gt; cd stratum
 host&gt; vim stratum/hal/bin/bmv2/BUILD

...
&quot;libboost1.67-all-dev&quot;,
...

REF:
<A HREF="https://github.com/stratum/stratum/blob/main/stratum/hal/bin/bmv2/BUILD#L81-L98">https://github.com/stratum/stratum/blob/main/stratum/hal/bin/bmv2/BUILD#L81-L98</A>

3. Start the stratum docker development container and build the BMv2
package:

   host&gt; ./setup_dev_env.sh # You should now be in the stratum container.
   stratum_dev&gt; bazel build --stamp
//stratum/hal/bin/bmv2:stratum_bmv2_debian
   stratum_dev&gt; mkdir stratum_bmv2_configs/libs &amp;&amp; cd
stratum_bmv2_configs/libs
   stratum_dev&gt; cp /usr/local/lib/libbmpi.so.0.0.0
./stratum_bmv2_configs/libs
   stratum_dev&gt; cp /usr/local/lib/libsimpleswitch_runner.so.0.0.0
./stratum_bmv2_configs/libs

Note: The package should exist at
~/repos/stratum/bazel-bin/stratum/hal/bin/bmv2/stratum_bmv2_debian.deb on
the
host. Let's move the package to a common directory:

stratum_dev&gt; mkdir stratum_bmv2_configs/bmv2_package &amp;&amp; cd
stratum_bmv2_configs/bmv2_package
stratum_dev&gt; cp
~/repos/stratum/bazel-bin/stratum/hal/bin/bmv2/stratum_bmv2_debian.deb ./

4. SCP the package and associated libraries to the VM.

host&gt; ssh &lt;user&gt;@&lt;VM IP&gt;
vm&gt; mkdir stratum &amp;&amp; mkdir stratum/bmv2_package
host&gt; scp stratum_bmv2_configs/bmv2_package/stratum_bmv2_debian.deb
&lt;user&gt;@&lt;VM IP&gt;:/home/&lt;user&gt;/stratum/bmv2_package
host&gt; scp -r stratum_bmv2_configs/libs &lt;user&gt;@&lt;VM IP&gt;:/home/&lt;user&gt;/stratum
host&gt; scp -r stratum_bmv2_configs/bmv2_config &lt;user&gt;@&lt;VM
IP&gt;:/home/&lt;user&gt;/stratum
host&gt; scp ~/repos/stratum/stratum/hal/bin/bmv2/dummy.json &lt;user&gt;@&lt;VM
IP&gt;:/home/&lt;user&gt;/stratum

5. Install bazel 3.7.2 on the VM
vm&gt; sudo apt install apt-transport-https curl gnupg
vm&gt; curl -fsSL <A HREF="https://bazel.build/bazel-release.pub.gpg">https://bazel.build/bazel-release.pub.gpg</A> | gpg --dearmor &gt;
bazel.gpg
vm&gt; sudo mv bazel.gpg /etc/apt/trusted.gpg.d/
vm&gt; echo &quot;deb [arch=amd64] <A HREF="https://storage.googleapis.com/bazel-apt">https://storage.googleapis.com/bazel-apt</A> stable
jdk1.8&quot; | sudo tee /etc/apt/sources.list.d/bazel.list
vm&gt; sudo apt update &amp;&amp; sudo apt install bazel-3.7.2

REF:
<A HREF="https://docs.bazel.build/versions/master/install-ubuntu.html">https://docs.bazel.build/versions/master/install-ubuntu.html</A>

3. Install dependencies and build stratum:
vm&gt; sudo apt-get update
vm&gt; sudo apt-get install apt-utils libjudy-dev libgmp-dev libpcap-dev
mpi-default-dev libnl-3-200=3.4.0-1 libnl-route-3-200=3.4.0-1
libnl-route-3-dev libnl-3-dev libibverbs-dev libopenmpi-dev
libboost-mpi-dev libboost-mpi-python-dev libboost1.67-all-dev -y

REF:
<A HREF="https://github.com/stratum/stratum/blob/main/stratum/hal/bin/bmv2/BUILD#L81-L98">https://github.com/stratum/stratum/blob/main/stratum/hal/bin/bmv2/BUILD#L81-L98</A>

4. Configure bmv2 associated libraries:
vm&gt; cd stratum/libs
vm&gt; sudo cp * /usr/local/lib/ &amp;&amp; cd /usr/local/lib/
vm&gt; sudo ln -s libsimpleswitch_runner.so.0.0.0 libsimpleswitch_runner.so.0
&amp;&amp; sudo ln -s libbmpi.so.0.0.0 libbmpi.so.0
vm&gt; sudo vim /etc/ld.so.conf
...
/usr/local/lib

vm&gt; sudo ldconfig

5. Create links to older version of boost libraries:
vm&gt; sudo ln -s /usr/lib/x86_64-linux-gnu/libboost_system.so.1.67.0
/usr/lib/x86_64-linux-gnu/libboost_system.so.1.62.0
vm&gt; sudo ln -s /usr/lib/x86_64-linux-gnu/libboost_program_options.so.1.67.0
/usr/lib/x86_64-linux-gnu/libboost_program_options.so.1.62.0
vm&gt; sudo ln -s /usr/lib/x86_64-linux-gnu/libboost_filesystem.so.1.67.0
/usr/lib/x86_64-linux-gnu/libboost_filesystem.so.1.62.0
vm&gt; sudo ln -s /usr/lib/x86_64-linux-gnu/libboost_thread.so.1.67.0
/usr/lib/x86_64-linux-gnu/libboost_thread.so.1.62.0

6. Install the bmv2 package:
vm&gt; cd ~/stratum/bmv2_package
vm&gt; sudo apt-get install --reinstall ./stratum_bmv2_debian.deb

7. Add interfaces to config file and create the empty p4_pipeline.pb.txt
which
is where your pipeconfig will be stored (i.e. after being pushed by the
switch):
vm&gt; cd ~/stratum/bmv2_config
vm&gt; cp config.txt switch_ports-spine1.txt
vm&gt; vim switch_ports-spine1.txt

description: &quot;Spine1&quot;
chassis {
  platform: PLT_P4_SOFT_SWITCH
  name: &quot;bmv2-simple_switch&quot;
}
nodes {
  id: 1
  slot: 1
  index: 1
}
singleton_ports {
  id: 0
  name: &quot;Eth0&quot;
  slot: 1
  port: 0
  channel: 1
  speed_bps: 100000000000
  config_params {
    admin_state: ADMIN_STATE_ENABLED
  }
  node: 1
}
...

9. Create an empty &quot;p4_pipeline.pb.txt&quot; file (The P4 pipeline, pushed by the
controller, will be stored in there).
vm&gt; vim p4_pipeline.pb.txt

10. Start the switch on port 50010:

vm&gt; sudo stratum_bmv2 \
    --persistent_config_dir=/home/&lt;user&gt;/stratum/bmv2_config \

--forwarding_pipeline_configs_file=/home/&lt;user&gt;/stratum/bmv2_config/p4_pipeline.pb.txt
\

--chassis_config_file=/home/&lt;user&gt;/stratum/bmv2_config/switch_ports-spine1.txt
\
    --external_stratum_urls=&quot;192.168.122.10:50010&quot; \
    --initial_pipeline=&quot;/home/&lt;user&gt;/stratum/bmv2_config/dummy.json&quot; \
    --bmv2_log_level=info

11. Attempt to connect to the switch from the P4R shell:
host&gt; cd ~/repos
host&gt; git clone <A HREF="https://lists.stratumproject.org/listinfo/stratum-dev">git at github.com</A>:opennetworkinglab/ngsdn-tutorial.git
host&gt; cd ~/repos/ngsdn-tutorial
host&gt; util/p4rt-sh  --grpc-addr 192.168.122.10:50010 --config
../stratum/stratum_bmv2_configs/bmv2_config/p4info.txt,../stratum/stratum_bmv2_configs/bmv2_config/bmv2.json
--election-id 0,1

12. Use the gnmi utility to ensure that all ports are visible:
host&gt; util/gnmi-cli --grpc-addr 192.168.122.10:50010 get / |
util/oc-pb-decoder | less

Cheers!
-Syd


On Fri, Mar 26, 2021 at 2:34 PM Maximilian Pudelko &lt;<A HREF="https://lists.stratumproject.org/listinfo/stratum-dev">max at opennetworking.org</A>&gt;
wrote:

&gt;<i> We're using Debian 9 in many parts of the stack. You could either use that
</I>&gt;<i> or
</I>&gt;<i> replace the dependency with `libboost1.67-all-dev`in the Bazel build rule.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Max
</I>&gt;<i>
</I>&gt;<i> On Thu, Mar 25, 2021 at 6:48 PM A Sydney &lt;<A HREF="https://lists.stratumproject.org/listinfo/stratum-dev">asydney007 at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Ah great! I was able to build the package, yay! But I'm having a few
</I>&gt;&gt;<i> dependency issues:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On the vm which hosts the stratum switch, I'm running Debian 10.
</I>&gt;&gt;<i> Unfortunately, I could not find &quot;libboost1.55-all-dev.
</I>&gt;&gt;<i> However, libboost1.67-all-dev did exist, so I attempted to install this
</I>&gt;&gt;<i> version but no success. It appears that &quot;libboost1.55-all-dev&quot; is a hard
</I>&gt;&gt;<i> requirement?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;&quot;&quot;
</I>&gt;&gt;<i> sudo apt-get install --reinstall ./stratum_bmv2_debian.deb
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i> Note, selecting 'stratum_bmv2' instead of './stratum_bmv2_debian.deb'
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i> stratum_bmv2 : Depends: libboost1.55-all-dev but it is not installable
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i> &quot;&quot;&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any suggestions on how to work around this one? If this version is truly
</I>&gt;&gt;<i> a hard requirement, what linux distributions would you suggest (e.g. what
</I>&gt;&gt;<i> distributions have you tried the install)?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> -Syd
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Thu, Mar 25, 2021 at 4:17 PM Maximilian Pudelko &lt;
</I>&gt;&gt;<i> <A HREF="https://lists.stratumproject.org/listinfo/stratum-dev">max at opennetworking.org</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi Syd,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> As you have found out, the P4Runtime/gNMI ports have to be exposed from
</I>&gt;&gt;&gt;<i> inside the container
</I>&gt;&gt;&gt;<i> to be reachable from outside.
</I>&gt;&gt;&gt;<i> We have a start-stratum-container.sh script that takes care of that, or
</I>&gt;&gt;&gt;<i> you map them manually with -p,
</I>&gt;&gt;&gt;<i> like you did.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &gt; I didn't quite get this one. Where can I get the associated *.deb
</I>&gt;&gt;&gt;<i> package for the install?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> What I linked is the Bazel target that *builds* the .deb package. Build
</I>&gt;&gt;&gt;<i> it with
</I>&gt;&gt;&gt;<i> `bazel build --stamp //stratum/hal/bin/bmv2:stratum_bmv2_debian`.
</I>&gt;&gt;&gt;<i> The resulting file will be under
</I>&gt;&gt;&gt;<i> `bazel-bin/stratum/hal/bin/bmv2/stratum_bmv2_debian.deb`
</I>&gt;&gt;&gt;<i> and can be installed on most Ubuntu and Debian systems:
</I>&gt;&gt;&gt;<i> `apt-get install --reinstall ./stratum_bmv2_debian.deb`
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Best,
</I>&gt;&gt;&gt;<i> Max
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Thu, Mar 25, 2021 at 12:06 PM A Sydney &lt;<A HREF="https://lists.stratumproject.org/listinfo/stratum-dev">asydney007 at gmail.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> But instead of building Stratum many times, check if the Debian package might not be more convenient:
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://github.com/stratum/stratum/blob/main/stratum/hal/bin/bmv2/BUILD#L81-L98">https://github.com/stratum/stratum/blob/main/stratum/hal/bin/bmv2/BUILD#L81-L98</A>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I didn't quite get this one. Where can I get the associated *.deb
</I>&gt;&gt;&gt;&gt;<i> package for the install?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Thanks,
</I>&gt;&gt;&gt;&gt;<i> -Syd
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="https://lists.stratumproject.org/archives/stratum-dev/attachments/20210407/a9aa5549/attachment.html">https://lists.stratumproject.org/archives/stratum-dev/attachments/20210407/a9aa5549/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000202.html">[stratum-dev] [stratum-announce] Stratum 2021-03-31 release is	available!
</A></li>
	<LI>Next message (by thread): <A HREF="000204.html">[stratum-dev] Query about accessing P4Runtime shell
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#203">[ date ]</a>
              <a href="thread.html#203">[ thread ]</a>
              <a href="subject.html#203">[ subject ]</a>
              <a href="author.html#203">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.stratumproject.org/listinfo/stratum-dev">More information about the stratum-dev
mailing list</a><br>
</body></html>
