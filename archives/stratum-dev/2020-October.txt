From aghaffar at google.com  Thu Oct  1 02:24:22 2020
From: aghaffar at google.com (Alireza Ghaffarkhah)
Date: Wed, 30 Sep 2020 19:24:22 -0700
Subject: [stratum-dev] [stratum-announce] Stratum 2020-09-30 release is
	available!
In-Reply-To: <01010174e1695314-7bada663-0580-4128-892d-5fc4a8f20d66-000000@us-west-2.amazonses.com>
References: <01010174e1695314-7bada663-0580-4128-892d-5fc4a8f20d66-000000@us-west-2.amazonses.com>
Message-ID: <CA+kiLHE+OC8p4uueQasJ51JnjRsnRYycPNNKmbrJ9bjsUAU3MQ@mail.gmail.com>

Good news Brian. Thanks for the update.

On Wed, Sep 30, 2020, 4:47 PM Brian O'Connor via stratum-announce <
stratum-announce at lists.stratumproject.org> wrote:

> We are pleased to announce the second Stratum release: *2020-09-30* (or
> 20.09 for short)
>
> Pre-built Docker images and Debian packages, along with a more extensive
> changelist, is available in the GitHub release page:
> https://github.com/stratum/stratum/releases/tag/2020-09-30
>
> This release supports P4Runtime v1.2.0 and gNMI v0.7.0 on several targets
> <https://github.com/stratum/stratum/tree/2020-09-30#supported-devices>.
> Stratum's date-named releases are scheduled to happen quarterly, but they
> may be more or less frequent if needed.
>
> Thanks again to everyone that has participated in this release!
> Brian, Max, Yi and the rest of the Stratum team
> _______________________________________________
> stratum-announce mailing list
> stratum-announce at lists.stratumproject.org
> https://lists.stratumproject.org/listinfo/stratum-announce
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200930/315e7d3d/attachment.html>

From NHESS at extremenetworks.com  Sun Oct 11 15:35:14 2020
From: NHESS at extremenetworks.com (Narada Hess)
Date: Sun, 11 Oct 2020 15:35:14 +0000
Subject: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc
	library?
Message-ID: <BY5PR04MB6342E8E7C84C75AF907FF730AD060@BY5PR04MB6342.namprd04.prod.outlook.com>

Hi,
I'm trying to build stratum_bf with the BF SDE BF-Runtime server enabled. That requires building the SDE with gRPC. Of course, when I try to run stratum_bf, it crashes because of the two instances of the gRPC library (see below).

Is there any way to build stratum_bf with dynamic linking of the gRPC (and protobuf too, I'm guessing) library? I saw half a dozen files in the bazel directory referencing gRPC. Just removing the references of course did not work.

Thanks for any suggestions on how to proceed. N


/usr/local/bin/stratum_bf -flagfile=/etc/service/stratum/stratum-tofino-model.flags

[libprotobuf ERROR external/com_google_protobuf/src/google/protobuf/descriptor_database.cc:120] File already exists in database: google/protobuf/descriptor.proto [libprotobuf FATAL external/com_google_protobuf/src/google/protobuf/descriptor.cc:1382] CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

terminate called after throwing an instance of 'google::protobuf::FatalException'

  what():  CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

Aborted (core dumped)

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201011/0a8c3118/attachment.html>

From max at opennetworking.org  Mon Oct 12 19:30:38 2020
From: max at opennetworking.org (Maximilian Pudelko)
Date: Mon, 12 Oct 2020 12:30:38 -0700
Subject: [stratum-dev] Can I build stratum_bf with dynamic load of the
 grpc library?
In-Reply-To: <01010175184d4dd2-827879e6-ddc1-482a-8333-b81dedf2d187-000000@us-west-2.amazonses.com>
References: <01010175184d4dd2-827879e6-ddc1-482a-8333-b81dedf2d187-000000@us-west-2.amazonses.com>
Message-ID: <CAFh9Y_PE=NW8QknPvA73Wv0bUZToEwJqZYT-Nuht8fVg+pENTg@mail.gmail.com>

Hi Narada,

Bazel heavily favors static linking, but there are some options around
that:
https://docs.bazel.build/versions/master/be/c-cpp.html#cc_binary.linkstatic
Try adding this label on the stratum_bf target and rebuild.

Another potential source of problems could be the different versions of
gRPC and Protobuf between Stratum and the SDE. Adjusting it in Stratum is as
easy as swapping the urls in the deps.bzl file.


Max

On Sun, Oct 11, 2020 at 8:35 AM Narada Hess via stratum-dev <
stratum-dev at lists.stratumproject.org> wrote:

> Hi,
>
> I’m trying to build stratum_bf with the BF SDE BF-Runtime server enabled.
> That requires building the SDE with gRPC. Of course, when I try to run
> stratum_bf, it crashes because of the two instances of the gRPC library
> (see below).
>
>
>
> Is there any way to build stratum_bf with dynamic linking of the gRPC (and
> protobuf too, I’m guessing) library? I saw half a dozen files in the bazel
> directory referencing gRPC. Just removing the references of course did not
> work.
>
>
>
> Thanks for any suggestions on how to proceed. N
>
>
>
> /usr/local/bin/stratum_bf
> -flagfile=/etc/service/stratum/stratum-tofino-model.flags
>
> [libprotobuf ERROR
> external/com_google_protobuf/src/google/protobuf/descriptor_database.cc:120]
> File already exists in database: google/protobuf/descriptor.proto
> [libprotobuf FATAL
> external/com_google_protobuf/src/google/protobuf/descriptor.cc:1382] CHECK
> failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):
>
> terminate called after throwing an instance of
> 'google::protobuf::FatalException'
>
>   what():  CHECK failed:
> GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):
>
> Aborted (core dumped)
>
>
> _______________________________________________
> stratum-dev mailing list
> stratum-dev at lists.stratumproject.org
> https://lists.stratumproject.org/listinfo/stratum-dev
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201012/203699a6/attachment.html>

From NHESS at extremenetworks.com  Tue Oct 13 15:04:29 2020
From: NHESS at extremenetworks.com (Narada Hess)
Date: Tue, 13 Oct 2020 15:04:29 +0000
Subject: [stratum-dev] Can I build stratum_bf with dynamic load of the
 grpc library?
In-Reply-To: <CAFh9Y_PE=NW8QknPvA73Wv0bUZToEwJqZYT-Nuht8fVg+pENTg@mail.gmail.com>
References: <01010175184d4dd2-827879e6-ddc1-482a-8333-b81dedf2d187-000000@us-west-2.amazonses.com>
 <CAFh9Y_PE=NW8QknPvA73Wv0bUZToEwJqZYT-Nuht8fVg+pENTg@mail.gmail.com>
Message-ID: <BY5PR04MB634246ED31D0D784E7CDA222AD040@BY5PR04MB6342.namprd04.prod.outlook.com>

Thanks Max,
Setting linkstatic to False results in a set of missing libraries. I am using compatible versions of grpc and protobuf, so that is not the issue.

Has anyone reported being able to run stratum with the Barefoot SDE BFRT server enabled?

I have not thus far solved the issue of the duplicate references (protobuf, etc). Thanks, N

From: Maximilian Pudelko <max at opennetworking.org>
Sent: Monday, October 12, 2020 12:31 PM
To: Narada Hess <NHESS at extremenetworks.com>
Cc: stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
Hi Narada,

Bazel heavily favors static linking, but there are some options around that: https://docs.bazel.build/versions/master/be/c-cpp.html#cc_binary.linkstatic<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.bazel.build%2Fversions%2Fmaster%2Fbe%2Fc-cpp.html%23cc_binary.linkstatic&data=02%7C01%7CNHESS%40extremenetworks.com%7C1f43d59658434f0c669108d86ee55cd7%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C1%7C637381278676810927&sdata=RfHPgYkFU%2FPXl4bc%2BL7KJhAzQQFcRbWcPq%2B1LT8GV08%3D&reserved=0>
Try adding this label on the stratum_bf target and rebuild.
Another potential source of problems could be the different versions of gRPC and Protobuf between Stratum and the SDE. Adjusting it in Stratum is as
easy as swapping the urls in the deps.bzl file.

Max

On Sun, Oct 11, 2020 at 8:35 AM Narada Hess via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:
Hi,
I’m trying to build stratum_bf with the BF SDE BF-Runtime server enabled. That requires building the SDE with gRPC. Of course, when I try to run stratum_bf, it crashes because of the two instances of the gRPC library (see below).

Is there any way to build stratum_bf with dynamic linking of the gRPC (and protobuf too, I’m guessing) library? I saw half a dozen files in the bazel directory referencing gRPC. Just removing the references of course did not work.

Thanks for any suggestions on how to proceed. N


/usr/local/bin/stratum_bf -flagfile=/etc/service/stratum/stratum-tofino-model.flags

[libprotobuf ERROR external/com_google_protobuf/src/google/protobuf/descriptor_database.cc:120] File already exists in database: google/protobuf/descriptor.proto [libprotobuf FATAL external/com_google_protobuf/src/google/protobuf/descriptor.cc:1382] CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

terminate called after throwing an instance of 'google::protobuf::FatalException'

  what():  CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

Aborted (core dumped)

_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=02%7C01%7CNHESS%40extremenetworks.com%7C1f43d59658434f0c669108d86ee55cd7%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C1%7C637381278676810927&sdata=8l%2B%2BeeBJC0j5Js%2FLI7%2F7oGXlt9vn9xbk33%2FT%2B2f3eHs%3D&reserved=0>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201013/0b8305aa/attachment.html>

From max at opennetworking.org  Tue Oct 13 18:35:31 2020
From: max at opennetworking.org (Maximilian Pudelko)
Date: Tue, 13 Oct 2020 11:35:31 -0700
Subject: [stratum-dev] Can I build stratum_bf with dynamic load of the
 grpc library?
In-Reply-To: <BY5PR04MB634246ED31D0D784E7CDA222AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
References: <01010175184d4dd2-827879e6-ddc1-482a-8333-b81dedf2d187-000000@us-west-2.amazonses.com>
 <CAFh9Y_PE=NW8QknPvA73Wv0bUZToEwJqZYT-Nuht8fVg+pENTg@mail.gmail.com>
 <BY5PR04MB634246ED31D0D784E7CDA222AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
Message-ID: <CAFh9Y_PRVSJUZCwoELaezz19o1h0TtH4AzTkWHkcyxg6o_DY7w@mail.gmail.com>

Thanks for the update.

I think if you use bazel run directly on the switch, all the shared
libraries should be taken care of by Bazel.

To my knowledge, nobody had success running both gRPC services at the same
time yet. We internally tried a while ago,
but hit the same roadblocks as you.

Max

On Tue, Oct 13, 2020 at 8:04 AM Narada Hess <NHESS at extremenetworks.com>
wrote:

> Thanks Max,
>
> Setting linkstatic to False results in a set of missing libraries. I am
> using compatible versions of grpc and protobuf, so that is not the issue.
>
>
>
> Has anyone reported being able to run stratum with the Barefoot SDE BFRT
> server enabled?
>
>
>
> I have not thus far solved the issue of the duplicate references
> (protobuf, etc). Thanks, N
>
>
>
> *From:* Maximilian Pudelko <max at opennetworking.org>
> *Sent:* Monday, October 12, 2020 12:31 PM
> *To:* Narada Hess <NHESS at extremenetworks.com>
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Can I build stratum_bf with dynamic load of
> the grpc library?
>
>
>
> *External Email:* Use caution in opening links or attachments.
>
> Hi Narada,
>
>
>
> Bazel heavily favors static linking, but there are some options around
> that:
> https://docs.bazel.build/versions/master/be/c-cpp.html#cc_binary.linkstatic
> <https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.bazel.build%2Fversions%2Fmaster%2Fbe%2Fc-cpp.html%23cc_binary.linkstatic&data=02%7C01%7CNHESS%40extremenetworks.com%7C1f43d59658434f0c669108d86ee55cd7%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C1%7C637381278676810927&sdata=RfHPgYkFU%2FPXl4bc%2BL7KJhAzQQFcRbWcPq%2B1LT8GV08%3D&reserved=0>
>
> Try adding this label on the stratum_bf target and rebuild.
>
> Another potential source of problems could be the different versions of
> gRPC and Protobuf between Stratum and the SDE. Adjusting it in Stratum is as
>
> easy as swapping the urls in the deps.bzl file.
>
>
>
> Max
>
>
>
> On Sun, Oct 11, 2020 at 8:35 AM Narada Hess via stratum-dev <
> stratum-dev at lists.stratumproject.org> wrote:
>
> Hi,
>
> I’m trying to build stratum_bf with the BF SDE BF-Runtime server enabled.
> That requires building the SDE with gRPC. Of course, when I try to run
> stratum_bf, it crashes because of the two instances of the gRPC library
> (see below).
>
>
>
> Is there any way to build stratum_bf with dynamic linking of the gRPC (and
> protobuf too, I’m guessing) library? I saw half a dozen files in the bazel
> directory referencing gRPC. Just removing the references of course did not
> work.
>
>
>
> Thanks for any suggestions on how to proceed. N
>
>
>
> /usr/local/bin/stratum_bf
> -flagfile=/etc/service/stratum/stratum-tofino-model.flags
>
> [libprotobuf ERROR
> external/com_google_protobuf/src/google/protobuf/descriptor_database.cc:120]
> File already exists in database: google/protobuf/descriptor.proto
> [libprotobuf FATAL
> external/com_google_protobuf/src/google/protobuf/descriptor.cc:1382] CHECK
> failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):
>
> terminate called after throwing an instance of
> 'google::protobuf::FatalException'
>
>   what():  CHECK failed:
> GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):
>
> Aborted (core dumped)
>
>
>
> _______________________________________________
> stratum-dev mailing list
> stratum-dev at lists.stratumproject.org
> https://lists.stratumproject.org/listinfo/stratum-dev
> <https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=02%7C01%7CNHESS%40extremenetworks.com%7C1f43d59658434f0c669108d86ee55cd7%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C1%7C637381278676810927&sdata=8l%2B%2BeeBJC0j5Js%2FLI7%2F7oGXlt9vn9xbk33%2FT%2B2f3eHs%3D&reserved=0>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201013/a6cb44b9/attachment-0001.html>

From NHESS at extremenetworks.com  Tue Oct 13 18:49:27 2020
From: NHESS at extremenetworks.com (Narada Hess)
Date: Tue, 13 Oct 2020 18:49:27 +0000
Subject: [stratum-dev] Can I build stratum_bf with dynamic load of the
 grpc library?
In-Reply-To: <CAFh9Y_PRVSJUZCwoELaezz19o1h0TtH4AzTkWHkcyxg6o_DY7w@mail.gmail.com>
References: <01010175184d4dd2-827879e6-ddc1-482a-8333-b81dedf2d187-000000@us-west-2.amazonses.com>
 <CAFh9Y_PE=NW8QknPvA73Wv0bUZToEwJqZYT-Nuht8fVg+pENTg@mail.gmail.com>
 <BY5PR04MB634246ED31D0D784E7CDA222AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_PRVSJUZCwoELaezz19o1h0TtH4AzTkWHkcyxg6o_DY7w@mail.gmail.com>
Message-ID: <BY5PR04MB63424A8FA1FB0FF8F1C9CF36AD040@BY5PR04MB6342.namprd04.prod.outlook.com>

Thanks, Max
I googled it and found lots of references to ‘protobuf File already exists in database’. There were various ideas, but the common solution in all threads was to factor out the code using protobuf into a separate library for use by both modules.

Sure I can re-factor my own code, but refactoring protobuf out of stratum and BF-SDE into a separate dynamic library, that’s a lot bigger project! And probably not advisable.

There were other suggestions like using dlopen() with RLTD_GLOBAL and linking with -fvisibility=hidden. I didn’t find any instances of dlopen() in the stratum code, and bazel seems only to support hints about linking, not fine-grained options.

So scratching my head about this right now. N

From: Maximilian Pudelko <max at opennetworking.org>
Sent: Tuesday, October 13, 2020 11:36 AM
To: Narada Hess <NHESS at extremenetworks.com>
Cc: stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
Thanks for the update.

I think if you use bazel run directly on the switch, all the shared libraries should be taken care of by Bazel.

To my knowledge, nobody had success running both gRPC services at the same time yet. We internally tried a while ago,
but hit the same roadblocks as you.

Max

On Tue, Oct 13, 2020 at 8:04 AM Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>> wrote:
Thanks Max,
Setting linkstatic to False results in a set of missing libraries. I am using compatible versions of grpc and protobuf, so that is not the issue.

Has anyone reported being able to run stratum with the Barefoot SDE BFRT server enabled?

I have not thus far solved the issue of the duplicate references (protobuf, etc). Thanks, N

From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Monday, October 12, 2020 12:31 PM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
Hi Narada,

Bazel heavily favors static linking, but there are some options around that: https://docs.bazel.build/versions/master/be/c-cpp.html#cc_binary.linkstatic<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.bazel.build%2Fversions%2Fmaster%2Fbe%2Fc-cpp.html%23cc_binary.linkstatic&data=02%7C01%7CNHESS%40extremenetworks.com%7Ccde6702c8b3d426c6b8408d86fa6d49d%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637382109618752174&sdata=eramESx8rpGfpPV4Iu4wpWVbxhPnNt2j5VYVmPmsDs0%3D&reserved=0>
Try adding this label on the stratum_bf target and rebuild.
Another potential source of problems could be the different versions of gRPC and Protobuf between Stratum and the SDE. Adjusting it in Stratum is as
easy as swapping the urls in the deps.bzl file.

Max

On Sun, Oct 11, 2020 at 8:35 AM Narada Hess via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:
Hi,
I’m trying to build stratum_bf with the BF SDE BF-Runtime server enabled. That requires building the SDE with gRPC. Of course, when I try to run stratum_bf, it crashes because of the two instances of the gRPC library (see below).

Is there any way to build stratum_bf with dynamic linking of the gRPC (and protobuf too, I’m guessing) library? I saw half a dozen files in the bazel directory referencing gRPC. Just removing the references of course did not work.

Thanks for any suggestions on how to proceed. N


/usr/local/bin/stratum_bf -flagfile=/etc/service/stratum/stratum-tofino-model.flags

[libprotobuf ERROR external/com_google_protobuf/src/google/protobuf/descriptor_database.cc:120] File already exists in database: google/protobuf/descriptor.proto [libprotobuf FATAL external/com_google_protobuf/src/google/protobuf/descriptor.cc:1382] CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

terminate called after throwing an instance of 'google::protobuf::FatalException'

  what():  CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

Aborted (core dumped)

_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=02%7C01%7CNHESS%40extremenetworks.com%7Ccde6702c8b3d426c6b8408d86fa6d49d%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637382109618752174&sdata=w4pk0dKTPQJRR2JJoWeHMZAIAEEsWwOZb0iMgzpKCoE%3D&reserved=0>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201013/c3aaf89c/attachment-0001.html>

From max at opennetworking.org  Tue Oct 13 21:16:14 2020
From: max at opennetworking.org (Maximilian Pudelko)
Date: Tue, 13 Oct 2020 14:16:14 -0700
Subject: [stratum-dev] Can I build stratum_bf with dynamic load of the
 grpc library?
In-Reply-To: <BY5PR04MB63424A8FA1FB0FF8F1C9CF36AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
References: <01010175184d4dd2-827879e6-ddc1-482a-8333-b81dedf2d187-000000@us-west-2.amazonses.com>
 <CAFh9Y_PE=NW8QknPvA73Wv0bUZToEwJqZYT-Nuht8fVg+pENTg@mail.gmail.com>
 <BY5PR04MB634246ED31D0D784E7CDA222AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_PRVSJUZCwoELaezz19o1h0TtH4AzTkWHkcyxg6o_DY7w@mail.gmail.com>
 <BY5PR04MB63424A8FA1FB0FF8F1C9CF36AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
Message-ID: <CAFh9Y_O=+WcjFxdqJjE9aqrf42NtY=PEe=em-pm5YbLsDy-WPw@mail.gmail.com>

That does indeed sound like a lot of work.

I didn’t find any instances of dlopen()
>
This is correct. We don't participate in such heretic practices, but
instead build a single, fat and beautiful binary, like
the apostles from Bell Labs intended :D

On a more serious note, I wonder if we could link in the gRPC libraries
from the SDE, instead of our own.
Export them in bfsde.BUILD as cc_libraries and search-and-replace every
instance throughout the code base.


Max


On Tue, Oct 13, 2020 at 11:49 AM Narada Hess <NHESS at extremenetworks.com>
wrote:

> Thanks, Max
>
> I googled it and found lots of references to ‘protobuf File already exists
> in database’. There were various ideas, but the common solution in all
> threads was to factor out the code using protobuf into a separate library
> for use by both modules.
>
>
>
> Sure I can re-factor my own code, but refactoring protobuf out of stratum
> and BF-SDE into a separate dynamic library, that’s a lot bigger project!
> And probably not advisable.
>
>
>
> There were other suggestions like using dlopen() with RLTD_GLOBAL and
> linking with -fvisibility=hidden. I didn’t find any instances of dlopen()
> in the stratum code, and bazel seems only to support hints about linking,
> not fine-grained options.
>
>
>
> So scratching my head about this right now. N
>
>
>
> *From:* Maximilian Pudelko <max at opennetworking.org>
> *Sent:* Tuesday, October 13, 2020 11:36 AM
> *To:* Narada Hess <NHESS at extremenetworks.com>
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Can I build stratum_bf with dynamic load of
> the grpc library?
>
>
>
> *External Email:* Use caution in opening links or attachments.
>
> Thanks for the update.
>
>
>
> I think if you use bazel run directly on the switch, all the shared
> libraries should be taken care of by Bazel.
>
>
>
> To my knowledge, nobody had success running both gRPC services at the same
> time yet. We internally tried a while ago,
>
> but hit the same roadblocks as you.
>
>
>
> Max
>
>
>
> On Tue, Oct 13, 2020 at 8:04 AM Narada Hess <NHESS at extremenetworks.com>
> wrote:
>
> Thanks Max,
>
> Setting linkstatic to False results in a set of missing libraries. I am
> using compatible versions of grpc and protobuf, so that is not the issue.
>
>
>
> Has anyone reported being able to run stratum with the Barefoot SDE BFRT
> server enabled?
>
>
>
> I have not thus far solved the issue of the duplicate references
> (protobuf, etc). Thanks, N
>
>
>
> *From:* Maximilian Pudelko <max at opennetworking.org>
> *Sent:* Monday, October 12, 2020 12:31 PM
> *To:* Narada Hess <NHESS at extremenetworks.com>
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Can I build stratum_bf with dynamic load of
> the grpc library?
>
>
>
> *External Email:* Use caution in opening links or attachments.
>
> Hi Narada,
>
>
>
> Bazel heavily favors static linking, but there are some options around
> that:
> https://docs.bazel.build/versions/master/be/c-cpp.html#cc_binary.linkstatic
> <https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.bazel.build%2Fversions%2Fmaster%2Fbe%2Fc-cpp.html%23cc_binary.linkstatic&data=02%7C01%7CNHESS%40extremenetworks.com%7Ccde6702c8b3d426c6b8408d86fa6d49d%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637382109618752174&sdata=eramESx8rpGfpPV4Iu4wpWVbxhPnNt2j5VYVmPmsDs0%3D&reserved=0>
>
> Try adding this label on the stratum_bf target and rebuild.
>
> Another potential source of problems could be the different versions of
> gRPC and Protobuf between Stratum and the SDE. Adjusting it in Stratum is as
>
> easy as swapping the urls in the deps.bzl file.
>
>
>
> Max
>
>
>
> On Sun, Oct 11, 2020 at 8:35 AM Narada Hess via stratum-dev <
> stratum-dev at lists.stratumproject.org> wrote:
>
> Hi,
>
> I’m trying to build stratum_bf with the BF SDE BF-Runtime server enabled.
> That requires building the SDE with gRPC. Of course, when I try to run
> stratum_bf, it crashes because of the two instances of the gRPC library
> (see below).
>
>
>
> Is there any way to build stratum_bf with dynamic linking of the gRPC (and
> protobuf too, I’m guessing) library? I saw half a dozen files in the bazel
> directory referencing gRPC. Just removing the references of course did not
> work.
>
>
>
> Thanks for any suggestions on how to proceed. N
>
>
>
> /usr/local/bin/stratum_bf
> -flagfile=/etc/service/stratum/stratum-tofino-model.flags
>
> [libprotobuf ERROR
> external/com_google_protobuf/src/google/protobuf/descriptor_database.cc:120]
> File already exists in database: google/protobuf/descriptor.proto
> [libprotobuf FATAL
> external/com_google_protobuf/src/google/protobuf/descriptor.cc:1382] CHECK
> failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):
>
> terminate called after throwing an instance of
> 'google::protobuf::FatalException'
>
>   what():  CHECK failed:
> GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):
>
> Aborted (core dumped)
>
>
>
> _______________________________________________
> stratum-dev mailing list
> stratum-dev at lists.stratumproject.org
> https://lists.stratumproject.org/listinfo/stratum-dev
> <https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=02%7C01%7CNHESS%40extremenetworks.com%7Ccde6702c8b3d426c6b8408d86fa6d49d%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637382109618752174&sdata=w4pk0dKTPQJRR2JJoWeHMZAIAEEsWwOZb0iMgzpKCoE%3D&reserved=0>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201013/2afaab5c/attachment.html>

From NHESS at extremenetworks.com  Tue Oct 13 21:33:35 2020
From: NHESS at extremenetworks.com (Narada Hess)
Date: Tue, 13 Oct 2020 21:33:35 +0000
Subject: [stratum-dev] Can I build stratum_bf with dynamic load of the
 grpc library?
In-Reply-To: <CAFh9Y_O=+WcjFxdqJjE9aqrf42NtY=PEe=em-pm5YbLsDy-WPw@mail.gmail.com>
References: <01010175184d4dd2-827879e6-ddc1-482a-8333-b81dedf2d187-000000@us-west-2.amazonses.com>
 <CAFh9Y_PE=NW8QknPvA73Wv0bUZToEwJqZYT-Nuht8fVg+pENTg@mail.gmail.com>
 <BY5PR04MB634246ED31D0D784E7CDA222AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_PRVSJUZCwoELaezz19o1h0TtH4AzTkWHkcyxg6o_DY7w@mail.gmail.com>
 <BY5PR04MB63424A8FA1FB0FF8F1C9CF36AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_O=+WcjFxdqJjE9aqrf42NtY=PEe=em-pm5YbLsDy-WPw@mail.gmail.com>
Message-ID: <BY5PR04MB634219FB7D1F0F762302C709AD040@BY5PR04MB6342.namprd04.prod.outlook.com>

Thanks, Max,
Static linking is fine by me 😊

I very much like your SDE linkage idea. What confuses me is whether this is strictly a link issue, or a runtime initialization issue. The error (seen at run-time after much SDE init has been done) indicates that someone is trying to add the same file that has already been added. (Not sure whether the SDE or stratum got there first.)

What I have not yet determined is whether this is some kind of internal thing that the single linkage would somehow solve, or whether there is some kind of init/instantiation code that we would have to find and disable.

Actually, it might be a bit trickier, since the init would only need to be disabled if building stratum with an SDE that has BFRT enabled. Else of course you need it (since the SDE would not be doing it). And would there be some kind of handle that the SDE and stratum code would need to share?

If you are interested in solving this problem, I would love to discuss the details. I’d like to solve this in an appropriate generally-applicable way. N

From: Maximilian Pudelko <max at opennetworking.org>
Sent: Tuesday, October 13, 2020 2:16 PM
To: Narada Hess <NHESS at extremenetworks.com>
Cc: stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
That does indeed sound like a lot of work.

I didn’t find any instances of dlopen()
This is correct. We don't participate in such heretic practices, but instead build a single, fat and beautiful binary, like
the apostles from Bell Labs intended :D

On a more serious note, I wonder if we could link in the gRPC libraries from the SDE, instead of our own.
Export them in bfsde.BUILD as cc_libraries and search-and-replace every instance throughout the code base.


Max


On Tue, Oct 13, 2020 at 11:49 AM Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>> wrote:
Thanks, Max
I googled it and found lots of references to ‘protobuf File already exists in database’. There were various ideas, but the common solution in all threads was to factor out the code using protobuf into a separate library for use by both modules.

Sure I can re-factor my own code, but refactoring protobuf out of stratum and BF-SDE into a separate dynamic library, that’s a lot bigger project! And probably not advisable.

There were other suggestions like using dlopen() with RLTD_GLOBAL and linking with -fvisibility=hidden. I didn’t find any instances of dlopen() in the stratum code, and bazel seems only to support hints about linking, not fine-grained options.

So scratching my head about this right now. N

From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Tuesday, October 13, 2020 11:36 AM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
Thanks for the update.

I think if you use bazel run directly on the switch, all the shared libraries should be taken care of by Bazel.

To my knowledge, nobody had success running both gRPC services at the same time yet. We internally tried a while ago,
but hit the same roadblocks as you.

Max

On Tue, Oct 13, 2020 at 8:04 AM Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>> wrote:
Thanks Max,
Setting linkstatic to False results in a set of missing libraries. I am using compatible versions of grpc and protobuf, so that is not the issue.

Has anyone reported being able to run stratum with the Barefoot SDE BFRT server enabled?

I have not thus far solved the issue of the duplicate references (protobuf, etc). Thanks, N

From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Monday, October 12, 2020 12:31 PM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
Hi Narada,

Bazel heavily favors static linking, but there are some options around that: https://docs.bazel.build/versions/master/be/c-cpp.html#cc_binary.linkstatic<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.bazel.build%2Fversions%2Fmaster%2Fbe%2Fc-cpp.html%23cc_binary.linkstatic&data=02%7C01%7CNHESS%40extremenetworks.com%7C6679c3b9c8f24bca4bb808d86fbd47fb%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637382206046130538&sdata=qZJ4MYk2ydibLX6pJV%2BsiqjuwxN1CbrJENVcVytqj4w%3D&reserved=0>
Try adding this label on the stratum_bf target and rebuild.
Another potential source of problems could be the different versions of gRPC and Protobuf between Stratum and the SDE. Adjusting it in Stratum is as
easy as swapping the urls in the deps.bzl file.

Max

On Sun, Oct 11, 2020 at 8:35 AM Narada Hess via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:
Hi,
I’m trying to build stratum_bf with the BF SDE BF-Runtime server enabled. That requires building the SDE with gRPC. Of course, when I try to run stratum_bf, it crashes because of the two instances of the gRPC library (see below).

Is there any way to build stratum_bf with dynamic linking of the gRPC (and protobuf too, I’m guessing) library? I saw half a dozen files in the bazel directory referencing gRPC. Just removing the references of course did not work.

Thanks for any suggestions on how to proceed. N


/usr/local/bin/stratum_bf -flagfile=/etc/service/stratum/stratum-tofino-model.flags

[libprotobuf ERROR external/com_google_protobuf/src/google/protobuf/descriptor_database.cc:120] File already exists in database: google/protobuf/descriptor.proto [libprotobuf FATAL external/com_google_protobuf/src/google/protobuf/descriptor.cc:1382] CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

terminate called after throwing an instance of 'google::protobuf::FatalException'

  what():  CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

Aborted (core dumped)

_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=02%7C01%7CNHESS%40extremenetworks.com%7C6679c3b9c8f24bca4bb808d86fbd47fb%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637382206046140528&sdata=MTMz0FNh18u6%2B1QIepbP9zbKuotQD9ClTB1od6VCGyo%3D&reserved=0>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201013/bcdd06b7/attachment-0001.html>

From bocon at opennetworking.org  Thu Oct 15 00:25:33 2020
From: bocon at opennetworking.org (Brian O'Connor)
Date: Wed, 14 Oct 2020 20:25:33 -0400
Subject: [stratum-dev] Can I build stratum_bf with dynamic load of the
 grpc library?
In-Reply-To: <0101017523e20ee0-fa021eed-de3f-4398-b1cd-27bb50792cc9-000000@us-west-2.amazonses.com>
References: <01010175184d4dd2-827879e6-ddc1-482a-8333-b81dedf2d187-000000@us-west-2.amazonses.com>
 <CAFh9Y_PE=NW8QknPvA73Wv0bUZToEwJqZYT-Nuht8fVg+pENTg@mail.gmail.com>
 <BY5PR04MB634246ED31D0D784E7CDA222AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_PRVSJUZCwoELaezz19o1h0TtH4AzTkWHkcyxg6o_DY7w@mail.gmail.com>
 <BY5PR04MB63424A8FA1FB0FF8F1C9CF36AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_O=+WcjFxdqJjE9aqrf42NtY=PEe=em-pm5YbLsDy-WPw@mail.gmail.com>
 <0101017523e20ee0-fa021eed-de3f-4398-b1cd-27bb50792cc9-000000@us-west-2.amazonses.com>
Message-ID: <CACKOpDkAkrnhROhEoGpuaMm0UkFqVFuzKpgPaRkime5-KteisQ@mail.gmail.com>

Hi Narada,

The specific issue that you are seeing has to do with the way that
protobufs are being initialized. When a binary or shared library is loaded
that contains a protobuf, initialization code like the code below is
executed.

// Force running AddDescriptors() at dynamic initialization time.
static bool dynamic_init_dummy_google_2frpc_2fcode_2eproto =
(static_cast<void>(::PROTOBUF_NAMESPACE_ID::internal::AddDescriptors(&descriptor_table_google_2frpc_2fcode_2eproto)),
true);

This likely means that libprotobuf, libgrpc, and any other library that
introduces a protobuf (e.g. google/rpc/[code,status], P4Runtime) needs to
be either linked in the stratum_bfrt binary, linked to bf-drivers, OR
loaded once as a shared library for bf-drivers and stratum_bfrt to share.

Use of calls to dl_open() will only make this trickier, and it would be
best if we could get the loader resolve these dependencies at program
start. Getting this right will be a little tricky, but should be do-able
with some build changes.

We've allocated some time in the Stratum TST tomorrow to go over this
approach.

Thanks!
Brian

On Tue, Oct 13, 2020 at 5:33 PM Narada Hess via stratum-dev <
stratum-dev at lists.stratumproject.org> wrote:

> Thanks, Max,
>
> Static linking is fine by me 😊
>
>
>
> I very much like your SDE linkage idea. What confuses me is whether this
> is strictly a link issue, or a runtime initialization issue. The error
> (seen at run-time after much SDE init has been done) indicates that someone
> is trying to add the same file that has already been added. (Not sure
> whether the SDE or stratum got there first.)
>
>
>
> What I have not yet determined is whether this is some kind of internal
> thing that the single linkage would somehow solve, or whether there is some
> kind of init/instantiation code that we would have to find and disable.
>
>
>
> Actually, it might be a bit trickier, since the init would only need to be
> disabled if building stratum with an SDE that has BFRT enabled. Else of
> course you need it (since the SDE would not be doing it). And would there
> be some kind of handle that the SDE and stratum code would need to share?
>
>
>
> If you are interested in solving this problem, I would love to discuss the
> details. I’d like to solve this in an appropriate generally-applicable way.
> N
>
>
>
> *From:* Maximilian Pudelko <max at opennetworking.org>
> *Sent:* Tuesday, October 13, 2020 2:16 PM
> *To:* Narada Hess <NHESS at extremenetworks.com>
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Can I build stratum_bf with dynamic load of
> the grpc library?
>
>
>
> *External Email:* Use caution in opening links or attachments.
>
> That does indeed sound like a lot of work.
>
>
>
> I didn’t find any instances of dlopen()
>
> This is correct. We don't participate in such heretic practices, but
> instead build a single, fat and beautiful binary, like
>
> the apostles from Bell Labs intended :D
>
>
>
> On a more serious note, I wonder if we could link in the gRPC libraries
> from the SDE, instead of our own.
>
> Export them in bfsde.BUILD as cc_libraries and search-and-replace every
> instance throughout the code base.
>
>
>
>
>
> Max
>
>
>
>
>
> On Tue, Oct 13, 2020 at 11:49 AM Narada Hess <NHESS at extremenetworks.com>
> wrote:
>
> Thanks, Max
>
> I googled it and found lots of references to ‘protobuf File already exists
> in database’. There were various ideas, but the common solution in all
> threads was to factor out the code using protobuf into a separate library
> for use by both modules.
>
>
>
> Sure I can re-factor my own code, but refactoring protobuf out of stratum
> and BF-SDE into a separate dynamic library, that’s a lot bigger project!
> And probably not advisable.
>
>
>
> There were other suggestions like using dlopen() with RLTD_GLOBAL and
> linking with -fvisibility=hidden. I didn’t find any instances of dlopen()
> in the stratum code, and bazel seems only to support hints about linking,
> not fine-grained options.
>
>
>
> So scratching my head about this right now. N
>
>
>
> *From:* Maximilian Pudelko <max at opennetworking.org>
> *Sent:* Tuesday, October 13, 2020 11:36 AM
> *To:* Narada Hess <NHESS at extremenetworks.com>
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Can I build stratum_bf with dynamic load of
> the grpc library?
>
>
>
> *External Email:* Use caution in opening links or attachments.
>
> Thanks for the update.
>
>
>
> I think if you use bazel run directly on the switch, all the shared
> libraries should be taken care of by Bazel.
>
>
>
> To my knowledge, nobody had success running both gRPC services at the same
> time yet. We internally tried a while ago,
>
> but hit the same roadblocks as you.
>
>
>
> Max
>
>
>
> On Tue, Oct 13, 2020 at 8:04 AM Narada Hess <NHESS at extremenetworks.com>
> wrote:
>
> Thanks Max,
>
> Setting linkstatic to False results in a set of missing libraries. I am
> using compatible versions of grpc and protobuf, so that is not the issue.
>
>
>
> Has anyone reported being able to run stratum with the Barefoot SDE BFRT
> server enabled?
>
>
>
> I have not thus far solved the issue of the duplicate references
> (protobuf, etc). Thanks, N
>
>
>
> *From:* Maximilian Pudelko <max at opennetworking.org>
> *Sent:* Monday, October 12, 2020 12:31 PM
> *To:* Narada Hess <NHESS at extremenetworks.com>
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Can I build stratum_bf with dynamic load of
> the grpc library?
>
>
>
> *External Email:* Use caution in opening links or attachments.
>
> Hi Narada,
>
>
>
> Bazel heavily favors static linking, but there are some options around
> that:
> https://docs.bazel.build/versions/master/be/c-cpp.html#cc_binary.linkstatic
> <https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.bazel.build%2Fversions%2Fmaster%2Fbe%2Fc-cpp.html%23cc_binary.linkstatic&data=02%7C01%7CNHESS%40extremenetworks.com%7C6679c3b9c8f24bca4bb808d86fbd47fb%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637382206046130538&sdata=qZJ4MYk2ydibLX6pJV%2BsiqjuwxN1CbrJENVcVytqj4w%3D&reserved=0>
>
> Try adding this label on the stratum_bf target and rebuild.
>
> Another potential source of problems could be the different versions of
> gRPC and Protobuf between Stratum and the SDE. Adjusting it in Stratum is as
>
> easy as swapping the urls in the deps.bzl file.
>
>
>
> Max
>
>
>
> On Sun, Oct 11, 2020 at 8:35 AM Narada Hess via stratum-dev <
> stratum-dev at lists.stratumproject.org> wrote:
>
> Hi,
>
> I’m trying to build stratum_bf with the BF SDE BF-Runtime server enabled.
> That requires building the SDE with gRPC. Of course, when I try to run
> stratum_bf, it crashes because of the two instances of the gRPC library
> (see below).
>
>
>
> Is there any way to build stratum_bf with dynamic linking of the gRPC (and
> protobuf too, I’m guessing) library? I saw half a dozen files in the bazel
> directory referencing gRPC. Just removing the references of course did not
> work.
>
>
>
> Thanks for any suggestions on how to proceed. N
>
>
>
> /usr/local/bin/stratum_bf
> -flagfile=/etc/service/stratum/stratum-tofino-model.flags
>
> [libprotobuf ERROR
> external/com_google_protobuf/src/google/protobuf/descriptor_database.cc:120]
> File already exists in database: google/protobuf/descriptor.proto
> [libprotobuf FATAL
> external/com_google_protobuf/src/google/protobuf/descriptor.cc:1382] CHECK
> failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):
>
> terminate called after throwing an instance of
> 'google::protobuf::FatalException'
>
>   what():  CHECK failed:
> GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):
>
> Aborted (core dumped)
>
>
>
> _______________________________________________
> stratum-dev mailing list
> stratum-dev at lists.stratumproject.org
> https://lists.stratumproject.org/listinfo/stratum-dev
> <https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=02%7C01%7CNHESS%40extremenetworks.com%7C6679c3b9c8f24bca4bb808d86fbd47fb%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637382206046140528&sdata=MTMz0FNh18u6%2B1QIepbP9zbKuotQD9ClTB1od6VCGyo%3D&reserved=0>
>
> _______________________________________________
> stratum-dev mailing list
> stratum-dev at lists.stratumproject.org
> https://lists.stratumproject.org/listinfo/stratum-dev
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201014/f16c6665/attachment.html>

From NHESS at extremenetworks.com  Thu Oct 15 03:56:07 2020
From: NHESS at extremenetworks.com (Narada Hess)
Date: Thu, 15 Oct 2020 03:56:07 +0000
Subject: [stratum-dev] Can I build stratum_bf with dynamic load of the
 grpc library?
In-Reply-To: <CACKOpDkAkrnhROhEoGpuaMm0UkFqVFuzKpgPaRkime5-KteisQ@mail.gmail.com>
References: <01010175184d4dd2-827879e6-ddc1-482a-8333-b81dedf2d187-000000@us-west-2.amazonses.com>
 <CAFh9Y_PE=NW8QknPvA73Wv0bUZToEwJqZYT-Nuht8fVg+pENTg@mail.gmail.com>
 <BY5PR04MB634246ED31D0D784E7CDA222AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_PRVSJUZCwoELaezz19o1h0TtH4AzTkWHkcyxg6o_DY7w@mail.gmail.com>
 <BY5PR04MB63424A8FA1FB0FF8F1C9CF36AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_O=+WcjFxdqJjE9aqrf42NtY=PEe=em-pm5YbLsDy-WPw@mail.gmail.com>
 <0101017523e20ee0-fa021eed-de3f-4398-b1cd-27bb50792cc9-000000@us-west-2.amazonses.com>
 <CACKOpDkAkrnhROhEoGpuaMm0UkFqVFuzKpgPaRkime5-KteisQ@mail.gmail.com>
Message-ID: <BY5PR04MB6342194E7B6A1BEBDA1728B9AD020@BY5PR04MB6342.namprd04.prod.outlook.com>

Wow, thanks, Brian,
I appreciate the info. We are trying an approach (Max’s idea) to have stratum load only the BF SDE instance of the protobuf library. It means looking through the various bzl and BUILD files to find the references and adjusting them.

So we will have some context for the discussion tomorrow. N

From: Brian O'Connor <bocon at opennetworking.org>
Sent: Wednesday, October 14, 2020 5:26 PM
To: Narada Hess <NHESS at extremenetworks.com>
Cc: Maximilian Pudelko <max at opennetworking.org>; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
Hi Narada,

The specific issue that you are seeing has to do with the way that protobufs are being initialized. When a binary or shared library is loaded that contains a protobuf, initialization code like the code below is executed.

// Force running AddDescriptors() at dynamic initialization time.
static bool dynamic_init_dummy_google_2frpc_2fcode_2eproto =
(static_cast<void>(::PROTOBUF_NAMESPACE_ID::internal::AddDescriptors(&descriptor_table_google_2frpc_2fcode_2eproto)), true);

This likely means that libprotobuf, libgrpc, and any other library that introduces a protobuf (e.g. google/rpc/[code,status], P4Runtime) needs to be either linked in the stratum_bfrt binary, linked to bf-drivers, OR loaded once as a shared library for bf-drivers and stratum_bfrt to share.

Use of calls to dl_open() will only make this trickier, and it would be best if we could get the loader resolve these dependencies at program start. Getting this right will be a little tricky, but should be do-able with some build changes.

We've allocated some time in the Stratum TST tomorrow to go over this approach.

Thanks!
Brian

On Tue, Oct 13, 2020 at 5:33 PM Narada Hess via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:
Thanks, Max,
Static linking is fine by me 😊

I very much like your SDE linkage idea. What confuses me is whether this is strictly a link issue, or a runtime initialization issue. The error (seen at run-time after much SDE init has been done) indicates that someone is trying to add the same file that has already been added. (Not sure whether the SDE or stratum got there first.)

What I have not yet determined is whether this is some kind of internal thing that the single linkage would somehow solve, or whether there is some kind of init/instantiation code that we would have to find and disable.

Actually, it might be a bit trickier, since the init would only need to be disabled if building stratum with an SDE that has BFRT enabled. Else of course you need it (since the SDE would not be doing it). And would there be some kind of handle that the SDE and stratum code would need to share?

If you are interested in solving this problem, I would love to discuss the details. I’d like to solve this in an appropriate generally-applicable way. N

From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Tuesday, October 13, 2020 2:16 PM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
That does indeed sound like a lot of work.

I didn’t find any instances of dlopen()
This is correct. We don't participate in such heretic practices, but instead build a single, fat and beautiful binary, like
the apostles from Bell Labs intended :D

On a more serious note, I wonder if we could link in the gRPC libraries from the SDE, instead of our own.
Export them in bfsde.BUILD as cc_libraries and search-and-replace every instance throughout the code base.


Max


On Tue, Oct 13, 2020 at 11:49 AM Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>> wrote:
Thanks, Max
I googled it and found lots of references to ‘protobuf File already exists in database’. There were various ideas, but the common solution in all threads was to factor out the code using protobuf into a separate library for use by both modules.

Sure I can re-factor my own code, but refactoring protobuf out of stratum and BF-SDE into a separate dynamic library, that’s a lot bigger project! And probably not advisable.

There were other suggestions like using dlopen() with RLTD_GLOBAL and linking with -fvisibility=hidden. I didn’t find any instances of dlopen() in the stratum code, and bazel seems only to support hints about linking, not fine-grained options.

So scratching my head about this right now. N

From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Tuesday, October 13, 2020 11:36 AM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
Thanks for the update.

I think if you use bazel run directly on the switch, all the shared libraries should be taken care of by Bazel.

To my knowledge, nobody had success running both gRPC services at the same time yet. We internally tried a while ago,
but hit the same roadblocks as you.

Max

On Tue, Oct 13, 2020 at 8:04 AM Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>> wrote:
Thanks Max,
Setting linkstatic to False results in a set of missing libraries. I am using compatible versions of grpc and protobuf, so that is not the issue.

Has anyone reported being able to run stratum with the Barefoot SDE BFRT server enabled?

I have not thus far solved the issue of the duplicate references (protobuf, etc). Thanks, N

From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Monday, October 12, 2020 12:31 PM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
Hi Narada,

Bazel heavily favors static linking, but there are some options around that: https://docs.bazel.build/versions/master/be/c-cpp.html#cc_binary.linkstatic<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.bazel.build%2Fversions%2Fmaster%2Fbe%2Fc-cpp.html%23cc_binary.linkstatic&data=04%7C01%7CNHESS%40extremenetworks.com%7C38d38958275b47a6cc1108d870a0de5c%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637383183530591305%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=rJ6W0o6CL1rfrgOcACC4pOZfRInQaUPhVCwve8MdVrI%3D&reserved=0>
Try adding this label on the stratum_bf target and rebuild.
Another potential source of problems could be the different versions of gRPC and Protobuf between Stratum and the SDE. Adjusting it in Stratum is as
easy as swapping the urls in the deps.bzl file.

Max

On Sun, Oct 11, 2020 at 8:35 AM Narada Hess via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:
Hi,
I’m trying to build stratum_bf with the BF SDE BF-Runtime server enabled. That requires building the SDE with gRPC. Of course, when I try to run stratum_bf, it crashes because of the two instances of the gRPC library (see below).

Is there any way to build stratum_bf with dynamic linking of the gRPC (and protobuf too, I’m guessing) library? I saw half a dozen files in the bazel directory referencing gRPC. Just removing the references of course did not work.

Thanks for any suggestions on how to proceed. N


/usr/local/bin/stratum_bf -flagfile=/etc/service/stratum/stratum-tofino-model.flags

[libprotobuf ERROR external/com_google_protobuf/src/google/protobuf/descriptor_database.cc:120] File already exists in database: google/protobuf/descriptor.proto [libprotobuf FATAL external/com_google_protobuf/src/google/protobuf/descriptor.cc:1382] CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

terminate called after throwing an instance of 'google::protobuf::FatalException'

  what():  CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

Aborted (core dumped)

_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=04%7C01%7CNHESS%40extremenetworks.com%7C38d38958275b47a6cc1108d870a0de5c%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637383183530601297%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=FHrOYR%2F5ktHzwpsyj7CNnpVqPVb4yUdC%2BtFO94AvqxE%3D&reserved=0>
_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=04%7C01%7CNHESS%40extremenetworks.com%7C38d38958275b47a6cc1108d870a0de5c%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637383183530611296%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=ap64DEAFCXhW9Wm5JaYAYICVoqiIz21HNCG951xOeXI%3D&reserved=0>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201015/ef17232b/attachment-0001.html>

From NHESS at extremenetworks.com  Thu Oct 15 21:12:06 2020
From: NHESS at extremenetworks.com (Narada Hess)
Date: Thu, 15 Oct 2020 21:12:06 +0000
Subject: [stratum-dev] Can I build stratum_bf with dynamic load of the
 grpc library?
In-Reply-To: <CACKOpDkAkrnhROhEoGpuaMm0UkFqVFuzKpgPaRkime5-KteisQ@mail.gmail.com>
References: <01010175184d4dd2-827879e6-ddc1-482a-8333-b81dedf2d187-000000@us-west-2.amazonses.com>
 <CAFh9Y_PE=NW8QknPvA73Wv0bUZToEwJqZYT-Nuht8fVg+pENTg@mail.gmail.com>
 <BY5PR04MB634246ED31D0D784E7CDA222AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_PRVSJUZCwoELaezz19o1h0TtH4AzTkWHkcyxg6o_DY7w@mail.gmail.com>
 <BY5PR04MB63424A8FA1FB0FF8F1C9CF36AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_O=+WcjFxdqJjE9aqrf42NtY=PEe=em-pm5YbLsDy-WPw@mail.gmail.com>
 <0101017523e20ee0-fa021eed-de3f-4398-b1cd-27bb50792cc9-000000@us-west-2.amazonses.com>
 <CACKOpDkAkrnhROhEoGpuaMm0UkFqVFuzKpgPaRkime5-KteisQ@mail.gmail.com>
Message-ID: <BY5PR04MB63423D89B990F1912D35E29FAD020@BY5PR04MB6342.namprd04.prod.outlook.com>

Hi Brian,
We use a custom p4studio_build profile and dependencies.yaml file to build the SDE. Until we updated the grpc/protobuf versions to match stratum’s, we hit an error upon stratum start-up, saying that those versions were not compatible with each other.

Then after building stratum and SDE with consistent grpc/protobuf versions, we ran into this current duplicate file issue.

Now, we’ll try building with the profile below and your PR changes. N

dependencies.yaml:

  *   Changed grpc version to 1.30.0 and protobuf version to 3.12.2

build_profile.yaml (commented out grpc after our discussion today):

# SDE_VERSION : 9.2.0



bf-sde-sim-base:

  # Global flags to configure

  global_configure_options: ''



  # SDE components to be installed

  packages:

    - bf-syslibs:

      - bf_syslibs_configure_options: ''

    - bf-utils:

      - bf_utils_configure_options: ''

    - bf-drivers:

      - bf_drivers_configure_options: ''

      - pi

      - bf-runtime



  # Third party source packages to be installed

  # package_dependencies:

  #   - grpc



  # Tofino architecture

  tofino_architecture: tofino2


From: Brian O'Connor <bocon at opennetworking.org>
Sent: Wednesday, October 14, 2020 5:26 PM
To: Narada Hess <NHESS at extremenetworks.com>
Cc: Maximilian Pudelko <max at opennetworking.org>; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

Hi Narada,

The specific issue that you are seeing has to do with the way that protobufs are being initialized. When a binary or shared library is loaded that contains a protobuf, initialization code like the code below is executed.

// Force running AddDescriptors() at dynamic initialization time.
static bool dynamic_init_dummy_google_2frpc_2fcode_2eproto =

(static_cast<void>(::PROTOBUF_NAMESPACE_ID::internal::AddDescriptors(&descriptor_table_google_2frpc_2fcode_2eproto)), true);

This likely means that libprotobuf, libgrpc, and any other library that introduces a protobuf (e.g. google/rpc/[code,status], P4Runtime) needs to be either linked in the stratum_bfrt binary, linked to bf-drivers, OR loaded once as a shared library for bf-drivers and stratum_bfrt to share.

Use of calls to dl_open() will only make this trickier, and it would be best if we could get the loader resolve these dependencies at program start. Getting this right will be a little tricky, but should be do-able with some build changes.

We've allocated some time in the Stratum TST tomorrow to go over this approach.

Thanks!
Brian

On Tue, Oct 13, 2020 at 5:33 PM Narada Hess via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:
Thanks, Max,
Static linking is fine by me 😊

I very much like your SDE linkage idea. What confuses me is whether this is strictly a link issue, or a runtime initialization issue. The error (seen at run-time after much SDE init has been done) indicates that someone is trying to add the same file that has already been added. (Not sure whether the SDE or stratum got there first.)

What I have not yet determined is whether this is some kind of internal thing that the single linkage would somehow solve, or whether there is some kind of init/instantiation code that we would have to find and disable.

Actually, it might be a bit trickier, since the init would only need to be disabled if building stratum with an SDE that has BFRT enabled. Else of course you need it (since the SDE would not be doing it). And would there be some kind of handle that the SDE and stratum code would need to share?

If you are interested in solving this problem, I would love to discuss the details. I’d like to solve this in an appropriate generally-applicable way. N

From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Tuesday, October 13, 2020 2:16 PM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
That does indeed sound like a lot of work.

I didn’t find any instances of dlopen()
This is correct. We don't participate in such heretic practices, but instead build a single, fat and beautiful binary, like
the apostles from Bell Labs intended :D

On a more serious note, I wonder if we could link in the gRPC libraries from the SDE, instead of our own.
Export them in bfsde.BUILD as cc_libraries and search-and-replace every instance throughout the code base.


Max


On Tue, Oct 13, 2020 at 11:49 AM Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>> wrote:
Thanks, Max
I googled it and found lots of references to ‘protobuf File already exists in database’. There were various ideas, but the common solution in all threads was to factor out the code using protobuf into a separate library for use by both modules.

Sure I can re-factor my own code, but refactoring protobuf out of stratum and BF-SDE into a separate dynamic library, that’s a lot bigger project! And probably not advisable.

There were other suggestions like using dlopen() with RLTD_GLOBAL and linking with -fvisibility=hidden. I didn’t find any instances of dlopen() in the stratum code, and bazel seems only to support hints about linking, not fine-grained options.

So scratching my head about this right now. N

From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Tuesday, October 13, 2020 11:36 AM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
Thanks for the update.

I think if you use bazel run directly on the switch, all the shared libraries should be taken care of by Bazel.

To my knowledge, nobody had success running both gRPC services at the same time yet. We internally tried a while ago,
but hit the same roadblocks as you.

Max

On Tue, Oct 13, 2020 at 8:04 AM Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>> wrote:
Thanks Max,
Setting linkstatic to False results in a set of missing libraries. I am using compatible versions of grpc and protobuf, so that is not the issue.

Has anyone reported being able to run stratum with the Barefoot SDE BFRT server enabled?

I have not thus far solved the issue of the duplicate references (protobuf, etc). Thanks, N

From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Monday, October 12, 2020 12:31 PM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
Hi Narada,

Bazel heavily favors static linking, but there are some options around that: https://docs.bazel.build/versions/master/be/c-cpp.html#cc_binary.linkstatic<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.bazel.build%2Fversions%2Fmaster%2Fbe%2Fc-cpp.html%23cc_binary.linkstatic&data=04%7C01%7CNHESS%40extremenetworks.com%7C38d38958275b47a6cc1108d870a0de5c%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637383183530591305%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=rJ6W0o6CL1rfrgOcACC4pOZfRInQaUPhVCwve8MdVrI%3D&reserved=0>
Try adding this label on the stratum_bf target and rebuild.
Another potential source of problems could be the different versions of gRPC and Protobuf between Stratum and the SDE. Adjusting it in Stratum is as
easy as swapping the urls in the deps.bzl file.

Max

On Sun, Oct 11, 2020 at 8:35 AM Narada Hess via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:
Hi,
I’m trying to build stratum_bf with the BF SDE BF-Runtime server enabled. That requires building the SDE with gRPC. Of course, when I try to run stratum_bf, it crashes because of the two instances of the gRPC library (see below).

Is there any way to build stratum_bf with dynamic linking of the gRPC (and protobuf too, I’m guessing) library? I saw half a dozen files in the bazel directory referencing gRPC. Just removing the references of course did not work.

Thanks for any suggestions on how to proceed. N


/usr/local/bin/stratum_bf -flagfile=/etc/service/stratum/stratum-tofino-model.flags

[libprotobuf ERROR external/com_google_protobuf/src/google/protobuf/descriptor_database.cc:120] File already exists in database: google/protobuf/descriptor.proto [libprotobuf FATAL external/com_google_protobuf/src/google/protobuf/descriptor.cc:1382] CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

terminate called after throwing an instance of 'google::protobuf::FatalException'

  what():  CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

Aborted (core dumped)

_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=04%7C01%7CNHESS%40extremenetworks.com%7C38d38958275b47a6cc1108d870a0de5c%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637383183530601297%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=FHrOYR%2F5ktHzwpsyj7CNnpVqPVb4yUdC%2BtFO94AvqxE%3D&reserved=0>
_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=04%7C01%7CNHESS%40extremenetworks.com%7C38d38958275b47a6cc1108d870a0de5c%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637383183530611296%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=ap64DEAFCXhW9Wm5JaYAYICVoqiIz21HNCG951xOeXI%3D&reserved=0>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201015/0f1fa64a/attachment-0001.html>

From NHESS at extremenetworks.com  Thu Oct 15 22:22:52 2020
From: NHESS at extremenetworks.com (Narada Hess)
Date: Thu, 15 Oct 2020 22:22:52 +0000
Subject: [stratum-dev] Can I build stratum_bf with dynamic load of the
 grpc library?
In-Reply-To: <BY5PR04MB63423D89B990F1912D35E29FAD020@BY5PR04MB6342.namprd04.prod.outlook.com>
References: <01010175184d4dd2-827879e6-ddc1-482a-8333-b81dedf2d187-000000@us-west-2.amazonses.com>
 <CAFh9Y_PE=NW8QknPvA73Wv0bUZToEwJqZYT-Nuht8fVg+pENTg@mail.gmail.com>
 <BY5PR04MB634246ED31D0D784E7CDA222AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_PRVSJUZCwoELaezz19o1h0TtH4AzTkWHkcyxg6o_DY7w@mail.gmail.com>
 <BY5PR04MB63424A8FA1FB0FF8F1C9CF36AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_O=+WcjFxdqJjE9aqrf42NtY=PEe=em-pm5YbLsDy-WPw@mail.gmail.com>
 <0101017523e20ee0-fa021eed-de3f-4398-b1cd-27bb50792cc9-000000@us-west-2.amazonses.com>
 <CACKOpDkAkrnhROhEoGpuaMm0UkFqVFuzKpgPaRkime5-KteisQ@mail.gmail.com>
 <BY5PR04MB63423D89B990F1912D35E29FAD020@BY5PR04MB6342.namprd04.prod.outlook.com>
Message-ID: <BY5PR04MB634277D40BB7992FFEDAF523AD020@BY5PR04MB6342.namprd04.prod.outlook.com>

Hi Brian,
I just realized that your PR is based off the bfrt branch. I’m not sure how to de-risk cutting over to that branch.

I assume the bfrt branch is required for this solution? And we would deploy stratum_bfrt instead of stratum_bf? N

From: Narada Hess
Sent: Thursday, October 15, 2020 2:12 PM
Subject: RE: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

Hi Brian,
We use a custom p4studio_build profile and dependencies.yaml file to build the SDE. Until we updated the grpc/protobuf versions to match stratum’s, we hit an error upon stratum start-up, saying that those versions were not compatible with each other.

Then after building stratum and SDE with consistent grpc/protobuf versions, we ran into this current duplicate file issue.

Now, we’ll try building with the profile below and your PR changes. N

dependencies.yaml:

  *   Changed grpc version to 1.30.0 and protobuf version to 3.12.2

build_profile.yaml (commented out grpc after our discussion today):

# SDE_VERSION : 9.2.0



bf-sde-sim-base:

  # Global flags to configure

  global_configure_options: ''



  # SDE components to be installed

  packages:

    - bf-syslibs:

      - bf_syslibs_configure_options: ''

    - bf-utils:

      - bf_utils_configure_options: ''

    - bf-drivers:

      - bf_drivers_configure_options: ''

      - pi

      - bf-runtime



  # Third party source packages to be installed

  # package_dependencies:

  #   - grpc



  # Tofino architecture

  tofino_architecture: tofino2


From: Brian O'Connor <bocon at opennetworking.org<mailto:bocon at opennetworking.org>>
Sent: Wednesday, October 14, 2020 5:26 PM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

Hi Narada,

The specific issue that you are seeing has to do with the way that protobufs are being initialized. When a binary or shared library is loaded that contains a protobuf, initialization code like the code below is executed.

// Force running AddDescriptors() at dynamic initialization time.
static bool dynamic_init_dummy_google_2frpc_2fcode_2eproto =

(static_cast<void>(::PROTOBUF_NAMESPACE_ID::internal::AddDescriptors(&descriptor_table_google_2frpc_2fcode_2eproto)), true);

This likely means that libprotobuf, libgrpc, and any other library that introduces a protobuf (e.g. google/rpc/[code,status], P4Runtime) needs to be either linked in the stratum_bfrt binary, linked to bf-drivers, OR loaded once as a shared library for bf-drivers and stratum_bfrt to share.

Use of calls to dl_open() will only make this trickier, and it would be best if we could get the loader resolve these dependencies at program start. Getting this right will be a little tricky, but should be do-able with some build changes.

We've allocated some time in the Stratum TST tomorrow to go over this approach.

Thanks!
Brian

On Tue, Oct 13, 2020 at 5:33 PM Narada Hess via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:
Thanks, Max,
Static linking is fine by me 😊

I very much like your SDE linkage idea. What confuses me is whether this is strictly a link issue, or a runtime initialization issue. The error (seen at run-time after much SDE init has been done) indicates that someone is trying to add the same file that has already been added. (Not sure whether the SDE or stratum got there first.)

What I have not yet determined is whether this is some kind of internal thing that the single linkage would somehow solve, or whether there is some kind of init/instantiation code that we would have to find and disable.

Actually, it might be a bit trickier, since the init would only need to be disabled if building stratum with an SDE that has BFRT enabled. Else of course you need it (since the SDE would not be doing it). And would there be some kind of handle that the SDE and stratum code would need to share?

If you are interested in solving this problem, I would love to discuss the details. I’d like to solve this in an appropriate generally-applicable way. N

From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Tuesday, October 13, 2020 2:16 PM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
That does indeed sound like a lot of work.

I didn’t find any instances of dlopen()
This is correct. We don't participate in such heretic practices, but instead build a single, fat and beautiful binary, like
the apostles from Bell Labs intended :D

On a more serious note, I wonder if we could link in the gRPC libraries from the SDE, instead of our own.
Export them in bfsde.BUILD as cc_libraries and search-and-replace every instance throughout the code base.


Max


On Tue, Oct 13, 2020 at 11:49 AM Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>> wrote:
Thanks, Max
I googled it and found lots of references to ‘protobuf File already exists in database’. There were various ideas, but the common solution in all threads was to factor out the code using protobuf into a separate library for use by both modules.

Sure I can re-factor my own code, but refactoring protobuf out of stratum and BF-SDE into a separate dynamic library, that’s a lot bigger project! And probably not advisable.

There were other suggestions like using dlopen() with RLTD_GLOBAL and linking with -fvisibility=hidden. I didn’t find any instances of dlopen() in the stratum code, and bazel seems only to support hints about linking, not fine-grained options.

So scratching my head about this right now. N

From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Tuesday, October 13, 2020 11:36 AM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
Thanks for the update.

I think if you use bazel run directly on the switch, all the shared libraries should be taken care of by Bazel.

To my knowledge, nobody had success running both gRPC services at the same time yet. We internally tried a while ago,
but hit the same roadblocks as you.

Max

On Tue, Oct 13, 2020 at 8:04 AM Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>> wrote:
Thanks Max,
Setting linkstatic to False results in a set of missing libraries. I am using compatible versions of grpc and protobuf, so that is not the issue.

Has anyone reported being able to run stratum with the Barefoot SDE BFRT server enabled?

I have not thus far solved the issue of the duplicate references (protobuf, etc). Thanks, N

From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Monday, October 12, 2020 12:31 PM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?

External Email: Use caution in opening links or attachments.
Hi Narada,

Bazel heavily favors static linking, but there are some options around that: https://docs.bazel.build/versions/master/be/c-cpp.html#cc_binary.linkstatic<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.bazel.build%2Fversions%2Fmaster%2Fbe%2Fc-cpp.html%23cc_binary.linkstatic&data=04%7C01%7CNHESS%40extremenetworks.com%7C38d38958275b47a6cc1108d870a0de5c%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637383183530591305%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=rJ6W0o6CL1rfrgOcACC4pOZfRInQaUPhVCwve8MdVrI%3D&reserved=0>
Try adding this label on the stratum_bf target and rebuild.
Another potential source of problems could be the different versions of gRPC and Protobuf between Stratum and the SDE. Adjusting it in Stratum is as
easy as swapping the urls in the deps.bzl file.

Max

On Sun, Oct 11, 2020 at 8:35 AM Narada Hess via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:
Hi,
I’m trying to build stratum_bf with the BF SDE BF-Runtime server enabled. That requires building the SDE with gRPC. Of course, when I try to run stratum_bf, it crashes because of the two instances of the gRPC library (see below).

Is there any way to build stratum_bf with dynamic linking of the gRPC (and protobuf too, I’m guessing) library? I saw half a dozen files in the bazel directory referencing gRPC. Just removing the references of course did not work.

Thanks for any suggestions on how to proceed. N


/usr/local/bin/stratum_bf -flagfile=/etc/service/stratum/stratum-tofino-model.flags

[libprotobuf ERROR external/com_google_protobuf/src/google/protobuf/descriptor_database.cc:120] File already exists in database: google/protobuf/descriptor.proto [libprotobuf FATAL external/com_google_protobuf/src/google/protobuf/descriptor.cc:1382] CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

terminate called after throwing an instance of 'google::protobuf::FatalException'

  what():  CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

Aborted (core dumped)

_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=04%7C01%7CNHESS%40extremenetworks.com%7C38d38958275b47a6cc1108d870a0de5c%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637383183530601297%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=FHrOYR%2F5ktHzwpsyj7CNnpVqPVb4yUdC%2BtFO94AvqxE%3D&reserved=0>
_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=04%7C01%7CNHESS%40extremenetworks.com%7C38d38958275b47a6cc1108d870a0de5c%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637383183530611296%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=ap64DEAFCXhW9Wm5JaYAYICVoqiIz21HNCG951xOeXI%3D&reserved=0>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201015/eb07c40d/attachment-0001.html>

From bocon at opennetworking.org  Fri Oct 16 05:57:06 2020
From: bocon at opennetworking.org (Brian O'Connor)
Date: Thu, 15 Oct 2020 22:57:06 -0700
Subject: [stratum-dev] Can I build stratum_bf with dynamic load of the
 grpc library?
In-Reply-To: <BY5PR04MB634277D40BB7992FFEDAF523AD020@BY5PR04MB6342.namprd04.prod.outlook.com>
References: <01010175184d4dd2-827879e6-ddc1-482a-8333-b81dedf2d187-000000@us-west-2.amazonses.com>
 <CAFh9Y_PE=NW8QknPvA73Wv0bUZToEwJqZYT-Nuht8fVg+pENTg@mail.gmail.com>
 <BY5PR04MB634246ED31D0D784E7CDA222AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_PRVSJUZCwoELaezz19o1h0TtH4AzTkWHkcyxg6o_DY7w@mail.gmail.com>
 <BY5PR04MB63424A8FA1FB0FF8F1C9CF36AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_O=+WcjFxdqJjE9aqrf42NtY=PEe=em-pm5YbLsDy-WPw@mail.gmail.com>
 <0101017523e20ee0-fa021eed-de3f-4398-b1cd-27bb50792cc9-000000@us-west-2.amazonses.com>
 <CACKOpDkAkrnhROhEoGpuaMm0UkFqVFuzKpgPaRkime5-KteisQ@mail.gmail.com>
 <BY5PR04MB63423D89B990F1912D35E29FAD020@BY5PR04MB6342.namprd04.prod.outlook.com>
 <BY5PR04MB634277D40BB7992FFEDAF523AD020@BY5PR04MB6342.namprd04.prod.outlook.com>
Message-ID: <CACKOpDmXBiV5HrdSPqgZESYgZ8o9UrEJ6mgR98ZjBmN-Hi6hRg@mail.gmail.com>

I think I figured out the compilation issue, and it seems like it builds
now with gRPC 1.30.0

We shouldn't need the bfrt branch (master should work), and the stratum_bf
target should work as long as "pi" and "bf-runtime" are enabled in the SDE
profile. You should comment out grpc in the SDE profile as you've done.

I'll try to update the PR in the next day or so with the following:
- base of master
- script for building install directory

Brian

On Thu, Oct 15, 2020 at 3:22 PM Narada Hess <NHESS at extremenetworks.com>
wrote:

> Hi Brian,
>
> I just realized that your PR is based off the bfrt branch. I’m not sure
> how to de-risk cutting over to that branch.
>
>
>
> I assume the bfrt branch is required for this solution? And we would
> deploy stratum_bfrt instead of stratum_bf? N
>
>
>
> *From:* Narada Hess
> *Sent:* Thursday, October 15, 2020 2:12 PM
> *Subject:* RE: [stratum-dev] Can I build stratum_bf with dynamic load of
> the grpc library?
>
>
>
> Hi Brian,
>
> We use a custom p4studio_build profile and dependencies.yaml file to build
> the SDE. Until we updated the grpc/protobuf versions to match stratum’s, we
> hit an error upon stratum start-up, saying that those versions were not
> compatible with each other.
>
>
>
> Then after building stratum and SDE with consistent grpc/protobuf
> versions, we ran into this current duplicate file issue.
>
>
>
> Now, we’ll try building with the profile below and your PR changes. N
>
>
>
> dependencies.yaml:
>
>    - Changed grpc version to 1.30.0 and protobuf version to 3.12.2
>
>
>
> build_profile.yaml (commented out grpc after our discussion today):
>
> # SDE_VERSION : 9.2.0
>
>
>
> bf-sde-sim-base:
>
>   # Global flags to configure
>
>   global_configure_options: ''
>
>
>
>   # SDE components to be installed
>
>   packages:
>
>     - bf-syslibs:
>
>       - bf_syslibs_configure_options: ''
>
>     - bf-utils:
>
>       - bf_utils_configure_options: ''
>
>     - bf-drivers:
>
>       - bf_drivers_configure_options: ''
>
>       - pi
>
>       - bf-runtime
>
>
>
>   # Third party source packages to be installed
>
>   # package_dependencies:
>
>   #   - grpc
>
>
>
>   # Tofino architecture
>
>   tofino_architecture: tofino2
>
>
>
>
>
> *From:* Brian O'Connor <bocon at opennetworking.org>
> *Sent:* Wednesday, October 14, 2020 5:26 PM
> *To:* Narada Hess <NHESS at extremenetworks.com>
> *Cc:* Maximilian Pudelko <max at opennetworking.org>;
> stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Can I build stratum_bf with dynamic load of
> the grpc library?
>
>
>
> Hi Narada,
>
> The specific issue that you are seeing has to do with the way that
> protobufs are being initialized. When a binary or shared library is loaded
> that contains a protobuf, initialization code like the code below is
> executed.
>
>
>
> // Force running AddDescriptors() at dynamic initialization time.
>
> static bool dynamic_init_dummy_google_2frpc_2fcode_2eproto =
>
>
>
> (static_cast<void>(::PROTOBUF_NAMESPACE_ID::internal::AddDescriptors(&descriptor_table_google_2frpc_2fcode_2eproto)),
> true);
>
>
> This likely means that libprotobuf, libgrpc, and any other library that
> introduces a protobuf (e.g. google/rpc/[code,status], P4Runtime) needs to
> be either linked in the stratum_bfrt binary, linked to bf-drivers, OR
> loaded once as a shared library for bf-drivers and stratum_bfrt to share.
>
>
>
> Use of calls to dl_open() will only make this trickier, and it would be
> best if we could get the loader resolve these dependencies at program
> start. Getting this right will be a little tricky, but should be do-able
> with some build changes.
>
>
>
> We've allocated some time in the Stratum TST tomorrow to go over this
> approach.
>
>
>
> Thanks!
>
> Brian
>
>
>
> On Tue, Oct 13, 2020 at 5:33 PM Narada Hess via stratum-dev <
> stratum-dev at lists.stratumproject.org> wrote:
>
> Thanks, Max,
>
> Static linking is fine by me 😊
>
>
>
> I very much like your SDE linkage idea. What confuses me is whether this
> is strictly a link issue, or a runtime initialization issue. The error
> (seen at run-time after much SDE init has been done) indicates that someone
> is trying to add the same file that has already been added. (Not sure
> whether the SDE or stratum got there first.)
>
>
>
> What I have not yet determined is whether this is some kind of internal
> thing that the single linkage would somehow solve, or whether there is some
> kind of init/instantiation code that we would have to find and disable.
>
>
>
> Actually, it might be a bit trickier, since the init would only need to be
> disabled if building stratum with an SDE that has BFRT enabled. Else of
> course you need it (since the SDE would not be doing it). And would there
> be some kind of handle that the SDE and stratum code would need to share?
>
>
>
> If you are interested in solving this problem, I would love to discuss the
> details. I’d like to solve this in an appropriate generally-applicable way.
> N
>
>
>
> *From:* Maximilian Pudelko <max at opennetworking.org>
> *Sent:* Tuesday, October 13, 2020 2:16 PM
> *To:* Narada Hess <NHESS at extremenetworks.com>
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Can I build stratum_bf with dynamic load of
> the grpc library?
>
>
>
> *External Email:* Use caution in opening links or attachments.
>
> That does indeed sound like a lot of work.
>
>
>
> I didn’t find any instances of dlopen()
>
> This is correct. We don't participate in such heretic practices, but
> instead build a single, fat and beautiful binary, like
>
> the apostles from Bell Labs intended :D
>
>
>
> On a more serious note, I wonder if we could link in the gRPC libraries
> from the SDE, instead of our own.
>
> Export them in bfsde.BUILD as cc_libraries and search-and-replace every
> instance throughout the code base.
>
>
>
>
>
> Max
>
>
>
>
>
> On Tue, Oct 13, 2020 at 11:49 AM Narada Hess <NHESS at extremenetworks.com>
> wrote:
>
> Thanks, Max
>
> I googled it and found lots of references to ‘protobuf File already exists
> in database’. There were various ideas, but the common solution in all
> threads was to factor out the code using protobuf into a separate library
> for use by both modules.
>
>
>
> Sure I can re-factor my own code, but refactoring protobuf out of stratum
> and BF-SDE into a separate dynamic library, that’s a lot bigger project!
> And probably not advisable.
>
>
>
> There were other suggestions like using dlopen() with RLTD_GLOBAL and
> linking with -fvisibility=hidden. I didn’t find any instances of dlopen()
> in the stratum code, and bazel seems only to support hints about linking,
> not fine-grained options.
>
>
>
> So scratching my head about this right now. N
>
>
>
> *From:* Maximilian Pudelko <max at opennetworking.org>
> *Sent:* Tuesday, October 13, 2020 11:36 AM
> *To:* Narada Hess <NHESS at extremenetworks.com>
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Can I build stratum_bf with dynamic load of
> the grpc library?
>
>
>
> *External Email:* Use caution in opening links or attachments.
>
> Thanks for the update.
>
>
>
> I think if you use bazel run directly on the switch, all the shared
> libraries should be taken care of by Bazel.
>
>
>
> To my knowledge, nobody had success running both gRPC services at the same
> time yet. We internally tried a while ago,
>
> but hit the same roadblocks as you.
>
>
>
> Max
>
>
>
> On Tue, Oct 13, 2020 at 8:04 AM Narada Hess <NHESS at extremenetworks.com>
> wrote:
>
> Thanks Max,
>
> Setting linkstatic to False results in a set of missing libraries. I am
> using compatible versions of grpc and protobuf, so that is not the issue.
>
>
>
> Has anyone reported being able to run stratum with the Barefoot SDE BFRT
> server enabled?
>
>
>
> I have not thus far solved the issue of the duplicate references
> (protobuf, etc). Thanks, N
>
>
>
> *From:* Maximilian Pudelko <max at opennetworking.org>
> *Sent:* Monday, October 12, 2020 12:31 PM
> *To:* Narada Hess <NHESS at extremenetworks.com>
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Can I build stratum_bf with dynamic load of
> the grpc library?
>
>
>
> *External Email:* Use caution in opening links or attachments.
>
> Hi Narada,
>
>
>
> Bazel heavily favors static linking, but there are some options around
> that:
> https://docs.bazel.build/versions/master/be/c-cpp.html#cc_binary.linkstatic
> <https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.bazel.build%2Fversions%2Fmaster%2Fbe%2Fc-cpp.html%23cc_binary.linkstatic&data=04%7C01%7CNHESS%40extremenetworks.com%7C38d38958275b47a6cc1108d870a0de5c%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637383183530591305%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=rJ6W0o6CL1rfrgOcACC4pOZfRInQaUPhVCwve8MdVrI%3D&reserved=0>
>
> Try adding this label on the stratum_bf target and rebuild.
>
> Another potential source of problems could be the different versions of
> gRPC and Protobuf between Stratum and the SDE. Adjusting it in Stratum is as
>
> easy as swapping the urls in the deps.bzl file.
>
>
>
> Max
>
>
>
> On Sun, Oct 11, 2020 at 8:35 AM Narada Hess via stratum-dev <
> stratum-dev at lists.stratumproject.org> wrote:
>
> Hi,
>
> I’m trying to build stratum_bf with the BF SDE BF-Runtime server enabled.
> That requires building the SDE with gRPC. Of course, when I try to run
> stratum_bf, it crashes because of the two instances of the gRPC library
> (see below).
>
>
>
> Is there any way to build stratum_bf with dynamic linking of the gRPC (and
> protobuf too, I’m guessing) library? I saw half a dozen files in the bazel
> directory referencing gRPC. Just removing the references of course did not
> work.
>
>
>
> Thanks for any suggestions on how to proceed. N
>
>
>
> /usr/local/bin/stratum_bf
> -flagfile=/etc/service/stratum/stratum-tofino-model.flags
>
> [libprotobuf ERROR
> external/com_google_protobuf/src/google/protobuf/descriptor_database.cc:120]
> File already exists in database: google/protobuf/descriptor.proto
> [libprotobuf FATAL
> external/com_google_protobuf/src/google/protobuf/descriptor.cc:1382] CHECK
> failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):
>
> terminate called after throwing an instance of
> 'google::protobuf::FatalException'
>
>   what():  CHECK failed:
> GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):
>
> Aborted (core dumped)
>
>
>
> _______________________________________________
> stratum-dev mailing list
> stratum-dev at lists.stratumproject.org
> https://lists.stratumproject.org/listinfo/stratum-dev
> <https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=04%7C01%7CNHESS%40extremenetworks.com%7C38d38958275b47a6cc1108d870a0de5c%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637383183530601297%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=FHrOYR%2F5ktHzwpsyj7CNnpVqPVb4yUdC%2BtFO94AvqxE%3D&reserved=0>
>
> _______________________________________________
> stratum-dev mailing list
> stratum-dev at lists.stratumproject.org
> https://lists.stratumproject.org/listinfo/stratum-dev
> <https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=04%7C01%7CNHESS%40extremenetworks.com%7C38d38958275b47a6cc1108d870a0de5c%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637383183530611296%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=ap64DEAFCXhW9Wm5JaYAYICVoqiIz21HNCG951xOeXI%3D&reserved=0>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201015/66f17674/attachment-0001.html>

From Craig.Stevens at Dell.com  Fri Oct 16 05:58:42 2020
From: Craig.Stevens at Dell.com (Stevens, Craig)
Date: Fri, 16 Oct 2020 05:58:42 +0000
Subject: [stratum-dev] Can I build stratum_bf with dynamic load of the
 grpc library?
In-Reply-To: <010101752ffbec74-0a84830a-7742-4ee3-a0d5-93c88668833c-000000@us-west-2.amazonses.com>
References: <01010175184d4dd2-827879e6-ddc1-482a-8333-b81dedf2d187-000000@us-west-2.amazonses.com>
 <CAFh9Y_PE=NW8QknPvA73Wv0bUZToEwJqZYT-Nuht8fVg+pENTg@mail.gmail.com>
 <BY5PR04MB634246ED31D0D784E7CDA222AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_PRVSJUZCwoELaezz19o1h0TtH4AzTkWHkcyxg6o_DY7w@mail.gmail.com>
 <BY5PR04MB63424A8FA1FB0FF8F1C9CF36AD040@BY5PR04MB6342.namprd04.prod.outlook.com>
 <CAFh9Y_O=+WcjFxdqJjE9aqrf42NtY=PEe=em-pm5YbLsDy-WPw@mail.gmail.com>
 <0101017523e20ee0-fa021eed-de3f-4398-b1cd-27bb50792cc9-000000@us-west-2.amazonses.com>
 <CACKOpDkAkrnhROhEoGpuaMm0UkFqVFuzKpgPaRkime5-KteisQ@mail.gmail.com>
 <BY5PR04MB63423D89B990F1912D35E29FAD020@BY5PR04MB6342.namprd04.prod.outlook.com>
 <BY5PR04MB634277D40BB7992FFEDAF523AD020@BY5PR04MB6342.namprd04.prod.outlook.com>,
 <010101752ffbec74-0a84830a-7742-4ee3-a0d5-93c88668833c-000000@us-west-2.amazonses.com>
Message-ID: <DM5PR19MB13229D368D31542BF113C7D6F9030@DM5PR19MB1322.namprd19.prod.outlook.com>

Nice work Brian!!

Get Outlook for iOS<https://aka.ms/o0ukef>
________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on behalf of Brian O'Connor via stratum-dev <stratum-dev at lists.stratumproject.org>
Sent: Friday, October 16, 2020 4:57:20 PM
To: Narada Hess <NHESS at extremenetworks.com>
Cc: stratum-dev at lists.stratumproject.org <stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?


[EXTERNAL EMAIL]

I think I figured out the compilation issue, and it seems like it builds now with gRPC 1.30.0

We shouldn't need the bfrt branch (master should work), and the stratum_bf target should work as long as "pi" and "bf-runtime" are enabled in the SDE profile. You should comment out grpc in the SDE profile as you've done.

I'll try to update the PR in the next day or so with the following:
- base of master
- script for building install directory

Brian

On Thu, Oct 15, 2020 at 3:22 PM Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>> wrote:

Hi Brian,

I just realized that your PR is based off the bfrt branch. I’m not sure how to de-risk cutting over to that branch.



I assume the bfrt branch is required for this solution? And we would deploy stratum_bfrt instead of stratum_bf? N



From: Narada Hess
Sent: Thursday, October 15, 2020 2:12 PM
Subject: RE: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?



Hi Brian,

We use a custom p4studio_build profile and dependencies.yaml file to build the SDE. Until we updated the grpc/protobuf versions to match stratum’s, we hit an error upon stratum start-up, saying that those versions were not compatible with each other.



Then after building stratum and SDE with consistent grpc/protobuf versions, we ran into this current duplicate file issue.



Now, we’ll try building with the profile below and your PR changes. N



dependencies.yaml:

  *   Changed grpc version to 1.30.0 and protobuf version to 3.12.2



build_profile.yaml (commented out grpc after our discussion today):

# SDE_VERSION : 9.2.0



bf-sde-sim-base:

  # Global flags to configure

  global_configure_options: ''



  # SDE components to be installed

  packages:

    - bf-syslibs:

      - bf_syslibs_configure_options: ''

    - bf-utils:

      - bf_utils_configure_options: ''

    - bf-drivers:

      - bf_drivers_configure_options: ''

      - pi

      - bf-runtime



  # Third party source packages to be installed

  # package_dependencies:

  #   - grpc



  # Tofino architecture

  tofino_architecture: tofino2





From: Brian O'Connor <bocon at opennetworking.org<mailto:bocon at opennetworking.org>>
Sent: Wednesday, October 14, 2020 5:26 PM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?



Hi Narada,

The specific issue that you are seeing has to do with the way that protobufs are being initialized. When a binary or shared library is loaded that contains a protobuf, initialization code like the code below is executed.



// Force running AddDescriptors() at dynamic initialization time.

static bool dynamic_init_dummy_google_2frpc_2fcode_2eproto =



(static_cast<void>(::PROTOBUF_NAMESPACE_ID::internal::AddDescriptors(&descriptor_table_google_2frpc_2fcode_2eproto)), true);

This likely means that libprotobuf, libgrpc, and any other library that introduces a protobuf (e.g. google/rpc/[code,status], P4Runtime) needs to be either linked in the stratum_bfrt binary, linked to bf-drivers, OR loaded once as a shared library for bf-drivers and stratum_bfrt to share.



Use of calls to dl_open() will only make this trickier, and it would be best if we could get the loader resolve these dependencies at program start. Getting this right will be a little tricky, but should be do-able with some build changes.



We've allocated some time in the Stratum TST tomorrow to go over this approach.



Thanks!

Brian



On Tue, Oct 13, 2020 at 5:33 PM Narada Hess via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:

Thanks, Max,

Static linking is fine by me 😊



I very much like your SDE linkage idea. What confuses me is whether this is strictly a link issue, or a runtime initialization issue. The error (seen at run-time after much SDE init has been done) indicates that someone is trying to add the same file that has already been added. (Not sure whether the SDE or stratum got there first.)



What I have not yet determined is whether this is some kind of internal thing that the single linkage would somehow solve, or whether there is some kind of init/instantiation code that we would have to find and disable.



Actually, it might be a bit trickier, since the init would only need to be disabled if building stratum with an SDE that has BFRT enabled. Else of course you need it (since the SDE would not be doing it). And would there be some kind of handle that the SDE and stratum code would need to share?



If you are interested in solving this problem, I would love to discuss the details. I’d like to solve this in an appropriate generally-applicable way. N



From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Tuesday, October 13, 2020 2:16 PM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?



External Email: Use caution in opening links or attachments.

That does indeed sound like a lot of work.



I didn’t find any instances of dlopen()

This is correct. We don't participate in such heretic practices, but instead build a single, fat and beautiful binary, like

the apostles from Bell Labs intended :D



On a more serious note, I wonder if we could link in the gRPC libraries from the SDE, instead of our own.

Export them in bfsde.BUILD as cc_libraries and search-and-replace every instance throughout the code base.





Max





On Tue, Oct 13, 2020 at 11:49 AM Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>> wrote:

Thanks, Max

I googled it and found lots of references to ‘protobuf File already exists in database’. There were various ideas, but the common solution in all threads was to factor out the code using protobuf into a separate library for use by both modules.



Sure I can re-factor my own code, but refactoring protobuf out of stratum and BF-SDE into a separate dynamic library, that’s a lot bigger project! And probably not advisable.



There were other suggestions like using dlopen() with RLTD_GLOBAL and linking with -fvisibility=hidden. I didn’t find any instances of dlopen() in the stratum code, and bazel seems only to support hints about linking, not fine-grained options.



So scratching my head about this right now. N



From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Tuesday, October 13, 2020 11:36 AM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?



External Email: Use caution in opening links or attachments.

Thanks for the update.



I think if you use bazel run directly on the switch, all the shared libraries should be taken care of by Bazel.



To my knowledge, nobody had success running both gRPC services at the same time yet. We internally tried a while ago,

but hit the same roadblocks as you.



Max



On Tue, Oct 13, 2020 at 8:04 AM Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>> wrote:

Thanks Max,

Setting linkstatic to False results in a set of missing libraries. I am using compatible versions of grpc and protobuf, so that is not the issue.



Has anyone reported being able to run stratum with the Barefoot SDE BFRT server enabled?



I have not thus far solved the issue of the duplicate references (protobuf, etc). Thanks, N



From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Monday, October 12, 2020 12:31 PM
To: Narada Hess <NHESS at extremenetworks.com<mailto:NHESS at extremenetworks.com>>
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Can I build stratum_bf with dynamic load of the grpc library?



External Email: Use caution in opening links or attachments.

Hi Narada,



Bazel heavily favors static linking, but there are some options around that: https://docs.bazel.build/versions/master/be/c-cpp.html#cc_binary.linkstatic<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Fdocs.bazel.build%2Fversions%2Fmaster%2Fbe%2Fc-cpp.html%23cc_binary.linkstatic&data=04%7C01%7CNHESS%40extremenetworks.com%7C38d38958275b47a6cc1108d870a0de5c%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637383183530591305%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=rJ6W0o6CL1rfrgOcACC4pOZfRInQaUPhVCwve8MdVrI%3D&reserved=0>

Try adding this label on the stratum_bf target and rebuild.

Another potential source of problems could be the different versions of gRPC and Protobuf between Stratum and the SDE. Adjusting it in Stratum is as

easy as swapping the urls in the deps.bzl file.



Max



On Sun, Oct 11, 2020 at 8:35 AM Narada Hess via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:

Hi,

I’m trying to build stratum_bf with the BF SDE BF-Runtime server enabled. That requires building the SDE with gRPC. Of course, when I try to run stratum_bf, it crashes because of the two instances of the gRPC library (see below).



Is there any way to build stratum_bf with dynamic linking of the gRPC (and protobuf too, I’m guessing) library? I saw half a dozen files in the bazel directory referencing gRPC. Just removing the references of course did not work.



Thanks for any suggestions on how to proceed. N



/usr/local/bin/stratum_bf -flagfile=/etc/service/stratum/stratum-tofino-model.flags

[libprotobuf ERROR external/com_google_protobuf/src/google/protobuf/descriptor_database.cc:120] File already exists in database: google/protobuf/descriptor.proto [libprotobuf FATAL external/com_google_protobuf/src/google/protobuf/descriptor.cc:1382] CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

terminate called after throwing an instance of 'google::protobuf::FatalException'

  what():  CHECK failed: GeneratedDatabase()-\u003eAdd(encoded_file_descriptor, size):

Aborted (core dumped)



_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=04%7C01%7CNHESS%40extremenetworks.com%7C38d38958275b47a6cc1108d870a0de5c%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637383183530601297%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=FHrOYR%2F5ktHzwpsyj7CNnpVqPVb4yUdC%2BtFO94AvqxE%3D&reserved=0>

_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev<https://nam05.safelinks.protection.outlook.com/?url=https%3A%2F%2Flists.stratumproject.org%2Flistinfo%2Fstratum-dev&data=04%7C01%7CNHESS%40extremenetworks.com%7C38d38958275b47a6cc1108d870a0de5c%7Cfc8c2bf6914d4c1fb35246a9adb87030%7C0%7C0%7C637383183530611296%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C1000&sdata=ap64DEAFCXhW9Wm5JaYAYICVoqiIz21HNCG951xOeXI%3D&reserved=0>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201016/fe41af7b/attachment-0001.html>

From bocon at opennetworking.org  Tue Oct 20 16:40:38 2020
From: bocon at opennetworking.org (bocon at opennetworking.org)
Date: Tue, 20 Oct 2020 16:40:38 +0000
Subject: [stratum-dev] Updated invitation: Stratum TST Meeting @ Weekly from
 3:30pm to 4pm on Thursday (EDT) (stratum-dev@lists.stratumproject.org)
Message-ID: <000000000000152e5305b21ce466@google.com>

This event has been changed.

Title: Stratum TST Meeting
Stratum Technical Steering Team MeetingJoin Zoom  
Meetinghttps://onf.zoom.us/j/787501745?pwd=OHdtQVA3eXdoeThxZ0UzS1VVWEtxQT09Meeting  
ID: 787 501 745Passcode: 258532One tap mobile+13126266799,,787501745# US  
(Chicago)+19292056099,,787501745# US (New York)Agenda and Meeting  
Noteshttps://docs.google.com/document/d/1ret8Vbnl-xbLgNsnDEH-jWP2_WwDYym4zDn6me3tiTA/editThe  
plan is to reserve the 1st and 3rd Thursdays of each month for  
presentations and community updates. If you can only attend some of these  
meetings, those will be more interesting. The other meetings will be more  
informal&nbsp;sync ups to discuss current issues, progress, and status. You  
can see what presentations are planned by checking the agenda  
above.Supporting Slides and Previous  
Recordingshttps://drive.google.com/drive/folders/1ZeYp6RwIGYi9VnIctvnKF1c1NxiAXeOT----------------------------------------------------------------Dial  
by your location&nbsp; &nbsp; &nbsp; &nbsp; +1 312 626 6799 US  
(Chicago)&nbsp; &nbsp; &nbsp; &nbsp; +1 929 205 6099 US (New York)&nbsp;  
&nbsp; &nbsp; &nbsp; +1 301 715 8592 US (Germantown)&nbsp; &nbsp; &nbsp;  
&nbsp; +1 346 248 7799 US (Houston)&nbsp; &nbsp; &nbsp; &nbsp; +1 669 900  
6833 US (San Jose)&nbsp; &nbsp; &nbsp; &nbsp; +1 253 215 8782 US  
(Tacoma)&nbsp; &nbsp; &nbsp; &nbsp; 888 788 0099 US Toll-free&nbsp; &nbsp;  
&nbsp; &nbsp; 877 853 5247 US Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +61 2  
8015 6011 Australia&nbsp; &nbsp; &nbsp; &nbsp; +61 3 7018 2005  
Australia&nbsp; &nbsp; &nbsp; &nbsp; +61 7 3185 3730 Australia&nbsp; &nbsp;  
&nbsp; &nbsp; +61 8 6119 3900 Australia&nbsp; &nbsp; &nbsp; &nbsp; +61 8  
7150 1149 Australia&nbsp; &nbsp; &nbsp; &nbsp; 1800 945 157 Australia  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 1800 893 423 Australia Toll-free&nbsp;  
&nbsp; &nbsp; &nbsp; +81 363 628 317 Japan&nbsp; &nbsp; &nbsp; &nbsp; +81  
524 564 439 Japan&nbsp; &nbsp; &nbsp; &nbsp; +81 3 4578 1488 Japan&nbsp;  
&nbsp; &nbsp; &nbsp; 0 800 100 5040 Japan Toll-free&nbsp; &nbsp; &nbsp;  
&nbsp; 00 663 381 4092 Japan Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +49 69  
7104 9922 Germany&nbsp; &nbsp; &nbsp; &nbsp; +49 30 5679 5800 Germany&nbsp;  
&nbsp; &nbsp; &nbsp; +49 69 3807 9883 Germany&nbsp; &nbsp; &nbsp; &nbsp;  
+49 695 050 2596 Germany&nbsp; &nbsp; &nbsp; &nbsp; 0 800 1800 150 Germany  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 0 800 000 6954 Germany Toll-free&nbsp;  
&nbsp; &nbsp; &nbsp; +886 (2) 7741 7473 Taiwan&nbsp; &nbsp; &nbsp; &nbsp;  
08 0909 9864 Taiwan Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +48 22 307 3488  
Poland&nbsp; &nbsp; &nbsp; &nbsp; +48 22 398 7356 Poland&nbsp; &nbsp;  
&nbsp; &nbsp; +48 22 306 5342 Poland&nbsp; &nbsp; &nbsp; &nbsp; 00 800 321  
1464 Poland Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 00 800 112 5171 Poland  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +44 208 080 6592 United Kingdom&nbsp;  
&nbsp; &nbsp; &nbsp; +44 330 088 5830 United Kingdom&nbsp; &nbsp; &nbsp;  
&nbsp; +44 131 460 1196 United Kingdom&nbsp; &nbsp; &nbsp; &nbsp; +44 203  
481 5237 United Kingdom&nbsp; &nbsp; &nbsp; &nbsp; +44 203 481 5240 United  
Kingdom&nbsp; &nbsp; &nbsp; &nbsp; +44 203 901 7895 United Kingdom&nbsp;  
&nbsp; &nbsp; &nbsp; +44 208 080 6591 United Kingdom&nbsp; &nbsp; &nbsp;  
&nbsp; 0 800 260 5801 United Kingdom Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 0  
800 031 5717 United Kingdom Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +353 1 536  
9320 Ireland&nbsp; &nbsp; &nbsp; &nbsp; +353 1 653 3895 Ireland&nbsp;  
&nbsp; &nbsp; &nbsp; +353 1 653 3897 Ireland&nbsp; &nbsp; &nbsp; &nbsp;  
+353 1 653 3898 Ireland&nbsp; &nbsp; &nbsp; &nbsp; +353 6 163 9031  
Ireland&nbsp; &nbsp; &nbsp; &nbsp; +353 1 240 8941 Ireland&nbsp; &nbsp;  
&nbsp; &nbsp; 1800 949 238 Ireland Toll-free&nbsp; &nbsp; &nbsp; &nbsp;  
1800 901 561 Ireland Toll-freeMeeting ID: 787 501 745Find your local  
number:  
https://onf.zoom.us/u/ad1osSbywU----------------------------------------------------------------If  
you would like to get added to the calendar invite, please ask Brian.
When: Weekly from 3:30pm to 4pm on Thursday Eastern Time - New York
Where: (Online conference room)-Zoom-3
Calendar: stratum-dev at lists.stratumproject.org
Who:
     * bocon at opennetworking.org - creator
     * max at opennetworking.org
     * bill at opennetworking.org
     * mohammed.habeeb at inventec.com
     * yi at opennetworking.org
     * carmelo at opennetworking.org
     * xiao.david at inventec.com
     * Rich Renner
     * Devjit Gopalpur
     * Alireza Ghaffarkhah
     * Leonid Khedyk
     * niloofar at opennetworking.org
     * hsuanchung.lee at qct.io
     * Arkadiy Shapiro
     * you at opennetworking.org
     * abhilash at opennetworking.org
     * stratum-dev at lists.stratumproject.org
     * maksym.kovaliov at plvision.eu
     * craig.stevens at dell.com
     * maksym.tropets at plvision.eu
     * jeff_catlin at edge-core.com
     * chris.sommers at keysight.com
     * David Gengenbach
     * John L
     * cmace at extremenetworks.com
     * Poongovan Ponnavaikko

Event details:  
https://www.google.com/calendar/event?action=VIEW&eid=MTVxdHRrZTdoOGNrZG9ycHYzaDJoZ3VvZGpfUjIwMjAxMDIyVDE5MzAwMCBzdHJhdHVtLWRldkBsaXN0cy5zdHJhdHVtcHJvamVjdC5vcmc&tok=NzEjb3Blbm5ldHdvcmtpbmcub3JnX3Z2M2xmdDg5ZTc5NGI0amxtcjNqOXAxcGVzQGdyb3VwLmNhbGVuZGFyLmdvb2dsZS5jb204NWUxODgyMWMyNTkwOGNhYThiOTc0YmViMDZmNzVjOWNkYWU4OGZm&ctz=America%2FNew_York&hl=en&es=0

Invitation from Google Calendar: https://www.google.com/calendar/

You are receiving this courtesy email at the account  
stratum-dev at lists.stratumproject.org because you are an attendee of this  
event.

To stop receiving future updates for this event, decline this event.  
Alternatively you can sign up for a Google account at  
https://www.google.com/calendar/ and control your notification settings for  
your entire calendar.

Forwarding this invitation could allow any recipient to send a response to  
the organizer and be added to the guest list, or invite others regardless  
of their own invitation status, or to modify your RSVP. Learn more at  
https://support.google.com/calendar/answer/37135#forwarding
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201020/76844044/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: text/calendar
Size: 10906 bytes
Desc: not available
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201020/76844044/attachment-0001.ics>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: invite.ics
Type: application/ics
Size: 11089 bytes
Desc: not available
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201020/76844044/attachment-0001.bin>

From bocon at opennetworking.org  Tue Oct 20 16:40:39 2020
From: bocon at opennetworking.org (bocon at opennetworking.org)
Date: Tue, 20 Oct 2020 16:40:39 +0000
Subject: [stratum-dev] Updated invitation: Stratum TST Meeting @ Weekly from
 3:30pm to 4pm on Thursday from Thu Oct 1 to Thu Oct 22 (EDT)
 (stratum-dev@lists.stratumproject.org)
Message-ID: <0000000000001776bd05b21ce434@google.com>

This event has been changed.

Title: Stratum TST Meeting
Stratum Technical Steering Team MeetingJoin Zoom  
Meetinghttps://onf.zoom.us/j/787501745?pwd=OHdtQVA3eXdoeThxZ0UzS1VVWEtxQT09Meeting  
ID: 787 501 745Passcode: 258532One tap mobile+13126266799,,787501745# US  
(Chicago)+19292056099,,787501745# US (New York)Agenda and Meeting  
Noteshttps://docs.google.com/document/d/1ret8Vbnl-xbLgNsnDEH-jWP2_WwDYym4zDn6me3tiTA/editThe  
plan is to reserve the 1st and 3rd Thursdays of each month for  
presentations and community updates. If you can only attend some of these  
meetings, those will be more interesting. The other meetings will be more  
informal&nbsp;sync ups to discuss current issues, progress, and status. You  
can see what presentations are planned by checking the agenda  
above.Supporting Slides and Previous  
Recordingshttps://drive.google.com/drive/folders/1ZeYp6RwIGYi9VnIctvnKF1c1NxiAXeOT----------------------------------------------------------------Dial  
by your location&nbsp; &nbsp; &nbsp; &nbsp; +1 312 626 6799 US  
(Chicago)&nbsp; &nbsp; &nbsp; &nbsp; +1 929 205 6099 US (New York)&nbsp;  
&nbsp; &nbsp; &nbsp; +1 301 715 8592 US (Germantown)&nbsp; &nbsp; &nbsp;  
&nbsp; +1 346 248 7799 US (Houston)&nbsp; &nbsp; &nbsp; &nbsp; +1 669 900  
6833 US (San Jose)&nbsp; &nbsp; &nbsp; &nbsp; +1 253 215 8782 US  
(Tacoma)&nbsp; &nbsp; &nbsp; &nbsp; 888 788 0099 US Toll-free&nbsp; &nbsp;  
&nbsp; &nbsp; 877 853 5247 US Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +61 2  
8015 6011 Australia&nbsp; &nbsp; &nbsp; &nbsp; +61 3 7018 2005  
Australia&nbsp; &nbsp; &nbsp; &nbsp; +61 7 3185 3730 Australia&nbsp; &nbsp;  
&nbsp; &nbsp; +61 8 6119 3900 Australia&nbsp; &nbsp; &nbsp; &nbsp; +61 8  
7150 1149 Australia&nbsp; &nbsp; &nbsp; &nbsp; 1800 945 157 Australia  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 1800 893 423 Australia Toll-free&nbsp;  
&nbsp; &nbsp; &nbsp; +81 363 628 317 Japan&nbsp; &nbsp; &nbsp; &nbsp; +81  
524 564 439 Japan&nbsp; &nbsp; &nbsp; &nbsp; +81 3 4578 1488 Japan&nbsp;  
&nbsp; &nbsp; &nbsp; 0 800 100 5040 Japan Toll-free&nbsp; &nbsp; &nbsp;  
&nbsp; 00 663 381 4092 Japan Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +49 69  
7104 9922 Germany&nbsp; &nbsp; &nbsp; &nbsp; +49 30 5679 5800 Germany&nbsp;  
&nbsp; &nbsp; &nbsp; +49 69 3807 9883 Germany&nbsp; &nbsp; &nbsp; &nbsp;  
+49 695 050 2596 Germany&nbsp; &nbsp; &nbsp; &nbsp; 0 800 1800 150 Germany  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 0 800 000 6954 Germany Toll-free&nbsp;  
&nbsp; &nbsp; &nbsp; +886 (2) 7741 7473 Taiwan&nbsp; &nbsp; &nbsp; &nbsp;  
08 0909 9864 Taiwan Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +48 22 307 3488  
Poland&nbsp; &nbsp; &nbsp; &nbsp; +48 22 398 7356 Poland&nbsp; &nbsp;  
&nbsp; &nbsp; +48 22 306 5342 Poland&nbsp; &nbsp; &nbsp; &nbsp; 00 800 321  
1464 Poland Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 00 800 112 5171 Poland  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +44 208 080 6592 United Kingdom&nbsp;  
&nbsp; &nbsp; &nbsp; +44 330 088 5830 United Kingdom&nbsp; &nbsp; &nbsp;  
&nbsp; +44 131 460 1196 United Kingdom&nbsp; &nbsp; &nbsp; &nbsp; +44 203  
481 5237 United Kingdom&nbsp; &nbsp; &nbsp; &nbsp; +44 203 481 5240 United  
Kingdom&nbsp; &nbsp; &nbsp; &nbsp; +44 203 901 7895 United Kingdom&nbsp;  
&nbsp; &nbsp; &nbsp; +44 208 080 6591 United Kingdom&nbsp; &nbsp; &nbsp;  
&nbsp; 0 800 260 5801 United Kingdom Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 0  
800 031 5717 United Kingdom Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +353 1 536  
9320 Ireland&nbsp; &nbsp; &nbsp; &nbsp; +353 1 653 3895 Ireland&nbsp;  
&nbsp; &nbsp; &nbsp; +353 1 653 3897 Ireland&nbsp; &nbsp; &nbsp; &nbsp;  
+353 1 653 3898 Ireland&nbsp; &nbsp; &nbsp; &nbsp; +353 6 163 9031  
Ireland&nbsp; &nbsp; &nbsp; &nbsp; +353 1 240 8941 Ireland&nbsp; &nbsp;  
&nbsp; &nbsp; 1800 949 238 Ireland Toll-free&nbsp; &nbsp; &nbsp; &nbsp;  
1800 901 561 Ireland Toll-freeMeeting ID: 787 501 745Find your local  
number:  
https://onf.zoom.us/u/ad1osSbywU----------------------------------------------------------------If  
you would like to get added to the calendar invite, please ask Brian.
When: Weekly from 3:30pm to 4pm on Thursday from Thu Oct 1 to Thu Oct 22  
Eastern Time - New York (changed)
Where: (Online conference room)-Zoom-3
Calendar: stratum-dev at lists.stratumproject.org
Who:
     * bocon at opennetworking.org - creator
     * max at opennetworking.org
     * bill at opennetworking.org
     * mohammed.habeeb at inventec.com
     * yi at opennetworking.org
     * carmelo at opennetworking.org
     * xiao.david at inventec.com
     * Rich Renner
     * Devjit Gopalpur
     * Alireza Ghaffarkhah
     * Leonid Khedyk
     * niloofar at opennetworking.org
     * hsuanchung.lee at qct.io
     * Arkadiy Shapiro
     * you at opennetworking.org
     * abhilash at opennetworking.org
     * David Gengenbach
     * stratum-dev at lists.stratumproject.org
     * maksym.kovaliov at plvision.eu
     * craig.stevens at dell.com
     * maksym.tropets at plvision.eu
     * jeff_catlin at edge-core.com
     * chris.sommers at keysight.com

Event details:  
https://www.google.com/calendar/event?action=VIEW&eid=MTVxdHRrZTdoOGNrZG9ycHYzaDJoZ3VvZGpfUjIwMjAxMDAxVDE5MzAwMCBzdHJhdHVtLWRldkBsaXN0cy5zdHJhdHVtcHJvamVjdC5vcmc&tok=NzEjb3Blbm5ldHdvcmtpbmcub3JnX3Z2M2xmdDg5ZTc5NGI0amxtcjNqOXAxcGVzQGdyb3VwLmNhbGVuZGFyLmdvb2dsZS5jb21iZDhlYTI1NTUwZWVlM2EwYzk3ZjNjZWZmNzAzYmRjMTk1NzRkNGM1&ctz=America%2FNew_York&hl=en&es=0

Invitation from Google Calendar: https://www.google.com/calendar/

You are receiving this courtesy email at the account  
stratum-dev at lists.stratumproject.org because you are an attendee of this  
event.

To stop receiving future updates for this event, decline this event.  
Alternatively you can sign up for a Google account at  
https://www.google.com/calendar/ and control your notification settings for  
your entire calendar.

Forwarding this invitation could allow any recipient to send a response to  
the organizer and be added to the guest list, or invite others regardless  
of their own invitation status, or to modify your RSVP. Learn more at  
https://support.google.com/calendar/answer/37135#forwarding
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201020/fd4d6aad/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: text/calendar
Size: 10470 bytes
Desc: not available
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201020/fd4d6aad/attachment-0001.ics>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: invite.ics
Type: application/ics
Size: 10645 bytes
Desc: not available
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201020/fd4d6aad/attachment-0001.bin>

From zzha at masonlive.gmu.edu  Wed Oct 21 18:57:40 2020
From: zzha at masonlive.gmu.edu (zzha)
Date: Wed, 21 Oct 2020 18:57:40 +0000
Subject: [stratum-dev] Questions regarding pushing pipeline configs to
 barefoot Tofino switch
Message-ID: <MW2PR0102MB3580077FADB5EE7D62A5149F901C0@MW2PR0102MB3580.prod.exchangelabs.com>

Hi there,

I have built and started Stratum on a Tofino switch. But when I was trying to install a pipeline configuration through p4runtime-shell, Stratum reports a segmentation fault if the P4 program is compiled without "--p4runtime-force-std-externs" flag. However, with this p4c compilation flag, for programs that use Tofino specific externs like registers, the compiler will report a warning that says "No known conversion to standard P4Info for 'Register' extern type". Any suggestions on how to fix this would be greatly appreciated!

Best regards,
Zoey
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201021/31e65413/attachment.html>

From yi at opennetworking.org  Mon Oct 26 21:24:01 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Mon, 26 Oct 2020 14:24:01 -0700
Subject: [stratum-dev] Questions regarding pushing pipeline configs to
 barefoot Tofino switch
In-Reply-To: <0101017565bb71f4-ab0089d0-ad88-489c-9863-80290b791f07-000000@us-west-2.amazonses.com>
References: <0101017565bb71f4-ab0089d0-ad88-489c-9863-80290b791f07-000000@us-west-2.amazonses.com>
Message-ID: <CAOyFVR1Nt=hHtFgg67dVsLzZMizez3iOBJ2px6JhBe9tLh=QeQ@mail.gmail.com>

Hi Zoey,

We believed that Barefoot will add support for converting Register extern
to the standard one in the next Barefoot's SDE release.

Also, the current stratum_bf doesn't support register since the PI
framework doesn't support it (Implementation here
<https://github.com/p4lang/PI/blob/master/proto/frontend/src/device_mgr.cpp#L2059-L2061>
)

Currently, we are working on a new Stratum target called stratum_bfrt which
is based on Barefoot's BfRt C++ API (Pull request here
<https://github.com/stratum/stratum/pull/337>).
And it should support the native P4Runtime register messages.

Yi

On Mon, Oct 26, 2020 at 9:26 AM zzha via stratum-dev <
stratum-dev at lists.stratumproject.org> wrote:

> Hi there,
>
> I have built and started Stratum on a Tofino switch. But when I was trying
> to install a pipeline configuration through p4runtime-shell, Stratum
> reports a segmentation fault if the P4 program is compiled without
> "--p4runtime-force-std-externs" flag. However, with this p4c compilation
> flag, for programs that use Tofino specific externs like registers, the
> compiler will report a warning that says "No known conversion to standard
> P4Info for 'Register' extern type". Any suggestions on how to fix this
> would be greatly appreciated!
>
> Best regards,
> Zoey
> _______________________________________________
> stratum-dev mailing list
> stratum-dev at lists.stratumproject.org
> https://lists.stratumproject.org/listinfo/stratum-dev



-- 
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201026/c0300390/attachment.html>

From max at opennetworking.org  Mon Oct 26 22:10:41 2020
From: max at opennetworking.org (Maximilian Pudelko)
Date: Mon, 26 Oct 2020 15:10:41 -0700
Subject: [stratum-dev] Questions regarding pushing pipeline configs to
 barefoot Tofino switch
In-Reply-To: <0101017566cc8608-6d1948cc-33d1-42fb-9733-3202f286c84f-000000@us-west-2.amazonses.com>
References: <0101017565bb71f4-ab0089d0-ad88-489c-9863-80290b791f07-000000@us-west-2.amazonses.com>
 <0101017566cc8608-6d1948cc-33d1-42fb-9733-3202f286c84f-000000@us-west-2.amazonses.com>
Message-ID: <CAFh9Y_NGshH955wSw6NkdXcSzeO2VeF8g81NmBELZcT3Wb0OsA@mail.gmail.com>

Hi Zoey,

Yi summarized it pretty well. While the extern flag is required, Stratum
should not segfault.
If you could post the error log we could see how to handle this better.

Max

On Mon, Oct 26, 2020 at 2:24 PM Yi Tseng via stratum-dev <
stratum-dev at lists.stratumproject.org> wrote:

> Hi Zoey,
>
> We believed that Barefoot will add support for converting Register extern
> to the standard one in the next Barefoot's SDE release.
>
> Also, the current stratum_bf doesn't support register since the PI
> framework doesn't support it (Implementation here
> <https://github.com/p4lang/PI/blob/master/proto/frontend/src/device_mgr.cpp#L2059-L2061>
> )
>
> Currently, we are working on a new Stratum target called stratum_bfrt
> which is based on Barefoot's BfRt C++ API (Pull request here
> <https://github.com/stratum/stratum/pull/337>).
> And it should support the native P4Runtime register messages.
>
> Yi
>
> On Mon, Oct 26, 2020 at 9:26 AM zzha via stratum-dev <
> stratum-dev at lists.stratumproject.org> wrote:
>
>> Hi there,
>>
>> I have built and started Stratum on a Tofino switch. But when I was
>> trying to install a pipeline configuration through p4runtime-shell, Stratum
>> reports a segmentation fault if the P4 program is compiled without
>> "--p4runtime-force-std-externs" flag. However, with this p4c compilation
>> flag, for programs that use Tofino specific externs like registers, the
>> compiler will report a warning that says "No known conversion to standard
>> P4Info for 'Register' extern type". Any suggestions on how to fix this
>> would be greatly appreciated!
>>
>> Best regards,
>> Zoey
>> _______________________________________________
>> stratum-dev mailing list
>> stratum-dev at lists.stratumproject.org
>> https://lists.stratumproject.org/listinfo/stratum-dev
>
>
>
> --
> Yi Tseng
> Member of Technical Staff
> Open Networking Foundation
> https://www.opennetworking.org/
> _______________________________________________
> stratum-dev mailing list
> stratum-dev at lists.stratumproject.org
> https://lists.stratumproject.org/listinfo/stratum-dev
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201026/2c13bc95/attachment.html>

From zzha at masonlive.gmu.edu  Mon Oct 26 23:29:08 2020
From: zzha at masonlive.gmu.edu (zzha)
Date: Mon, 26 Oct 2020 23:29:08 +0000
Subject: [stratum-dev] Questions regarding pushing pipeline configs to
 barefoot Tofino switch
In-Reply-To: <CAFh9Y_NGshH955wSw6NkdXcSzeO2VeF8g81NmBELZcT3Wb0OsA@mail.gmail.com>
References: <0101017565bb71f4-ab0089d0-ad88-489c-9863-80290b791f07-000000@us-west-2.amazonses.com>
 <0101017566cc8608-6d1948cc-33d1-42fb-9733-3202f286c84f-000000@us-west-2.amazonses.com>,
 <CAFh9Y_NGshH955wSw6NkdXcSzeO2VeF8g81NmBELZcT3Wb0OsA@mail.gmail.com>
Message-ID: <MW2PR0102MB3580F33840FAC25EF054E11490190@MW2PR0102MB3580.prod.exchangelabs.com>

Hi Max and Yi,

Thanks a lot for the explanation. I will definitely try out the stratum_bfrt target. FYI, the seg fault message from stratum is as below if I tried to push configs generated without --p4runtime-force-std-externs during compilation.
------------------------------------------------------------------------------------------------------------------------
I20201026 22:34:10.255018  6773 bf_chassis_manager.cc:716] State of port 64 in node 1: UP.
I20201026 22:34:10.256922  6773 bf_chassis_manager.cc:716] State of port 65 in node 1: UP.
I20201026 22:34:10.565280  6773 bf_chassis_manager.cc:716] State of port 66 in node 1: UP.
I20201026 22:34:10.586470  6773 bf_chassis_manager.cc:716] State of port 67 in node 1: UP.
I20201026 22:34:36.289355  6778 p4_service.cc:698] Controller (connection_id: 1, election_id: 1, uri: ipv4:192.168.100.13:34090) is connected as MASTER for node (aka device) with ID 1.
bf_switchd: starting warm init for dev_id 0 mode 1 serdes_upgrade 0
|2020-10-26 22:34:36.571587 BF_PI ERROR - get_table_state: error when retrieving table state 33580535 for device 0
*** Aborted at 1603751676 (unix time) try "date -d @1603751676" if you are using GNU date ***
PC: @                0x0 (unknown)
*** SIGSEGV (@0x0) received by PID 6732 (TID 0x7f099e7dc700) from PID 0; stack trace: ***
    @     0x7f09b72cf0e0 (unknown)
    @     0x7f09b8e24459 pi_state_table_id_to_handle
    @     0x7f09b8e1d2ab _pi_update_device_start
    @           0xcb1e24 pi_update_device_start
    @           0xb99d24 pi::fe::proto::DeviceMgrImp::pipeline_config_set()
    @           0xb921cd pi::fe::proto::DeviceMgr::pipeline_config_set()
    @           0xac7719 stratum::hal::pi::PINode::PushForwardingPipelineConfig()
    @           0x43deaa stratum::hal::barefoot::BFSwitch::PushForwardingPipelineConfig()
    @           0x94b501 stratum::hal::P4Service::SetForwardingPipelineConfig()
    @           0xc28e50 std::_Mem_fn<>::operator()<>()
    @           0xc26099 std::_Function_handler<>::_M_invoke()
    @           0xc3aed4 std::function<>::operator()()
    @           0xc31aa2 _ZZN9grpc_impl8internal16RpcMethodHandlerIN2p42v19P4Runtime7ServiceENS3_34SetForwardingPipelineConfigRequestENS3_35SetForwardingPipelineConfigResponseEE10RunHandlerERKN4grpc8internal13MethodHandler16HandlerParameterEENKUlvE_clEv
    @           0xc3af09 _ZN9grpc_impl8internal23CatchingFunctionHandlerIZNS0_16RpcMethodHandlerIN2p42v19P4Runtime7ServiceENS4_34SetForwardingPipelineConfigRequestENS4_35SetForwardingPipelineConfigResponseEE10RunHandlerERKN4grpc8internal13MethodHandler16HandlerParameterEEUlvE_EENSA_6StatusEOT_
    @           0xc31b57 grpc_impl::internal::RpcMethodHandler<>::RunHandler()
    @           0xe07a48 grpc_impl::Server::SyncRequest::CallData::ContinueRunAfterInterception()
    @           0xe07877 grpc_impl::Server::SyncRequest::CallData::Run()
    @           0xe08013 grpc_impl::Server::SyncRequestThreadManager::DoWork()
    @           0xe24429 grpc::ThreadManager::MainWorkLoop()
    @           0xe23a9b grpc::ThreadManager::WorkerThread::Run()
    @           0xe2395a _ZZN4grpc13ThreadManager12WorkerThreadC4EPS0_ENKUlPvE_clES3_
    @           0xe23979 _ZZN4grpc13ThreadManager12WorkerThreadC4EPS0_ENUlPvE_4_FUNES3_
    @          0x1016b54 _ZZN9grpc_core12_GLOBAL__N_120ThreadInternalsPosixC4EPKcPFvPvES4_PbRKNS_6Thread7OptionsEENKUlS4_E_clES4_
    @          0x1016b99 _ZZN9grpc_core12_GLOBAL__N_120ThreadInternalsPosixC4EPKcPFvPvES4_PbRKNS_6Thread7OptionsEENUlS4_E_4_FUNES4_
    @     0x7f09b72c54a4 start_thread
    @     0x7f09b6bedd0f clone
    @                0x0 (unknown)
Segmentation fault

Best regards,
Zoey
________________________________
From: Maximilian Pudelko <max at opennetworking.org>
Sent: Monday, October 26, 2020 6:10 PM
To: Yi Tseng <yi at opennetworking.org>
Cc: zzha <zzha at masonlive.gmu.edu>; stratum-dev at lists.stratumproject.org <stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Questions regarding pushing pipeline configs to barefoot Tofino switch

Hi Zoey,

Yi summarized it pretty well. While the extern flag is required, Stratum should not segfault.
If you could post the error log we could see how to handle this better.

Max

On Mon, Oct 26, 2020 at 2:24 PM Yi Tseng via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:
Hi Zoey,

We believed that Barefoot will add support for converting Register extern to the standard one in the next Barefoot's SDE release.

Also, the current stratum_bf doesn't support register since the PI framework doesn't support it (Implementation here<https://github.com/p4lang/PI/blob/master/proto/frontend/src/device_mgr.cpp#L2059-L2061>)

Currently, we are working on a new Stratum target called stratum_bfrt which is based on Barefoot's BfRt C++ API (Pull request here<https://github.com/stratum/stratum/pull/337>).
And it should support the native P4Runtime register messages.

Yi

On Mon, Oct 26, 2020 at 9:26 AM zzha via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:
Hi there,

I have built and started Stratum on a Tofino switch. But when I was trying to install a pipeline configuration through p4runtime-shell, Stratum reports a segmentation fault if the P4 program is compiled without "--p4runtime-force-std-externs" flag. However, with this p4c compilation flag, for programs that use Tofino specific externs like registers, the compiler will report a warning that says "No known conversion to standard P4Info for 'Register' extern type". Any suggestions on how to fix this would be greatly appreciated!

Best regards,
Zoey
_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201026/0409dafe/attachment-0001.html>

From max at opennetworking.org  Tue Oct 27 04:43:30 2020
From: max at opennetworking.org (Maximilian Pudelko)
Date: Mon, 26 Oct 2020 21:43:30 -0700
Subject: [stratum-dev] Questions regarding pushing pipeline configs to
 barefoot Tofino switch
In-Reply-To: <MW2PR0102MB3580F33840FAC25EF054E11490190@MW2PR0102MB3580.prod.exchangelabs.com>
References: <0101017565bb71f4-ab0089d0-ad88-489c-9863-80290b791f07-000000@us-west-2.amazonses.com>
 <0101017566cc8608-6d1948cc-33d1-42fb-9733-3202f286c84f-000000@us-west-2.amazonses.com>
 <CAFh9Y_NGshH955wSw6NkdXcSzeO2VeF8g81NmBELZcT3Wb0OsA@mail.gmail.com>
 <MW2PR0102MB3580F33840FAC25EF054E11490190@MW2PR0102MB3580.prod.exchangelabs.com>
Message-ID: <CAFh9Y_MT_KXmaVHC_UOmwVy43WcF9j2UDMrf48+yAdG_RRYUzw@mail.gmail.com>

Thanks for posting the log.
Sadly the segfault is happening deep inside the PI / SDE code. The only
thing we could do is to detect and catch such a pipeline and fail
gracefully.

Max

On Mon, Oct 26, 2020 at 4:29 PM zzha <zzha at masonlive.gmu.edu> wrote:

> Hi Max and Yi,
>
> Thanks a lot for the explanation. I will definitely try out the
> stratum_bfrt target. FYI, the seg fault message from stratum is as below if
> I tried to push configs generated without --p4runtime-force-std-externs
> during compilation.
>
> ------------------------------------------------------------------------------------------------------------------------
> I20201026 22:34:10.255018  6773 bf_chassis_manager.cc:716] State of port
> 64 in node 1: UP.
> I20201026 22:34:10.256922  6773 bf_chassis_manager.cc:716] State of port
> 65 in node 1: UP.
> I20201026 22:34:10.565280  6773 bf_chassis_manager.cc:716] State of port
> 66 in node 1: UP.
> I20201026 22:34:10.586470  6773 bf_chassis_manager.cc:716] State of port
> 67 in node 1: UP.
> I20201026 22:34:36.289355  6778 p4_service.cc:698] Controller
> (connection_id: 1, election_id: 1, uri: ipv4:192.168.100.13:34090) is
> connected as MASTER for node (aka device) with ID 1.
> bf_switchd: starting warm init for dev_id 0 mode 1 serdes_upgrade 0
> |2020-10-26 22:34:36.571587 BF_PI ERROR - get_table_state: error when
> retrieving table state 33580535 for device 0
> *** Aborted at 1603751676 (unix time) try "date -d @1603751676" if you are
> using GNU date ***
> PC: @                0x0 (unknown)
> *** SIGSEGV (@0x0) received by PID 6732 (TID 0x7f099e7dc700) from PID 0;
> stack trace: ***
>     @     0x7f09b72cf0e0 (unknown)
>     @     0x7f09b8e24459 pi_state_table_id_to_handle
>     @     0x7f09b8e1d2ab _pi_update_device_start
>     @           0xcb1e24 pi_update_device_start
>     @           0xb99d24 pi::fe::proto::DeviceMgrImp::pipeline_config_set()
>     @           0xb921cd pi::fe::proto::DeviceMgr::pipeline_config_set()
>     @           0xac7719
> stratum::hal::pi::PINode::PushForwardingPipelineConfig()
>     @           0x43deaa
> stratum::hal::barefoot::BFSwitch::PushForwardingPipelineConfig()
>     @           0x94b501
> stratum::hal::P4Service::SetForwardingPipelineConfig()
>     @           0xc28e50 std::_Mem_fn<>::operator()<>()
>     @           0xc26099 std::_Function_handler<>::_M_invoke()
>     @           0xc3aed4 std::function<>::operator()()
>     @           0xc31aa2
> _ZZN9grpc_impl8internal16RpcMethodHandlerIN2p42v19P4Runtime7ServiceENS3_34SetForwardingPipelineConfigRequestENS3_35SetForwardingPipelineConfigResponseEE10RunHandlerERKN4grpc8internal13MethodHandler16HandlerParameterEENKUlvE_clEv
>     @           0xc3af09
> _ZN9grpc_impl8internal23CatchingFunctionHandlerIZNS0_16RpcMethodHandlerIN2p42v19P4Runtime7ServiceENS4_34SetForwardingPipelineConfigRequestENS4_35SetForwardingPipelineConfigResponseEE10RunHandlerERKN4grpc8internal13MethodHandler16HandlerParameterEEUlvE_EENSA_6StatusEOT_
>     @           0xc31b57
> grpc_impl::internal::RpcMethodHandler<>::RunHandler()
>     @           0xe07a48
> grpc_impl::Server::SyncRequest::CallData::ContinueRunAfterInterception()
>     @           0xe07877 grpc_impl::Server::SyncRequest::CallData::Run()
>     @           0xe08013
> grpc_impl::Server::SyncRequestThreadManager::DoWork()
>     @           0xe24429 grpc::ThreadManager::MainWorkLoop()
>     @           0xe23a9b grpc::ThreadManager::WorkerThread::Run()
>     @           0xe2395a
> _ZZN4grpc13ThreadManager12WorkerThreadC4EPS0_ENKUlPvE_clES3_
>     @           0xe23979
> _ZZN4grpc13ThreadManager12WorkerThreadC4EPS0_ENUlPvE_4_FUNES3_
>     @          0x1016b54
> _ZZN9grpc_core12_GLOBAL__N_120ThreadInternalsPosixC4EPKcPFvPvES4_PbRKNS_6Thread7OptionsEENKUlS4_E_clES4_
>     @          0x1016b99
> _ZZN9grpc_core12_GLOBAL__N_120ThreadInternalsPosixC4EPKcPFvPvES4_PbRKNS_6Thread7OptionsEENUlS4_E_4_FUNES4_
>     @     0x7f09b72c54a4 start_thread
>     @     0x7f09b6bedd0f clone
>     @                0x0 (unknown)
> Segmentation fault
>
> Best regards,
> Zoey
> ------------------------------
> *From:* Maximilian Pudelko <max at opennetworking.org>
> *Sent:* Monday, October 26, 2020 6:10 PM
> *To:* Yi Tseng <yi at opennetworking.org>
> *Cc:* zzha <zzha at masonlive.gmu.edu>; stratum-dev at lists.stratumproject.org
> <stratum-dev at lists.stratumproject.org>
> *Subject:* Re: [stratum-dev] Questions regarding pushing pipeline configs
> to barefoot Tofino switch
>
> Hi Zoey,
>
> Yi summarized it pretty well. While the extern flag is required, Stratum
> should not segfault.
> If you could post the error log we could see how to handle this better.
>
> Max
>
> On Mon, Oct 26, 2020 at 2:24 PM Yi Tseng via stratum-dev <
> stratum-dev at lists.stratumproject.org> wrote:
>
> Hi Zoey,
>
> We believed that Barefoot will add support for converting Register extern
> to the standard one in the next Barefoot's SDE release.
>
> Also, the current stratum_bf doesn't support register since the PI
> framework doesn't support it (Implementation here
> <https://github.com/p4lang/PI/blob/master/proto/frontend/src/device_mgr.cpp#L2059-L2061>
> )
>
> Currently, we are working on a new Stratum target called stratum_bfrt
> which is based on Barefoot's BfRt C++ API (Pull request here
> <https://github.com/stratum/stratum/pull/337>).
> And it should support the native P4Runtime register messages.
>
> Yi
>
> On Mon, Oct 26, 2020 at 9:26 AM zzha via stratum-dev <
> stratum-dev at lists.stratumproject.org> wrote:
>
> Hi there,
>
> I have built and started Stratum on a Tofino switch. But when I was trying
> to install a pipeline configuration through p4runtime-shell, Stratum
> reports a segmentation fault if the P4 program is compiled without
> "--p4runtime-force-std-externs" flag. However, with this p4c compilation
> flag, for programs that use Tofino specific externs like registers, the
> compiler will report a warning that says "No known conversion to standard
> P4Info for 'Register' extern type". Any suggestions on how to fix this
> would be greatly appreciated!
>
> Best regards,
> Zoey
> _______________________________________________
> stratum-dev mailing list
> stratum-dev at lists.stratumproject.org
> https://lists.stratumproject.org/listinfo/stratum-dev
>
>
>
> --
> Yi Tseng
> Member of Technical Staff
> Open Networking Foundation
> https://www.opennetworking.org/
> _______________________________________________
> stratum-dev mailing list
> stratum-dev at lists.stratumproject.org
> https://lists.stratumproject.org/listinfo/stratum-dev
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20201026/caf3aa0f/attachment.html>

