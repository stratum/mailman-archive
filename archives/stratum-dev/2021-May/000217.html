<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [stratum-dev] BMv2 standalone instances unable to forward	traffic
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:stratum-dev%40lists.stratumproject.org?Subject=Re%3A%20%5Bstratum-dev%5D%20BMv2%20standalone%20instances%20unable%20to%20forward%0A%09traffic&In-Reply-To=%3CCAFh9Y_ML5W%2BwXxzkG8w1j694Nzk9PPWne0Md4O5c5Yn3r86pmg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000211.html">
   <LINK REL="Next"  HREF="000214.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[stratum-dev] BMv2 standalone instances unable to forward	traffic</H1>
    <B>Maximilian Pudelko</B> 
    <A HREF="mailto:stratum-dev%40lists.stratumproject.org?Subject=Re%3A%20%5Bstratum-dev%5D%20BMv2%20standalone%20instances%20unable%20to%20forward%0A%09traffic&In-Reply-To=%3CCAFh9Y_ML5W%2BwXxzkG8w1j694Nzk9PPWne0Md4O5c5Yn3r86pmg%40mail.gmail.com%3E"
       TITLE="[stratum-dev] BMv2 standalone instances unable to forward	traffic">max at opennetworking.org
       </A><BR>
    <I>Tue May 11 18:33:04 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000211.html">[stratum-dev] BMv2 standalone instances unable to forward	traffic
</A></li>
        <LI>Next message (by thread): <A HREF="000214.html">[stratum-dev] Is there a limit on the # of ECMP groups stratum_bmv2	can handle?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#217">[ date ]</a>
              <a href="thread.html#217">[ thread ]</a>
              <a href="subject.html#217">[ subject ]</a>
              <a href="author.html#217">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Glad you could make it work and thanks for writing up the solution.

Max

On Mon, May 3, 2021 at 12:58 PM A Sydney via stratum-dev &lt;
<A HREF="https://lists.stratumproject.org/listinfo/stratum-dev">stratum-dev at lists.stratumproject.org</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> I was able to resolve the issue. Below is a quick summary:
</I>&gt;<i> Problem: The ONOS GUI did not show any links and further investigation
</I>&gt;<i> showed that LLDP traffic was not observed in the stratum_bmv2 log.
</I>&gt;<i> Solution: I specified the &quot;cpu_port&quot; argument when stratum_bmv2 starts-up
</I>&gt;<i> (i.e. cpu_port was set to 255, which is the same port used in the p4
</I>&gt;<i> program).
</I>&gt;<i>
</I>&gt;<i> PS. Feel free to read below for more details:
</I>&gt;<i>
</I>&gt;<i> Cheers!
</I>&gt;<i> -Syd
</I>&gt;<i>
</I>&gt;<i> On Mon, Apr 26, 2021 at 1:41 PM A Sydney &lt;<A HREF="https://lists.stratumproject.org/listinfo/stratum-dev">asydney007 at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi Stratum folks,
</I>&gt;&gt;<i>                            It appears that traffic is not forwarded by
</I>&gt;&gt;<i> the BMv2 standalone instances. Here are more details:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. I used Max's instructions to create standalone BMv2 instances running
</I>&gt;&gt;<i> on Debian 10.
</I>&gt;&gt;<i> 2. I created an SdnTest app on ONOS with the identical pipeconf,
</I>&gt;&gt;<i> bmv2.json, and p4info.txt files from the ngsdn-tutorial app (i.e. the same
</I>&gt;&gt;<i> working versions of these files from the ngsdn-tutorial VM are used in a
</I>&gt;&gt;<i> different setup with a different ONOS controller and 6 standalone bmv2
</I>&gt;&gt;<i> switches). (<A HREF="https://github.com/opennetworkinglab/ngsdn-tutorial">https://github.com/opennetworkinglab/ngsdn-tutorial</A>).
</I>&gt;&gt;<i> 3. I created a custom 6-node Clos topology and I've attached the
</I>&gt;&gt;<i> corresponding netcfg.json in the tarball.
</I>&gt;&gt;<i> 4. Onos starts up just fine and I ensure that all apps (similar to the
</I>&gt;&gt;<i> ones running on ngsdn-tutorial) are fired-up (See onos_cli_log in attached).
</I>&gt;&gt;<i> 5. I then push netcfg.json to onos, and the onos logs show a few &quot;Failed
</I>&gt;&gt;<i> to register Bandwidth&quot; and &quot;Failed to register Port&quot; errors (See onos_log
</I>&gt;&gt;<i> in attached tarball): Note: After digging a bit, it appears that these
</I>&gt;&gt;<i> messages originate from ResourceDeviceListener.java on line 162 when
</I>&gt;&gt;<i> &quot;log.isTraceEnabled()&quot; is not set in ConsistentResourceStore on line 122
</I>&gt;&gt;<i> (So this essentially may not be an issue?). In any case, onos_cli_log shows
</I>&gt;&gt;<i> that all devices are connected and available. Interestingly, the &quot;Tx&quot;
</I>&gt;&gt;<i> portstat remains at 0. Given the fact the the lldpprovider app is running,
</I>&gt;&gt;<i> I would expect at least LLDP traffic to be flowing.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 6. As an example, I logged onto leaf1 to take a look at the logs, and
</I>&gt;&gt;<i> from the terminal, I see the following (See leaf1_stratum_terminal_log for
</I>&gt;&gt;<i> more details):
</I>&gt;&gt;<i> &quot;&quot;&quot;
</I>&gt;&gt;<i> E20210426 16:01:18.918056  5458 p4_service.cc:311] Failed to write
</I>&gt;&gt;<i> forwarding entries to node 1:
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This occurs when an attempt is made to install a flow that already exists.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> &quot;&quot;&quot;
</I>&gt;&gt;<i> So when the switch starts up, the initial &quot;chassis_config_file&quot; lists all
</I>&gt;&gt;<i> 8 ports on all switches. However, netcfg.json specifies 6 of the 8. When I
</I>&gt;&gt;<i> take a look through the onos web GUI, I still see all 8 ports which implies
</I>&gt;&gt;<i> that perhaps there may be issues pushing the updated chassis_config_file to
</I>&gt;&gt;<i> the switch?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 7. When I look through the details debug log for leaf1 (see
</I>&gt;&gt;<i> leaf1_log_written_to_file), I only see 1 LLDP pkt (i.e. ethtype 88cc),
</I>&gt;&gt;<i> though tcpdump from the controller shows that the controller is indeed
</I>&gt;&gt;<i> sending numerous discovery pkts.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This turns out to be the log when lldphostprovider adds the LLDP rule to
</I>&gt;<i> the switch.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> PS. I've attached a tarball with the various log files and a ReadMe
</I>&gt;&gt;<i> describing the contents of each file.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Can you kindly provide feedback on perhaps why traffic (at least LLDP) is
</I>&gt;&gt;<i> not forwarded by the switches?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Using tcpdump, I observed that LLDP traffic was sent from the controller
</I>&gt;<i> and made it to the switch. However, the bmv2 logs did not register any LLDP
</I>&gt;<i> traffic on port 255 (i.e. the CPU port specified in the p4 program). I took
</I>&gt;<i> a look at how stratum_bmv2 starts from the ngsdn-tutorial vm and observed
</I>&gt;<i> that &quot;cpu_port&quot; was one of the arguments and was set to 255. For some
</I>&gt;<i> reason, I thought that 255 was the default CPU port but it turns out that
</I>&gt;<i> the default port is 64.  So I specified the &quot;cpu_port&quot; argument in
</I>&gt;<i> testrig and pkt-in/outs now work and hence LLDP works.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> BTW. I also tried to connect to leaf1 via &quot;util/p4rt-sh&quot;, install flow
</I>&gt;&gt;<i> rules to foward traffic between ports 5 and 6, but a quick ping showed that
</I>&gt;&gt;<i> traffic was not flowing: I also used tcpdump on leaf1 to verify that indeed
</I>&gt;&gt;<i> no pkts were making it on ports 5 and 6 (except dhcp which is expected).
</I>&gt;&gt;<i>
</I>&gt;<i> This was a result of the behavior of the protocols in my environment. I
</I>&gt;<i> had to add new tables and their corresponding ONOS components, and now
</I>&gt;<i> traffic flows just fine.
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> stratum-dev mailing list
</I>&gt;<i> <A HREF="https://lists.stratumproject.org/listinfo/stratum-dev">stratum-dev at lists.stratumproject.org</A>
</I>&gt;<i> <A HREF="https://lists.stratumproject.org/listinfo/stratum-dev">https://lists.stratumproject.org/listinfo/stratum-dev</A>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="https://lists.stratumproject.org/archives/stratum-dev/attachments/20210511/a79ae61d/attachment.html">https://lists.stratumproject.org/archives/stratum-dev/attachments/20210511/a79ae61d/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000211.html">[stratum-dev] BMv2 standalone instances unable to forward	traffic
</A></li>
	<LI>Next message (by thread): <A HREF="000214.html">[stratum-dev] Is there a limit on the # of ECMP groups stratum_bmv2	can handle?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#217">[ date ]</a>
              <a href="thread.html#217">[ thread ]</a>
              <a href="subject.html#217">[ subject ]</a>
              <a href="author.html#217">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.stratumproject.org/listinfo/stratum-dev">More information about the stratum-dev
mailing list</a><br>
</body></html>
