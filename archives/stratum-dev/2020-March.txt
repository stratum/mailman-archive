From yi at opennetworking.org  Mon Mar  2 19:43:29 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Mon, 2 Mar 2020 11:43:29 -0800
Subject: [stratum-dev] [brigade-p4] Stratum pre-built container
In-Reply-To: <77c56eb8472346538d55d222b6a39104@kau.se>
References: <3219e60081e54a23950b45fb513ca36e@kau.se>
 <C51D008B-728A-4591-8CA7-EFD77B8FBB2A@opennetworking.org>
 <CAOyFVR17KiGdfwZeD1ZyhJm1t5eh4Ar177gGA86HPSa_0TVRjA@mail.gmail.com>
 <b23068b17b02411bad50514261401a63@kau.se>
 <CAOyFVR1VeaA+dPWT6x=yjX-qpqYV-UMMOMSvLrMRdLWWVqZFYQ@mail.gmail.com>
 <77c56eb8472346538d55d222b6a39104@kau.se>
Message-ID: <CAOyFVR2Zzcw=K0D9=cdyCq-dhAOcEObFDRmV4fXQ4hDf1T6iPg@mail.gmail.com>

Hi Deval,

You need to set up *BF_SDE_INSTALL* environment variable before you build
the Stratum
https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md#building-stratum-from-scratch

The *switchd* binary is provided by Barefoot, which supports P4Runtime and
some private protocols.
The *Stratum* binary implements P4Runtime, gNMI, and gNOI protocols and use
switch SDK to control the switch ASIC.
You can find the overview of Stratum architecture here:
https://github.com/stratum/stratum#component-overview

Yi

On Sun, Mar 1, 2020 at 6:21 AM Deval Bhamare <Deval.Bhamare at kau.se> wrote:

> Hello Yi,
>
>
>
> I tried stratum build in dev environment, however, now I am getting error
> like below (Complete screenshot attached).
>
>
> *ERROR: */stratum/stratum/hal/lib/barefoot/BUILD:124:1: no such target
> '@local_barefoot_bin//:bf_headers': target 'bf_headers' not declared in
> package '' defined by
> /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/local_barefoot_bin/BUILD
> and referenced by '//stratum/hal/lib/barefoot:bf_pal_wrapper'
>
> *ERROR: */stratum/stratum/hal/lib/barefoot/BUILD:124:1: no such target
> '@local_barefoot_bin//:bf_drivers': target 'bf_drivers' not declared in
> package '' defined by
> /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/local_barefoot_bin/BUILD
> and referenced by '//stratum/hal/lib/barefoot:bf_pal_wrapper'
>
> ...
>
>
> Any suggestions?
>
>
> Also, I wanted to ask, what is the exact difference between using stratum
> and communicating with tofino by enabling the grpc server (something like *
> ./run_switchd.sh -c $SDE_INSTALL/share/p4/targets/tofino/skip_p4.conf
> --skip-p4 --p4rt-server 0.0.0.0:50051 <http://0.0.0.0:50051>*)? Can you
> please explain?
>
>
> Thanks,
>
>
> Deval.
> ------------------------------
> *From:* Yi Tseng <yi at opennetworking.org>
> *Sent:* Thursday, February 27, 2020 8:57:41 PM
> *To:* Deval Bhamare
> *Cc:* stratum-dev at lists.stratumproject.org; devalb at gmail.com
> *Subject:* Re: [brigade-p4] Stratum pre-built container
>
> Hello, please see my reply *inline*
>
> On Tue, Feb 25, 2020 at 1:21 AM Deval Bhamare <Deval.Bhamare at kau.se>
> wrote:
>
>> Dear Yi,
>>
>>
>> I appreciate your valuable input. I tried to build the  Stratum directly
>> on the machine as well. It gave me an error. Details are below:
>>
>>
>> *1. Build Stratum from scratch*: I have BF SDE 8.9.0 and I execute the
>> command (first I executed it without
>> incompatible_bzl_disallow_load_after_statement=false and it asked me to
>> include that option in command):
>>
>>
>> bazel build //stratum/hal/bin/barefoot:stratum_bf --define
>> phal_with_onlp=false --define sde_ver=8.9.0
>> --incompatible_bzl_disallow_load_after_statement=false
>>
>>
> *Please use the stratum build development environment to build the
> Stratum. We only support Bazel 0.23.2 now. And will move to 2.0 in the
> future.*
> *https://github.com/stratum/stratum#development-environment
> <https://github.com/stratum/stratum#development-environment>*
>
>
>>
>> It gave me the error:
>>
>>
>> *ERROR:* /home/tofino/.cache/bazel/_bazel_tofino/f6d313d4f595c91e594b2a1b1a2579ea/external/io_bazel_rules_python/python/pip.bzl:39:25:
>> Traceback (most recent call last):
>> File
>> "/home/tofino/.cache/bazel/_bazel_tofino/f6d313d4f595c91e594b2a1b1a2579ea/external/io_bazel_rules_python/python/pip.bzl",
>> line 37
>> repository_rule(<2 more arguments>)
>> File
>> "/home/tofino/.cache/bazel/_bazel_tofino/f6d313d4f595c91e594b2a1b1a2579ea/external/io_bazel_rules_python/python/pip.bzl",
>> line 39, in repository_rule
>> attr.label(allow_files = True, <2 more arguments>)
>> 'single_file' is no longer supported. use allow_single_file instead. You
>> can use --incompatible_disable_deprecated_attr_params=false to temporarily
>> disable this check.
>> *ERROR:* error loading package '': Extension file 'python/pip.bzl' has
>> errors
>> *ERROR:* error loading package '': Extension file 'python/pip.bzl' has
>> errors
>> INFO: Elapsed time: 0.101s
>> INFO: 0 processes.
>> *FAILED:* Build did NOT complete successfully (0 packages loaded)
>>
>>
>>
>> I also tried to build the Docker Image manually.
>>
>> *3. Build the docker image manually*: I tried to execute the command
>> below, as per my kernel and SDE
>>
>>
>> ./build-stratum-bf-container.sh bf-sde-8.9.0.tar linux-4.4.173.tar.gz
>>
>>
>> However, it failed with error below. Where can I find *Linux ONL tar* for
>> my linux kernel?
>> Error:
>>
>
> *You should be able to find it from /usr/src/linux-headers-[your linux
> kernel version]. *
>
>
>
>> make: Entering directory '/usr/src/kernel-headers'
>>
>>   ERROR: Kernel configuration is invalid.
>>          include/generated/autoconf.h or include/config/auto.conf are
>> missing.
>>          Run 'make oldconfig && make prepare' on kernel src to fix it.
>>
>>
>>   WARNING: Symbol version dump ./Module.symvers
>>            is missing; modules will have no dependencies and modversions.
>>
>>   Building modules, stage 2.
>> scripts/Makefile.modpost:42: include/config/auto.conf: No such file or
>> directory
>> make[1]: *** No rule to make target 'include/config/auto.conf'.  Stop.
>> Makefile:1439: recipe for target 'modules' failed
>> make: Leaving directory '/usr/src/kernel-headers'
>> make: *** [modules] Error 2
>> The command '/bin/sh -c make -C /usr/src/kernel-headers M=$KDRV_DIR
>> src=$KDRV_DIR modules &&     mv $KDRV_DIR/bf_kdrv.ko
>> $SDE_INSTALL/lib/modules/bf_kdrv.ko' returned a non-zero code: 2
>>
>> Thanks,
>>
>>
>> Deval.
>> ------------------------------
>> *From:* Yi Tseng <yi at opennetworking.org>
>> *Sent:* Tuesday, February 25, 2020 2:07:35 AM
>> *To:* Deval Bhamare
>> *Cc:* stratum-dev at lists.stratumproject.org
>> *Subject:* Re: [brigade-p4] Stratum pre-built container
>>
>> [+stratum-dev at lists.stratumproject.org
>> <stratum-dev at lists.stratumproject.org>, remove p4-brigade list]
>>
>> Hi Deval,
>>
>> The public container images include a specific Barefoot Linux kernel
>> module.
>>
>> Now we only compile the module for kernels from OpenNetworkLiunx (3.16,
>> 4.9, and 4.14)
>>
>> If you want to run Stratum on different kernel (4.4.0-173-generic), you
>> need to compile the Barefoot SDE with the kernel header and run Stratum
>> directly on the OS
>>
>> I've created a GitHub issue to support this request. And will make a PR
>> to support this case.
>> https://github.com/stratum/stratum/issues/140
>>
>> Yi
>>
>>
>> On Mon, Feb 24, 2020 at 3:25 PM Carmelo Cascone <
>> carmelo at opennetworking.org> wrote:
>>
>>> Hi Deval,
>>>
>>> I suggest you ask on the stratum-dev mailing list or Slack channel:
>>> https://wiki.opennetworking.org/display/COM/Stratum
>>>
>>> This mailing list is for discussions related to P4/P4Runtime support in
>>> ONOS.
>>>
>>> Thanks
>>> Carmelo
>>>
>>> On Feb 24, 2020, at 6:53 AM, Deval Bhamare <Deval.Bhamare at kau.se> wrote:
>>>
>>> Hi,
>>>
>>> I am trying to find Stratum pre-built docker image for Linux
>>> 4.4.0-173-generic x86_64 , however couldn't find it. Can you please tell me
>>> whether Stratum is not supported on Generic and only runs on ONL version?
>>>
>>> I tried *stratumproject/stratum-bf:8.9.1-4.14.49-OpenNetworkLinux* ,
>>> but it failed with error:
>>>
>>> cat: /etc/onl/platform: No such file or directory
>>> Use default flag file
>>> Cannot find /usr/local/share/stratum/.json
>>>
>>>
>>> Maybe because the Linux doesn't support ONL? What may be the solution?
>>> Please let me know.
>>>
>>>
>>> Thanks,
>>> Deval
>>>
>>> --
>>> You received this message because you are subscribed to the Google
>>> Groups "P4 brigade" group.
>>> To unsubscribe from this group and stop receiving emails from it, send
>>> an email to brigade-p4+unsubscribe at onosproject.org.
>>> To view this discussion on the web visit
>>> https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/3219e60081e54a23950b45fb513ca36e%40kau.se
>>> <https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/3219e60081e54a23950b45fb513ca36e%40kau.se?utm_medium=email&utm_source=footer>
>>> .
>>>
>>>
>>> --
>>> You received this message because you are subscribed to the Google
>>> Groups "P4 brigade" group.
>>> To unsubscribe from this group and stop receiving emails from it, send
>>> an email to brigade-p4+unsubscribe at onosproject.org.
>>> To view this discussion on the web visit
>>> https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/C51D008B-728A-4591-8CA7-EFD77B8FBB2A%40opennetworking.org
>>> <https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/C51D008B-728A-4591-8CA7-EFD77B8FBB2A%40opennetworking.org?utm_medium=email&utm_source=footer>
>>> .
>>>
>>
>>
>> --
>> Yi Tseng
>> Member of Technical Staff
>> Open Networking Foundation
>> https://www.opennetworking.org/
>>
>
>
> --
> Yi Tseng
> Member of Technical Staff
> Open Networking Foundation
> https://www.opennetworking.org/
>


-- 
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200302/8350e8c8/attachment-0001.html>

From Deval.Bhamare at kau.se  Sun Mar  1 14:21:39 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Sun, 1 Mar 2020 14:21:39 +0000
Subject: [stratum-dev] [brigade-p4] Stratum pre-built container
In-Reply-To: <CAOyFVR1VeaA+dPWT6x=yjX-qpqYV-UMMOMSvLrMRdLWWVqZFYQ@mail.gmail.com>
References: <3219e60081e54a23950b45fb513ca36e@kau.se>
 <C51D008B-728A-4591-8CA7-EFD77B8FBB2A@opennetworking.org>
 <CAOyFVR17KiGdfwZeD1ZyhJm1t5eh4Ar177gGA86HPSa_0TVRjA@mail.gmail.com>
 <b23068b17b02411bad50514261401a63@kau.se>,
 <CAOyFVR1VeaA+dPWT6x=yjX-qpqYV-UMMOMSvLrMRdLWWVqZFYQ@mail.gmail.com>
Message-ID: <77c56eb8472346538d55d222b6a39104@kau.se>

Hello Yi,



I tried stratum build in dev environment, however, now I am getting error like below (Complete screenshot attached).


ERROR: /stratum/stratum/hal/lib/barefoot/BUILD:124:1: no such target '@local_barefoot_bin//:bf_headers': target 'bf_headers' not declared in package '' defined by /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/local_barefoot_bin/BUILD and referenced by '//stratum/hal/lib/barefoot:bf_pal_wrapper'

ERROR: /stratum/stratum/hal/lib/barefoot/BUILD:124:1: no such target '@local_barefoot_bin//:bf_drivers': target 'bf_drivers' not declared in package '' defined by /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/local_barefoot_bin/BUILD and referenced by '//stratum/hal/lib/barefoot:bf_pal_wrapper'

...


Any suggestions?


Also, I wanted to ask, what is the exact difference between using stratum and communicating with tofino by enabling the grpc server (something like ./run_switchd.sh -c $SDE_INSTALL/share/p4/targets/tofino/skip_p4.conf --skip-p4 --p4rt-server 0.0.0.0:50051)? Can you please explain?


Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Thursday, February 27, 2020 8:57:41 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org; devalb at gmail.com
Subject: Re: [brigade-p4] Stratum pre-built container

Hello, please see my reply inline

On Tue, Feb 25, 2020 at 1:21 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Dear Yi,


I appreciate your valuable input. I tried to build the  Stratum directly on the machine as well. It gave me an error. Details are below:


1. Build Stratum from scratch: I have BF SDE 8.9.0 and I execute the command (first I executed it without incompatible_bzl_disallow_load_after_statement=false and it asked me to include that option in command):


bazel build //stratum/hal/bin/barefoot:stratum_bf --define phal_with_onlp=false --define sde_ver=8.9.0 --incompatible_bzl_disallow_load_after_statement=false


Please use the stratum build development environment to build the Stratum. We only support Bazel 0.23.2 now. And will move to 2.0 in the future.
https://github.com/stratum/stratum#development-environment


It gave me the error:


ERROR: /home/tofino/.cache/bazel/_bazel_tofino/f6d313d4f595c91e594b2a1b1a2579ea/external/io_bazel_rules_python/python/pip.bzl:39:25: Traceback (most recent call last):
File "/home/tofino/.cache/bazel/_bazel_tofino/f6d313d4f595c91e594b2a1b1a2579ea/external/io_bazel_rules_python/python/pip.bzl", line 37
repository_rule(<2 more arguments>)
File "/home/tofino/.cache/bazel/_bazel_tofino/f6d313d4f595c91e594b2a1b1a2579ea/external/io_bazel_rules_python/python/pip.bzl", line 39, in repository_rule
attr.label(allow_files = True, <2 more arguments>)
'single_file' is no longer supported. use allow_single_file instead. You can use --incompatible_disable_deprecated_attr_params=false to temporarily disable this check.
ERROR: error loading package '': Extension file 'python/pip.bzl' has errors
ERROR: error loading package '': Extension file 'python/pip.bzl' has errors
INFO: Elapsed time: 0.101s
INFO: 0 processes.
FAILED: Build did NOT complete successfully (0 packages loaded)



I also tried to build the Docker Image manually.

3. Build the docker image manually: I tried to execute the command below, as per my kernel and SDE


./build-stratum-bf-container.sh bf-sde-8.9.0.tar linux-4.4.173.tar.gz


However, it failed with error below. Where can I find Linux ONL tar for my linux kernel?
Error:

You should be able to find it from /usr/src/linux-headers-[your linux kernel version].



make: Entering directory '/usr/src/kernel-headers'

  ERROR: Kernel configuration is invalid.
         include/generated/autoconf.h or include/config/auto.conf are missing.
         Run 'make oldconfig && make prepare' on kernel src to fix it.


  WARNING: Symbol version dump ./Module.symvers
           is missing; modules will have no dependencies and modversions.

  Building modules, stage 2.
scripts/Makefile.modpost:42: include/config/auto.conf: No such file or directory
make[1]: *** No rule to make target 'include/config/auto.conf'.  Stop.
Makefile:1439: recipe for target 'modules' failed
make: Leaving directory '/usr/src/kernel-headers'
make: *** [modules] Error 2
The command '/bin/sh -c make -C /usr/src/kernel-headers M=$KDRV_DIR src=$KDRV_DIR modules &&     mv $KDRV_DIR/bf_kdrv.ko $SDE_INSTALL/lib/modules/bf_kdrv.ko' returned a non-zero code: 2

Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Tuesday, February 25, 2020 2:07:35 AM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [brigade-p4] Stratum pre-built container

[+stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>, remove p4-brigade list]

Hi Deval,

The public container images include a specific Barefoot Linux kernel module.

Now we only compile the module for kernels from OpenNetworkLiunx (3.16, 4.9, and 4.14)

If you want to run Stratum on different kernel (4.4.0-173-generic), you need to compile the Barefoot SDE with the kernel header and run Stratum directly on the OS

I've created a GitHub issue to support this request. And will make a PR to support this case.
https://github.com/stratum/stratum/issues/140

Yi


On Mon, Feb 24, 2020 at 3:25 PM Carmelo Cascone <carmelo at opennetworking.org<mailto:carmelo at opennetworking.org>> wrote:
Hi Deval,

I suggest you ask on the stratum-dev mailing list or Slack channel:
https://wiki.opennetworking.org/display/COM/Stratum

This mailing list is for discussions related to P4/P4Runtime support in ONOS.

Thanks
Carmelo

On Feb 24, 2020, at 6:53 AM, Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hi,

I am trying to find Stratum pre-built docker image for Linux 4.4.0-173-generic x86_64 , however couldn't find it. Can you please tell me whether Stratum is not supported on Generic and only runs on ONL version?

I tried stratumproject/stratum-bf:8.9.1-4.14.49-OpenNetworkLinux , but it failed with error:


cat: /etc/onl/platform: No such file or directory
Use default flag file
Cannot find /usr/local/share/stratum/.json

Maybe because the Linux doesn't support ONL? What may be the solution? Please let me know.


Thanks,
Deval

--
You received this message because you are subscribed to the Google Groups "P4 brigade" group.
To unsubscribe from this group and stop receiving emails from it, send an email to brigade-p4+unsubscribe at onosproject.org<mailto:brigade-p4+unsubscribe at onosproject.org>.
To view this discussion on the web visit https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/3219e60081e54a23950b45fb513ca36e%40kau.se<https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/3219e60081e54a23950b45fb513ca36e%40kau.se?utm_medium=email&utm_source=footer>.


--
You received this message because you are subscribed to the Google Groups "P4 brigade" group.
To unsubscribe from this group and stop receiving emails from it, send an email to brigade-p4+unsubscribe at onosproject.org<mailto:brigade-p4+unsubscribe at onosproject.org>.
To view this discussion on the web visit https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/C51D008B-728A-4591-8CA7-EFD77B8FBB2A%40opennetworking.org<https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/C51D008B-728A-4591-8CA7-EFD77B8FBB2A%40opennetworking.org?utm_medium=email&utm_source=footer>.


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200301/34defa05/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: stratum-dev-build-error.png
Type: image/png
Size: 697107 bytes
Desc: stratum-dev-build-error.png
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200301/34defa05/attachment-0001.png>

From Deval.Bhamare at kau.se  Tue Mar  3 14:42:04 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Tue, 3 Mar 2020 14:42:04 +0000
Subject: [stratum-dev] [brigade-p4] Stratum pre-built container
In-Reply-To: <CAOyFVR3EgOJZuxPxPUy2rh66SrMAq4b8_Hp0TXzGQpaBCtff_w@mail.gmail.com>
References: <3219e60081e54a23950b45fb513ca36e@kau.se>
 <C51D008B-728A-4591-8CA7-EFD77B8FBB2A@opennetworking.org>
 <CAOyFVR17KiGdfwZeD1ZyhJm1t5eh4Ar177gGA86HPSa_0TVRjA@mail.gmail.com>
 <b23068b17b02411bad50514261401a63@kau.se>
 <CAOyFVR1VeaA+dPWT6x=yjX-qpqYV-UMMOMSvLrMRdLWWVqZFYQ@mail.gmail.com>
 <77c56eb8472346538d55d222b6a39104@kau.se>
 <CAOyFVR2Zzcw=K0D9=cdyCq-dhAOcEObFDRmV4fXQ4hDf1T6iPg@mail.gmail.com>
 <6b0e9c8910b54dbb8adb21123e508d2a@kau.se>,
 <CAOyFVR3EgOJZuxPxPUy2rh66SrMAq4b8_Hp0TXzGQpaBCtff_w@mail.gmail.com>
Message-ID: <33f8d704001e4c54a01ac6c5d32277c8@kau.se>

Hi YI,


I tried it and the previous error is gone (manes @local_barefoot_bin is set now?). However I am now getting error (screenshot attached):


missing input file '@local_barefoot_bin//:barefoot-bin/lib/libbf_switchd_lib.so'



The code has been invoked from the file at:   stratum/hal/lib/barefoot/barefoot.bzl


The missing file is there in stratum/ container folder at: ./bf-sde-8.9.0/install/lib/libbf_switchd_lib.so


In the container (/stratum)   BF_SDE_INSTALL is set to:  bf-sde-8.9.0/install/



Please suggest.


Thanks,


Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Tuesday, March 3, 2020 12:13:36 AM
To: Deval Bhamare
Subject: Re: [brigade-p4] Stratum pre-built container

Hi Deval,

What I usually do for development is to mount the install directory(e.g. bf-sde-x.x.x/install) to the development environment container and set up the BF_SDE_INSTALL environment.
You can also create a tarball for that install dir and copy it to the container.

Another option is to create a container based on the build container<https://hub.docker.com/repository/docker/stratumproject/build> with SDE installed.

On Mon, Mar 2, 2020 at 12:54 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hi,


So I have BF SDE already installed. But as you have mentioned, the command should be executed in development environment for Stratum using setup_dev_env.sh, which eventually starts a docker container.


Does it mean I have to install BF SDE in the docker container again?


~DB

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Monday, March 2, 2020 9:43:29 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [brigade-p4] Stratum pre-built container

Hi Deval,

You need to set up BF_SDE_INSTALL environment variable before you build the Stratum
https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md#building-stratum-from-scratch

The switchd binary is provided by Barefoot, which supports P4Runtime and some private protocols.
The Stratum binary implements P4Runtime, gNMI, and gNOI protocols and use switch SDK to control the switch ASIC.
You can find the overview of Stratum architecture here:
https://github.com/stratum/stratum#component-overview

Yi

On Sun, Mar 1, 2020 at 6:21 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,



I tried stratum build in dev environment, however, now I am getting error like below (Complete screenshot attached).


ERROR: /stratum/stratum/hal/lib/barefoot/BUILD:124:1: no such target '@local_barefoot_bin//:bf_headers': target 'bf_headers' not declared in package '' defined by /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/local_barefoot_bin/BUILD and referenced by '//stratum/hal/lib/barefoot:bf_pal_wrapper'

ERROR: /stratum/stratum/hal/lib/barefoot/BUILD:124:1: no such target '@local_barefoot_bin//:bf_drivers': target 'bf_drivers' not declared in package '' defined by /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/local_barefoot_bin/BUILD and referenced by '//stratum/hal/lib/barefoot:bf_pal_wrapper'

...


Any suggestions?


Also, I wanted to ask, what is the exact difference between using stratum and communicating with tofino by enabling the grpc server (something like ./run_switchd.sh -c $SDE_INSTALL/share/p4/targets/tofino/skip_p4.conf --skip-p4 --p4rt-server 0.0.0.0:50051<http://0.0.0.0:50051>)? Can you please explain?


Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, February 27, 2020 8:57:41 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>; devalb at gmail.com<mailto:devalb at gmail.com>
Subject: Re: [brigade-p4] Stratum pre-built container

Hello, please see my reply inline

On Tue, Feb 25, 2020 at 1:21 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Dear Yi,


I appreciate your valuable input. I tried to build the  Stratum directly on the machine as well. It gave me an error. Details are below:


1. Build Stratum from scratch: I have BF SDE 8.9.0 and I execute the command (first I executed it without incompatible_bzl_disallow_load_after_statement=false and it asked me to include that option in command):


bazel build //stratum/hal/bin/barefoot:stratum_bf --define phal_with_onlp=false --define sde_ver=8.9.0 --incompatible_bzl_disallow_load_after_statement=false


Please use the stratum build development environment to build the Stratum. We only support Bazel 0.23.2 now. And will move to 2.0 in the future.
https://github.com/stratum/stratum#development-environment


It gave me the error:


ERROR: /home/tofino/.cache/bazel/_bazel_tofino/f6d313d4f595c91e594b2a1b1a2579ea/external/io_bazel_rules_python/python/pip.bzl:39:25: Traceback (most recent call last):
File "/home/tofino/.cache/bazel/_bazel_tofino/f6d313d4f595c91e594b2a1b1a2579ea/external/io_bazel_rules_python/python/pip.bzl", line 37
repository_rule(<2 more arguments>)
File "/home/tofino/.cache/bazel/_bazel_tofino/f6d313d4f595c91e594b2a1b1a2579ea/external/io_bazel_rules_python/python/pip.bzl", line 39, in repository_rule
attr.label(allow_files = True, <2 more arguments>)
'single_file' is no longer supported. use allow_single_file instead. You can use --incompatible_disable_deprecated_attr_params=false to temporarily disable this check.
ERROR: error loading package '': Extension file 'python/pip.bzl' has errors
ERROR: error loading package '': Extension file 'python/pip.bzl' has errors
INFO: Elapsed time: 0.101s
INFO: 0 processes.
FAILED: Build did NOT complete successfully (0 packages loaded)



I also tried to build the Docker Image manually.

3. Build the docker image manually: I tried to execute the command below, as per my kernel and SDE


./build-stratum-bf-container.sh bf-sde-8.9.0.tar linux-4.4.173.tar.gz


However, it failed with error below. Where can I find Linux ONL tar for my linux kernel?
Error:

You should be able to find it from /usr/src/linux-headers-[your linux kernel version].



make: Entering directory '/usr/src/kernel-headers'

  ERROR: Kernel configuration is invalid.
         include/generated/autoconf.h or include/config/auto.conf are missing.
         Run 'make oldconfig && make prepare' on kernel src to fix it.


  WARNING: Symbol version dump ./Module.symvers
           is missing; modules will have no dependencies and modversions.

  Building modules, stage 2.
scripts/Makefile.modpost:42: include/config/auto.conf: No such file or directory
make[1]: *** No rule to make target 'include/config/auto.conf'.  Stop.
Makefile:1439: recipe for target 'modules' failed
make: Leaving directory '/usr/src/kernel-headers'
make: *** [modules] Error 2
The command '/bin/sh -c make -C /usr/src/kernel-headers M=$KDRV_DIR src=$KDRV_DIR modules &&     mv $KDRV_DIR/bf_kdrv.ko $SDE_INSTALL/lib/modules/bf_kdrv.ko' returned a non-zero code: 2

Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Tuesday, February 25, 2020 2:07:35 AM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [brigade-p4] Stratum pre-built container

[+stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>, remove p4-brigade list]

Hi Deval,

The public container images include a specific Barefoot Linux kernel module.

Now we only compile the module for kernels from OpenNetworkLiunx (3.16, 4.9, and 4.14)

If you want to run Stratum on different kernel (4.4.0-173-generic), you need to compile the Barefoot SDE with the kernel header and run Stratum directly on the OS

I've created a GitHub issue to support this request. And will make a PR to support this case.
https://github.com/stratum/stratum/issues/140

Yi


On Mon, Feb 24, 2020 at 3:25 PM Carmelo Cascone <carmelo at opennetworking.org<mailto:carmelo at opennetworking.org>> wrote:
Hi Deval,

I suggest you ask on the stratum-dev mailing list or Slack channel:
https://wiki.opennetworking.org/display/COM/Stratum

This mailing list is for discussions related to P4/P4Runtime support in ONOS.

Thanks
Carmelo

On Feb 24, 2020, at 6:53 AM, Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hi,

I am trying to find Stratum pre-built docker image for Linux 4.4.0-173-generic x86_64 , however couldn't find it. Can you please tell me whether Stratum is not supported on Generic and only runs on ONL version?

I tried stratumproject/stratum-bf:8.9.1-4.14.49-OpenNetworkLinux , but it failed with error:


cat: /etc/onl/platform: No such file or directory
Use default flag file
Cannot find /usr/local/share/stratum/.json

Maybe because the Linux doesn't support ONL? What may be the solution? Please let me know.


Thanks,
Deval

--
You received this message because you are subscribed to the Google Groups "P4 brigade" group.
To unsubscribe from this group and stop receiving emails from it, send an email to brigade-p4+unsubscribe at onosproject.org<mailto:brigade-p4+unsubscribe at onosproject.org>.
To view this discussion on the web visit https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/3219e60081e54a23950b45fb513ca36e%40kau.se<https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/3219e60081e54a23950b45fb513ca36e%40kau.se?utm_medium=email&utm_source=footer>.


--
You received this message because you are subscribed to the Google Groups "P4 brigade" group.
To unsubscribe from this group and stop receiving emails from it, send an email to brigade-p4+unsubscribe at onosproject.org<mailto:brigade-p4+unsubscribe at onosproject.org>.
To view this discussion on the web visit https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/C51D008B-728A-4591-8CA7-EFD77B8FBB2A%40opennetworking.org<https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/C51D008B-728A-4591-8CA7-EFD77B8FBB2A%40opennetworking.org?utm_medium=email&utm_source=footer>.


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200303/de8997e4/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Screen Shot 2020-03-03 at 15.36.25.png
Type: image/png
Size: 171252 bytes
Desc: Screen Shot 2020-03-03 at 15.36.25.png
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200303/de8997e4/attachment-0001.png>

From yi at opennetworking.org  Thu Mar  5 00:09:55 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Wed, 4 Mar 2020 16:09:55 -0800
Subject: [stratum-dev] Update Bazel version to 2.2.0
Message-ID: <CAOyFVR2yae8h6hBsyfS2s_T=fQ_Thy8QeyJuh4-_vdTviS=kNg@mail.gmail.com>

Hello Stratum developers:

Today we updated the Bazel version to 2.2.0 (see #84
<https://github.com/stratum/stratum/pull/84>)

Please run *./setup_dev_env.sh --pull* to get new Stratum development
container image.

Feel free to let us know if you have any questions or issues with new Bazel

Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200304/79b6b643/attachment.html>

From Deval.Bhamare at kau.se  Thu Mar  5 13:04:13 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Thu, 5 Mar 2020 13:04:13 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
Message-ID: <62eb173564ba43b8ba5497605c0d4cf9@kau.se>

Hello Yi,


Thanks for the updates. I had reported this earlier as well, but with the Bazel version to 2.2.0 , I get following error:



I also had reported the error I get with previous container image (older Bazel version).


Please suggest. Thank you.

________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on behalf of Yi Tseng via stratum-dev <stratum-dev at lists.stratumproject.org>
Sent: Thursday, March 5, 2020 2:10:35 AM
To: stratum-dev at lists.stratumproject.org
Subject: [stratum-dev] Update Bazel version to 2.2.0

Hello Stratum developers:

Today we updated the Bazel version to 2.2.0 (see #84<https://github.com/stratum/stratum/pull/84>)

Please run ./setup_dev_env.sh --pull to get new Stratum development container image.

Feel free to let us know if you have any questions or issues with new Bazel

Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200305/da3bb86a/attachment.html>

From Deval.Bhamare at kau.se  Thu Mar  5 13:04:46 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Thu, 5 Mar 2020 13:04:46 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>,
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
Message-ID: <32bafe8dde884fccbd43729b6a00d918@kau.se>

Forgot to paste the error message:


ERROR: /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/io_bazel_rules_python/python/pip.bzl:39:25: Traceback (most recent call last):

File "/home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/io_bazel_rules_python/python/pip.bzl", line 37

repository_rule(<2 more arguments>)

File "/home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/io_bazel_rules_python/python/pip.bzl", line 39, in repository_rule

attr.label(allow_files = True, <2 more arguments>)

'single_file' is no longer supported. use allow_single_file instead. You can use --incompatible_disable_deprecated_attr_params=false to temporarily disable this check.

ERROR: error loading package '': Extension file 'python/pip.bzl' has errors

ERROR: error loading package '': Extension file 'python/pip.bzl' has errors

INFO: Elapsed time: 9.195s

INFO: 0 processes.

FAILED: Build did NOT complete successfully (0 packages loaded)



Thanks,


Deval.

________________________________
From: Deval Bhamare
Sent: Thursday, March 5, 2020 3:04:13 PM
To: Yi Tseng; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Yi,


Thanks for the updates. I had reported this earlier as well, but with the Bazel version to 2.2.0 , I get following error:



I also had reported the error I get with previous container image (older Bazel version).


Please suggest. Thank you.

________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on behalf of Yi Tseng via stratum-dev <stratum-dev at lists.stratumproject.org>
Sent: Thursday, March 5, 2020 2:10:35 AM
To: stratum-dev at lists.stratumproject.org
Subject: [stratum-dev] Update Bazel version to 2.2.0

Hello Stratum developers:

Today we updated the Bazel version to 2.2.0 (see #84<https://github.com/stratum/stratum/pull/84>)

Please run ./setup_dev_env.sh --pull to get new Stratum development container image.

Feel free to let us know if you have any questions or issues with new Bazel

Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200305/a9f90169/attachment.html>

From Deval.Bhamare at kau.se  Thu Mar  5 15:10:44 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Thu, 5 Mar 2020 15:10:44 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>,
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>,
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
Message-ID: <ca635b6054e74331b75c3ac20af06ff3@kau.se>

Hi,


So as per the suggestions in the errors, and further suggestions, I commented out the single_file attribute in the repository rule in pip.bzl.


So the build went ahead and now I am getting error:


DEBUG: Call stack for the definition of repository 'build_stack_rules_proto' which is a http_archive (rule definition at /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/bazel_tools/tools/build_defs/repo/http.bzl:296:16):

 - <builtin>

 - /stratum/bazel/workspace_rule.bzl:62:5

 - /stratum/bazel/workspace_rule.bzl:144:22

 - /stratum/bazel/deps.bzl:87:9

 - /stratum/WORKSPACE:55:1

ERROR: /stratum/stratum/hal/bin/barefoot/BUILD:24:1: file '//bazel:rules.bzl' does not contain symbol 'stratum_cc_binary'

ERROR: Skipping '//stratum/hal/bin/barefoot:stratum_bf': no such target '//stratum/hal/bin/barefoot:stratum_bf': target 'stratum_bf' not declared in package 'stratum/hal/bin/barefoot' defined by /stratum/stratum/hal/bin/barefoot/BUILD

WARNING: Target pattern parsing failed.

ERROR: no such target '//stratum/hal/bin/barefoot:stratum_bf': target 'stratum_bf' not declared in package 'stratum/hal/bin/barefoot' defined by /stratum/stratum/hal/bin/barefoot/BUILD

INFO: Elapsed time: 29.345s

INFO: 0 processes.

FAILED: Build did NOT complete successfully (1 packages loaded)



No idea how to deal with it. Please suggest.


Thanks,

Deval.



________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org>
Sent: Thursday, March 5, 2020 3:04:49 PM
To: Yi Tseng; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Forgot to paste the error message:


ERROR: /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/io_bazel_rules_python/python/pip.bzl:39:25: Traceback (most recent call last):

File "/home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/io_bazel_rules_python/python/pip.bzl", line 37

repository_rule(<2 more arguments>)

File "/home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/io_bazel_rules_python/python/pip.bzl", line 39, in repository_rule

attr.label(allow_files = True, <2 more arguments>)

'single_file' is no longer supported. use allow_single_file instead. You can use --incompatible_disable_deprecated_attr_params=false to temporarily disable this check.

ERROR: error loading package '': Extension file 'python/pip.bzl' has errors

ERROR: error loading package '': Extension file 'python/pip.bzl' has errors

INFO: Elapsed time: 9.195s

INFO: 0 processes.

FAILED: Build did NOT complete successfully (0 packages loaded)



Thanks,


Deval.

________________________________
From: Deval Bhamare
Sent: Thursday, March 5, 2020 3:04:13 PM
To: Yi Tseng; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Yi,


Thanks for the updates. I had reported this earlier as well, but with the Bazel version to 2.2.0 , I get following error:



I also had reported the error I get with previous container image (older Bazel version).


Please suggest. Thank you.

________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on behalf of Yi Tseng via stratum-dev <stratum-dev at lists.stratumproject.org>
Sent: Thursday, March 5, 2020 2:10:35 AM
To: stratum-dev at lists.stratumproject.org
Subject: [stratum-dev] Update Bazel version to 2.2.0

Hello Stratum developers:

Today we updated the Bazel version to 2.2.0 (see #84<https://github.com/stratum/stratum/pull/84>)

Please run ./setup_dev_env.sh --pull to get new Stratum development container image.

Feel free to let us know if you have any questions or issues with new Bazel

Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200305/b2109dc2/attachment-0001.html>

From Deval.Bhamare at kau.se  Thu Mar  5 19:46:33 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Thu, 5 Mar 2020 19:46:33 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>,
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>,
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>,
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
Message-ID: <ec543d4d92fb4206b830a19262960255@kau.se>

Also, as per your suggestion here: https://github.com/stratum/stratum/issues/17


I downloaded the repo (from here https://github.com/stratum/stratum#development-environment ) and I am getting error (bunch of them) as follows:

My Bazel is 2.2.0

I did setup the dev environment with:

./setup_dev_env.sh --pull



ERROR: /stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error executing command /usr/bin/gcc @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params


Use --sandbox_debug to see verbose messages from the sandbox

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_assign_device: error: undefined reference to '_pi_assign_device'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_update_device_start: error: undefined reference to '_pi_update_device_start'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_update_device_end: error: undefined reference to '_pi_update_device_end'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_remove_device: error: undefined reference to '_pi_remove_device'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_session_init: error: undefined reference to '_pi_session_init'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_session_cleanup: error: undefined reference to '_pi_session_cleanup'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_batch_begin: error: undefined reference to '_pi_batch_begin'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_batch_end: error: undefined reference to '_pi_batch_end'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_destroy: error: undefined reference to '_pi_destroy'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_packetout_send: error: undefined reference to '_pi_packetout_send'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_port_status_get: error: undefined reference to '_pi_port_status_get'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_create: error: undefined reference to '_pi_act_prof_mbr_create'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_delete: error: undefined reference to '_pi_act_prof_mbr_delete'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_modify: error: undefined reference to '_pi_act_prof_mbr_modify'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_create: error: undefined reference to '_pi_act_prof_grp_create'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_delete: error: undefined reference to '_pi_act_prof_grp_delete'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_add_mbr: error: undefined reference to '_pi_act_prof_grp_add_mbr'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_remove_mbr: error: undefined reference to '_pi_act_prof_grp_remove_mbr'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_set_mbrs: error: undefined reference to '_pi_act_prof_grp_set_mbrs'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_activate_mbr: error: undefined reference to '_pi_act_prof_grp_activate_mbr'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_deactivate_mbr: error: undefined reference to '_pi_act_prof_grp_deactivate_mbr'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_entries_fetch: error: undefined reference to '_pi_act_prof_entries_fetch'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_fetch: error: undefined reference to '_pi_act_prof_mbr_fetch'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_fetch: error: undefined reference to '_pi_act_prof_grp_fetch'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_entries_fetch_done: error: undefined reference to '_pi_act_prof_entries_fetch_done'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_api_support: error: undefined reference to '_pi_act_prof_api_support'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_add: error: undefined reference to '_pi_table_entry_add'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_set: error: undefined reference to '_pi_table_default_action_set'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_reset: error: undefined reference to '_pi_table_default_action_reset'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_get: error: undefined reference to '_pi_table_default_action_get'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_done: error: undefined reference to '_pi_table_default_action_done'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_get_handle: error: undefined reference to '_pi_table_default_action_get_handle'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_delete: error: undefined reference to '_pi_table_entry_delete'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_delete_wkey: error: undefined reference to '_pi_table_entry_delete_wkey'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_modify: error: undefined reference to '_pi_table_entry_modify'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_modify_wkey: error: undefined reference to '_pi_table_entry_modify_wkey'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch: error: undefined reference to '_pi_table_entries_fetch'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_one: error: undefined reference to '_pi_table_entries_fetch_one'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_wkey: error: undefined reference to '_pi_table_entries_fetch_wkey'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_done: error: undefined reference to '_pi_table_entries_fetch_done'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_idle_timeout_config_set: error: undefined reference to '_pi_table_idle_timeout_config_set'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_get_remaining_ttl: error: undefined reference to '_pi_table_entry_get_remaining_ttl'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_read: error: undefined reference to '_pi_meter_read'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_set: error: undefined reference to '_pi_meter_set'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_read_direct: error: undefined reference to '_pi_meter_read_direct'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_set_direct: error: undefined reference to '_pi_meter_set_direct'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_session_init: error: undefined reference to '_pi_mc_session_init'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_session_cleanup: error: undefined reference to '_pi_mc_session_cleanup'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_create: error: undefined reference to '_pi_mc_grp_create'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_delete: error: undefined reference to '_pi_mc_grp_delete'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_create: error: undefined reference to '_pi_mc_node_create'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_modify: error: undefined reference to '_pi_mc_node_modify'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_delete: error: undefined reference to '_pi_mc_node_delete'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_attach_node: error: undefined reference to '_pi_mc_grp_attach_node'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_detach_node: error: undefined reference to '_pi_mc_grp_detach_node'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_config_set: error: undefined reference to '_pi_learn_config_set'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_msg_ack: error: undefined reference to '_pi_learn_msg_ack'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_msg_done: error: undefined reference to '_pi_learn_msg_done'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_read: error: undefined reference to '_pi_counter_read'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_write: error: undefined reference to '_pi_counter_write'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_read_direct: error: undefined reference to '_pi_counter_read_direct'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_write_direct: error: undefined reference to '_pi_counter_write_direct'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_hw_sync: error: undefined reference to '_pi_counter_hw_sync'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function pi_clone_session_set: error: undefined reference to '_pi_clone_session_set'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function pi_clone_session_reset: error: undefined reference to '_pi_clone_session_reset'

collect2: error: ld returned 1 exit status

Target //stratum/hal/bin/barefoot:stratum_bf failed to build

Use --verbose_failures to see the command lines of failed build steps.

INFO: Elapsed time: 95.850s, Critical Path: 56.95s

INFO: 1141 processes: 1141 processwrapper-sandbox.

FAILED: Build did NOT complete successfully



So how should I proceed now. Please suggest.


Thanks,


Deval.


________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org>
Sent: Thursday, March 5, 2020 5:10:49 PM
To: Yi Tseng; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hi,


So as per the suggestions in the errors, and further suggestions, I commented out the single_file attribute in the repository rule in pip.bzl.


So the build went ahead and now I am getting error:


DEBUG: Call stack for the definition of repository 'build_stack_rules_proto' which is a http_archive (rule definition at /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/bazel_tools/tools/build_defs/repo/http.bzl:296:16):

 - <builtin>

 - /stratum/bazel/workspace_rule.bzl:62:5

 - /stratum/bazel/workspace_rule.bzl:144:22

 - /stratum/bazel/deps.bzl:87:9

 - /stratum/WORKSPACE:55:1

ERROR: /stratum/stratum/hal/bin/barefoot/BUILD:24:1: file '//bazel:rules.bzl' does not contain symbol 'stratum_cc_binary'

ERROR: Skipping '//stratum/hal/bin/barefoot:stratum_bf': no such target '//stratum/hal/bin/barefoot:stratum_bf': target 'stratum_bf' not declared in package 'stratum/hal/bin/barefoot' defined by /stratum/stratum/hal/bin/barefoot/BUILD

WARNING: Target pattern parsing failed.

ERROR: no such target '//stratum/hal/bin/barefoot:stratum_bf': target 'stratum_bf' not declared in package 'stratum/hal/bin/barefoot' defined by /stratum/stratum/hal/bin/barefoot/BUILD

INFO: Elapsed time: 29.345s

INFO: 0 processes.

FAILED: Build did NOT complete successfully (1 packages loaded)



No idea how to deal with it. Please suggest.


Thanks,

Deval.



________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org>
Sent: Thursday, March 5, 2020 3:04:49 PM
To: Yi Tseng; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Forgot to paste the error message:


ERROR: /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/io_bazel_rules_python/python/pip.bzl:39:25: Traceback (most recent call last):

File "/home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/io_bazel_rules_python/python/pip.bzl", line 37

repository_rule(<2 more arguments>)

File "/home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/io_bazel_rules_python/python/pip.bzl", line 39, in repository_rule

attr.label(allow_files = True, <2 more arguments>)

'single_file' is no longer supported. use allow_single_file instead. You can use --incompatible_disable_deprecated_attr_params=false to temporarily disable this check.

ERROR: error loading package '': Extension file 'python/pip.bzl' has errors

ERROR: error loading package '': Extension file 'python/pip.bzl' has errors

INFO: Elapsed time: 9.195s

INFO: 0 processes.

FAILED: Build did NOT complete successfully (0 packages loaded)



Thanks,


Deval.

________________________________
From: Deval Bhamare
Sent: Thursday, March 5, 2020 3:04:13 PM
To: Yi Tseng; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Yi,


Thanks for the updates. I had reported this earlier as well, but with the Bazel version to 2.2.0 , I get following error:



I also had reported the error I get with previous container image (older Bazel version).


Please suggest. Thank you.

________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on behalf of Yi Tseng via stratum-dev <stratum-dev at lists.stratumproject.org>
Sent: Thursday, March 5, 2020 2:10:35 AM
To: stratum-dev at lists.stratumproject.org
Subject: [stratum-dev] Update Bazel version to 2.2.0

Hello Stratum developers:

Today we updated the Bazel version to 2.2.0 (see #84<https://github.com/stratum/stratum/pull/84>)

Please run ./setup_dev_env.sh --pull to get new Stratum development container image.

Feel free to let us know if you have any questions or issues with new Bazel

Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200305/d78c2eed/attachment-0001.html>

From carmelo at opennetworking.org  Thu Mar  5 19:54:32 2020
From: carmelo at opennetworking.org (Carmelo Cascone)
Date: Thu, 5 Mar 2020 11:54:32 -0800
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <01010170ac3c5149-cee8e2a8-e734-4a24-b4e9-6526a43440f9-000000@us-west-2.amazonses.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <01010170ac3c5149-cee8e2a8-e734-4a24-b4e9-6526a43440f9-000000@us-west-2.amazonses.com>
Message-ID: <CAOzAiu+1mppZ0vJXwOtYFGZdPg057vtyauCBf33mrfsURT_SqQ@mail.gmail.com>

Hi Deval,

While the Stratum experts figure out why you are seeing this issue (nightly
builds seems to work well in our CI system), I want to make sure you really
need to build stratum_bf from scratch.

Are you looking to make changes to Stratum or simply using it? If you don't
need to make changes, then I would suggest downloading one of the pre-built
Docker images as explained here:
https://github.com/opennetworkinglab/stratum/tree/master/stratum/hal/bin/barefoot/docker

Hope it helps
Carmelo

On Thu, Mar 5, 2020 at 11:46 AM Deval Bhamare via stratum-dev <
stratum-dev at lists.stratumproject.org> wrote:

> Also, as per your suggestion here:
> https://github.com/stratum/stratum/issues/17
>
>
> I downloaded the repo (from here
> https://github.com/stratum/stratum#development-environment ) and I am
> getting error (bunch of them) as follows:
>
>
> My Bazel is 2.2.0
>
> I did setup the dev environment with:
>
> ./setup_dev_env.sh --pull
>
>
>
> *ERROR: */stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule
> '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error
> executing command /usr/bin/gcc
> @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params
>
>
> Use --sandbox_debug to see verbose messages from the sandbox
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_init: error: undefined reference to '_pi_init'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_assign_device: error: undefined reference to '_pi_assign_device'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_update_device_start: error: undefined reference to
> '_pi_update_device_start'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_update_device_end: error: undefined reference to '_pi_update_device_end'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_remove_device: error: undefined reference to '_pi_remove_device'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_session_init: error: undefined reference to '_pi_session_init'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_session_cleanup: error: undefined reference to '_pi_session_cleanup'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_batch_begin: error: undefined reference to '_pi_batch_begin'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_batch_end: error: undefined reference to '_pi_batch_end'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_destroy: error: undefined reference to '_pi_destroy'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_packetout_send: error: undefined reference to '_pi_packetout_send'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_port_status_get: error: undefined reference to '_pi_port_status_get'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_mbr_create: error: undefined reference to
> '_pi_act_prof_mbr_create'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_mbr_delete: error: undefined reference to
> '_pi_act_prof_mbr_delete'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_mbr_modify: error: undefined reference to
> '_pi_act_prof_mbr_modify'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_create: error: undefined reference to
> '_pi_act_prof_grp_create'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_delete: error: undefined reference to
> '_pi_act_prof_grp_delete'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_add_mbr: error: undefined reference to
> '_pi_act_prof_grp_add_mbr'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_remove_mbr: error: undefined reference to
> '_pi_act_prof_grp_remove_mbr'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_set_mbrs: error: undefined reference to
> '_pi_act_prof_grp_set_mbrs'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_activate_mbr: error: undefined reference to
> '_pi_act_prof_grp_activate_mbr'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_deactivate_mbr: error: undefined reference to
> '_pi_act_prof_grp_deactivate_mbr'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_entries_fetch: error: undefined reference to
> '_pi_act_prof_entries_fetch'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_mbr_fetch: error: undefined reference to
> '_pi_act_prof_mbr_fetch'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_fetch: error: undefined reference to
> '_pi_act_prof_grp_fetch'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_entries_fetch_done: error: undefined reference to
> '_pi_act_prof_entries_fetch_done'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_api_support: error: undefined reference to
> '_pi_act_prof_api_support'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entry_add: error: undefined reference to '_pi_table_entry_add'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_default_action_set: error: undefined reference to
> '_pi_table_default_action_set'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_default_action_reset: error: undefined reference to
> '_pi_table_default_action_reset'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_default_action_get: error: undefined reference to
> '_pi_table_default_action_get'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_default_action_done: error: undefined reference to
> '_pi_table_default_action_done'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_default_action_get_handle: error: undefined reference to
> '_pi_table_default_action_get_handle'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entry_delete: error: undefined reference to
> '_pi_table_entry_delete'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entry_delete_wkey: error: undefined reference to
> '_pi_table_entry_delete_wkey'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entry_modify: error: undefined reference to
> '_pi_table_entry_modify'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entry_modify_wkey: error: undefined reference to
> '_pi_table_entry_modify_wkey'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entries_fetch: error: undefined reference to
> '_pi_table_entries_fetch'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entries_fetch_one: error: undefined reference to
> '_pi_table_entries_fetch_one'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entries_fetch_wkey: error: undefined reference to
> '_pi_table_entries_fetch_wkey'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entries_fetch_done: error: undefined reference to
> '_pi_table_entries_fetch_done'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_idle_timeout_config_set: error: undefined reference to
> '_pi_table_idle_timeout_config_set'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entry_get_remaining_ttl: error: undefined reference to
> '_pi_table_entry_get_remaining_ttl'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
> pi_meter_read: error: undefined reference to '_pi_meter_read'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
> pi_meter_set: error: undefined reference to '_pi_meter_set'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
> pi_meter_read_direct: error: undefined reference to '_pi_meter_read_direct'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
> pi_meter_set_direct: error: undefined reference to '_pi_meter_set_direct'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_session_init: error: undefined reference to '_pi_mc_session_init'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_session_cleanup: error: undefined reference to
> '_pi_mc_session_cleanup'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_grp_create: error: undefined reference to '_pi_mc_grp_create'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_grp_delete: error: undefined reference to '_pi_mc_grp_delete'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_node_create: error: undefined reference to '_pi_mc_node_create'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_node_modify: error: undefined reference to '_pi_mc_node_modify'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_node_delete: error: undefined reference to '_pi_mc_node_delete'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_grp_attach_node: error: undefined reference to
> '_pi_mc_grp_attach_node'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_grp_detach_node: error: undefined reference to
> '_pi_mc_grp_detach_node'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function
> pi_learn_config_set: error: undefined reference to '_pi_learn_config_set'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function
> pi_learn_msg_ack: error: undefined reference to '_pi_learn_msg_ack'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function
> pi_learn_msg_done: error: undefined reference to '_pi_learn_msg_done'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
> pi_counter_read: error: undefined reference to '_pi_counter_read'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
> pi_counter_write: error: undefined reference to '_pi_counter_write'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
> pi_counter_read_direct: error: undefined reference to
> '_pi_counter_read_direct'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
> pi_counter_write_direct: error: undefined reference to
> '_pi_counter_write_direct'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
> pi_counter_hw_sync: error: undefined reference to '_pi_counter_hw_sync'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function
> pi_clone_session_set: error: undefined reference to '_pi_clone_session_set'
>
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function
> pi_clone_session_reset: error: undefined reference to
> '_pi_clone_session_reset'
>
> collect2: error: ld returned 1 exit status
>
> Target //stratum/hal/bin/barefoot:stratum_bf failed to build
>
> Use --verbose_failures to see the command lines of failed build steps.
>
> INFO: Elapsed time: 95.850s, Critical Path: 56.95s
>
> INFO: 1141 processes: 1141 processwrapper-sandbox.
>
> *FAILED:* Build did NOT complete successfully
>
>
> So how should I proceed now. Please suggest.
>
>
> Thanks,
>
>
> Deval.
>
>
> ------------------------------
> *From:* stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on
> behalf of Deval Bhamare via stratum-dev <
> stratum-dev at lists.stratumproject.org>
> *Sent:* Thursday, March 5, 2020 5:10:49 PM
> *To:* Yi Tseng; stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
>
> Hi,
>
>
> So as per the suggestions in the errors, and further suggestions, I
> commented out the single_file attribute in the repository rule in pip.bzl.
>
>
> So the build went ahead and now I am getting error:
>
>
> DEBUG: Call stack for the definition of repository
> 'build_stack_rules_proto' which is a http_archive (rule definition at
> /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/bazel_tools/tools/build_defs/repo/http.bzl:296:16):
>
>  - <builtin>
>
>  - /stratum/bazel/workspace_rule.bzl:62:5
>
>  - /stratum/bazel/workspace_rule.bzl:144:22
>
>  - /stratum/bazel/deps.bzl:87:9
>
>  - /stratum/WORKSPACE:55:1
>
> *ERROR: */stratum/stratum/hal/bin/barefoot/BUILD:24:1: file
> '//bazel:rules.bzl' does not contain symbol 'stratum_cc_binary'
>
> *ERROR: *Skipping '//stratum/hal/bin/barefoot:stratum_bf': no such target
> '//stratum/hal/bin/barefoot:stratum_bf': target 'stratum_bf' not declared
> in package 'stratum/hal/bin/barefoot' defined by
> /stratum/stratum/hal/bin/barefoot/BUILD
>
> WARNING: Target pattern parsing failed.
>
> *ERROR: *no such target '//stratum/hal/bin/barefoot:stratum_bf': target
> 'stratum_bf' not declared in package 'stratum/hal/bin/barefoot' defined by
> /stratum/stratum/hal/bin/barefoot/BUILD
>
> INFO: Elapsed time: 29.345s
>
> INFO: 0 processes.
>
> *FAILED:* Build did NOT complete successfully (1 packages loaded)
>
>
> No idea how to deal with it. Please suggest.
>
>
> Thanks,
>
> Deval.
>
>
> ------------------------------
> *From:* stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on
> behalf of Deval Bhamare via stratum-dev <
> stratum-dev at lists.stratumproject.org>
> *Sent:* Thursday, March 5, 2020 3:04:49 PM
> *To:* Yi Tseng; stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
>
> Forgot to paste the error message:
>
>
> *ERROR: */home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/io_bazel_rules_python/python/pip.bzl:39:25:
> Traceback (most recent call last):
>
> File
> "/home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/io_bazel_rules_python/python/pip.bzl",
> line 37
>
> repository_rule(<2 more arguments>)
>
> File
> "/home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/io_bazel_rules_python/python/pip.bzl",
> line 39, in repository_rule
>
> attr.label(allow_files = True, <2 more arguments>)
>
> 'single_file' is no longer supported. use allow_single_file instead. You
> can use --incompatible_disable_deprecated_attr_params=false to temporarily
> disable this check.
>
> *ERROR: *error loading package '': Extension file 'python/pip.bzl' has
> errors
>
> *ERROR: *error loading package '': Extension file 'python/pip.bzl' has
> errors
>
> INFO: Elapsed time: 9.195s
>
> INFO: 0 processes.
>
> *FAILED:* Build did NOT complete successfully (0 packages loaded)
>
>
> Thanks,
>
>
> Deval.
> ------------------------------
> *From:* Deval Bhamare
> *Sent:* Thursday, March 5, 2020 3:04:13 PM
> *To:* Yi Tseng; stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
>
> Hello Yi,
>
>
> Thanks for the updates. I had reported this earlier as well, but with the Bazel
> version to 2.2.0 , I get following error:
>
>
>
> I also had reported the error I get with previous container image (older
> Bazel version).
>
>
> Please suggest. Thank you.
> ------------------------------
> *From:* stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on
> behalf of Yi Tseng via stratum-dev <stratum-dev at lists.stratumproject.org>
> *Sent:* Thursday, March 5, 2020 2:10:35 AM
> *To:* stratum-dev at lists.stratumproject.org
> *Subject:* [stratum-dev] Update Bazel version to 2.2.0
>
> Hello Stratum developers:
>
> Today we updated the Bazel version to 2.2.0 (see #84
> <https://github.com/stratum/stratum/pull/84>)
>
> Please run *./setup_dev_env.sh --pull* to get new Stratum development
> container image.
>
> Feel free to let us know if you have any questions or issues with new Bazel
>
> Yi Tseng
> Member of Technical Staff
> Open Networking Foundation
> https://www.opennetworking.org/
> _______________________________________________
> stratum-dev mailing list
> stratum-dev at lists.stratumproject.org
> https://lists.stratumproject.org/listinfo/stratum-dev
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200305/6a310a66/attachment-0001.html>

From Deval.Bhamare at kau.se  Thu Mar  5 19:58:52 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Thu, 5 Mar 2020 19:58:52 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOzAiu+1mppZ0vJXwOtYFGZdPg057vtyauCBf33mrfsURT_SqQ@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <01010170ac3c5149-cee8e2a8-e734-4a24-b4e9-6526a43440f9-000000@us-west-2.amazonses.com>,
 <CAOzAiu+1mppZ0vJXwOtYFGZdPg057vtyauCBf33mrfsURT_SqQ@mail.gmail.com>
Message-ID: <40bdc55540b94798943fba43a9703039@kau.se>

Dear Carmelo,
First of all, the link below is not working.

Also,
As per the reply from Yi on 25th Feb,


"The public container images include a specific Barefoot Linux kernel module.

Now we only compile the module for kernels from OpenNetworkLiunx (3.16, 4.9, and 4.14)".


My Linux kernel is: 4.4.0-173-generic



And hence I am using the containerised dev environment as mentioned here: https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md

But I am getting errors as I have mentioned in my earlier thread.

Thanks,
Deval.


________________________________
From: Carmelo Cascone <carmelo at opennetworking.org>
Sent: Thursday, March 5, 2020 9:54:32 PM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

While the Stratum experts figure out why you are seeing this issue (nightly builds seems to work well in our CI system), I want to make sure you really need to build stratum_bf from scratch.

Are you looking to make changes to Stratum or simply using it? If you don't need to make changes, then I would suggest downloading one of the pre-built Docker images as explained here:
https://github.com/opennetworkinglab/stratum/tree/master/stratum/hal/bin/barefoot/docker

Hope it helps
Carmelo

On Thu, Mar 5, 2020 at 11:46 AM Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:

Also, as per your suggestion here: https://github.com/stratum/stratum/issues/17


I downloaded the repo (from here https://github.com/stratum/stratum#development-environment ) and I am getting error (bunch of them) as follows:

My Bazel is 2.2.0

I did setup the dev environment with:

./setup_dev_env.sh --pull



ERROR: /stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error executing command /usr/bin/gcc @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params


Use --sandbox_debug to see verbose messages from the sandbox

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_assign_device: error: undefined reference to '_pi_assign_device'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_update_device_start: error: undefined reference to '_pi_update_device_start'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_update_device_end: error: undefined reference to '_pi_update_device_end'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_remove_device: error: undefined reference to '_pi_remove_device'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_session_init: error: undefined reference to '_pi_session_init'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_session_cleanup: error: undefined reference to '_pi_session_cleanup'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_batch_begin: error: undefined reference to '_pi_batch_begin'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_batch_end: error: undefined reference to '_pi_batch_end'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_destroy: error: undefined reference to '_pi_destroy'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_packetout_send: error: undefined reference to '_pi_packetout_send'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_port_status_get: error: undefined reference to '_pi_port_status_get'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_create: error: undefined reference to '_pi_act_prof_mbr_create'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_delete: error: undefined reference to '_pi_act_prof_mbr_delete'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_modify: error: undefined reference to '_pi_act_prof_mbr_modify'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_create: error: undefined reference to '_pi_act_prof_grp_create'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_delete: error: undefined reference to '_pi_act_prof_grp_delete'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_add_mbr: error: undefined reference to '_pi_act_prof_grp_add_mbr'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_remove_mbr: error: undefined reference to '_pi_act_prof_grp_remove_mbr'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_set_mbrs: error: undefined reference to '_pi_act_prof_grp_set_mbrs'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_activate_mbr: error: undefined reference to '_pi_act_prof_grp_activate_mbr'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_deactivate_mbr: error: undefined reference to '_pi_act_prof_grp_deactivate_mbr'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_entries_fetch: error: undefined reference to '_pi_act_prof_entries_fetch'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_fetch: error: undefined reference to '_pi_act_prof_mbr_fetch'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_fetch: error: undefined reference to '_pi_act_prof_grp_fetch'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_entries_fetch_done: error: undefined reference to '_pi_act_prof_entries_fetch_done'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_api_support: error: undefined reference to '_pi_act_prof_api_support'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_add: error: undefined reference to '_pi_table_entry_add'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_set: error: undefined reference to '_pi_table_default_action_set'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_reset: error: undefined reference to '_pi_table_default_action_reset'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_get: error: undefined reference to '_pi_table_default_action_get'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_done: error: undefined reference to '_pi_table_default_action_done'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_get_handle: error: undefined reference to '_pi_table_default_action_get_handle'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_delete: error: undefined reference to '_pi_table_entry_delete'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_delete_wkey: error: undefined reference to '_pi_table_entry_delete_wkey'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_modify: error: undefined reference to '_pi_table_entry_modify'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_modify_wkey: error: undefined reference to '_pi_table_entry_modify_wkey'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch: error: undefined reference to '_pi_table_entries_fetch'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_one: error: undefined reference to '_pi_table_entries_fetch_one'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_wkey: error: undefined reference to '_pi_table_entries_fetch_wkey'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_done: error: undefined reference to '_pi_table_entries_fetch_done'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_idle_timeout_config_set: error: undefined reference to '_pi_table_idle_timeout_config_set'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_get_remaining_ttl: error: undefined reference to '_pi_table_entry_get_remaining_ttl'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_read: error: undefined reference to '_pi_meter_read'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_set: error: undefined reference to '_pi_meter_set'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_read_direct: error: undefined reference to '_pi_meter_read_direct'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_set_direct: error: undefined reference to '_pi_meter_set_direct'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_session_init: error: undefined reference to '_pi_mc_session_init'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_session_cleanup: error: undefined reference to '_pi_mc_session_cleanup'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_create: error: undefined reference to '_pi_mc_grp_create'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_delete: error: undefined reference to '_pi_mc_grp_delete'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_create: error: undefined reference to '_pi_mc_node_create'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_modify: error: undefined reference to '_pi_mc_node_modify'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_delete: error: undefined reference to '_pi_mc_node_delete'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_attach_node: error: undefined reference to '_pi_mc_grp_attach_node'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_detach_node: error: undefined reference to '_pi_mc_grp_detach_node'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_config_set: error: undefined reference to '_pi_learn_config_set'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_msg_ack: error: undefined reference to '_pi_learn_msg_ack'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_msg_done: error: undefined reference to '_pi_learn_msg_done'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_read: error: undefined reference to '_pi_counter_read'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_write: error: undefined reference to '_pi_counter_write'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_read_direct: error: undefined reference to '_pi_counter_read_direct'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_write_direct: error: undefined reference to '_pi_counter_write_direct'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_hw_sync: error: undefined reference to '_pi_counter_hw_sync'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function pi_clone_session_set: error: undefined reference to '_pi_clone_session_set'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function pi_clone_session_reset: error: undefined reference to '_pi_clone_session_reset'

collect2: error: ld returned 1 exit status

Target //stratum/hal/bin/barefoot:stratum_bf failed to build

Use --verbose_failures to see the command lines of failed build steps.

INFO: Elapsed time: 95.850s, Critical Path: 56.95s

INFO: 1141 processes: 1141 processwrapper-sandbox.

FAILED: Build did NOT complete successfully



So how should I proceed now. Please suggest.


Thanks,


Deval.


________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org<mailto:stratum-dev-bounces at lists.stratumproject.org>> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>>
Sent: Thursday, March 5, 2020 5:10:49 PM
To: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hi,


So as per the suggestions in the errors, and further suggestions, I commented out the single_file attribute in the repository rule in pip.bzl.


So the build went ahead and now I am getting error:


DEBUG: Call stack for the definition of repository 'build_stack_rules_proto' which is a http_archive (rule definition at /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/bazel_tools/tools/build_defs/repo/http.bzl:296:16):

 - <builtin>

 - /stratum/bazel/workspace_rule.bzl:62:5

 - /stratum/bazel/workspace_rule.bzl:144:22

 - /stratum/bazel/deps.bzl:87:9

 - /stratum/WORKSPACE:55:1

ERROR: /stratum/stratum/hal/bin/barefoot/BUILD:24:1: file '//bazel:rules.bzl' does not contain symbol 'stratum_cc_binary'

ERROR: Skipping '//stratum/hal/bin/barefoot:stratum_bf': no such target '//stratum/hal/bin/barefoot:stratum_bf': target 'stratum_bf' not declared in package 'stratum/hal/bin/barefoot' defined by /stratum/stratum/hal/bin/barefoot/BUILD

WARNING: Target pattern parsing failed.

ERROR: no such target '//stratum/hal/bin/barefoot:stratum_bf': target 'stratum_bf' not declared in package 'stratum/hal/bin/barefoot' defined by /stratum/stratum/hal/bin/barefoot/BUILD

INFO: Elapsed time: 29.345s

INFO: 0 processes.

FAILED: Build did NOT complete successfully (1 packages loaded)



No idea how to deal with it. Please suggest.


Thanks,

Deval.



________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org<mailto:stratum-dev-bounces at lists.stratumproject.org>> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>>
Sent: Thursday, March 5, 2020 3:04:49 PM
To: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Forgot to paste the error message:


ERROR: /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/io_bazel_rules_python/python/pip.bzl:39:25: Traceback (most recent call last):

File "/home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/io_bazel_rules_python/python/pip.bzl", line 37

repository_rule(<2 more arguments>)

File "/home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/io_bazel_rules_python/python/pip.bzl", line 39, in repository_rule

attr.label(allow_files = True, <2 more arguments>)

'single_file' is no longer supported. use allow_single_file instead. You can use --incompatible_disable_deprecated_attr_params=false to temporarily disable this check.

ERROR: error loading package '': Extension file 'python/pip.bzl' has errors

ERROR: error loading package '': Extension file 'python/pip.bzl' has errors

INFO: Elapsed time: 9.195s

INFO: 0 processes.

FAILED: Build did NOT complete successfully (0 packages loaded)



Thanks,


Deval.

________________________________
From: Deval Bhamare
Sent: Thursday, March 5, 2020 3:04:13 PM
To: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Yi,


Thanks for the updates. I had reported this earlier as well, but with the Bazel version to 2.2.0 , I get following error:



I also had reported the error I get with previous container image (older Bazel version).


Please suggest. Thank you.

________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org<mailto:stratum-dev-bounces at lists.stratumproject.org>> on behalf of Yi Tseng via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>>
Sent: Thursday, March 5, 2020 2:10:35 AM
To: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: [stratum-dev] Update Bazel version to 2.2.0

Hello Stratum developers:

Today we updated the Bazel version to 2.2.0 (see #84<https://github.com/stratum/stratum/pull/84>)

Please run ./setup_dev_env.sh --pull to get new Stratum development container image.

Feel free to let us know if you have any questions or issues with new Bazel

Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200305/ca8df62b/attachment-0001.html>

From yi at opennetworking.org  Thu Mar  5 22:08:42 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Thu, 5 Mar 2020 14:08:42 -0800
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <ec543d4d92fb4206b830a19262960255@kau.se>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
Message-ID: <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>

Hi Deval,

Can you try to clean up your cache and build it again? (*bazel clean
--expunge*)

I tested the build in my environment and it works.

Also, which SDE version you are using? I assume that you are using 8.9.0
(According to previous email thread)

Have you tried to add Bazel flag "--define sde_ver=8.9.2"? (Both 8.9.2 and
8.9.0 uses the same dependency)

Yi

Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200305/92c15b33/attachment.html>

From Deval.Bhamare at kau.se  Fri Mar  6 09:47:58 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Fri, 6 Mar 2020 09:47:58 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>,
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
Message-ID: <c5b7716226554a42a1ad5c8aa3c44eef@kau.se>

Hi Yi,


Yes I am using --define sde_ver=8.9.2 and now tried bazel clean --expunge, but no luck.


Same gcc errors:


ERROR: /stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error executing command /usr/bin/gcc @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params


Use --sandbox_debug to see verbose messages from the sandbox

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_8_9_2/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'

.. and so on..


Thanks,

Deval

________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Friday, March 6, 2020 12:08:42 AM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

Can you try to clean up your cache and build it again? (bazel clean --expunge)

I tested the build in my environment and it works.

Also, which SDE version you are using? I assume that you are using 8.9.0 (According to previous email thread)

Have you tried to add Bazel flag "--define sde_ver=8.9.2"? (Both 8.9.2 and 8.9.0 uses the same dependency)

Yi

Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200306/5a577ed2/attachment.html>

From bocon at opennetworking.org  Fri Mar  6 22:01:35 2020
From: bocon at opennetworking.org (Brian O'Connor)
Date: Fri, 6 Mar 2020 14:01:35 -0800
Subject: [stratum-dev] Upcoming Webinar and Stratum Announcements
Message-ID: <CACKOpDmw9cx2PRFgFdsh1S9TnZhQSz7xJexgQwMbVNZYq3uLxg@mail.gmail.com>

Hi everyone,

In light of the cancellation of OCP, we will be hosting two webinars in the
near future to highlight the Stratum community's progress and showcase the
OCP demos. The content will be the same, so feel free to attend the one
that works best for your schedule.

*Webinar*: *ONF Open Source Solutions Enable Data Center Interconnect and
Broadband Access*
Option 1 - *March 17, 2020*: Zoom Registration URL
<https://onf.zoom.us/webinar/register/WN_kH3HhVTsS0KPQ3OTMqcXdQ>

10:00 San Francisco, 13:00 New York City, 17:00 London, 18:00 Berlin

Option 2 - *March 18, 2020*: Zoom Registration URL
<https://onf.zoom.us/webinar/register/WN_duQlUvZkStWKJpv0jBVR1Q>

8:30 India, 11:00 China, 14:00 Sydney


I am also happy to share two announcements about the work being done by the
Stratum community:

   - First, a press release from the ONF
   <https://www.opennetworking.org/news-and-events/press-releases/onfs-stratum-open-source-switch-os-now-available-on-cassini-hardware-from-tip-2/>
   announcing the development of Stratum for the Cassini packet optical
   transponder.
   - Second, a blog post from me
   <https://www.opennetworking.org/news-and-events/blog/stratum-now-powers-trellis-and-odtn-opening-the-door-to-embedding-network-functions-into-the-fabric/>
   on the current state of Stratum developments from the community.

Please feel free to share the webinar registration details and
announcements.

Thanks!
Brian
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200306/889fbedb/attachment.html>

From yi at opennetworking.org  Sat Mar  7 02:37:41 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Fri, 6 Mar 2020 18:37:41 -0800
Subject: [stratum-dev] [brigade-p4] Stratum pre-built container
In-Reply-To: <33f8d704001e4c54a01ac6c5d32277c8@kau.se>
References: <3219e60081e54a23950b45fb513ca36e@kau.se>
 <C51D008B-728A-4591-8CA7-EFD77B8FBB2A@opennetworking.org>
 <CAOyFVR17KiGdfwZeD1ZyhJm1t5eh4Ar177gGA86HPSa_0TVRjA@mail.gmail.com>
 <b23068b17b02411bad50514261401a63@kau.se>
 <CAOyFVR1VeaA+dPWT6x=yjX-qpqYV-UMMOMSvLrMRdLWWVqZFYQ@mail.gmail.com>
 <77c56eb8472346538d55d222b6a39104@kau.se>
 <CAOyFVR2Zzcw=K0D9=cdyCq-dhAOcEObFDRmV4fXQ4hDf1T6iPg@mail.gmail.com>
 <6b0e9c8910b54dbb8adb21123e508d2a@kau.se>
 <CAOyFVR3EgOJZuxPxPUy2rh66SrMAq4b8_Hp0TXzGQpaBCtff_w@mail.gmail.com>
 <33f8d704001e4c54a01ac6c5d32277c8@kau.se>
Message-ID: <CAOyFVR3-+-y4Qbs29yZG6fu_KsCeTR7hCHDhb4n6jou7aG=Kng@mail.gmail.com>

Hi Deval,

Can you verify that libbf_switch_lib.so.0.0.0.0 exists also in that
directory?

# ls -al libbf_switchd_lib.so*
lrwxrwxrwx 1 root root      26 Mar  7 00:20 libbf_switchd_lib.so ->
libbf_switchd_lib.so.0.0.0
lrwxrwxrwx 1 root root      26 Mar  7 00:20 libbf_switchd_lib.so.0 ->
libbf_switchd_lib.so.0.0.0
-rwxr-xr-x 1 root root 1935960 Mar  7 00:20 libbf_switchd_lib.so.0.0.0



On Tue, Mar 3, 2020 at 6:42 AM Deval Bhamare <Deval.Bhamare at kau.se> wrote:

> Hi YI,
>
>
> I tried it and the previous error is gone (manes @local_barefoot_bin is
> set now?). However I am now getting error (screenshot attached):
>
>
> missing input file
> '@local_barefoot_bin//:barefoot-bin/lib/libbf_switchd_lib.so'
>
>
>
> The code has been invoked from the file at:
> stratum/hal/lib/barefoot/barefoot.bzl
>
>
> The missing file is there in stratum/ container folder at:
> ./bf-sde-8.9.0/install/lib/libbf_switchd_lib.so
>
> In the container (/stratum)   BF_SDE_INSTALL is set to:
> bf-sde-8.9.0/install/
>
>
>
> Please suggest.
>
>
> Thanks,
>
>
> Deval.
>
>
> ------------------------------
> *From:* Yi Tseng <yi at opennetworking.org>
> *Sent:* Tuesday, March 3, 2020 12:13:36 AM
> *To:* Deval Bhamare
> *Subject:* Re: [brigade-p4] Stratum pre-built container
>
> Hi Deval,
>
> What I usually do for development is to mount the install directory(e.g.
> bf-sde-x.x.x/install) to the development environment container and set up
> the BF_SDE_INSTALL environment.
> You can also create a tarball for that install dir and copy it to the
> container.
>
> Another option is to create a container based on the build container
> <https://hub.docker.com/repository/docker/stratumproject/build> with SDE
> installed.
>
> On Mon, Mar 2, 2020 at 12:54 PM Deval Bhamare <Deval.Bhamare at kau.se>
> wrote:
>
>> Hi,
>>
>>
>> So I have BF SDE already installed. But as you have mentioned, the
>> command should be executed in development environment for Stratum using
>> setup_dev_env.sh, which eventually starts a docker container.
>>
>>
>> Does it mean I have to install BF SDE in the docker container again?
>>
>>
>> ~DB
>> ------------------------------
>> *From:* Yi Tseng <yi at opennetworking.org>
>> *Sent:* Monday, March 2, 2020 9:43:29 PM
>> *To:* Deval Bhamare
>> *Cc:* stratum-dev at lists.stratumproject.org
>> *Subject:* Re: [brigade-p4] Stratum pre-built container
>>
>> Hi Deval,
>>
>> You need to set up *BF_SDE_INSTALL* environment variable before you
>> build the Stratum
>>
>> https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md#building-stratum-from-scratch
>>
>> The *switchd* binary is provided by Barefoot, which supports P4Runtime
>> and some private protocols.
>> The *Stratum* binary implements P4Runtime, gNMI, and gNOI protocols and
>> use switch SDK to control the switch ASIC.
>> You can find the overview of Stratum architecture here:
>> https://github.com/stratum/stratum#component-overview
>>
>> Yi
>>
>> On Sun, Mar 1, 2020 at 6:21 AM Deval Bhamare <Deval.Bhamare at kau.se>
>> wrote:
>>
>>> Hello Yi,
>>>
>>>
>>>
>>> I tried stratum build in dev environment, however, now I am getting
>>> error like below (Complete screenshot attached).
>>>
>>>
>>> *ERROR: */stratum/stratum/hal/lib/barefoot/BUILD:124:1: no such target
>>> '@local_barefoot_bin//:bf_headers': target 'bf_headers' not declared in
>>> package '' defined by
>>> /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/local_barefoot_bin/BUILD
>>> and referenced by '//stratum/hal/lib/barefoot:bf_pal_wrapper'
>>>
>>> *ERROR: */stratum/stratum/hal/lib/barefoot/BUILD:124:1: no such target
>>> '@local_barefoot_bin//:bf_drivers': target 'bf_drivers' not declared in
>>> package '' defined by
>>> /home/tofino/.cache/bazel/_bazel_tofino/1b07b1db06ec9ee22c71eac6f0bd4549/external/local_barefoot_bin/BUILD
>>> and referenced by '//stratum/hal/lib/barefoot:bf_pal_wrapper'
>>>
>>> ...
>>>
>>>
>>> Any suggestions?
>>>
>>>
>>> Also, I wanted to ask, what is the exact difference between using
>>> stratum and communicating with tofino by enabling the grpc server
>>> (something like * ./run_switchd.sh -c
>>> $SDE_INSTALL/share/p4/targets/tofino/skip_p4.conf --skip-p4 --p4rt-server
>>> 0.0.0.0:50051 <http://0.0.0.0:50051>*)? Can you please explain?
>>>
>>>
>>> Thanks,
>>>
>>>
>>> Deval.
>>> ------------------------------
>>> *From:* Yi Tseng <yi at opennetworking.org>
>>> *Sent:* Thursday, February 27, 2020 8:57:41 PM
>>> *To:* Deval Bhamare
>>> *Cc:* stratum-dev at lists.stratumproject.org; devalb at gmail.com
>>> *Subject:* Re: [brigade-p4] Stratum pre-built container
>>>
>>> Hello, please see my reply *inline*
>>>
>>> On Tue, Feb 25, 2020 at 1:21 AM Deval Bhamare <Deval.Bhamare at kau.se>
>>> wrote:
>>>
>>>> Dear Yi,
>>>>
>>>>
>>>> I appreciate your valuable input. I tried to build the  Stratum
>>>> directly on the machine as well. It gave me an error. Details are below:
>>>>
>>>>
>>>> *1. Build Stratum from scratch*: I have BF SDE 8.9.0 and I execute the
>>>> command (first I executed it without
>>>> incompatible_bzl_disallow_load_after_statement=false and it asked me
>>>> to include that option in command):
>>>>
>>>>
>>>> bazel build //stratum/hal/bin/barefoot:stratum_bf --define
>>>> phal_with_onlp=false --define sde_ver=8.9.0
>>>> --incompatible_bzl_disallow_load_after_statement=false
>>>>
>>>>
>>> *Please use the stratum build development environment to build the
>>> Stratum. We only support Bazel 0.23.2 now. And will move to 2.0 in the
>>> future.*
>>> *https://github.com/stratum/stratum#development-environment
>>> <https://github.com/stratum/stratum#development-environment>*
>>>
>>>
>>>>
>>>> It gave me the error:
>>>>
>>>>
>>>> *ERROR:* /home/tofino/.cache/bazel/_bazel_tofino/f6d313d4f595c91e594b2a1b1a2579ea/external/io_bazel_rules_python/python/pip.bzl:39:25:
>>>> Traceback (most recent call last):
>>>> File
>>>> "/home/tofino/.cache/bazel/_bazel_tofino/f6d313d4f595c91e594b2a1b1a2579ea/external/io_bazel_rules_python/python/pip.bzl",
>>>> line 37
>>>> repository_rule(<2 more arguments>)
>>>> File
>>>> "/home/tofino/.cache/bazel/_bazel_tofino/f6d313d4f595c91e594b2a1b1a2579ea/external/io_bazel_rules_python/python/pip.bzl",
>>>> line 39, in repository_rule
>>>> attr.label(allow_files = True, <2 more arguments>)
>>>> 'single_file' is no longer supported. use allow_single_file instead.
>>>> You can use --incompatible_disable_deprecated_attr_params=false to
>>>> temporarily disable this check.
>>>> *ERROR:* error loading package '': Extension file 'python/pip.bzl' has
>>>> errors
>>>> *ERROR:* error loading package '': Extension file 'python/pip.bzl' has
>>>> errors
>>>> INFO: Elapsed time: 0.101s
>>>> INFO: 0 processes.
>>>> *FAILED:* Build did NOT complete successfully (0 packages loaded)
>>>>
>>>>
>>>>
>>>> I also tried to build the Docker Image manually.
>>>>
>>>> *3. Build the docker image manually*: I tried to execute the command
>>>> below, as per my kernel and SDE
>>>>
>>>>
>>>> ./build-stratum-bf-container.sh bf-sde-8.9.0.tar linux-4.4.173.tar.gz
>>>>
>>>>
>>>> However, it failed with error below. Where can I find *Linux ONL tar* for
>>>> my linux kernel?
>>>> Error:
>>>>
>>>
>>> *You should be able to find it from /usr/src/linux-headers-[your linux
>>> kernel version]. *
>>>
>>>
>>>
>>>> make: Entering directory '/usr/src/kernel-headers'
>>>>
>>>>   ERROR: Kernel configuration is invalid.
>>>>          include/generated/autoconf.h or include/config/auto.conf are
>>>> missing.
>>>>          Run 'make oldconfig && make prepare' on kernel src to fix it.
>>>>
>>>>
>>>>   WARNING: Symbol version dump ./Module.symvers
>>>>            is missing; modules will have no dependencies and
>>>> modversions.
>>>>
>>>>   Building modules, stage 2.
>>>> scripts/Makefile.modpost:42: include/config/auto.conf: No such file or
>>>> directory
>>>> make[1]: *** No rule to make target 'include/config/auto.conf'.  Stop.
>>>> Makefile:1439: recipe for target 'modules' failed
>>>> make: Leaving directory '/usr/src/kernel-headers'
>>>> make: *** [modules] Error 2
>>>> The command '/bin/sh -c make -C /usr/src/kernel-headers M=$KDRV_DIR
>>>> src=$KDRV_DIR modules &&     mv $KDRV_DIR/bf_kdrv.ko
>>>> $SDE_INSTALL/lib/modules/bf_kdrv.ko' returned a non-zero code: 2
>>>>
>>>> Thanks,
>>>>
>>>>
>>>> Deval.
>>>> ------------------------------
>>>> *From:* Yi Tseng <yi at opennetworking.org>
>>>> *Sent:* Tuesday, February 25, 2020 2:07:35 AM
>>>> *To:* Deval Bhamare
>>>> *Cc:* stratum-dev at lists.stratumproject.org
>>>> *Subject:* Re: [brigade-p4] Stratum pre-built container
>>>>
>>>> [+stratum-dev at lists.stratumproject.org
>>>> <stratum-dev at lists.stratumproject.org>, remove p4-brigade list]
>>>>
>>>> Hi Deval,
>>>>
>>>> The public container images include a specific Barefoot Linux kernel
>>>> module.
>>>>
>>>> Now we only compile the module for kernels from OpenNetworkLiunx (3.16,
>>>> 4.9, and 4.14)
>>>>
>>>> If you want to run Stratum on different kernel (4.4.0-173-generic), you
>>>> need to compile the Barefoot SDE with the kernel header and run Stratum
>>>> directly on the OS
>>>>
>>>> I've created a GitHub issue to support this request. And will make a PR
>>>> to support this case.
>>>> https://github.com/stratum/stratum/issues/140
>>>>
>>>> Yi
>>>>
>>>>
>>>> On Mon, Feb 24, 2020 at 3:25 PM Carmelo Cascone <
>>>> carmelo at opennetworking.org> wrote:
>>>>
>>>>> Hi Deval,
>>>>>
>>>>> I suggest you ask on the stratum-dev mailing list or Slack channel:
>>>>> https://wiki.opennetworking.org/display/COM/Stratum
>>>>>
>>>>> This mailing list is for discussions related to P4/P4Runtime support
>>>>> in ONOS.
>>>>>
>>>>> Thanks
>>>>> Carmelo
>>>>>
>>>>> On Feb 24, 2020, at 6:53 AM, Deval Bhamare <Deval.Bhamare at kau.se>
>>>>> wrote:
>>>>>
>>>>> Hi,
>>>>>
>>>>> I am trying to find Stratum pre-built docker image for Linux
>>>>> 4.4.0-173-generic x86_64 , however couldn't find it. Can you please tell me
>>>>> whether Stratum is not supported on Generic and only runs on ONL version?
>>>>>
>>>>> I tried *stratumproject/stratum-bf:8.9.1-4.14.49-OpenNetworkLinux* ,
>>>>> but it failed with error:
>>>>>
>>>>> cat: /etc/onl/platform: No such file or directory
>>>>> Use default flag file
>>>>> Cannot find /usr/local/share/stratum/.json
>>>>>
>>>>>
>>>>> Maybe because the Linux doesn't support ONL? What may be the
>>>>> solution? Please let me know.
>>>>>
>>>>>
>>>>> Thanks,
>>>>> Deval
>>>>>
>>>>> --
>>>>> You received this message because you are subscribed to the Google
>>>>> Groups "P4 brigade" group.
>>>>> To unsubscribe from this group and stop receiving emails from it, send
>>>>> an email to brigade-p4+unsubscribe at onosproject.org.
>>>>> To view this discussion on the web visit
>>>>> https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/3219e60081e54a23950b45fb513ca36e%40kau.se
>>>>> <https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/3219e60081e54a23950b45fb513ca36e%40kau.se?utm_medium=email&utm_source=footer>
>>>>> .
>>>>>
>>>>>
>>>>> --
>>>>> You received this message because you are subscribed to the Google
>>>>> Groups "P4 brigade" group.
>>>>> To unsubscribe from this group and stop receiving emails from it, send
>>>>> an email to brigade-p4+unsubscribe at onosproject.org.
>>>>> To view this discussion on the web visit
>>>>> https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/C51D008B-728A-4591-8CA7-EFD77B8FBB2A%40opennetworking.org
>>>>> <https://groups.google.com/a/onosproject.org/d/msgid/brigade-p4/C51D008B-728A-4591-8CA7-EFD77B8FBB2A%40opennetworking.org?utm_medium=email&utm_source=footer>
>>>>> .
>>>>>
>>>>
>>>>
>>>> --
>>>> Yi Tseng
>>>> Member of Technical Staff
>>>> Open Networking Foundation
>>>> https://www.opennetworking.org/
>>>>
>>>
>>>
>>> --
>>> Yi Tseng
>>> Member of Technical Staff
>>> Open Networking Foundation
>>> https://www.opennetworking.org/
>>>
>>
>>
>> --
>> Yi Tseng
>> Member of Technical Staff
>> Open Networking Foundation
>> https://www.opennetworking.org/
>>
>
>
> --
> Yi Tseng
> Member of Technical Staff
> Open Networking Foundation
> https://www.opennetworking.org/
>


-- 
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200306/a7a5c182/attachment-0001.html>

From Deval.Bhamare at kau.se  Sat Mar  7 10:00:55 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Sat, 7 Mar 2020 10:00:55 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>,
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
Message-ID: <280d12daac4a4957b30144e3b7720db4@kau.se>

Hello Yi,


I am answering all your question here. Yes, libbf_switchd_lib.so exists in/bf-sde-8.9.0/install/lib/. That error is resolved now.


As I have mentioned, I am stuck at the GCC error mentioned earlier (and below).


"The BSP is optional for Stratum, you can have the BSP installed in your SDE_INSTALL directory or not."


>> So it means even if I am using --define phal_with_onlp=false and relying on BSP, nothing different needs to be done besides compiling BF SDE with BSP, which i have already done.


So what can be the issue with the GCC error I am getting and how to resolve it (pasting below again)


ERROR: /stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error executing command /usr/bin/gcc @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params

Use --sandbox_debug to see verbose messages from the sandbox
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_assign_device: error: undefined reference to '_pi_assign_device'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_update_device_start: error: undefined reference to '_pi_update_device_start'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_update_device_end: error: undefined reference to '_pi_update_device_end'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_remove_device: error: undefined reference to '_pi_remove_device'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_session_init: error: undefined reference to '_pi_session_init'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_session_cleanup: error: undefined reference to '_pi_session_cleanup'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_batch_begin: error: undefined reference to '_pi_batch_begin'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_batch_end: error: undefined reference to '_pi_batch_end'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_destroy: error: undefined reference to '_pi_destroy'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_packetout_send: error: undefined reference to '_pi_packetout_send'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_port_status_get: error: undefined reference to '_pi_port_status_get'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_create: error: undefined reference to '_pi_act_prof_mbr_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_delete: error: undefined reference to '_pi_act_prof_mbr_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_modify: error: undefined reference to '_pi_act_prof_mbr_modify'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_create: error: undefined reference to '_pi_act_prof_grp_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_delete: error: undefined reference to '_pi_act_prof_grp_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_add_mbr: error: undefined reference to '_pi_act_prof_grp_add_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_remove_mbr: error: undefined reference to '_pi_act_prof_grp_remove_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_set_mbrs: error: undefined reference to '_pi_act_prof_grp_set_mbrs'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_activate_mbr: error: undefined reference to '_pi_act_prof_grp_activate_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_deactivate_mbr: error: undefined reference to '_pi_act_prof_grp_deactivate_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_entries_fetch: error: undefined reference to '_pi_act_prof_entries_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_fetch: error: undefined reference to '_pi_act_prof_mbr_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_fetch: error: undefined reference to '_pi_act_prof_grp_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_entries_fetch_done: error: undefined reference to '_pi_act_prof_entries_fetch_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_api_support: error: undefined reference to '_pi_act_prof_api_support'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_add: error: undefined reference to '_pi_table_entry_add'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_set: error: undefined reference to '_pi_table_default_action_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_reset: error: undefined reference to '_pi_table_default_action_reset'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_get: error: undefined reference to '_pi_table_default_action_get'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_done: error: undefined reference to '_pi_table_default_action_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_get_handle: error: undefined reference to '_pi_table_default_action_get_handle'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_delete: error: undefined reference to '_pi_table_entry_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_delete_wkey: error: undefined reference to '_pi_table_entry_delete_wkey'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_modify: error: undefined reference to '_pi_table_entry_modify'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_modify_wkey: error: undefined reference to '_pi_table_entry_modify_wkey'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch: error: undefined reference to '_pi_table_entries_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_one: error: undefined reference to '_pi_table_entries_fetch_one'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_wkey: error: undefined reference to '_pi_table_entries_fetch_wkey'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_done: error: undefined reference to '_pi_table_entries_fetch_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_idle_timeout_config_set: error: undefined reference to '_pi_table_idle_timeout_config_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_get_remaining_ttl: error: undefined reference to '_pi_table_entry_get_remaining_ttl'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_read: error: undefined reference to '_pi_meter_read'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_set: error: undefined reference to '_pi_meter_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_read_direct: error: undefined reference to '_pi_meter_read_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_set_direct: error: undefined reference to '_pi_meter_set_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_session_init: error: undefined reference to '_pi_mc_session_init'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_session_cleanup: error: undefined reference to '_pi_mc_session_cleanup'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_create: error: undefined reference to '_pi_mc_grp_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_delete: error: undefined reference to '_pi_mc_grp_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_create: error: undefined reference to '_pi_mc_node_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_modify: error: undefined reference to '_pi_mc_node_modify'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_delete: error: undefined reference to '_pi_mc_node_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_attach_node: error: undefined reference to '_pi_mc_grp_attach_node'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_detach_node: error: undefined reference to '_pi_mc_grp_detach_node'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_config_set: error: undefined reference to '_pi_learn_config_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_msg_ack: error: undefined reference to '_pi_learn_msg_ack'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_msg_done: error: undefined reference to '_pi_learn_msg_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_read: error: undefined reference to '_pi_counter_read'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_write: error: undefined reference to '_pi_counter_write'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_read_direct: error: undefined reference to '_pi_counter_read_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_write_direct: error: undefined reference to '_pi_counter_write_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_hw_sync: error: undefined reference to '_pi_counter_hw_sync'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function pi_clone_session_set: error: undefined reference to '_pi_clone_session_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function pi_clone_session_reset: error: undefined reference to '_pi_clone_session_reset'
collect2: error: ld returned 1 exit status
Target //stratum/hal/bin/barefoot:stratum_bf failed to build
Use --verbose_failures to see the command lines of failed build steps.
INFO: Elapsed time: 95.850s, Critical Path: 56.95s
INFO: 1141 processes: 1141 processwrapper-sandbox.
FAILED: Build did NOT complete successfully



Thanks,

Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Saturday, March 7, 2020 4:46:10 AM
To: Deval Bhamare
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

The BSP is optional for Stratum, you can have the BSP installed in your SDE_INSTALL directory or not.

On Fri, Mar 6, 2020 at 2:34 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I just want to add that, I am doing it without ONLP support  (--define phal_with_onlp=false)


We have built the BF SDE 8.9.0 with BF2556X-1T_BSP_8.9.0-master and I have copied the BF SDE folder to Stratum Container. Do I have to copy the BSP folder as well?


Thanks,

Deval.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200307/a5a7808d/attachment-0001.html>

From yi at opennetworking.org  Sun Mar  8 00:34:22 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Sat, 7 Mar 2020 16:34:22 -0800
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <280d12daac4a4957b30144e3b7720db4@kau.se>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
Message-ID: <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>

Hi Deval,

According to the log from your latest email, for example:

"bazel-out/k8-fastbuild/bin/external/*com_github_p4lang_PI_**bf_9_1_0*/_objs/pi/pi.pic.o:pi.c:function
pi_init: error: undefined reference to '_pi_init'"

Looks like you are still trying to compile Stratum with 9.1.0 dependency

Is there a reason you want to use 8.9.0 instead of 8.9.2 or 9.1.0?



On Sat, Mar 7, 2020 at 2:00 AM Deval Bhamare <Deval.Bhamare at kau.se> wrote:

> Hello Yi,
>
>
> I am answering all your question here. Yes, libbf_switchd_lib.so exists in
> /bf-sde-8.9.0/install/lib/. That error is resolved now.
>
>
> As I have mentioned, I am stuck at the GCC error mentioned earlier (and
> below).
>
>
> "The BSP is optional for Stratum, you can have the BSP installed in your
> SDE_INSTALL directory or not."
>
>
> >> So it means even if I am using * --define phal_with_onlp=false *and
> relying on BSP, nothing different needs to be done besides compiling BF SDE
> with BSP, which i have already done.
>
>
> So what can be the issue with the GCC error I am getting and how to
> resolve it (pasting below again)
>
>
> *ERROR: */stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule
> '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error
> executing command /usr/bin/gcc
> @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params
>
> Use --sandbox_debug to see verbose messages from the sandbox
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_init: error: undefined reference to '_pi_init'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_assign_device: error: undefined reference to '_pi_assign_device'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_update_device_start: error: undefined reference to
> '_pi_update_device_start'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_update_device_end: error: undefined reference to '_pi_update_device_end'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_remove_device: error: undefined reference to '_pi_remove_device'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_session_init: error: undefined reference to '_pi_session_init'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_session_cleanup: error: undefined reference to '_pi_session_cleanup'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_batch_begin: error: undefined reference to '_pi_batch_begin'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_batch_end: error: undefined reference to '_pi_batch_end'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_destroy: error: undefined reference to '_pi_destroy'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_packetout_send: error: undefined reference to '_pi_packetout_send'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
> pi_port_status_get: error: undefined reference to '_pi_port_status_get'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_mbr_create: error: undefined reference to
> '_pi_act_prof_mbr_create'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_mbr_delete: error: undefined reference to
> '_pi_act_prof_mbr_delete'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_mbr_modify: error: undefined reference to
> '_pi_act_prof_mbr_modify'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_create: error: undefined reference to
> '_pi_act_prof_grp_create'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_delete: error: undefined reference to
> '_pi_act_prof_grp_delete'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_add_mbr: error: undefined reference to
> '_pi_act_prof_grp_add_mbr'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_remove_mbr: error: undefined reference to
> '_pi_act_prof_grp_remove_mbr'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_set_mbrs: error: undefined reference to
> '_pi_act_prof_grp_set_mbrs'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_activate_mbr: error: undefined reference to
> '_pi_act_prof_grp_activate_mbr'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_deactivate_mbr: error: undefined reference to
> '_pi_act_prof_grp_deactivate_mbr'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_entries_fetch: error: undefined reference to
> '_pi_act_prof_entries_fetch'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_mbr_fetch: error: undefined reference to
> '_pi_act_prof_mbr_fetch'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_grp_fetch: error: undefined reference to
> '_pi_act_prof_grp_fetch'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_entries_fetch_done: error: undefined reference to
> '_pi_act_prof_entries_fetch_done'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
> pi_act_prof_api_support: error: undefined reference to
> '_pi_act_prof_api_support'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entry_add: error: undefined reference to '_pi_table_entry_add'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_default_action_set: error: undefined reference to
> '_pi_table_default_action_set'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_default_action_reset: error: undefined reference to
> '_pi_table_default_action_reset'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_default_action_get: error: undefined reference to
> '_pi_table_default_action_get'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_default_action_done: error: undefined reference to
> '_pi_table_default_action_done'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_default_action_get_handle: error: undefined reference to
> '_pi_table_default_action_get_handle'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entry_delete: error: undefined reference to
> '_pi_table_entry_delete'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entry_delete_wkey: error: undefined reference to
> '_pi_table_entry_delete_wkey'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entry_modify: error: undefined reference to
> '_pi_table_entry_modify'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entry_modify_wkey: error: undefined reference to
> '_pi_table_entry_modify_wkey'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entries_fetch: error: undefined reference to
> '_pi_table_entries_fetch'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entries_fetch_one: error: undefined reference to
> '_pi_table_entries_fetch_one'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entries_fetch_wkey: error: undefined reference to
> '_pi_table_entries_fetch_wkey'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entries_fetch_done: error: undefined reference to
> '_pi_table_entries_fetch_done'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_idle_timeout_config_set: error: undefined reference to
> '_pi_table_idle_timeout_config_set'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
> pi_table_entry_get_remaining_ttl: error: undefined reference to
> '_pi_table_entry_get_remaining_ttl'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
> pi_meter_read: error: undefined reference to '_pi_meter_read'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
> pi_meter_set: error: undefined reference to '_pi_meter_set'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
> pi_meter_read_direct: error: undefined reference to '_pi_meter_read_direct'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
> pi_meter_set_direct: error: undefined reference to '_pi_meter_set_direct'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_session_init: error: undefined reference to '_pi_mc_session_init'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_session_cleanup: error: undefined reference to
> '_pi_mc_session_cleanup'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_grp_create: error: undefined reference to '_pi_mc_grp_create'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_grp_delete: error: undefined reference to '_pi_mc_grp_delete'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_node_create: error: undefined reference to '_pi_mc_node_create'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_node_modify: error: undefined reference to '_pi_mc_node_modify'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_node_delete: error: undefined reference to '_pi_mc_node_delete'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_grp_attach_node: error: undefined reference to
> '_pi_mc_grp_attach_node'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
> pi_mc_grp_detach_node: error: undefined reference to
> '_pi_mc_grp_detach_node'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function
> pi_learn_config_set: error: undefined reference to '_pi_learn_config_set'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function
> pi_learn_msg_ack: error: undefined reference to '_pi_learn_msg_ack'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function
> pi_learn_msg_done: error: undefined reference to '_pi_learn_msg_done'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
> pi_counter_read: error: undefined reference to '_pi_counter_read'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
> pi_counter_write: error: undefined reference to '_pi_counter_write'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
> pi_counter_read_direct: error: undefined reference to
> '_pi_counter_read_direct'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
> pi_counter_write_direct: error: undefined reference to
> '_pi_counter_write_direct'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
> pi_counter_hw_sync: error: undefined reference to '_pi_counter_hw_sync'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function
> pi_clone_session_set: error: undefined reference to '_pi_clone_session_set'
> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function
> pi_clone_session_reset: error: undefined reference to
> '_pi_clone_session_reset'
> collect2: error: ld returned 1 exit status
> Target //stratum/hal/bin/barefoot:stratum_bf failed to build
> Use --verbose_failures to see the command lines of failed build steps.
> INFO: Elapsed time: 95.850s, Critical Path: 56.95s
> INFO: 1141 processes: 1141 processwrapper-sandbox.
> *FAILED:* Build did NOT complete successfully
>
>
> Thanks,
>
> Deval.
> ------------------------------
> *From:* Yi Tseng <yi at opennetworking.org>
> *Sent:* Saturday, March 7, 2020 4:46:10 AM
> *To:* Deval Bhamare
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
> Hi Deval,
>
> The BSP is optional for Stratum, you can have the BSP installed in your
> SDE_INSTALL directory or not.
>
> On Fri, Mar 6, 2020 at 2:34 AM Deval Bhamare <Deval.Bhamare at kau.se> wrote:
>
>> Hello Yi,
>>
>>
>> I just want to add that, I am doing it without ONLP support  (*--define
>> phal_with_onlp=false*)
>>
>>
>> We have built the BF SDE 8.9.0 with BF2556X-1T_BSP_8.9.0-master and I
>> have copied the BF SDE folder to Stratum Container. Do I have to copy the
>> BSP folder as well?
>>
>>
>> Thanks,
>>
>> Deval.
>>
>>

-- 
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200307/2f4c8024/attachment-0001.html>

From Deval.Bhamare at kau.se  Sun Mar  8 07:45:31 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Sun, 8 Mar 2020 07:45:31 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>,
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
Message-ID: <ec8feacc7f404d02a6143c4b08c7c5b4@kau.se>

Hi,


By mistake I copied the incorrect logs, since I was trying it with different options.

Even with BF 8.9.2, the error is the same as below:


ERROR: /stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error executing command /usr/bin/gcc @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params


Use --sandbox_debug to see verbose messages from the sandbox

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_8_9_2/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_8_9_2/_objs/pi/pi.pic.o:pi.c:function pi_assign_device: error: undefined reference to '_pi_assign_device'


.... and so on....


Thanks,

Deval

________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Sunday, March 8, 2020 2:34:22 AM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

According to the log from your latest email, for example:

"bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'"

Looks like you are still trying to compile Stratum with 9.1.0 dependency

Is there a reason you want to use 8.9.0 instead of 8.9.2 or 9.1.0?



On Sat, Mar 7, 2020 at 2:00 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I am answering all your question here. Yes, libbf_switchd_lib.so exists in/bf-sde-8.9.0/install/lib/. That error is resolved now.


As I have mentioned, I am stuck at the GCC error mentioned earlier (and below).


"The BSP is optional for Stratum, you can have the BSP installed in your SDE_INSTALL directory or not."


>> So it means even if I am using --define phal_with_onlp=false and relying on BSP, nothing different needs to be done besides compiling BF SDE with BSP, which i have already done.


So what can be the issue with the GCC error I am getting and how to resolve it (pasting below again)


ERROR: /stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error executing command /usr/bin/gcc @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params

Use --sandbox_debug to see verbose messages from the sandbox
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_assign_device: error: undefined reference to '_pi_assign_device'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_update_device_start: error: undefined reference to '_pi_update_device_start'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_update_device_end: error: undefined reference to '_pi_update_device_end'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_remove_device: error: undefined reference to '_pi_remove_device'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_session_init: error: undefined reference to '_pi_session_init'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_session_cleanup: error: undefined reference to '_pi_session_cleanup'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_batch_begin: error: undefined reference to '_pi_batch_begin'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_batch_end: error: undefined reference to '_pi_batch_end'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_destroy: error: undefined reference to '_pi_destroy'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_packetout_send: error: undefined reference to '_pi_packetout_send'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_port_status_get: error: undefined reference to '_pi_port_status_get'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_create: error: undefined reference to '_pi_act_prof_mbr_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_delete: error: undefined reference to '_pi_act_prof_mbr_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_modify: error: undefined reference to '_pi_act_prof_mbr_modify'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_create: error: undefined reference to '_pi_act_prof_grp_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_delete: error: undefined reference to '_pi_act_prof_grp_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_add_mbr: error: undefined reference to '_pi_act_prof_grp_add_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_remove_mbr: error: undefined reference to '_pi_act_prof_grp_remove_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_set_mbrs: error: undefined reference to '_pi_act_prof_grp_set_mbrs'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_activate_mbr: error: undefined reference to '_pi_act_prof_grp_activate_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_deactivate_mbr: error: undefined reference to '_pi_act_prof_grp_deactivate_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_entries_fetch: error: undefined reference to '_pi_act_prof_entries_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_fetch: error: undefined reference to '_pi_act_prof_mbr_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_fetch: error: undefined reference to '_pi_act_prof_grp_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_entries_fetch_done: error: undefined reference to '_pi_act_prof_entries_fetch_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_api_support: error: undefined reference to '_pi_act_prof_api_support'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_add: error: undefined reference to '_pi_table_entry_add'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_set: error: undefined reference to '_pi_table_default_action_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_reset: error: undefined reference to '_pi_table_default_action_reset'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_get: error: undefined reference to '_pi_table_default_action_get'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_done: error: undefined reference to '_pi_table_default_action_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_get_handle: error: undefined reference to '_pi_table_default_action_get_handle'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_delete: error: undefined reference to '_pi_table_entry_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_delete_wkey: error: undefined reference to '_pi_table_entry_delete_wkey'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_modify: error: undefined reference to '_pi_table_entry_modify'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_modify_wkey: error: undefined reference to '_pi_table_entry_modify_wkey'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch: error: undefined reference to '_pi_table_entries_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_one: error: undefined reference to '_pi_table_entries_fetch_one'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_wkey: error: undefined reference to '_pi_table_entries_fetch_wkey'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_done: error: undefined reference to '_pi_table_entries_fetch_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_idle_timeout_config_set: error: undefined reference to '_pi_table_idle_timeout_config_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_get_remaining_ttl: error: undefined reference to '_pi_table_entry_get_remaining_ttl'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_read: error: undefined reference to '_pi_meter_read'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_set: error: undefined reference to '_pi_meter_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_read_direct: error: undefined reference to '_pi_meter_read_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_set_direct: error: undefined reference to '_pi_meter_set_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_session_init: error: undefined reference to '_pi_mc_session_init'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_session_cleanup: error: undefined reference to '_pi_mc_session_cleanup'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_create: error: undefined reference to '_pi_mc_grp_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_delete: error: undefined reference to '_pi_mc_grp_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_create: error: undefined reference to '_pi_mc_node_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_modify: error: undefined reference to '_pi_mc_node_modify'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_delete: error: undefined reference to '_pi_mc_node_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_attach_node: error: undefined reference to '_pi_mc_grp_attach_node'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_detach_node: error: undefined reference to '_pi_mc_grp_detach_node'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_config_set: error: undefined reference to '_pi_learn_config_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_msg_ack: error: undefined reference to '_pi_learn_msg_ack'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_msg_done: error: undefined reference to '_pi_learn_msg_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_read: error: undefined reference to '_pi_counter_read'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_write: error: undefined reference to '_pi_counter_write'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_read_direct: error: undefined reference to '_pi_counter_read_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_write_direct: error: undefined reference to '_pi_counter_write_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_hw_sync: error: undefined reference to '_pi_counter_hw_sync'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function pi_clone_session_set: error: undefined reference to '_pi_clone_session_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function pi_clone_session_reset: error: undefined reference to '_pi_clone_session_reset'
collect2: error: ld returned 1 exit status
Target //stratum/hal/bin/barefoot:stratum_bf failed to build
Use --verbose_failures to see the command lines of failed build steps.
INFO: Elapsed time: 95.850s, Critical Path: 56.95s
INFO: 1141 processes: 1141 processwrapper-sandbox.
FAILED: Build did NOT complete successfully



Thanks,

Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Saturday, March 7, 2020 4:46:10 AM
To: Deval Bhamare
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

The BSP is optional for Stratum, you can have the BSP installed in your SDE_INSTALL directory or not.

On Fri, Mar 6, 2020 at 2:34 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I just want to add that, I am doing it without ONLP support  (--define phal_with_onlp=false)


We have built the BF SDE 8.9.0 with BF2556X-1T_BSP_8.9.0-master and I have copied the BF SDE folder to Stratum Container. Do I have to copy the BSP folder as well?


Thanks,

Deval.



--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200308/8747857e/attachment-0001.html>

From Deval.Bhamare at kau.se  Mon Mar  9 16:14:54 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Mon, 9 Mar 2020 16:14:54 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>,
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>,
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
Message-ID: <6a72d675258e4056b510ac74fab4eef0@kau.se>

Hello,


The Link error has been resolved (you need to build the BF SDE with stratum_profile option, which has the PI libraries included, and not ALL).


Now, while running the stratum, I found the command below from the repo page. However, I have following doubts about it such as:

1. What is  <config dir> ?

2. Where can I find or how should I prepare file p4_pipeline.pb.txt?


Command is below:


sudo LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib \
     ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
       --external_stratum_urls=0.0.0.0:28000 \
       --grpc_max_recv_msg_size=256 \
       --bf_sde_install=$BF_SDE_INSTALL \
       --persistent_config_dir=<config dir> \
       --forwarding_pipeline_configs_file=<config dir>/p4_pipeline.pb.txt \
       --chassis_config_file=<config dir>/chassis_config.pb.txt \
       --write_req_log_file=<config dir>/p4_writes.pb.txt \
       --bf_sim



Thanks,


Deval.


________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org>
Sent: Sunday, March 8, 2020 9:45:37 AM
To: Yi Tseng
Cc: stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hi,


By mistake I copied the incorrect logs, since I was trying it with different options.

Even with BF 8.9.2, the error is the same as below:


ERROR: /stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error executing command /usr/bin/gcc @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params


Use --sandbox_debug to see verbose messages from the sandbox

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_8_9_2/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_8_9_2/_objs/pi/pi.pic.o:pi.c:function pi_assign_device: error: undefined reference to '_pi_assign_device'


.... and so on....


Thanks,

Deval

________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Sunday, March 8, 2020 2:34:22 AM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

According to the log from your latest email, for example:

"bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'"

Looks like you are still trying to compile Stratum with 9.1.0 dependency

Is there a reason you want to use 8.9.0 instead of 8.9.2 or 9.1.0?



On Sat, Mar 7, 2020 at 2:00 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I am answering all your question here. Yes, libbf_switchd_lib.so exists in/bf-sde-8.9.0/install/lib/. That error is resolved now.


As I have mentioned, I am stuck at the GCC error mentioned earlier (and below).


"The BSP is optional for Stratum, you can have the BSP installed in your SDE_INSTALL directory or not."


>> So it means even if I am using --define phal_with_onlp=false and relying on BSP, nothing different needs to be done besides compiling BF SDE with BSP, which i have already done.


So what can be the issue with the GCC error I am getting and how to resolve it (pasting below again)


ERROR: /stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error executing command /usr/bin/gcc @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params

Use --sandbox_debug to see verbose messages from the sandbox
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_assign_device: error: undefined reference to '_pi_assign_device'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_update_device_start: error: undefined reference to '_pi_update_device_start'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_update_device_end: error: undefined reference to '_pi_update_device_end'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_remove_device: error: undefined reference to '_pi_remove_device'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_session_init: error: undefined reference to '_pi_session_init'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_session_cleanup: error: undefined reference to '_pi_session_cleanup'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_batch_begin: error: undefined reference to '_pi_batch_begin'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_batch_end: error: undefined reference to '_pi_batch_end'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_destroy: error: undefined reference to '_pi_destroy'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_packetout_send: error: undefined reference to '_pi_packetout_send'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_port_status_get: error: undefined reference to '_pi_port_status_get'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_create: error: undefined reference to '_pi_act_prof_mbr_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_delete: error: undefined reference to '_pi_act_prof_mbr_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_modify: error: undefined reference to '_pi_act_prof_mbr_modify'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_create: error: undefined reference to '_pi_act_prof_grp_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_delete: error: undefined reference to '_pi_act_prof_grp_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_add_mbr: error: undefined reference to '_pi_act_prof_grp_add_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_remove_mbr: error: undefined reference to '_pi_act_prof_grp_remove_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_set_mbrs: error: undefined reference to '_pi_act_prof_grp_set_mbrs'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_activate_mbr: error: undefined reference to '_pi_act_prof_grp_activate_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_deactivate_mbr: error: undefined reference to '_pi_act_prof_grp_deactivate_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_entries_fetch: error: undefined reference to '_pi_act_prof_entries_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_fetch: error: undefined reference to '_pi_act_prof_mbr_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_fetch: error: undefined reference to '_pi_act_prof_grp_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_entries_fetch_done: error: undefined reference to '_pi_act_prof_entries_fetch_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_api_support: error: undefined reference to '_pi_act_prof_api_support'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_add: error: undefined reference to '_pi_table_entry_add'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_set: error: undefined reference to '_pi_table_default_action_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_reset: error: undefined reference to '_pi_table_default_action_reset'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_get: error: undefined reference to '_pi_table_default_action_get'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_done: error: undefined reference to '_pi_table_default_action_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_get_handle: error: undefined reference to '_pi_table_default_action_get_handle'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_delete: error: undefined reference to '_pi_table_entry_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_delete_wkey: error: undefined reference to '_pi_table_entry_delete_wkey'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_modify: error: undefined reference to '_pi_table_entry_modify'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_modify_wkey: error: undefined reference to '_pi_table_entry_modify_wkey'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch: error: undefined reference to '_pi_table_entries_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_one: error: undefined reference to '_pi_table_entries_fetch_one'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_wkey: error: undefined reference to '_pi_table_entries_fetch_wkey'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_done: error: undefined reference to '_pi_table_entries_fetch_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_idle_timeout_config_set: error: undefined reference to '_pi_table_idle_timeout_config_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_get_remaining_ttl: error: undefined reference to '_pi_table_entry_get_remaining_ttl'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_read: error: undefined reference to '_pi_meter_read'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_set: error: undefined reference to '_pi_meter_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_read_direct: error: undefined reference to '_pi_meter_read_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_set_direct: error: undefined reference to '_pi_meter_set_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_session_init: error: undefined reference to '_pi_mc_session_init'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_session_cleanup: error: undefined reference to '_pi_mc_session_cleanup'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_create: error: undefined reference to '_pi_mc_grp_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_delete: error: undefined reference to '_pi_mc_grp_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_create: error: undefined reference to '_pi_mc_node_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_modify: error: undefined reference to '_pi_mc_node_modify'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_delete: error: undefined reference to '_pi_mc_node_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_attach_node: error: undefined reference to '_pi_mc_grp_attach_node'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_detach_node: error: undefined reference to '_pi_mc_grp_detach_node'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_config_set: error: undefined reference to '_pi_learn_config_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_msg_ack: error: undefined reference to '_pi_learn_msg_ack'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_msg_done: error: undefined reference to '_pi_learn_msg_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_read: error: undefined reference to '_pi_counter_read'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_write: error: undefined reference to '_pi_counter_write'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_read_direct: error: undefined reference to '_pi_counter_read_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_write_direct: error: undefined reference to '_pi_counter_write_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_hw_sync: error: undefined reference to '_pi_counter_hw_sync'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function pi_clone_session_set: error: undefined reference to '_pi_clone_session_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function pi_clone_session_reset: error: undefined reference to '_pi_clone_session_reset'
collect2: error: ld returned 1 exit status
Target //stratum/hal/bin/barefoot:stratum_bf failed to build
Use --verbose_failures to see the command lines of failed build steps.
INFO: Elapsed time: 95.850s, Critical Path: 56.95s
INFO: 1141 processes: 1141 processwrapper-sandbox.
FAILED: Build did NOT complete successfully



Thanks,

Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Saturday, March 7, 2020 4:46:10 AM
To: Deval Bhamare
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

The BSP is optional for Stratum, you can have the BSP installed in your SDE_INSTALL directory or not.

On Fri, Mar 6, 2020 at 2:34 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I just want to add that, I am doing it without ONLP support  (--define phal_with_onlp=false)


We have built the BF SDE 8.9.0 with BF2556X-1T_BSP_8.9.0-master and I have copied the BF SDE folder to Stratum Container. Do I have to copy the BSP folder as well?


Thanks,

Deval.



--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200309/0c00f82d/attachment-0001.html>

From yi at opennetworking.org  Mon Mar  9 16:43:56 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Mon, 9 Mar 2020 09:43:56 -0700
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <6a72d675258e4056b510ac74fab4eef0@kau.se>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
Message-ID: <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>

Hi Deval,

The *config dir* is the directory you put config files, for example,
*$HOME/stratum_configs*

The *forwarding_pipeline_configs_file* is the file we store pipeline
configs, this file will be created when a controller push the pipeline via
P4Runtime.



On Mon, Mar 9, 2020 at 9:14 AM Deval Bhamare <Deval.Bhamare at kau.se> wrote:

> Hello,
>
>
> The Link error has been resolved (you need to build the BF SDE with
> stratum_profile option, which has the PI libraries included, and not ALL).
>
>
> Now, while running the stratum, I found the command below from the repo
> page. However, I have following doubts about it such as:
>
> 1. What is  <config dir> ?
>
> 2. Where can I find or how should I prepare file p4_pipeline.pb.txt?
>
>
> Command is below:
>
>
> sudo LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib \
>      ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
>        --external_stratum_urls=0.0.0.0:28000 \
>        --grpc_max_recv_msg_size=256 \
>        --bf_sde_install=$BF_SDE_INSTALL \
>        --persistent_config_dir=<config dir> \
>        --forwarding_pipeline_configs_file=<config dir>/p4_pipeline.pb.txt \
>        --chassis_config_file=<config dir>/chassis_config.pb.txt \
>        --write_req_log_file=<config dir>/p4_writes.pb.txt \
>        --bf_sim
>
>
>
> Thanks,
>
>
> Deval.
>
>
> ------------------------------
> *From:* stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on
> behalf of Deval Bhamare via stratum-dev <
> stratum-dev at lists.stratumproject.org>
> *Sent:* Sunday, March 8, 2020 9:45:37 AM
> *To:* Yi Tseng
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
>
> Hi,
>
>
> By mistake I copied the incorrect logs, since I was trying it with
> different options.
>
> Even with BF 8.9.2, the error is the same as below:
>
>
> *ERROR: */stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule
> '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error
> executing command /usr/bin/gcc
> @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params
>
>
> Use --sandbox_debug to see verbose messages from the sandbox
>
> bazel-out/k8-fastbuild/bin/external/*com_github_p4lang_PI_bf_8_9_2*/_objs/pi/pi.pic.o:pi.c:function
> pi_init: error: undefined reference to '_pi_init'
>
> bazel-out/k8-fastbuild/bin/external/*com_github_p4lang_PI_bf_8_9_2*/_objs/pi/pi.pic.o:pi.c:function
> pi_assign_device: error: undefined reference to '_pi_assign_device'
>
> .... and so on....
>
>
> Thanks,
>
> Deval
> ------------------------------
> *From:* Yi Tseng <yi at opennetworking.org>
> *Sent:* Sunday, March 8, 2020 2:34:22 AM
> *To:* Deval Bhamare
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
> Hi Deval,
>
> According to the log from your latest email, for example:
>
> "bazel-out/k8-fastbuild/bin/external/*com_github_p4lang_PI_**bf_9_1_0*/_objs/pi/pi.pic.o:pi.c:function
> pi_init: error: undefined reference to '_pi_init'"
>
> Looks like you are still trying to compile Stratum with 9.1.0 dependency
>
> Is there a reason you want to use 8.9.0 instead of 8.9.2 or 9.1.0?
>
>
>
> On Sat, Mar 7, 2020 at 2:00 AM Deval Bhamare <Deval.Bhamare at kau.se> wrote:
>
>> Hello Yi,
>>
>>
>> I am answering all your question here. Yes, libbf_switchd_lib.so exists
>> in/bf-sde-8.9.0/install/lib/. That error is resolved now.
>>
>>
>> As I have mentioned, I am stuck at the GCC error mentioned earlier (and
>> below).
>>
>>
>> "The BSP is optional for Stratum, you can have the BSP installed in your
>> SDE_INSTALL directory or not."
>>
>>
>> >> So it means even if I am using * --define phal_with_onlp=false *and
>> relying on BSP, nothing different needs to be done besides compiling BF SDE
>> with BSP, which i have already done.
>>
>>
>> So what can be the issue with the GCC error I am getting and how to
>> resolve it (pasting below again)
>>
>>
>> *ERROR: */stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule
>> '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error
>> executing command /usr/bin/gcc
>> @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params
>>
>> Use --sandbox_debug to see verbose messages from the sandbox
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>> pi_init: error: undefined reference to '_pi_init'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>> pi_assign_device: error: undefined reference to '_pi_assign_device'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>> pi_update_device_start: error: undefined reference to
>> '_pi_update_device_start'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>> pi_update_device_end: error: undefined reference to '_pi_update_device_end'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>> pi_remove_device: error: undefined reference to '_pi_remove_device'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>> pi_session_init: error: undefined reference to '_pi_session_init'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>> pi_session_cleanup: error: undefined reference to '_pi_session_cleanup'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>> pi_batch_begin: error: undefined reference to '_pi_batch_begin'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>> pi_batch_end: error: undefined reference to '_pi_batch_end'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>> pi_destroy: error: undefined reference to '_pi_destroy'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>> pi_packetout_send: error: undefined reference to '_pi_packetout_send'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>> pi_port_status_get: error: undefined reference to '_pi_port_status_get'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>> pi_act_prof_mbr_create: error: undefined reference to
>> '_pi_act_prof_mbr_create'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>> pi_act_prof_mbr_delete: error: undefined reference to
>> '_pi_act_prof_mbr_delete'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>> pi_act_prof_mbr_modify: error: undefined reference to
>> '_pi_act_prof_mbr_modify'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>> pi_act_prof_grp_create: error: undefined reference to
>> '_pi_act_prof_grp_create'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>> pi_act_prof_grp_delete: error: undefined reference to
>> '_pi_act_prof_grp_delete'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>> pi_act_prof_grp_add_mbr: error: undefined reference to
>> '_pi_act_prof_grp_add_mbr'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>> pi_act_prof_grp_remove_mbr: error: undefined reference to
>> '_pi_act_prof_grp_remove_mbr'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>> pi_act_prof_grp_set_mbrs: error: undefined reference to
>> '_pi_act_prof_grp_set_mbrs'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>> pi_act_prof_grp_activate_mbr: error: undefined reference to
>> '_pi_act_prof_grp_activate_mbr'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>> pi_act_prof_grp_deactivate_mbr: error: undefined reference to
>> '_pi_act_prof_grp_deactivate_mbr'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>> pi_act_prof_entries_fetch: error: undefined reference to
>> '_pi_act_prof_entries_fetch'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>> pi_act_prof_mbr_fetch: error: undefined reference to
>> '_pi_act_prof_mbr_fetch'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>> pi_act_prof_grp_fetch: error: undefined reference to
>> '_pi_act_prof_grp_fetch'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>> pi_act_prof_entries_fetch_done: error: undefined reference to
>> '_pi_act_prof_entries_fetch_done'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>> pi_act_prof_api_support: error: undefined reference to
>> '_pi_act_prof_api_support'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_entry_add: error: undefined reference to '_pi_table_entry_add'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_default_action_set: error: undefined reference to
>> '_pi_table_default_action_set'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_default_action_reset: error: undefined reference to
>> '_pi_table_default_action_reset'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_default_action_get: error: undefined reference to
>> '_pi_table_default_action_get'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_default_action_done: error: undefined reference to
>> '_pi_table_default_action_done'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_default_action_get_handle: error: undefined reference to
>> '_pi_table_default_action_get_handle'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_entry_delete: error: undefined reference to
>> '_pi_table_entry_delete'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_entry_delete_wkey: error: undefined reference to
>> '_pi_table_entry_delete_wkey'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_entry_modify: error: undefined reference to
>> '_pi_table_entry_modify'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_entry_modify_wkey: error: undefined reference to
>> '_pi_table_entry_modify_wkey'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_entries_fetch: error: undefined reference to
>> '_pi_table_entries_fetch'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_entries_fetch_one: error: undefined reference to
>> '_pi_table_entries_fetch_one'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_entries_fetch_wkey: error: undefined reference to
>> '_pi_table_entries_fetch_wkey'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_entries_fetch_done: error: undefined reference to
>> '_pi_table_entries_fetch_done'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_idle_timeout_config_set: error: undefined reference to
>> '_pi_table_idle_timeout_config_set'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>> pi_table_entry_get_remaining_ttl: error: undefined reference to
>> '_pi_table_entry_get_remaining_ttl'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
>> pi_meter_read: error: undefined reference to '_pi_meter_read'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
>> pi_meter_set: error: undefined reference to '_pi_meter_set'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
>> pi_meter_read_direct: error: undefined reference to '_pi_meter_read_direct'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
>> pi_meter_set_direct: error: undefined reference to '_pi_meter_set_direct'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>> pi_mc_session_init: error: undefined reference to '_pi_mc_session_init'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>> pi_mc_session_cleanup: error: undefined reference to
>> '_pi_mc_session_cleanup'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>> pi_mc_grp_create: error: undefined reference to '_pi_mc_grp_create'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>> pi_mc_grp_delete: error: undefined reference to '_pi_mc_grp_delete'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>> pi_mc_node_create: error: undefined reference to '_pi_mc_node_create'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>> pi_mc_node_modify: error: undefined reference to '_pi_mc_node_modify'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>> pi_mc_node_delete: error: undefined reference to '_pi_mc_node_delete'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>> pi_mc_grp_attach_node: error: undefined reference to
>> '_pi_mc_grp_attach_node'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>> pi_mc_grp_detach_node: error: undefined reference to
>> '_pi_mc_grp_detach_node'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function
>> pi_learn_config_set: error: undefined reference to '_pi_learn_config_set'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function
>> pi_learn_msg_ack: error: undefined reference to '_pi_learn_msg_ack'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function
>> pi_learn_msg_done: error: undefined reference to '_pi_learn_msg_done'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
>> pi_counter_read: error: undefined reference to '_pi_counter_read'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
>> pi_counter_write: error: undefined reference to '_pi_counter_write'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
>> pi_counter_read_direct: error: undefined reference to
>> '_pi_counter_read_direct'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
>> pi_counter_write_direct: error: undefined reference to
>> '_pi_counter_write_direct'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
>> pi_counter_hw_sync: error: undefined reference to '_pi_counter_hw_sync'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function
>> pi_clone_session_set: error: undefined reference to '_pi_clone_session_set'
>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function
>> pi_clone_session_reset: error: undefined reference to
>> '_pi_clone_session_reset'
>> collect2: error: ld returned 1 exit status
>> Target //stratum/hal/bin/barefoot:stratum_bf failed to build
>> Use --verbose_failures to see the command lines of failed build steps.
>> INFO: Elapsed time: 95.850s, Critical Path: 56.95s
>> INFO: 1141 processes: 1141 processwrapper-sandbox.
>> *FAILED:* Build did NOT complete successfully
>>
>>
>> Thanks,
>>
>> Deval.
>> ------------------------------
>> *From:* Yi Tseng <yi at opennetworking.org>
>> *Sent:* Saturday, March 7, 2020 4:46:10 AM
>> *To:* Deval Bhamare
>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>
>> Hi Deval,
>>
>> The BSP is optional for Stratum, you can have the BSP installed in your
>> SDE_INSTALL directory or not.
>>
>> On Fri, Mar 6, 2020 at 2:34 AM Deval Bhamare <Deval.Bhamare at kau.se>
>> wrote:
>>
>>> Hello Yi,
>>>
>>>
>>> I just want to add that, I am doing it without ONLP support  (*--define
>>> phal_with_onlp=false*)
>>>
>>>
>>> We have built the BF SDE 8.9.0 with BF2556X-1T_BSP_8.9.0-master and I
>>> have copied the BF SDE folder to Stratum Container. Do I have to copy the
>>> BSP folder as well?
>>>
>>>
>>> Thanks,
>>>
>>> Deval.
>>>
>>>
>
> --
> Yi Tseng
> Member of Technical Staff
> Open Networking Foundation
> https://www.opennetworking.org/
>


-- 
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200309/cbcf3d39/attachment-0001.html>

From yi at opennetworking.org  Mon Mar  9 19:00:00 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Mon, 9 Mar 2020 12:00:00 -0700
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <3334ec1599bd419d8b996bac91ec36eb@kau.se>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
Message-ID: <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>

Hi Deval,

According to the README of Stratum. You need to remove the thrift package
if you are using SDE 8.9.x and use Stratum profile (*see step 3*)
https://github.com/stratum/stratum/tree/master/stratum/hal/bin/barefoot#installing-the-sde

cd $SDE/p4studio_build
*sed -i.bak '/package_dependencies/d; /thrift/d'
profiles/stratum_profile.yaml  # For SDE version <= 8.9.x*
./p4studio_build.py -up profiles/stratum_profile.yaml



On Mon, Mar 9, 2020 at 9:58 AM Deval Bhamare <Deval.Bhamare at kau.se> wrote:

> Okay, thank you.
>
>
> So I created the config directory and put some dummy files initially. Then
> I executed the command from inside the docker container.
>
>
> Now I am getting *libthrift-0.9.2.so <http://libthrift-0.9.2.so> missing*
> at runtime. If I search for it, I can find that file under BF_SDE folder
> inside the stratum. Also, my BF_SDE_INSTALL is already set (shouldn't be
> a problem as my build worked, right?)
>
>
> I couldn't find from where the call for libthrift-0.9.2.so is made. Maybe
> form some binary file?
>
>
> What maybe missing?
>
>
> Thanks,
>
> Deval.
>
>
> ------------------------------
> *From:* Yi Tseng <yi at opennetworking.org>
> *Sent:* Monday, March 9, 2020 6:43:56 PM
> *To:* Deval Bhamare
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
> Hi Deval,
>
> The *config dir* is the directory you put config files, for example, *
> $HOME/stratum_configs*
>
> The *forwarding_pipeline_configs_file* is the file we store pipeline
> configs, this file will be created when a controller push the pipeline via
> P4Runtime.
>
>
>
> On Mon, Mar 9, 2020 at 9:14 AM Deval Bhamare <Deval.Bhamare at kau.se> wrote:
>
>> Hello,
>>
>>
>> The Link error has been resolved (you need to build the BF SDE with
>> stratum_profile option, which has the PI libraries included, and not ALL).
>>
>>
>> Now, while running the stratum, I found the command below from the repo
>> page. However, I have following doubts about it such as:
>>
>> 1. What is  <config dir> ?
>>
>> 2. Where can I find or how should I prepare file p4_pipeline.pb.txt?
>>
>>
>> Command is below:
>>
>>
>> sudo LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib \
>>      ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
>>        --external_stratum_urls=0.0.0.0:28000 \
>>        --grpc_max_recv_msg_size=256 \
>>        --bf_sde_install=$BF_SDE_INSTALL \
>>        --persistent_config_dir=<config dir> \
>>        --forwarding_pipeline_configs_file=<config dir>/p4_pipeline.pb.txt \
>>        --chassis_config_file=<config dir>/chassis_config.pb.txt \
>>        --write_req_log_file=<config dir>/p4_writes.pb.txt \
>>        --bf_sim
>>
>>
>>
>> Thanks,
>>
>>
>> Deval.
>>
>>
>> ------------------------------
>> *From:* stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on
>> behalf of Deval Bhamare via stratum-dev <
>> stratum-dev at lists.stratumproject.org>
>> *Sent:* Sunday, March 8, 2020 9:45:37 AM
>> *To:* Yi Tseng
>> *Cc:* stratum-dev at lists.stratumproject.org
>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>
>>
>> Hi,
>>
>>
>> By mistake I copied the incorrect logs, since I was trying it with
>> different options.
>>
>> Even with BF 8.9.2, the error is the same as below:
>>
>>
>> *ERROR: */stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule
>> '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error
>> executing command /usr/bin/gcc
>> @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params
>>
>>
>> Use --sandbox_debug to see verbose messages from the sandbox
>>
>> bazel-out/k8-fastbuild/bin/external/*com_github_p4lang_PI_bf_8_9_2*/_objs/pi/pi.pic.o:pi.c:function
>> pi_init: error: undefined reference to '_pi_init'
>>
>> bazel-out/k8-fastbuild/bin/external/*com_github_p4lang_PI_bf_8_9_2*/_objs/pi/pi.pic.o:pi.c:function
>> pi_assign_device: error: undefined reference to '_pi_assign_device'
>>
>> .... and so on....
>>
>>
>> Thanks,
>>
>> Deval
>> ------------------------------
>> *From:* Yi Tseng <yi at opennetworking.org>
>> *Sent:* Sunday, March 8, 2020 2:34:22 AM
>> *To:* Deval Bhamare
>> *Cc:* stratum-dev at lists.stratumproject.org
>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>
>> Hi Deval,
>>
>> According to the log from your latest email, for example:
>>
>> "bazel-out/k8-fastbuild/bin/external/*com_github_p4lang_PI_**bf_9_1_0*/_objs/pi/pi.pic.o:pi.c:function
>> pi_init: error: undefined reference to '_pi_init'"
>>
>> Looks like you are still trying to compile Stratum with 9.1.0 dependency
>>
>> Is there a reason you want to use 8.9.0 instead of 8.9.2 or 9.1.0?
>>
>>
>>
>> On Sat, Mar 7, 2020 at 2:00 AM Deval Bhamare <Deval.Bhamare at kau.se>
>> wrote:
>>
>>> Hello Yi,
>>>
>>>
>>> I am answering all your question here. Yes, libbf_switchd_lib.so exists
>>> in/bf-sde-8.9.0/install/lib/. That error is resolved now.
>>>
>>>
>>> As I have mentioned, I am stuck at the GCC error mentioned earlier (and
>>> below).
>>>
>>>
>>> "The BSP is optional for Stratum, you can have the BSP installed in
>>> your SDE_INSTALL directory or not."
>>>
>>>
>>> >> So it means even if I am using * --define phal_with_onlp=false *and
>>> relying on BSP, nothing different needs to be done besides compiling BF SDE
>>> with BSP, which i have already done.
>>>
>>>
>>> So what can be the issue with the GCC error I am getting and how to
>>> resolve it (pasting below again)
>>>
>>>
>>> *ERROR: */stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule
>>> '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error
>>> executing command /usr/bin/gcc
>>> @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params
>>>
>>> Use --sandbox_debug to see verbose messages from the sandbox
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>>> pi_init: error: undefined reference to '_pi_init'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>>> pi_assign_device: error: undefined reference to '_pi_assign_device'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>>> pi_update_device_start: error: undefined reference to
>>> '_pi_update_device_start'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>>> pi_update_device_end: error: undefined reference to '_pi_update_device_end'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>>> pi_remove_device: error: undefined reference to '_pi_remove_device'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>>> pi_session_init: error: undefined reference to '_pi_session_init'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>>> pi_session_cleanup: error: undefined reference to '_pi_session_cleanup'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>>> pi_batch_begin: error: undefined reference to '_pi_batch_begin'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>>> pi_batch_end: error: undefined reference to '_pi_batch_end'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>>> pi_destroy: error: undefined reference to '_pi_destroy'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>>> pi_packetout_send: error: undefined reference to '_pi_packetout_send'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function
>>> pi_port_status_get: error: undefined reference to '_pi_port_status_get'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>>> pi_act_prof_mbr_create: error: undefined reference to
>>> '_pi_act_prof_mbr_create'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>>> pi_act_prof_mbr_delete: error: undefined reference to
>>> '_pi_act_prof_mbr_delete'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>>> pi_act_prof_mbr_modify: error: undefined reference to
>>> '_pi_act_prof_mbr_modify'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>>> pi_act_prof_grp_create: error: undefined reference to
>>> '_pi_act_prof_grp_create'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>>> pi_act_prof_grp_delete: error: undefined reference to
>>> '_pi_act_prof_grp_delete'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>>> pi_act_prof_grp_add_mbr: error: undefined reference to
>>> '_pi_act_prof_grp_add_mbr'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>>> pi_act_prof_grp_remove_mbr: error: undefined reference to
>>> '_pi_act_prof_grp_remove_mbr'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>>> pi_act_prof_grp_set_mbrs: error: undefined reference to
>>> '_pi_act_prof_grp_set_mbrs'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>>> pi_act_prof_grp_activate_mbr: error: undefined reference to
>>> '_pi_act_prof_grp_activate_mbr'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>>> pi_act_prof_grp_deactivate_mbr: error: undefined reference to
>>> '_pi_act_prof_grp_deactivate_mbr'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>>> pi_act_prof_entries_fetch: error: undefined reference to
>>> '_pi_act_prof_entries_fetch'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>>> pi_act_prof_mbr_fetch: error: undefined reference to
>>> '_pi_act_prof_mbr_fetch'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>>> pi_act_prof_grp_fetch: error: undefined reference to
>>> '_pi_act_prof_grp_fetch'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>>> pi_act_prof_entries_fetch_done: error: undefined reference to
>>> '_pi_act_prof_entries_fetch_done'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function
>>> pi_act_prof_api_support: error: undefined reference to
>>> '_pi_act_prof_api_support'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_entry_add: error: undefined reference to '_pi_table_entry_add'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_default_action_set: error: undefined reference to
>>> '_pi_table_default_action_set'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_default_action_reset: error: undefined reference to
>>> '_pi_table_default_action_reset'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_default_action_get: error: undefined reference to
>>> '_pi_table_default_action_get'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_default_action_done: error: undefined reference to
>>> '_pi_table_default_action_done'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_default_action_get_handle: error: undefined reference to
>>> '_pi_table_default_action_get_handle'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_entry_delete: error: undefined reference to
>>> '_pi_table_entry_delete'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_entry_delete_wkey: error: undefined reference to
>>> '_pi_table_entry_delete_wkey'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_entry_modify: error: undefined reference to
>>> '_pi_table_entry_modify'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_entry_modify_wkey: error: undefined reference to
>>> '_pi_table_entry_modify_wkey'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_entries_fetch: error: undefined reference to
>>> '_pi_table_entries_fetch'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_entries_fetch_one: error: undefined reference to
>>> '_pi_table_entries_fetch_one'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_entries_fetch_wkey: error: undefined reference to
>>> '_pi_table_entries_fetch_wkey'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_entries_fetch_done: error: undefined reference to
>>> '_pi_table_entries_fetch_done'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_idle_timeout_config_set: error: undefined reference to
>>> '_pi_table_idle_timeout_config_set'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function
>>> pi_table_entry_get_remaining_ttl: error: undefined reference to
>>> '_pi_table_entry_get_remaining_ttl'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
>>> pi_meter_read: error: undefined reference to '_pi_meter_read'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
>>> pi_meter_set: error: undefined reference to '_pi_meter_set'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
>>> pi_meter_read_direct: error: undefined reference to '_pi_meter_read_direct'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function
>>> pi_meter_set_direct: error: undefined reference to '_pi_meter_set_direct'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>>> pi_mc_session_init: error: undefined reference to '_pi_mc_session_init'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>>> pi_mc_session_cleanup: error: undefined reference to
>>> '_pi_mc_session_cleanup'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>>> pi_mc_grp_create: error: undefined reference to '_pi_mc_grp_create'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>>> pi_mc_grp_delete: error: undefined reference to '_pi_mc_grp_delete'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>>> pi_mc_node_create: error: undefined reference to '_pi_mc_node_create'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>>> pi_mc_node_modify: error: undefined reference to '_pi_mc_node_modify'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>>> pi_mc_node_delete: error: undefined reference to '_pi_mc_node_delete'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>>> pi_mc_grp_attach_node: error: undefined reference to
>>> '_pi_mc_grp_attach_node'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function
>>> pi_mc_grp_detach_node: error: undefined reference to
>>> '_pi_mc_grp_detach_node'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function
>>> pi_learn_config_set: error: undefined reference to '_pi_learn_config_set'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function
>>> pi_learn_msg_ack: error: undefined reference to '_pi_learn_msg_ack'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function
>>> pi_learn_msg_done: error: undefined reference to '_pi_learn_msg_done'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
>>> pi_counter_read: error: undefined reference to '_pi_counter_read'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
>>> pi_counter_write: error: undefined reference to '_pi_counter_write'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
>>> pi_counter_read_direct: error: undefined reference to
>>> '_pi_counter_read_direct'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
>>> pi_counter_write_direct: error: undefined reference to
>>> '_pi_counter_write_direct'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function
>>> pi_counter_hw_sync: error: undefined reference to '_pi_counter_hw_sync'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function
>>> pi_clone_session_set: error: undefined reference to '_pi_clone_session_set'
>>> bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function
>>> pi_clone_session_reset: error: undefined reference to
>>> '_pi_clone_session_reset'
>>> collect2: error: ld returned 1 exit status
>>> Target //stratum/hal/bin/barefoot:stratum_bf failed to build
>>> Use --verbose_failures to see the command lines of failed build steps.
>>> INFO: Elapsed time: 95.850s, Critical Path: 56.95s
>>> INFO: 1141 processes: 1141 processwrapper-sandbox.
>>> *FAILED:* Build did NOT complete successfully
>>>
>>>
>>> Thanks,
>>>
>>> Deval.
>>> ------------------------------
>>> *From:* Yi Tseng <yi at opennetworking.org>
>>> *Sent:* Saturday, March 7, 2020 4:46:10 AM
>>> *To:* Deval Bhamare
>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>
>>> Hi Deval,
>>>
>>> The BSP is optional for Stratum, you can have the BSP installed in your
>>> SDE_INSTALL directory or not.
>>>
>>> On Fri, Mar 6, 2020 at 2:34 AM Deval Bhamare <Deval.Bhamare at kau.se>
>>> wrote:
>>>
>>>> Hello Yi,
>>>>
>>>>
>>>> I just want to add that, I am doing it without ONLP support  (*--define
>>>> phal_with_onlp=false*)
>>>>
>>>>
>>>> We have built the BF SDE 8.9.0 with BF2556X-1T_BSP_8.9.0-master and I
>>>> have copied the BF SDE folder to Stratum Container. Do I have to copy the
>>>> BSP folder as well?
>>>>
>>>>
>>>> Thanks,
>>>>
>>>> Deval.
>>>>
>>>>
>>
>> --
>> Yi Tseng
>> Member of Technical Staff
>> Open Networking Foundation
>> https://www.opennetworking.org/
>>
>
>
> --
> Yi Tseng
> Member of Technical Staff
> Open Networking Foundation
> https://www.opennetworking.org/
>


-- 
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200309/18927522/attachment-0001.html>

From ain at opennetworking.org  Mon Mar  9 20:16:09 2020
From: ain at opennetworking.org (Ain Indermitte)
Date: Mon, 9 Mar 2020 13:16:09 -0700
Subject: [stratum-dev] ACTION REQUIRED: Sign your ONF CLA before April 1,
	2020!
In-Reply-To: <CACZfwXup8Fgozb1WDqKok3kHMB7cgu8vxxKNyCwfDrYjG5wFaA@mail.gmail.com>
References: <CACZfwXup8Fgozb1WDqKok3kHMB7cgu8vxxKNyCwfDrYjG5wFaA@mail.gmail.com>
Message-ID: <CACZfwXueTHUHCXzNAbkcfvJR-QJrhh6KKi6tvUat-ZNDEGbgsA@mail.gmail.com>

Hello ONF developers and contributors,

ONF is happy to announce that it is moving to an automated system for
Contributor License Agreement (CLA) management. This will make it easier
for you to create and manage your Individual and Institutional (Corporate)
CLAs. It requires you to take action - log into the CLA Manager
<https://cla.opennetworking.org/>, sign a CLA, and add the email and/or
GitHub user identities you use to contribute source code. Please sign the
CLA and add these identities <https://cla.opennetworking.org/> before April
1, 2020. Starting April 1st, you will not be able to make contributions
through GitHub or Gerrit unless you have a valid CLA in place.

More about CLAs:

   -

   A CLA is a legal document in which a contributor states that they are
   entitled to contribute the code/documentation/translation to the project
   and are willing to have it used in distributions and derivative works.
   Should there be any kind of legal issue in the future regarding the origins
   and ownership of any particular piece of code, the project will have the
   necessary forms on file from the contributor(s) saying they were permitted
   to make this contribution.
   -

   The CLA also ensures that once a contributor has provided a
   contribution, they cannot try to withdraw permission for its use at a later
   date. People and companies can therefore use that software, confident that
   they will not be asked to stop using pieces of the code at a later date.
   -

   Whenever a non-ONF contributor wants to submit a contribution to an ONF
   open source project, they must first sign a CLA. This allows the
   contributor to retain their ownership in the code submitted while granting
   ONF the necessary legal rights to use and relicense that contribution. The
   CLA only needs to be signed once and it covers all unrestricted Apache 2.0
   ONF projects.


Note that there are two types of CLAs - Individual and Institutional
(Corporate). Most source code contributions made to ONF projects are made
on behalf of developers working for corporations that hold copyright to
those contributions. You will need to know your companys process to
authorize making open source contributions - in some cases, if your company
has an existing membership or partner relationship with ONF, this
authorization might have already been given. The CLA Manager
<https://cla.opennetworking.org/> will ask you if you have the authority to
sign your CLA. If you do, you should sign the Individual CLA. However, if
you do not, the CLA Manager <https://cla.opennetworking.org/> suggests a
sample email you should send to the person who has this authority. The
authorized person should then sign the Institutional CLA and add your email
and/or GitHub user identities to the Institutional CLA.

You can find additional information about the ONF CLA process here
<https://wiki.opennetworking.org/x/BgCUI>. Feel free to contact us at
help at opennetworking.org.

Finally, please take a few moments now to sign your CLA in the ONF CLA
Manager <https://cla.opennetworking.org/>.

With best regards,

-- 
Ain Indermitte
Senior Director, Head of Developer Relations
Open Networking Foundation
+1-408-431-9939
ain at opennetworking.org


[BCC:
aether-dev at opennetworking.org
comac-dev at opennetworking.org

odtn at opennetworking.org

seba-dev at opennetworking.org

trellis-dev at opennetworking.org

information-modeling at opennetworking.org

omec-dev at opennetworking.org

onos-dev at onosproject.org

opentransport at opennetworking.org

p4-dev at lists.p4.org

stratum-dev at lists.stratumproject.org <stratum-dev at stratumproject.org>

voltha-discuss at opencord.org

devel at xosproject.org

cord-dev at opencord.org

]
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200309/02cb2d1f/attachment.html>

From Deval.Bhamare at kau.se  Tue Mar 10 13:46:33 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Tue, 10 Mar 2020 13:46:33 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>,
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
Message-ID: <30c96be70f2145eda3593d67d5d04031@kau.se>

Okay,


in that case how do we support fixed function APIs in Toifno? These APIs need Thrift support.


Thanks,

Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Monday, March 9, 2020 9:00:00 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hi Deval,

According to the README of Stratum. You need to remove the thrift package if you are using SDE 8.9.x and use Stratum profile (see step 3)
https://github.com/stratum/stratum/tree/master/stratum/hal/bin/barefoot#installing-the-sde

cd $SDE/p4studio_build
sed -i.bak '/package_dependencies/d; /thrift/d' profiles/stratum_profile.yaml  # For SDE version <= 8.9.x
./p4studio_build.py -up profiles/stratum_profile.yaml



On Mon, Mar 9, 2020 at 9:58 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Okay, thank you.


So I created the config directory and put some dummy files initially. Then I executed the command from inside the docker container.


Now I am getting libthrift-0.9.2.so<http://libthrift-0.9.2.so> missing at runtime. If I search for it, I can find that file under BF_SDE folder inside the stratum. Also, my BF_SDE_INSTALL is already set (shouldn't be a problem as my build worked, right?)


I couldn't find from where the call for libthrift-0.9.2.so<http://libthrift-0.9.2.so> is made. Maybe form some binary file?


What maybe missing?


Thanks,

Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Monday, March 9, 2020 6:43:56 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

The config dir is the directory you put config files, for example, $HOME/stratum_configs

The forwarding_pipeline_configs_file is the file we store pipeline configs, this file will be created when a controller push the pipeline via P4Runtime.



On Mon, Mar 9, 2020 at 9:14 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello,


The Link error has been resolved (you need to build the BF SDE with stratum_profile option, which has the PI libraries included, and not ALL).


Now, while running the stratum, I found the command below from the repo page. However, I have following doubts about it such as:

1. What is  <config dir> ?

2. Where can I find or how should I prepare file p4_pipeline.pb.txt?


Command is below:


sudo LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib \
     ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
       --external_stratum_urls=0.0.0.0:28000<http://0.0.0.0:28000> \
       --grpc_max_recv_msg_size=256 \
       --bf_sde_install=$BF_SDE_INSTALL \
       --persistent_config_dir=<config dir> \
       --forwarding_pipeline_configs_file=<config dir>/p4_pipeline.pb.txt \
       --chassis_config_file=<config dir>/chassis_config.pb.txt \
       --write_req_log_file=<config dir>/p4_writes.pb.txt \
       --bf_sim



Thanks,


Deval.


________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org<mailto:stratum-dev-bounces at lists.stratumproject.org>> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>>
Sent: Sunday, March 8, 2020 9:45:37 AM
To: Yi Tseng
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hi,


By mistake I copied the incorrect logs, since I was trying it with different options.

Even with BF 8.9.2, the error is the same as below:


ERROR: /stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error executing command /usr/bin/gcc @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params


Use --sandbox_debug to see verbose messages from the sandbox

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_8_9_2/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_8_9_2/_objs/pi/pi.pic.o:pi.c:function pi_assign_device: error: undefined reference to '_pi_assign_device'


.... and so on....


Thanks,

Deval

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Sunday, March 8, 2020 2:34:22 AM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

According to the log from your latest email, for example:

"bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'"

Looks like you are still trying to compile Stratum with 9.1.0 dependency

Is there a reason you want to use 8.9.0 instead of 8.9.2 or 9.1.0?



On Sat, Mar 7, 2020 at 2:00 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I am answering all your question here. Yes, libbf_switchd_lib.so exists in/bf-sde-8.9.0/install/lib/. That error is resolved now.


As I have mentioned, I am stuck at the GCC error mentioned earlier (and below).


"The BSP is optional for Stratum, you can have the BSP installed in your SDE_INSTALL directory or not."


>> So it means even if I am using --define phal_with_onlp=false and relying on BSP, nothing different needs to be done besides compiling BF SDE with BSP, which i have already done.


So what can be the issue with the GCC error I am getting and how to resolve it (pasting below again)


ERROR: /stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error executing command /usr/bin/gcc @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params

Use --sandbox_debug to see verbose messages from the sandbox
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_assign_device: error: undefined reference to '_pi_assign_device'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_update_device_start: error: undefined reference to '_pi_update_device_start'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_update_device_end: error: undefined reference to '_pi_update_device_end'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_remove_device: error: undefined reference to '_pi_remove_device'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_session_init: error: undefined reference to '_pi_session_init'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_session_cleanup: error: undefined reference to '_pi_session_cleanup'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_batch_begin: error: undefined reference to '_pi_batch_begin'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_batch_end: error: undefined reference to '_pi_batch_end'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_destroy: error: undefined reference to '_pi_destroy'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_packetout_send: error: undefined reference to '_pi_packetout_send'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_port_status_get: error: undefined reference to '_pi_port_status_get'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_create: error: undefined reference to '_pi_act_prof_mbr_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_delete: error: undefined reference to '_pi_act_prof_mbr_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_modify: error: undefined reference to '_pi_act_prof_mbr_modify'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_create: error: undefined reference to '_pi_act_prof_grp_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_delete: error: undefined reference to '_pi_act_prof_grp_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_add_mbr: error: undefined reference to '_pi_act_prof_grp_add_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_remove_mbr: error: undefined reference to '_pi_act_prof_grp_remove_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_set_mbrs: error: undefined reference to '_pi_act_prof_grp_set_mbrs'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_activate_mbr: error: undefined reference to '_pi_act_prof_grp_activate_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_deactivate_mbr: error: undefined reference to '_pi_act_prof_grp_deactivate_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_entries_fetch: error: undefined reference to '_pi_act_prof_entries_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_fetch: error: undefined reference to '_pi_act_prof_mbr_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_fetch: error: undefined reference to '_pi_act_prof_grp_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_entries_fetch_done: error: undefined reference to '_pi_act_prof_entries_fetch_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_api_support: error: undefined reference to '_pi_act_prof_api_support'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_add: error: undefined reference to '_pi_table_entry_add'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_set: error: undefined reference to '_pi_table_default_action_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_reset: error: undefined reference to '_pi_table_default_action_reset'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_get: error: undefined reference to '_pi_table_default_action_get'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_done: error: undefined reference to '_pi_table_default_action_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_get_handle: error: undefined reference to '_pi_table_default_action_get_handle'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_delete: error: undefined reference to '_pi_table_entry_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_delete_wkey: error: undefined reference to '_pi_table_entry_delete_wkey'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_modify: error: undefined reference to '_pi_table_entry_modify'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_modify_wkey: error: undefined reference to '_pi_table_entry_modify_wkey'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch: error: undefined reference to '_pi_table_entries_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_one: error: undefined reference to '_pi_table_entries_fetch_one'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_wkey: error: undefined reference to '_pi_table_entries_fetch_wkey'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_done: error: undefined reference to '_pi_table_entries_fetch_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_idle_timeout_config_set: error: undefined reference to '_pi_table_idle_timeout_config_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_get_remaining_ttl: error: undefined reference to '_pi_table_entry_get_remaining_ttl'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_read: error: undefined reference to '_pi_meter_read'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_set: error: undefined reference to '_pi_meter_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_read_direct: error: undefined reference to '_pi_meter_read_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_set_direct: error: undefined reference to '_pi_meter_set_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_session_init: error: undefined reference to '_pi_mc_session_init'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_session_cleanup: error: undefined reference to '_pi_mc_session_cleanup'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_create: error: undefined reference to '_pi_mc_grp_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_delete: error: undefined reference to '_pi_mc_grp_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_create: error: undefined reference to '_pi_mc_node_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_modify: error: undefined reference to '_pi_mc_node_modify'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_delete: error: undefined reference to '_pi_mc_node_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_attach_node: error: undefined reference to '_pi_mc_grp_attach_node'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_detach_node: error: undefined reference to '_pi_mc_grp_detach_node'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_config_set: error: undefined reference to '_pi_learn_config_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_msg_ack: error: undefined reference to '_pi_learn_msg_ack'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_msg_done: error: undefined reference to '_pi_learn_msg_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_read: error: undefined reference to '_pi_counter_read'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_write: error: undefined reference to '_pi_counter_write'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_read_direct: error: undefined reference to '_pi_counter_read_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_write_direct: error: undefined reference to '_pi_counter_write_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_hw_sync: error: undefined reference to '_pi_counter_hw_sync'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function pi_clone_session_set: error: undefined reference to '_pi_clone_session_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function pi_clone_session_reset: error: undefined reference to '_pi_clone_session_reset'
collect2: error: ld returned 1 exit status
Target //stratum/hal/bin/barefoot:stratum_bf failed to build
Use --verbose_failures to see the command lines of failed build steps.
INFO: Elapsed time: 95.850s, Critical Path: 56.95s
INFO: 1141 processes: 1141 processwrapper-sandbox.
FAILED: Build did NOT complete successfully



Thanks,

Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Saturday, March 7, 2020 4:46:10 AM
To: Deval Bhamare
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

The BSP is optional for Stratum, you can have the BSP installed in your SDE_INSTALL directory or not.

On Fri, Mar 6, 2020 at 2:34 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I just want to add that, I am doing it without ONLP support  (--define phal_with_onlp=false)


We have built the BF SDE 8.9.0 with BF2556X-1T_BSP_8.9.0-master and I have copied the BF SDE folder to Stratum Container. Do I have to copy the BSP folder as well?


Thanks,

Deval.



--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200310/6be7c3d8/attachment-0001.html>

From Deval.Bhamare at kau.se  Tue Mar 10 20:27:06 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Tue, 10 Mar 2020 20:27:06 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>,
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
Message-ID: <bb9bcf366044401c814a3aadf17e53fe@kau.se>

Hi Yi,


in continuation to this thread, I did as per the suggestions below. The Build was successful.


cd $SDE/p4studio_build
sed -i.bak '/package_dependencies/d; /thrift/d' profiles/stratum_profile.yaml  # For SDE version <= 8.9.x
./p4studio_build.py -up profiles/stratum_profile.yaml


However, while running stratum, I am still getting the error:


./bazel-bin/stratum/hal/bin/barefoot/stratum_bf: error while loading shared libraries: libavago.so.0: cannot open shared object file: No such file or directory


My Run command (from inside the stratum-dev container) is:


sudo LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib \
     ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
       --external_stratum_urls=0.0.0.0:28000 \
       --grpc_max_recv_msg_size=256 \
       --bf_sde_install=$BF_SDE_INSTALL \
       --persistent_config_dir=/stratum/config/ \
       --forwarding_pipeline_configs_file=/stratum/config/p4_pipeline.pb.txt \
       --chassis_config_file=/stratum/config/chassis_config.pb.txt \
       --write_req_log_file=/stratum/config/p4_writes.pb.txt \
       --bf_sim


Some debug info:


echo $LD_LIBRARY_PATH/

>> /stratum/bf-sde-8.9.0/install/lib/


find .  -name 'libavago.so.0'

>> /stratum/bf-sde-8.9.0/install/lib/libavago.so.0


Reported missing file libavago.so.0 is located exactly in the defined path of $LD_LIBRARY_PATH/

Hope to get some solution.


Thanks,

Deval.



________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Monday, March 9, 2020 9:00:00 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hi Deval,

According to the README of Stratum. You need to remove the thrift package if you are using SDE 8.9.x and use Stratum profile (see step 3)
https://github.com/stratum/stratum/tree/master/stratum/hal/bin/barefoot#installing-the-sde

cd $SDE/p4studio_build
sed -i.bak '/package_dependencies/d; /thrift/d' profiles/stratum_profile.yaml  # For SDE version <= 8.9.x
./p4studio_build.py -up profiles/stratum_profile.yaml



On Mon, Mar 9, 2020 at 9:58 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Okay, thank you.


So I created the config directory and put some dummy files initially. Then I executed the command from inside the docker container.


Now I am getting libthrift-0.9.2.so<http://libthrift-0.9.2.so> missing at runtime. If I search for it, I can find that file under BF_SDE folder inside the stratum. Also, my BF_SDE_INSTALL is already set (shouldn't be a problem as my build worked, right?)


I couldn't find from where the call for libthrift-0.9.2.so<http://libthrift-0.9.2.so> is made. Maybe form some binary file?


What maybe missing?


Thanks,

Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Monday, March 9, 2020 6:43:56 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

The config dir is the directory you put config files, for example, $HOME/stratum_configs

The forwarding_pipeline_configs_file is the file we store pipeline configs, this file will be created when a controller push the pipeline via P4Runtime.



On Mon, Mar 9, 2020 at 9:14 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello,


The Link error has been resolved (you need to build the BF SDE with stratum_profile option, which has the PI libraries included, and not ALL).


Now, while running the stratum, I found the command below from the repo page. However, I have following doubts about it such as:

1. What is  <config dir> ?

2. Where can I find or how should I prepare file p4_pipeline.pb.txt?


Command is below:


sudo LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib \
     ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
       --external_stratum_urls=0.0.0.0:28000<http://0.0.0.0:28000> \
       --grpc_max_recv_msg_size=256 \
       --bf_sde_install=$BF_SDE_INSTALL \
       --persistent_config_dir=<config dir> \
       --forwarding_pipeline_configs_file=<config dir>/p4_pipeline.pb.txt \
       --chassis_config_file=<config dir>/chassis_config.pb.txt \
       --write_req_log_file=<config dir>/p4_writes.pb.txt \
       --bf_sim



Thanks,


Deval.


________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org<mailto:stratum-dev-bounces at lists.stratumproject.org>> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>>
Sent: Sunday, March 8, 2020 9:45:37 AM
To: Yi Tseng
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hi,


By mistake I copied the incorrect logs, since I was trying it with different options.

Even with BF 8.9.2, the error is the same as below:


ERROR: /stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error executing command /usr/bin/gcc @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params


Use --sandbox_debug to see verbose messages from the sandbox

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_8_9_2/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'

bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_8_9_2/_objs/pi/pi.pic.o:pi.c:function pi_assign_device: error: undefined reference to '_pi_assign_device'


.... and so on....


Thanks,

Deval

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Sunday, March 8, 2020 2:34:22 AM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

According to the log from your latest email, for example:

"bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'"

Looks like you are still trying to compile Stratum with 9.1.0 dependency

Is there a reason you want to use 8.9.0 instead of 8.9.2 or 9.1.0?



On Sat, Mar 7, 2020 at 2:00 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I am answering all your question here. Yes, libbf_switchd_lib.so exists in/bf-sde-8.9.0/install/lib/. That error is resolved now.


As I have mentioned, I am stuck at the GCC error mentioned earlier (and below).


"The BSP is optional for Stratum, you can have the BSP installed in your SDE_INSTALL directory or not."


>> So it means even if I am using --define phal_with_onlp=false and relying on BSP, nothing different needs to be done besides compiling BF SDE with BSP, which i have already done.


So what can be the issue with the GCC error I am getting and how to resolve it (pasting below again)


ERROR: /stratum/stratum/hal/bin/barefoot/BUILD:26:1: Linking of rule '//stratum/hal/bin/barefoot:stratum_bf' failed (Exit 1) gcc failed: error executing command /usr/bin/gcc @bazel-out/k8-fastbuild/bin/stratum/hal/bin/barefoot/stratum_bf-2.params

Use --sandbox_debug to see verbose messages from the sandbox
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_init: error: undefined reference to '_pi_init'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_assign_device: error: undefined reference to '_pi_assign_device'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_update_device_start: error: undefined reference to '_pi_update_device_start'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_update_device_end: error: undefined reference to '_pi_update_device_end'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_remove_device: error: undefined reference to '_pi_remove_device'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_session_init: error: undefined reference to '_pi_session_init'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_session_cleanup: error: undefined reference to '_pi_session_cleanup'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_batch_begin: error: undefined reference to '_pi_batch_begin'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_batch_end: error: undefined reference to '_pi_batch_end'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_destroy: error: undefined reference to '_pi_destroy'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_packetout_send: error: undefined reference to '_pi_packetout_send'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi.pic.o:pi.c:function pi_port_status_get: error: undefined reference to '_pi_port_status_get'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_create: error: undefined reference to '_pi_act_prof_mbr_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_delete: error: undefined reference to '_pi_act_prof_mbr_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_modify: error: undefined reference to '_pi_act_prof_mbr_modify'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_create: error: undefined reference to '_pi_act_prof_grp_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_delete: error: undefined reference to '_pi_act_prof_grp_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_add_mbr: error: undefined reference to '_pi_act_prof_grp_add_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_remove_mbr: error: undefined reference to '_pi_act_prof_grp_remove_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_set_mbrs: error: undefined reference to '_pi_act_prof_grp_set_mbrs'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_activate_mbr: error: undefined reference to '_pi_act_prof_grp_activate_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_deactivate_mbr: error: undefined reference to '_pi_act_prof_grp_deactivate_mbr'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_entries_fetch: error: undefined reference to '_pi_act_prof_entries_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_mbr_fetch: error: undefined reference to '_pi_act_prof_mbr_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_grp_fetch: error: undefined reference to '_pi_act_prof_grp_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_entries_fetch_done: error: undefined reference to '_pi_act_prof_entries_fetch_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_act_prof.pic.o:pi_act_prof.c:function pi_act_prof_api_support: error: undefined reference to '_pi_act_prof_api_support'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_add: error: undefined reference to '_pi_table_entry_add'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_set: error: undefined reference to '_pi_table_default_action_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_reset: error: undefined reference to '_pi_table_default_action_reset'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_get: error: undefined reference to '_pi_table_default_action_get'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_done: error: undefined reference to '_pi_table_default_action_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_default_action_get_handle: error: undefined reference to '_pi_table_default_action_get_handle'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_delete: error: undefined reference to '_pi_table_entry_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_delete_wkey: error: undefined reference to '_pi_table_entry_delete_wkey'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_modify: error: undefined reference to '_pi_table_entry_modify'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_modify_wkey: error: undefined reference to '_pi_table_entry_modify_wkey'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch: error: undefined reference to '_pi_table_entries_fetch'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_one: error: undefined reference to '_pi_table_entries_fetch_one'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_wkey: error: undefined reference to '_pi_table_entries_fetch_wkey'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entries_fetch_done: error: undefined reference to '_pi_table_entries_fetch_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_idle_timeout_config_set: error: undefined reference to '_pi_table_idle_timeout_config_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_tables.pic.o:pi_tables.c:function pi_table_entry_get_remaining_ttl: error: undefined reference to '_pi_table_entry_get_remaining_ttl'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_read: error: undefined reference to '_pi_meter_read'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_set: error: undefined reference to '_pi_meter_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_read_direct: error: undefined reference to '_pi_meter_read_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_meter.pic.o:pi_meter.c:function pi_meter_set_direct: error: undefined reference to '_pi_meter_set_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_session_init: error: undefined reference to '_pi_mc_session_init'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_session_cleanup: error: undefined reference to '_pi_mc_session_cleanup'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_create: error: undefined reference to '_pi_mc_grp_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_delete: error: undefined reference to '_pi_mc_grp_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_create: error: undefined reference to '_pi_mc_node_create'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_modify: error: undefined reference to '_pi_mc_node_modify'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_node_delete: error: undefined reference to '_pi_mc_node_delete'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_attach_node: error: undefined reference to '_pi_mc_grp_attach_node'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_mc.pic.o:pi_mc.c:function pi_mc_grp_detach_node: error: undefined reference to '_pi_mc_grp_detach_node'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_config_set: error: undefined reference to '_pi_learn_config_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_msg_ack: error: undefined reference to '_pi_learn_msg_ack'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_learn.pic.o:pi_learn.c:function pi_learn_msg_done: error: undefined reference to '_pi_learn_msg_done'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_read: error: undefined reference to '_pi_counter_read'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_write: error: undefined reference to '_pi_counter_write'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_read_direct: error: undefined reference to '_pi_counter_read_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_write_direct: error: undefined reference to '_pi_counter_write_direct'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_counter.pic.o:pi_counter.c:function pi_counter_hw_sync: error: undefined reference to '_pi_counter_hw_sync'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function pi_clone_session_set: error: undefined reference to '_pi_clone_session_set'
bazel-out/k8-fastbuild/bin/external/com_github_p4lang_PI_bf_9_1_0/_objs/pi/pi_clone.pic.o:pi_clone.c:function pi_clone_session_reset: error: undefined reference to '_pi_clone_session_reset'
collect2: error: ld returned 1 exit status
Target //stratum/hal/bin/barefoot:stratum_bf failed to build
Use --verbose_failures to see the command lines of failed build steps.
INFO: Elapsed time: 95.850s, Critical Path: 56.95s
INFO: 1141 processes: 1141 processwrapper-sandbox.
FAILED: Build did NOT complete successfully



Thanks,

Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Saturday, March 7, 2020 4:46:10 AM
To: Deval Bhamare
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

The BSP is optional for Stratum, you can have the BSP installed in your SDE_INSTALL directory or not.

On Fri, Mar 6, 2020 at 2:34 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I just want to add that, I am doing it without ONLP support  (--define phal_with_onlp=false)


We have built the BF SDE 8.9.0 with BF2556X-1T_BSP_8.9.0-master and I have copied the BF SDE folder to Stratum Container. Do I have to copy the BSP folder as well?


Thanks,

Deval.



--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200310/3237a253/attachment-0001.html>

From yi at opennetworking.org  Thu Mar 12 04:57:14 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Thu, 12 Mar 2020 12:57:14 +0800
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
Message-ID: <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot
API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include
the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub
<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>,
feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

*LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd
./bazel-bin/stratum/hal/bin/barefoot/stratum_bf*

I think the system linker may have some issue to find the library.

The *libavago.so.0 *is a symbolic link to *libavago.so*. the libavago.so
must also exists.



*ls -al $BF_SDE_INSTALL/lib/libavago*-rwxr-xr-x 1 root root 1185264 Mar 12
04:19 libavago.solrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0
-> libavago.solrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0
-> libavago.so*
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200312/7918ae82/attachment.html>

From Deval.Bhamare at kau.se  Thu Mar 12 10:30:34 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Thu, 12 Mar 2020 10:30:34 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>,
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
Message-ID: <d77fb57e693045938342ae57f2c6d4ac@kau.se>

Hello Yi,


For Building Stratum Dev we have resolved the issue already with and without BSP.

The soft-links in Lib are pointing to the Libs using Hardcoded absolute path, which is not available from within the container. So had to delete them and create again pointing to local Libs. Also have to explicitly install the library libpltfm_mgr.


I will check the direct Docker option later-on.


Now Stratum in running, but with error below in the end (screenshot is attached).


Configuration for dev_id 0

  Family        : Tofino

  pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0

  pci_domain    : 0

  pci_bus       : 5

  pci_fn        : 0

  pci_dev       : 0

  pci_int_mode  : 1

  sbus_master_fw: /stratum/bf-sde-8.9.0/install/

  pcie_fw       : /stratum/bf-sde-8.9.0/install/

  serdes_fw     : /stratum/bf-sde-8.9.0/install/

  sds_fw_path   : /stratum/bf-sde-8.9.0/install/

  microp_fw_path:

bf_switchd: processing P4 configuration...

P4 profile for dev_id 0

  p4_name: dummy

    libpd:

    libpdthrift:

    context:

    config:

  Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so

  diag:

  mavericks diag:

  non_default_port_ppgs: 0

  SAI default initialize: 1

bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so loaded

bf_switchd: agent[0] initialized

Tcl server started..

Tcl server: listen socket created

Tcl server: bind done on port 8008, listening...

Tcl server: waiting for incoming connections...

sh: 1: onie-syseeprom: not found



2020-03-12 10:19:54.510206 BF_PLTFM ERROR - Error in cp2112 initialization


2020-03-12 10:19:54.510309 BF_PLTFM ERROR - pltfm_mgr: platform init failed



So, looks like BF platform initilization is failing. Also, what is onie-syseeprom


I also had a doubt that, is the port 28000 available outside the container? I cannot see any process listening on port 28000 or 8008 (given in the message above) from outside the container.


Thanks,

Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Thursday, March 12, 2020 6:57:14 AM
To: Deval Bhamare
Cc: Narada Hess; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>, feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf

I think the system linker may have some issue to find the library.

The libavago.so.0 is a symbolic link to libavago.so. the libavago.so must also exists.
ls -al $BF_SDE_INSTALL/lib/libavago*
-rwxr-xr-x 1 root root 1185264 Mar 12 04:19 libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0 -> libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0 -> libavago.so


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200312/cca01e1b/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Screen Shot 2020-03-11 at 17.34.18.png
Type: image/png
Size: 91046 bytes
Desc: Screen Shot 2020-03-11 at 17.34.18.png
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200312/cca01e1b/attachment-0001.png>

From yi at opennetworking.org  Sat Mar 14 05:37:41 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Sat, 14 Mar 2020 13:37:41 +0800
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <d77fb57e693045938342ae57f2c6d4ac@kau.se>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <d77fb57e693045938342ae57f2c6d4ac@kau.se>
Message-ID: <CAOyFVR1MywKy1cQZJuKO9np3SYoQB5B5Ox8t1Lo22-9H_kXnWw@mail.gmail.com>

Hi Deval,

As far as I know, "onie-syseeprom" is a tool which included in ONIE. The
BSP tries to use "onie-syseeprom" to read some information from the board.

However, I don't think ONL includes the onie-syseeprom tool (tried to
search from ONL master but only got onie-sysinfo and onie-shell tool)

In ONIE shell, you should be able to run "onie-syseeprom" command and get
information like below:




















*TlvInfo Header:   Id String:    TlvInfo   Version:      1   Total Length:
153TLV Name             Code Len Value-------------------- ---- ---
-----Product Name         0x21  10 BF2556X-1TPart Number          0x22  14
BF2556X-1T-A1FSerial Number        0x23  18 BF2556X1TXXXXXXXXXBase MAC
Address     0x24   6 XX:XX:XX:XX:XX:XXManufacture Date     0x25  19
07/08/2019 14:07:40Device Version       0x26   1 1Platform Name        0x28
 28 x86_64-stordis_bf2556x_1t-r0ONIE Version         0x29   4 1.10MAC
Addresses        0x2A   2 XXXXManufacturer         0x2B   7 STORDISCountry
Code         0x2C   2 TWVendor Name          0x2D   7 STORDISDiag Version
      0x2E   3 1.0CRC-32               0xFE   4 0x57762CCEChecksum is
valid.*

I would suggest contacting the vendor for the BSP issue.

For the container port, we do export the 28000 port, there is a script to
start the Stratum container, please follow the document to start it
https://github.com/stratum/stratum/tree/master/stratum/hal/bin/barefoot/docker#run-the-docker-container-on-the-device

Yi


On Thu, Mar 12, 2020 at 6:30 PM Deval Bhamare <Deval.Bhamare at kau.se> wrote:

> Hello Yi,
>
>
> For Building Stratum Dev we have resolved the issue already with and
> without BSP.
>
> The soft-links in Lib are pointing to the Libs using Hardcoded absolute
> path, which is not available from within the container. So had to delete
> them and create again pointing to local Libs. Also have to explicitly
> install the library libpltfm_mgr.
>
>
> I will check the direct Docker option later-on.
>
>
> Now Stratum in running, but with error below in the end (screenshot is
> attached).
>
>
> Configuration for dev_id 0
>
>   Family        : Tofino
>
>   pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0
>
>   pci_domain    : 0
>
>   pci_bus       : 5
>
>   pci_fn        : 0
>
>   pci_dev       : 0
>
>   pci_int_mode  : 1
>
>   sbus_master_fw: /stratum/bf-sde-8.9.0/install/
>
>   pcie_fw       : /stratum/bf-sde-8.9.0/install/
>
>   serdes_fw     : /stratum/bf-sde-8.9.0/install/
>
>   sds_fw_path   : /stratum/bf-sde-8.9.0/install/
>
>   microp_fw_path:
>
> bf_switchd: processing P4 configuration...
>
> P4 profile for dev_id 0
>
>   p4_name: dummy
>
>     libpd:
>
>     libpdthrift:
>
>     context:
>
>     config:
>
>   Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
>
>   diag:
>
>   mavericks diag:
>
>   non_default_port_ppgs: 0
>
>   SAI default initialize: 1
>
> bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
> loaded
>
> bf_switchd: agent[0] initialized
>
> Tcl server started..
>
> Tcl server: listen socket created
>
> Tcl server: bind done on port 8008, listening...
>
> Tcl server: waiting for incoming connections...
>
> *sh: 1: onie-syseeprom: not found*
>
>
>
> *2020-03-12 10:19:54.510206 BF_PLTFM ERROR - Error in cp2112
> initialization*
>
>
> *2020-03-12 10:19:54.510309 BF_PLTFM ERROR - pltfm_mgr: platform init
> failed*
>
>
>
> So, looks like BF platform initilization is failing. Also, what is
> *onie-syseeprom*
>
>
>
> I also had a doubt that, *is the port 28000 available outside the
> container*? I cannot see any process listening on port 28000 or 8008
> (given in the message above) from outside the container.
>
>
> Thanks,
>
> Deval.
> ------------------------------
> *From:* Yi Tseng <yi at opennetworking.org>
> *Sent:* Thursday, March 12, 2020 6:57:14 AM
> *To:* Deval Bhamare
> *Cc:* Narada Hess; stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
> Hi Deval,
>
> We don't support Barefoot thrift APIs in Stratum. We support some Barefoot
> API like port API via gNMI and the chassis config.
>
> For missing JSON file, I can confirm that our internal CI did not include
> the latest Stratum with kernel 3.16.56
>
> I just rebuild it and uploaded the new container image to the Docker hub
> <https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>,
> feel free to let me know if the issue still exists.
>
> About the missing library, can you run this command in your shell?
>
> *LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd
> ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf*
>
> I think the system linker may have some issue to find the library.
>
> The *libavago.so.0 *is a symbolic link to *libavago.so*. the libavago.so
> must also exists.
>
>
>
> *ls -al $BF_SDE_INSTALL/lib/libavago* -rwxr-xr-x 1 root root 1185264 Mar
> 12 04:19 libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
> libavago.so.0 -> libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
> libavago.so.0.0.0 -> libavago.so*
>
>
>

-- 
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200314/f60d0e62/attachment.html>

From yi at opennetworking.org  Sun Mar 15 12:06:19 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Sun, 15 Mar 2020 20:06:19 +0800
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <1b5d4b58963240fc80b3cf8ec786fa1b@kau.se>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <d77fb57e693045938342ae57f2c6d4ac@kau.se>
 <CAOyFVR1MywKy1cQZJuKO9np3SYoQB5B5Ox8t1Lo22-9H_kXnWw@mail.gmail.com>
 <1b5d4b58963240fc80b3cf8ec786fa1b@kau.se>
Message-ID: <CAOyFVR1zAx6MvQ324WwcRfnm4FosJuhAmk3f=fpRGf_M9bZSUQ@mail.gmail.com>

Hi Deval,

You can add "-- -p28000:28000" option (*./setup_dev_env.sh -- -p28000:28000*).
This will forward port 28000 to the container.

And yes, the huge page command needs to be run on the host system.



On Sat, Mar 14, 2020 at 5:07 PM Deval Bhamare <Deval.Bhamare at kau.se> wrote:

> Hello Yi,
>
>
> Thank you for your reply. We will contact BSP.
>
>
> About the mount and mapping thing, I would to clarify that I am using the
> option of building stratum from scratch (given here:
> https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md
> ).
>
>
> As per your suggestion, I first run*./setup_dev_env.sh* to start the
> container. Then I do everything within this container (I have copied BF SDE
> and BSP dependencies manually in the container folder).
>
>
> Are these steps correct? The commands you mentioned  (pasted below), have
> to be performed outside the container, am I correct? I have done that
> already. How can I make sure that Stratum is listening correctly and I can
> access it from ONOS?
>
>
> $ [sudo] echo "vm.nr_hugepages = 128" >> /etc/sysctl.conf
> $ [sudo] sysctl -p /etc/sysctl.conf
> $ [sudo] mkdir /mnt/huge
> $ [sudo] mount -t hugetlbfs nodev /mnt/huge
>
>
>
> Thanks,
>
> Deval.
> ------------------------------
> *From:* Yi Tseng <yi at opennetworking.org>
> *Sent:* Saturday, March 14, 2020 7:37:41 AM
> *To:* Deval Bhamare
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
> Hi Deval,
>
> As far as I know, "onie-syseeprom" is a tool which included in ONIE. The
> BSP tries to use "onie-syseeprom" to read some information from the board.
>
> However, I don't think ONL includes the onie-syseeprom tool (tried to
> search from ONL master but only got onie-sysinfo and onie-shell tool)
>
> In ONIE shell, you should be able to run "onie-syseeprom" command and get
> information like below:
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
> *TlvInfo Header:    Id String:    TlvInfo    Version:      1    Total
> Length: 153 TLV Name             Code Len Value -------------------- ----
> --- ----- Product Name         0x21  10 BF2556X-1T Part Number
>  0x22  14 BF2556X-1T-A1F Serial Number        0x23  18 BF2556X1TXXXXXXXXX
> Base MAC Address     0x24   6 XX:XX:XX:XX:XX:XX Manufacture Date     0x25
>  19 07/08/2019 14:07:40 Device Version       0x26   1 1 Platform Name
>  0x28  28 x86_64-stordis_bf2556x_1t-r0 ONIE Version         0x29   4 1.10
> MAC Addresses        0x2A   2 XXXX Manufacturer         0x2B   7 STORDIS
> Country Code         0x2C   2 TW Vendor Name          0x2D   7 STORDIS Diag
> Version         0x2E   3 1.0 CRC-32               0xFE   4 0x57762CCE
> Checksum is valid.*
>
> I would suggest contacting the vendor for the BSP issue.
>
> For the container port, we do export the 28000 port, there is a script to
> start the Stratum container, please follow the document to start it
>
> https://github.com/stratum/stratum/tree/master/stratum/hal/bin/barefoot/docker#run-the-docker-container-on-the-device
>
> Yi
>
>
> On Thu, Mar 12, 2020 at 6:30 PM Deval Bhamare <Deval.Bhamare at kau.se>
> wrote:
>
>> Hello Yi,
>>
>>
>> For Building Stratum Dev we have resolved the issue already with and
>> without BSP.
>>
>> The soft-links in Lib are pointing to the Libs using Hardcoded absolute
>> path, which is not available from within the container. So had to delete
>> them and create again pointing to local Libs. Also have to explicitly
>> install the library libpltfm_mgr.
>>
>>
>> I will check the direct Docker option later-on.
>>
>>
>> Now Stratum in running, but with error below in the end (screenshot is
>> attached).
>>
>>
>> Configuration for dev_id 0
>>
>>   Family        : Tofino
>>
>>   pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0
>>
>>   pci_domain    : 0
>>
>>   pci_bus       : 5
>>
>>   pci_fn        : 0
>>
>>   pci_dev       : 0
>>
>>   pci_int_mode  : 1
>>
>>   sbus_master_fw: /stratum/bf-sde-8.9.0/install/
>>
>>   pcie_fw       : /stratum/bf-sde-8.9.0/install/
>>
>>   serdes_fw     : /stratum/bf-sde-8.9.0/install/
>>
>>   sds_fw_path   : /stratum/bf-sde-8.9.0/install/
>>
>>   microp_fw_path:
>>
>> bf_switchd: processing P4 configuration...
>>
>> P4 profile for dev_id 0
>>
>>   p4_name: dummy
>>
>>     libpd:
>>
>>     libpdthrift:
>>
>>     context:
>>
>>     config:
>>
>>   Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
>>
>>   diag:
>>
>>   mavericks diag:
>>
>>   non_default_port_ppgs: 0
>>
>>   SAI default initialize: 1
>>
>> bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
>> loaded
>>
>> bf_switchd: agent[0] initialized
>>
>> Tcl server started..
>>
>> Tcl server: listen socket created
>>
>> Tcl server: bind done on port 8008, listening...
>>
>> Tcl server: waiting for incoming connections...
>>
>> *sh: 1: onie-syseeprom: not found*
>>
>>
>>
>> *2020-03-12 10:19:54.510206 BF_PLTFM ERROR - Error in cp2112
>> initialization*
>>
>>
>> *2020-03-12 10:19:54.510309 BF_PLTFM ERROR - pltfm_mgr: platform init
>> failed*
>>
>>
>>
>> So, looks like BF platform initilization is failing. Also, what is
>> *onie-syseeprom*
>>
>>
>>
>> I also had a doubt that, *is the port 28000 available outside the
>> container*? I cannot see any process listening on port 28000 or 8008
>> (given in the message above) from outside the container.
>>
>>
>> Thanks,
>>
>> Deval.
>> ------------------------------
>> *From:* Yi Tseng <yi at opennetworking.org>
>> *Sent:* Thursday, March 12, 2020 6:57:14 AM
>> *To:* Deval Bhamare
>> *Cc:* Narada Hess; stratum-dev at lists.stratumproject.org
>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>
>> Hi Deval,
>>
>> We don't support Barefoot thrift APIs in Stratum. We support some
>> Barefoot API like port API via gNMI and the chassis config.
>>
>> For missing JSON file, I can confirm that our internal CI did not include
>> the latest Stratum with kernel 3.16.56
>>
>> I just rebuild it and uploaded the new container image to the Docker hub
>> <https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>,
>> feel free to let me know if the issue still exists.
>>
>> About the missing library, can you run this command in your shell?
>>
>> *LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd
>> ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf*
>>
>> I think the system linker may have some issue to find the library.
>>
>> The *libavago.so.0 *is a symbolic link to *libavago.so*. the libavago.so
>> must also exists.
>>
>>
>>
>> *ls -al $BF_SDE_INSTALL/lib/libavago* -rwxr-xr-x 1 root root 1185264 Mar
>> 12 04:19 libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>> libavago.so.0 -> libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>> libavago.so.0.0.0 -> libavago.so*
>>
>>
>>
>
> --
> Yi Tseng
> Member of Technical Staff
> Open Networking Foundation
> https://www.opennetworking.org/
>


-- 
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200315/084a83c4/attachment.html>

From Deval.Bhamare at kau.se  Sun Mar 15 12:12:33 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Sun, 15 Mar 2020 12:12:33 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR1zAx6MvQ324WwcRfnm4FosJuhAmk3f=fpRGf_M9bZSUQ@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <d77fb57e693045938342ae57f2c6d4ac@kau.se>
 <CAOyFVR1MywKy1cQZJuKO9np3SYoQB5B5Ox8t1Lo22-9H_kXnWw@mail.gmail.com>
 <1b5d4b58963240fc80b3cf8ec786fa1b@kau.se>,
 <CAOyFVR1zAx6MvQ324WwcRfnm4FosJuhAmk3f=fpRGf_M9bZSUQ@mail.gmail.com>
Message-ID: <9d25892136574173925888045747eb45@kau.se>

Thanks Yi, will try that.


Regards,

Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Sunday, March 15, 2020 2:06:19 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

You can add "-- -p28000:28000" option (./setup_dev_env.sh -- -p28000:28000). This will forward port 28000 to the container.

And yes, the huge page command needs to be run on the host system.



On Sat, Mar 14, 2020 at 5:07 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


Thank you for your reply. We will contact BSP.


About the mount and mapping thing, I would to clarify that I am using the option of building stratum from scratch (given here: https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md).


As per your suggestion, I first run./setup_dev_env.sh to start the container. Then I do everything within this container (I have copied BF SDE and BSP dependencies manually in the container folder).


Are these steps correct? The commands you mentioned  (pasted below), have to be performed outside the container, am I correct? I have done that already. How can I make sure that Stratum is listening correctly and I can access it from ONOS?


$ [sudo] echo "vm.nr_hugepages = 128" >> /etc/sysctl.conf
$ [sudo] sysctl -p /etc/sysctl.conf
$ [sudo] mkdir /mnt/huge
$ [sudo] mount -t hugetlbfs nodev /mnt/huge



Thanks,

Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Saturday, March 14, 2020 7:37:41 AM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

As far as I know, "onie-syseeprom" is a tool which included in ONIE. The BSP tries to use "onie-syseeprom" to read some information from the board.

However, I don't think ONL includes the onie-syseeprom tool (tried to search from ONL master but only got onie-sysinfo and onie-shell tool)

In ONIE shell, you should be able to run "onie-syseeprom" command and get information like below:
TlvInfo Header:
   Id String:    TlvInfo
   Version:      1
   Total Length: 153
TLV Name             Code Len Value
-------------------- ---- --- -----
Product Name         0x21  10 BF2556X-1T
Part Number          0x22  14 BF2556X-1T-A1F
Serial Number        0x23  18 BF2556X1TXXXXXXXXX
Base MAC Address     0x24   6 XX:XX:XX:XX:XX:XX
Manufacture Date     0x25  19 07/08/2019 14:07:40
Device Version       0x26   1 1
Platform Name        0x28  28 x86_64-stordis_bf2556x_1t-r0
ONIE Version         0x29   4 1.10
MAC Addresses        0x2A   2 XXXX
Manufacturer         0x2B   7 STORDIS
Country Code         0x2C   2 TW
Vendor Name          0x2D   7 STORDIS
Diag Version         0x2E   3 1.0
CRC-32               0xFE   4 0x57762CCE
Checksum is valid.

I would suggest contacting the vendor for the BSP issue.

For the container port, we do export the 28000 port, there is a script to start the Stratum container, please follow the document to start it
https://github.com/stratum/stratum/tree/master/stratum/hal/bin/barefoot/docker#run-the-docker-container-on-the-device

Yi


On Thu, Mar 12, 2020 at 6:30 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


For Building Stratum Dev we have resolved the issue already with and without BSP.

The soft-links in Lib are pointing to the Libs using Hardcoded absolute path, which is not available from within the container. So had to delete them and create again pointing to local Libs. Also have to explicitly install the library libpltfm_mgr.


I will check the direct Docker option later-on.


Now Stratum in running, but with error below in the end (screenshot is attached).


Configuration for dev_id 0

  Family        : Tofino

  pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0

  pci_domain    : 0

  pci_bus       : 5

  pci_fn        : 0

  pci_dev       : 0

  pci_int_mode  : 1

  sbus_master_fw: /stratum/bf-sde-8.9.0/install/

  pcie_fw       : /stratum/bf-sde-8.9.0/install/

  serdes_fw     : /stratum/bf-sde-8.9.0/install/

  sds_fw_path   : /stratum/bf-sde-8.9.0/install/

  microp_fw_path:

bf_switchd: processing P4 configuration...

P4 profile for dev_id 0

  p4_name: dummy

    libpd:

    libpdthrift:

    context:

    config:

  Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so

  diag:

  mavericks diag:

  non_default_port_ppgs: 0

  SAI default initialize: 1

bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so loaded

bf_switchd: agent[0] initialized

Tcl server started..

Tcl server: listen socket created

Tcl server: bind done on port 8008, listening...

Tcl server: waiting for incoming connections...

sh: 1: onie-syseeprom: not found



2020-03-12 10:19:54.510206 BF_PLTFM ERROR - Error in cp2112 initialization


2020-03-12 10:19:54.510309 BF_PLTFM ERROR - pltfm_mgr: platform init failed



So, looks like BF platform initilization is failing. Also, what is onie-syseeprom


I also had a doubt that, is the port 28000 available outside the container? I cannot see any process listening on port 28000 or 8008 (given in the message above) from outside the container.


Thanks,

Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 12, 2020 6:57:14 AM
To: Deval Bhamare
Cc: Narada Hess; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>, feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf

I think the system linker may have some issue to find the library.

The libavago.so.0 is a symbolic link to libavago.so. the libavago.so must also exists.
ls -al $BF_SDE_INSTALL/lib/libavago*
-rwxr-xr-x 1 root root 1185264 Mar 12 04:19 libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0 -> libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0 -> libavago.so




--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200315/b880e699/attachment-0001.html>

From Deval.Bhamare at kau.se  Mon Mar 16 11:31:52 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Mon, 16 Mar 2020 11:31:52 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR1MywKy1cQZJuKO9np3SYoQB5B5Ox8t1Lo22-9H_kXnWw@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <d77fb57e693045938342ae57f2c6d4ac@kau.se>,
 <CAOyFVR1MywKy1cQZJuKO9np3SYoQB5B5Ox8t1Lo22-9H_kXnWw@mail.gmail.com>
Message-ID: <be2567dfee26464b9b8e17362b817ef0@kau.se>

Hello Yi,


Before sending it to the BSP vendor, I checked it on Barefoot forum for "missing onie-syseeprom". Someone have suggested to use p4_runtime_profile.yaml to build SDE.  However, as per the Readme, Stratum asks to use Stratum_profile.yml. This is contradicting.


So do I have to combine these two so that all the required dependencies get installed? Can you please have a look and suggest?


Thanks,


Deval.



________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Saturday, March 14, 2020 7:37:41 AM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

As far as I know, "onie-syseeprom" is a tool which included in ONIE. The BSP tries to use "onie-syseeprom" to read some information from the board.

However, I don't think ONL includes the onie-syseeprom tool (tried to search from ONL master but only got onie-sysinfo and onie-shell tool)

In ONIE shell, you should be able to run "onie-syseeprom" command and get information like below:
TlvInfo Header:
   Id String:    TlvInfo
   Version:      1
   Total Length: 153
TLV Name             Code Len Value
-------------------- ---- --- -----
Product Name         0x21  10 BF2556X-1T
Part Number          0x22  14 BF2556X-1T-A1F
Serial Number        0x23  18 BF2556X1TXXXXXXXXX
Base MAC Address     0x24   6 XX:XX:XX:XX:XX:XX
Manufacture Date     0x25  19 07/08/2019 14:07:40
Device Version       0x26   1 1
Platform Name        0x28  28 x86_64-stordis_bf2556x_1t-r0
ONIE Version         0x29   4 1.10
MAC Addresses        0x2A   2 XXXX
Manufacturer         0x2B   7 STORDIS
Country Code         0x2C   2 TW
Vendor Name          0x2D   7 STORDIS
Diag Version         0x2E   3 1.0
CRC-32               0xFE   4 0x57762CCE
Checksum is valid.

I would suggest contacting the vendor for the BSP issue.

For the container port, we do export the 28000 port, there is a script to start the Stratum container, please follow the document to start it
https://github.com/stratum/stratum/tree/master/stratum/hal/bin/barefoot/docker#run-the-docker-container-on-the-device

Yi


On Thu, Mar 12, 2020 at 6:30 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


For Building Stratum Dev we have resolved the issue already with and without BSP.

The soft-links in Lib are pointing to the Libs using Hardcoded absolute path, which is not available from within the container. So had to delete them and create again pointing to local Libs. Also have to explicitly install the library libpltfm_mgr.


I will check the direct Docker option later-on.


Now Stratum in running, but with error below in the end (screenshot is attached).


Configuration for dev_id 0

  Family        : Tofino

  pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0

  pci_domain    : 0

  pci_bus       : 5

  pci_fn        : 0

  pci_dev       : 0

  pci_int_mode  : 1

  sbus_master_fw: /stratum/bf-sde-8.9.0/install/

  pcie_fw       : /stratum/bf-sde-8.9.0/install/

  serdes_fw     : /stratum/bf-sde-8.9.0/install/

  sds_fw_path   : /stratum/bf-sde-8.9.0/install/

  microp_fw_path:

bf_switchd: processing P4 configuration...

P4 profile for dev_id 0

  p4_name: dummy

    libpd:

    libpdthrift:

    context:

    config:

  Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so

  diag:

  mavericks diag:

  non_default_port_ppgs: 0

  SAI default initialize: 1

bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so loaded

bf_switchd: agent[0] initialized

Tcl server started..

Tcl server: listen socket created

Tcl server: bind done on port 8008, listening...

Tcl server: waiting for incoming connections...

sh: 1: onie-syseeprom: not found



2020-03-12 10:19:54.510206 BF_PLTFM ERROR - Error in cp2112 initialization


2020-03-12 10:19:54.510309 BF_PLTFM ERROR - pltfm_mgr: platform init failed



So, looks like BF platform initilization is failing. Also, what is onie-syseeprom


I also had a doubt that, is the port 28000 available outside the container? I cannot see any process listening on port 28000 or 8008 (given in the message above) from outside the container.


Thanks,

Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 12, 2020 6:57:14 AM
To: Deval Bhamare
Cc: Narada Hess; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>, feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf

I think the system linker may have some issue to find the library.

The libavago.so.0 is a symbolic link to libavago.so. the libavago.so must also exists.
ls -al $BF_SDE_INSTALL/lib/libavago*
-rwxr-xr-x 1 root root 1185264 Mar 12 04:19 libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0 -> libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0 -> libavago.so




--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200316/f9c82618/attachment.html>

From yi at opennetworking.org  Thu Mar 19 04:07:19 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Thu, 19 Mar 2020 12:07:19 +0800
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <be2567dfee26464b9b8e17362b817ef0@kau.se>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <d77fb57e693045938342ae57f2c6d4ac@kau.se>
 <CAOyFVR1MywKy1cQZJuKO9np3SYoQB5B5Ox8t1Lo22-9H_kXnWw@mail.gmail.com>
 <be2567dfee26464b9b8e17362b817ef0@kau.se>
Message-ID: <CAOyFVR1Hx9BvQ0BpQiHi11ihMMQL-2NaFh91eSUpd6MFrGa_Sg@mail.gmail.com>

Hi Deval,

I cannot find the `onie-syseeprom` in the p4_runtime_profile.

Please confirm that the P4Runtime profile installs "onie-syseeprom" binary
before you merge these two profiles.

Yi

On Mon, Mar 16, 2020 at 7:31 PM Deval Bhamare <Deval.Bhamare at kau.se> wrote:

> Hello Yi,
>
>
> Before sending it to the BSP vendor, I checked it on Barefoot forum for "*missing
> **onie-syseeprom*". Someone have suggested to use *
> p4_runtime_profile.yaml* to build SDE.  However, as per the Readme,
> Stratum asks to use Stratum_profile.yml. This is contradicting.
>
>
> So do I have to combine these two so that all the required dependencies
> get installed? Can you please have a look and suggest?
>
>
> Thanks,
>
>
> Deval.
>
>
>
> ------------------------------
> *From:* Yi Tseng <yi at opennetworking.org>
> *Sent:* Saturday, March 14, 2020 7:37:41 AM
> *To:* Deval Bhamare
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
> Hi Deval,
>
> As far as I know, "onie-syseeprom" is a tool which included in ONIE. The
> BSP tries to use "onie-syseeprom" to read some information from the board.
>
> However, I don't think ONL includes the onie-syseeprom tool (tried to
> search from ONL master but only got onie-sysinfo and onie-shell tool)
>
> In ONIE shell, you should be able to run "onie-syseeprom" command and get
> information like below:
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
>
> *TlvInfo Header:    Id String:    TlvInfo    Version:      1    Total
> Length: 153 TLV Name             Code Len Value -------------------- ----
> --- ----- Product Name         0x21  10 BF2556X-1T Part Number
>  0x22  14 BF2556X-1T-A1F Serial Number        0x23  18 BF2556X1TXXXXXXXXX
> Base MAC Address     0x24   6 XX:XX:XX:XX:XX:XX Manufacture Date     0x25
>  19 07/08/2019 14:07:40 Device Version       0x26   1 1 Platform Name
>  0x28  28 x86_64-stordis_bf2556x_1t-r0 ONIE Version         0x29   4 1.10
> MAC Addresses        0x2A   2 XXXX Manufacturer         0x2B   7 STORDIS
> Country Code         0x2C   2 TW Vendor Name          0x2D   7 STORDIS Diag
> Version         0x2E   3 1.0 CRC-32               0xFE   4 0x57762CCE
> Checksum is valid.*
>
> I would suggest contacting the vendor for the BSP issue.
>
> For the container port, we do export the 28000 port, there is a script to
> start the Stratum container, please follow the document to start it
>
> https://github.com/stratum/stratum/tree/master/stratum/hal/bin/barefoot/docker#run-the-docker-container-on-the-device
>
> Yi
>
>
> On Thu, Mar 12, 2020 at 6:30 PM Deval Bhamare <Deval.Bhamare at kau.se>
> wrote:
>
>> Hello Yi,
>>
>>
>> For Building Stratum Dev we have resolved the issue already with and
>> without BSP.
>>
>> The soft-links in Lib are pointing to the Libs using Hardcoded absolute
>> path, which is not available from within the container. So had to delete
>> them and create again pointing to local Libs. Also have to explicitly
>> install the library libpltfm_mgr.
>>
>>
>> I will check the direct Docker option later-on.
>>
>>
>> Now Stratum in running, but with error below in the end (screenshot is
>> attached).
>>
>>
>> Configuration for dev_id 0
>>
>>   Family        : Tofino
>>
>>   pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0
>>
>>   pci_domain    : 0
>>
>>   pci_bus       : 5
>>
>>   pci_fn        : 0
>>
>>   pci_dev       : 0
>>
>>   pci_int_mode  : 1
>>
>>   sbus_master_fw: /stratum/bf-sde-8.9.0/install/
>>
>>   pcie_fw       : /stratum/bf-sde-8.9.0/install/
>>
>>   serdes_fw     : /stratum/bf-sde-8.9.0/install/
>>
>>   sds_fw_path   : /stratum/bf-sde-8.9.0/install/
>>
>>   microp_fw_path:
>>
>> bf_switchd: processing P4 configuration...
>>
>> P4 profile for dev_id 0
>>
>>   p4_name: dummy
>>
>>     libpd:
>>
>>     libpdthrift:
>>
>>     context:
>>
>>     config:
>>
>>   Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
>>
>>   diag:
>>
>>   mavericks diag:
>>
>>   non_default_port_ppgs: 0
>>
>>   SAI default initialize: 1
>>
>> bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
>> loaded
>>
>> bf_switchd: agent[0] initialized
>>
>> Tcl server started..
>>
>> Tcl server: listen socket created
>>
>> Tcl server: bind done on port 8008, listening...
>>
>> Tcl server: waiting for incoming connections...
>>
>> *sh: 1: onie-syseeprom: not found*
>>
>>
>>
>> *2020-03-12 10:19:54.510206 BF_PLTFM ERROR - Error in cp2112
>> initialization*
>>
>>
>> *2020-03-12 10:19:54.510309 BF_PLTFM ERROR - pltfm_mgr: platform init
>> failed*
>>
>>
>>
>> So, looks like BF platform initilization is failing. Also, what is
>> *onie-syseeprom*
>>
>>
>>
>> I also had a doubt that, *is the port 28000 available outside the
>> container*? I cannot see any process listening on port 28000 or 8008
>> (given in the message above) from outside the container.
>>
>>
>> Thanks,
>>
>> Deval.
>> ------------------------------
>> *From:* Yi Tseng <yi at opennetworking.org>
>> *Sent:* Thursday, March 12, 2020 6:57:14 AM
>> *To:* Deval Bhamare
>> *Cc:* Narada Hess; stratum-dev at lists.stratumproject.org
>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>
>> Hi Deval,
>>
>> We don't support Barefoot thrift APIs in Stratum. We support some
>> Barefoot API like port API via gNMI and the chassis config.
>>
>> For missing JSON file, I can confirm that our internal CI did not include
>> the latest Stratum with kernel 3.16.56
>>
>> I just rebuild it and uploaded the new container image to the Docker hub
>> <https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>,
>> feel free to let me know if the issue still exists.
>>
>> About the missing library, can you run this command in your shell?
>>
>> *LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd
>> ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf*
>>
>> I think the system linker may have some issue to find the library.
>>
>> The *libavago.so.0 *is a symbolic link to *libavago.so*. the libavago.so
>> must also exists.
>>
>>
>>
>> *ls -al $BF_SDE_INSTALL/lib/libavago* -rwxr-xr-x 1 root root 1185264 Mar
>> 12 04:19 libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>> libavago.so.0 -> libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>> libavago.so.0.0.0 -> libavago.so*
>>
>>
>>
>
> --
> Yi Tseng
> Member of Technical Staff
> Open Networking Foundation
> https://www.opennetworking.org/
>


-- 
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200319/e2ac72d6/attachment.html>

From bocon at opennetworking.org  Thu Mar 19 21:22:18 2020
From: bocon at opennetworking.org (bocon at opennetworking.org)
Date: Thu, 19 Mar 2020 21:22:18 +0000
Subject: [stratum-dev] Stratum TST Meeting
Message-ID: <0000000000007f927105a13bc378@google.com>

Hi everyone, There was a request to shift this meeting an hour or 1.5 hours  
later due to time changes: 12:30 or 13:00 PDT, 15:30 or 16:00 EDT, 21:30 or  
22:00 CEST (after time change), 5:30 or 6:00 AEST (after time change) We  
are also exploring adding a new meeting time later in the day to better  
accommodate India and Asia. Please let me know if you have an opinion and  
any suggestions before I make the change. Thanks! Brian

Title: Stratum TST Meeting
Stratum Technical Steering Team MeetingAgenda and Meeting  
Noteshttps://docs.google.com/document/d/1ret8Vbnl-xbLgNsnDEH-jWP2_WwDYym4zDn6me3tiTA/editThe  
plan is to reserve the 1st and 3rd Thursdays of each month for  
presentations and community updates. If you can only attend some of these  
meetings, those will be more interesting. The other meetings will be more  
informal&nbsp;sync ups to discuss current issues, progress, and status. You  
can see what presentations are planned by checking the agenda  
above.Supporting Slides and Previous  
Recordingshttps://drive.google.com/drive/folders/1ZeYp6RwIGYi9VnIctvnKF1c1NxiAXeOT----------------------------------------------------------------Join  
Zoom Meetinghttps://zoom.us/j/787501745Meeting ID: 787 501 745One tap  
mobile+16699006833,,787501745# US (San Jose)+19292056099,,787501745# US  
(New York)Dial by your location&nbsp; &nbsp; &nbsp; &nbsp; +1 669 900 6833  
US (San Jose)&nbsp; &nbsp; &nbsp; &nbsp; +1 929 205 6099 US (New  
York)&nbsp; &nbsp; &nbsp; &nbsp; 888 788 0099 US Toll-free&nbsp; &nbsp;  
&nbsp; &nbsp; 877 853 5247 US Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +61 3  
7018 2005 Australia&nbsp; &nbsp; &nbsp; &nbsp; +61 8 7150 1149  
Australia&nbsp; &nbsp; &nbsp; &nbsp; +61 2 8015 6011 Australia&nbsp; &nbsp;  
&nbsp; &nbsp; 1800 945 157 Australia Toll-free&nbsp; &nbsp; &nbsp; &nbsp;  
1800 893 423 Australia Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +81 524 564 439  
Japan&nbsp; &nbsp; &nbsp; &nbsp; +81 3 4578 1488 Japan&nbsp; &nbsp; &nbsp;  
&nbsp; 0 800 100 5040 Japan Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 00 663 381  
4092 Japan Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +49 695 050 2596  
Germany&nbsp; &nbsp; &nbsp; &nbsp; +49 69 7104 9922 Germany&nbsp; &nbsp;  
&nbsp; &nbsp; +49 30 5679 5800 Germany&nbsp; &nbsp; &nbsp; &nbsp; 0 800  
1800 150 Germany Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 0 800 000 6954  
Germany Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +886 (2) 7741 7473  
Taiwan&nbsp; &nbsp; &nbsp; &nbsp; 08 0909 9864 Taiwan Toll-free&nbsp;  
&nbsp; &nbsp; &nbsp; +48 22 398 7356 Poland&nbsp; &nbsp; &nbsp; &nbsp; +48  
22 307 3488 Poland&nbsp; &nbsp; &nbsp; &nbsp; 00 800 321 1464 Poland  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 00 800 112 5171 Poland Toll-free&nbsp;  
&nbsp; &nbsp; &nbsp; +44 203 481 5240 United Kingdom&nbsp; &nbsp; &nbsp;  
&nbsp; +44 131 460 1196 United Kingdom&nbsp; &nbsp; &nbsp; &nbsp; +44 203  
051 2874 United Kingdom&nbsp; &nbsp; &nbsp; &nbsp; +44 203 481 5237 United  
Kingdom&nbsp; &nbsp; &nbsp; &nbsp; 0 800 260 5801 United Kingdom  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 0 800 031 5717 United Kingdom  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +353 1 653 3895 Ireland&nbsp; &nbsp;  
&nbsp; &nbsp; +353 6 163 9031 Ireland&nbsp; &nbsp; &nbsp; &nbsp; +353 1 536  
9320 Ireland&nbsp; &nbsp; &nbsp; &nbsp; 1800 949 238 Ireland  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 1800 901 561 Ireland Toll-freeMeeting  
ID: 787 501 745Find your local number:  
https://zoom.us/u/adqQM87Zrg----------------------------------------------------------------If  
you would like to get added to the calendar invite, please ask Brian.
When: Thu Mar 26, 2020 11:30am  12pm Pacific Time - Los Angeles
Where: MP-1-Large Conference Room (25), (Online conference room)-Zoom-3
Who:
     * bocon at opennetworking.org - creator
     * stratum-dev at lists.stratumproject.org
     * max at opennetworking.org
     * bill at opennetworking.org
     * maksym.kovaliov at plvision.eu
     * mohammed.habeeb at inventec.com
     * craig.stevens at dell.com
     * yi at opennetworking.org
     * carmelo at opennetworking.org
     * maksym.tropets at plvision.eu
     * xiao.david at inventec.com
     * Rich Renner
     * Devjit Gopalpur
     * Alireza Ghaffarkhah
     * Leonid Khedyk
     * niloofar at opennetworking.org
     * hsuanchung.lee at qct.io
     * jeff_catlin at edge-core.com
     * Arkadiy Shapiro
     * you at opennetworking.org
     * abhilash at opennetworking.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200319/5ee97369/attachment-0001.html>

From Deval.Bhamare at kau.se  Fri Mar 20 17:28:54 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Fri, 20 Mar 2020 17:28:54 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>,
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
Message-ID: <08df48cbcfc3462fa41128f05c60db07@kau.se>

Hello Yi,


I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux, however, the error still persists:


+ KERNEL_VERSION=3.16.64-OpenNetworkLinux

+ DOCKER_IMAGE=stratumproject/stratum-bf

+ DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux

++ uname -r

++ uname -r

+ docker run -it --privileged -v /dev:/dev -v /sys:/sys -v /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1 -v /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so -v /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1 -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux

Use default flag file

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json



I also had peek at the script start-stratum-container.sh and found an option of ONLP_ARG="--env WITH_ONLP=false"
. So I wanted to ask whether I can set this option with Docker to force BSP usage, let us say, by hard-coding it in the script itself (also similar approach to set PORT_MAP in stratume_entrypoint.sh). I tried this and the error message in this case is:


Use default flag file

Cannot find /usr/local/share/stratum/.json

Please suggest.

Thanks,
Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Thursday, March 12, 2020 6:57 AM
To: Deval Bhamare
Cc: Narada Hess; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>, feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf

I think the system linker may have some issue to find the library.

The libavago.so.0 is a symbolic link to libavago.so. the libavago.so must also exists.
ls -al $BF_SDE_INSTALL/lib/libavago*
-rwxr-xr-x 1 root root 1185264 Mar 12 04:19 libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0 -> libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0 -> libavago.so


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200320/5bdfbdfb/attachment.html>

From yi at opennetworking.org  Tue Mar 24 13:25:06 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Tue, 24 Mar 2020 21:25:06 +0800
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <08df48cbcfc3462fa41128f05c60db07@kau.se>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <08df48cbcfc3462fa41128f05c60db07@kau.se>
Message-ID: <CAOyFVR3-vjAwOKDuQ1R5+z9s1Y3zZUD+UX_AQoK8-jJ3q5T5_g@mail.gmail.com>

Hi Deval,

I am now working on updating the script to support the custom platform
parameter <https://github.com/stratum/stratum/pull/150> since the Stratum
cannot detect the platform without the ONLP.

Should be merged soon.

On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se> wrote:

> Hello Yi,
>
>
> I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux,
> however, the error still persists:
>
>
> + KERNEL_VERSION=3.16.64-OpenNetworkLinux
>
> + DOCKER_IMAGE=stratumproject/stratum-bf
>
> + DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux
>
> ++ uname -r
>
> ++ uname -r
>
> + docker run -it --privileged -v /dev:/dev -v /sys:/sys -v
> /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux
> -v
> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so
> -v
> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1
> -v
> /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so
> -v
> /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1
> -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v
> /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v
> /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p
> 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs
> stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux
>
> *Use default flag file*
>
> *Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json*
>
>
> I also had peek at the script *start-stratum-container.sh* and found an
> option of *ONLP_ARG="--env WITH_ONLP=false"*
> . So I wanted to ask whether I can set this option with Docker to force
> BSP usage, let us say, by hard-coding it in the script itself (also similar
> approach to set PORT_MAP in *stratume_entrypoint.sh*). I tried this and
> the error message in this case is:
>
>
> *Use default flag file*
>
> *Cannot find /usr/local/share/stratum/.json *
>
> Please suggest.
>
> Thanks,
> Deval.
>
> ------------------------------
> *From:* Yi Tseng <yi at opennetworking.org>
> *Sent:* Thursday, March 12, 2020 6:57 AM
> *To:* Deval Bhamare
> *Cc:* Narada Hess; stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
> Hi Deval,
>
> We don't support Barefoot thrift APIs in Stratum. We support some Barefoot
> API like port API via gNMI and the chassis config.
>
> For missing JSON file, I can confirm that our internal CI did not include
> the latest Stratum with kernel 3.16.56
>
> I just rebuild it and uploaded the new container image to the Docker hub
> <https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>,
> feel free to let me know if the issue still exists.
>
> About the missing library, can you run this command in your shell?
>
> *LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd
> ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf*
>
> I think the system linker may have some issue to find the library.
>
> The *libavago.so.0 *is a symbolic link to *libavago.so*. the libavago.so
> must also exists.
>
>
>
> *ls -al $BF_SDE_INSTALL/lib/libavago* -rwxr-xr-x 1 root root 1185264 Mar
> 12 04:19 libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
> libavago.so.0 -> libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
> libavago.so.0.0.0 -> libavago.so*
>
>
>

-- 
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200324/c4ee22d8/attachment.html>

From Deval.Bhamare at kau.se  Wed Mar 25 22:13:20 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Wed, 25 Mar 2020 22:13:20 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR3-vjAwOKDuQ1R5+z9s1Y3zZUD+UX_AQoK8-jJ3q5T5_g@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <08df48cbcfc3462fa41128f05c60db07@kau.se>,
 <CAOyFVR3-vjAwOKDuQ1R5+z9s1Y3zZUD+UX_AQoK8-jJ3q5T5_g@mail.gmail.com>
Message-ID: <a6d7c4b6ed894c31bc007500efbf8b71@kau.se>

Hello Yi,


We have received a reply from Stordis and as per their suggestion, we can ignore the syseeprom error


You see only syseeprom errorr please ignore that :
Tcl server: listen socket created
Tcl server: bind done on port 8008, listening...
Tcl server: waiting for incoming connections...
sh: 1: onie-syseeprom: not found <Ignore this error>
Health monitor started
Operational mode set to ASIC



So, now when I try to push the netcfg.json for our device to Onos, I get following message:


2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452353961040, creationTime=1585173541276, computeCost=427068, clusters=0, devices=0, links=0} changed

2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason

2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452397561034, creationTime=1585173541319, computeCost=112832, clusters=0, devices=0, links=0} changed



ONOS CLI show, device available=false.


tofino at root > devices                                                        21:58:49

id=device:tofino, available=false, local-status=disconnected 37s ago, role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0, name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI



Netcfg.json contents are:

{
        "devices": {
        "device:tofino": {
        "basic": {
        "managementAddress": "grpc://127.0.0.1?device_id=0",
        "driver": "stratum-tofino",
        "pipeconf": "vepg-pipeconf"
        }
        }
        }
        }


Command is:


curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H 'Content-Type:application/json' 'http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json



Any idea what may be the issue?


Thanks,

Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Tuesday, March 24, 2020 3:25:06 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

I am now working on updating the script to support the custom platform parameter<https://github.com/stratum/stratum/pull/150> since the Stratum cannot detect the platform without the ONLP.

Should be merged soon.

On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux, however, the error still persists:


+ KERNEL_VERSION=3.16.64-OpenNetworkLinux

+ DOCKER_IMAGE=stratumproject/stratum-bf

+ DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux

++ uname -r

++ uname -r

+ docker run -it --privileged -v /dev:/dev -v /sys:/sys -v /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1 -v /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so -v /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1 -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux

Use default flag file

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json



I also had peek at the script start-stratum-container.sh and found an option of ONLP_ARG="--env WITH_ONLP=false"
. So I wanted to ask whether I can set this option with Docker to force BSP usage, let us say, by hard-coding it in the script itself (also similar approach to set PORT_MAP in stratume_entrypoint.sh). I tried this and the error message in this case is:


Use default flag file

Cannot find /usr/local/share/stratum/.json

Please suggest.

Thanks,
Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 12, 2020 6:57 AM
To: Deval Bhamare
Cc: Narada Hess; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>, feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf

I think the system linker may have some issue to find the library.

The libavago.so.0 is a symbolic link to libavago.so. the libavago.so must also exists.
ls -al $BF_SDE_INSTALL/lib/libavago*
-rwxr-xr-x 1 root root 1185264 Mar 12 04:19 libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0 -> libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0 -> libavago.so




--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200325/9fe0ffb8/attachment-0001.html>

From yi at opennetworking.org  Thu Mar 26 19:10:49 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Fri, 27 Mar 2020 03:10:49 +0800
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <a6d7c4b6ed894c31bc007500efbf8b71@kau.se>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <08df48cbcfc3462fa41128f05c60db07@kau.se>
 <CAOyFVR3-vjAwOKDuQ1R5+z9s1Y3zZUD+UX_AQoK8-jJ3q5T5_g@mail.gmail.com>
 <a6d7c4b6ed894c31bc007500efbf8b71@kau.se>
Message-ID: <CAOyFVR0wZCAN+RQQybzGydK6rNwyyjqmdy9kBrk8wSBGASYDRQ@mail.gmail.com>

Hi Deval,

Where you are running the ONOS controller? If you are running the ONOS
controller on a server, you need to set the management address to your
switch IP address.

For example, you run the ONOS on a server with IP address 192.168.0.100 and
running the Stratum on a switch with IP address 192.168.0.101. (And I
assume that you have connectivity between the server and the switch)

The netcfg.json will look like:

{
  "devices": {
    "device:tofino": {
      "basic": {
        "managementAddress": "grpc://192.168.0.101:28000?device_id=1",
        "driver": "stratum-tofino",
        "pipeconf": "[your pipeconf name]"
       }
    }
   }
}

Please also note that the device ID is 1 in the Stratum

Yi


On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se> wrote:

> Hello Yi,
>
>
> We have received a reply from Stordis and as per their suggestion, we can
> ignore the syseeprom error
>
>
> *You see only syseeprom errorr please ignore that :*
> *Tcl server: listen socket created*
> *Tcl server: bind done on port 8008, listening...*
> *Tcl server: waiting for incoming connections...*
> *sh: 1: onie-syseeprom: not found <Ignore this error>*
> *Health monitor started *
> *Operational mode set to ASIC*
>
>
> So, now when I try to push the netcfg.json for our device to Onos, I get
> following message:
>
>
> 2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl
>             | 237 - org.onosproject.onos-protocols-p4runtime-ctl -
> 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true,
> newElectionId=20, masterElectionId=null, sessionOpen=false
>
> 2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 |
> ModelCache                       | 211 -
> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
> device:tofino not found as a UiDevice
>
> 2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 |
> ModelCache                       | 211 -
> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
> device:tofino not found as a UiDevice
>
> 2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 |
> ModelCache                       | 211 -
> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
> device:tofino not found as a UiDevice
>
> 2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager
>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
> Topology DefaultTopology{time=20452353961040, creationTime=1585173541276,
> computeCost=427068, clusters=0, devices=0, links=0} changed
>
> 2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager
>             | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |*
> Device device:tofino registered*
>
> 2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 |
> StreamClientImpl                 | 237 -
> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT |* Error on
> StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for
> unknown reason*
>
> 2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager
>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
> Topology DefaultTopology{time=20452397561034, creationTime=1585173541319,
> computeCost=112832, clusters=0, devices=0, links=0} changed
>
>
>
> ONOS CLI show, device available=false.
>
>
> tofino at root > devices
>     21:58:49
>
> id=device:tofino, *available=false*, local-status=disconnected 37s ago,
> role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum,
> serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf,
> locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0,
> name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI
>
>
> Netcfg.json contents are:
>
> {
> "devices": {
> "device:tofino": {
> "basic": {
> "managementAddress": "grpc://127.0.0.1?device_id=0",
> "driver": "stratum-tofino",
> "pipeconf": "vepg-pipeconf"
> }
> }
> }
> }
>
> Command is:
>
>
> curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H
> 'Content-Type:application/json' '
> http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json
>
>
>
> Any idea what may be the issue?
>
>
> Thanks,
>
> Deval.
>
>
> ------------------------------
> *From:* Yi Tseng <yi at opennetworking.org>
> *Sent:* Tuesday, March 24, 2020 3:25:06 PM
> *To:* Deval Bhamare
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
> Hi Deval,
>
> I am now working on updating the script to support the custom platform
> parameter <https://github.com/stratum/stratum/pull/150> since the Stratum
> cannot detect the platform without the ONLP.
>
> Should be merged soon.
>
> On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se>
> wrote:
>
>> Hello Yi,
>>
>>
>> I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux,
>> however, the error still persists:
>>
>>
>> + KERNEL_VERSION=3.16.64-OpenNetworkLinux
>>
>> + DOCKER_IMAGE=stratumproject/stratum-bf
>>
>> + DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux
>>
>> ++ uname -r
>>
>> ++ uname -r
>>
>> + docker run -it --privileged -v /dev:/dev -v /sys:/sys -v
>> /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux
>> -v
>> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so
>> -v
>> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1
>> -v
>> /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so
>> -v
>> /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1
>> -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v
>> /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v
>> /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p
>> 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs
>> stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux
>>
>> *Use default flag file*
>>
>> *Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json*
>>
>>
>> I also had peek at the script *start-stratum-container.sh* and found an
>> option of *ONLP_ARG="--env WITH_ONLP=false"*
>> . So I wanted to ask whether I can set this option with Docker to force
>> BSP usage, let us say, by hard-coding it in the script itself (also similar
>> approach to set PORT_MAP in *stratume_entrypoint.sh*). I tried this and
>> the error message in this case is:
>>
>>
>> *Use default flag file*
>>
>> *Cannot find /usr/local/share/stratum/.json *
>>
>> Please suggest.
>>
>> Thanks,
>> Deval.
>>
>> ------------------------------
>> *From:* Yi Tseng <yi at opennetworking.org>
>> *Sent:* Thursday, March 12, 2020 6:57 AM
>> *To:* Deval Bhamare
>> *Cc:* Narada Hess; stratum-dev at lists.stratumproject.org
>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>
>> Hi Deval,
>>
>> We don't support Barefoot thrift APIs in Stratum. We support some
>> Barefoot API like port API via gNMI and the chassis config.
>>
>> For missing JSON file, I can confirm that our internal CI did not include
>> the latest Stratum with kernel 3.16.56
>>
>> I just rebuild it and uploaded the new container image to the Docker hub
>> <https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>,
>> feel free to let me know if the issue still exists.
>>
>> About the missing library, can you run this command in your shell?
>>
>> *LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd
>> ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf*
>>
>> I think the system linker may have some issue to find the library.
>>
>> The *libavago.so.0 *is a symbolic link to *libavago.so*. the libavago.so
>> must also exists.
>>
>>
>>
>> *ls -al $BF_SDE_INSTALL/lib/libavago* -rwxr-xr-x 1 root root 1185264 Mar
>> 12 04:19 libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>> libavago.so.0 -> libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>> libavago.so.0.0.0 -> libavago.so*
>>
>>
>>
>
> --
> Yi Tseng
> Member of Technical Staff
> Open Networking Foundation
> https://www.opennetworking.org/
>


-- 
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200327/3d004d78/attachment-0001.html>

From Deval.Bhamare at kau.se  Thu Mar 26 22:53:01 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Thu, 26 Mar 2020 22:53:01 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR0wZCAN+RQQybzGydK6rNwyyjqmdy9kBrk8wSBGASYDRQ@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <08df48cbcfc3462fa41128f05c60db07@kau.se>
 <CAOyFVR3-vjAwOKDuQ1R5+z9s1Y3zZUD+UX_AQoK8-jJ3q5T5_g@mail.gmail.com>
 <a6d7c4b6ed894c31bc007500efbf8b71@kau.se>,
 <CAOyFVR0wZCAN+RQQybzGydK6rNwyyjqmdy9kBrk8wSBGASYDRQ@mail.gmail.com>
Message-ID: <af63ef5e59324f66b4688b18bd9c9f27@kau.se>

Hello Yi,


I am running both ONOS and stratum container on the same machine, that is the tofino switch with public IP 192.168.60.131.


So I tried with grpc://192.168.60.131:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", as well now. This time message is connection refused and still no connectivity.




2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.

2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264511977012, creationTime=1585262479736, computeCost=117691, clusters=0, devices=0, links=0} changed

2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | device:tofino is unreachable (Connection refused: /192.168.60.131:28000)

2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264549921343, creationTime=1585262479774, computeCost=101378, clusters=0, devices=0, links=0} changed


With grpc://127.0.0.1:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", the error is


onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason


Also Stratum logs say


bf_switchd: processing P4 configuration...

P4 profile for dev_id 0


while starting, so I doubt device ID maybe 0 and hence tried with both device_id=1<http://192.168.0.101:28000/?device_id=1> and device_id=<http://192.168.0.101:28000/?device_id=1>0 but no luck.



Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Thursday, March 26, 2020 9:10:49 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

Where you are running the ONOS controller? If you are running the ONOS controller on a server, you need to set the management address to your switch IP address.

For example, you run the ONOS on a server with IP address 192.168.0.100 and running the Stratum on a switch with IP address 192.168.0.101. (And I assume that you have connectivity between the server and the switch)

The netcfg.json will look like:

{
  "devices": {
    "device:tofino": {
      "basic": {
        "managementAddress": "grpc://192.168.0.101:28000?device_id=1<http://192.168.0.101:28000?device_id=1>",
        "driver": "stratum-tofino",
        "pipeconf": "[your pipeconf name]"
       }
    }
   }
}

Please also note that the device ID is 1 in the Stratum

Yi


On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


We have received a reply from Stordis and as per their suggestion, we can ignore the syseeprom error


You see only syseeprom errorr please ignore that :
Tcl server: listen socket created
Tcl server: bind done on port 8008, listening...
Tcl server: waiting for incoming connections...
sh: 1: onie-syseeprom: not found <Ignore this error>
Health monitor started
Operational mode set to ASIC



So, now when I try to push the netcfg.json for our device to Onos, I get following message:


2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452353961040, creationTime=1585173541276, computeCost=427068, clusters=0, devices=0, links=0} changed

2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason

2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452397561034, creationTime=1585173541319, computeCost=112832, clusters=0, devices=0, links=0} changed



ONOS CLI show, device available=false.


tofino at root > devices                                                        21:58:49

id=device:tofino, available=false, local-status=disconnected 37s ago, role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0<http://127.0.0.1:28000?device_id=0>, name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI



Netcfg.json contents are:

{
        "devices": {
        "device:tofino": {
        "basic": {
        "managementAddress": "grpc://127.0.0.1?device_id=0<http://127.0.0.1?device_id=0>",
        "driver": "stratum-tofino",
        "pipeconf": "vepg-pipeconf"
        }
        }
        }
        }


Command is:


curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H 'Content-Type:application/json' 'http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json



Any idea what may be the issue?


Thanks,

Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Tuesday, March 24, 2020 3:25:06 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

I am now working on updating the script to support the custom platform parameter<https://github.com/stratum/stratum/pull/150> since the Stratum cannot detect the platform without the ONLP.

Should be merged soon.

On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux, however, the error still persists:


+ KERNEL_VERSION=3.16.64-OpenNetworkLinux

+ DOCKER_IMAGE=stratumproject/stratum-bf

+ DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux

++ uname -r

++ uname -r

+ docker run -it --privileged -v /dev:/dev -v /sys:/sys -v /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1 -v /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so -v /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1 -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux

Use default flag file

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json



I also had peek at the script start-stratum-container.sh and found an option of ONLP_ARG="--env WITH_ONLP=false"
. So I wanted to ask whether I can set this option with Docker to force BSP usage, let us say, by hard-coding it in the script itself (also similar approach to set PORT_MAP in stratume_entrypoint.sh). I tried this and the error message in this case is:


Use default flag file

Cannot find /usr/local/share/stratum/.json

Please suggest.

Thanks,
Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 12, 2020 6:57 AM
To: Deval Bhamare
Cc: Narada Hess; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>, feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf

I think the system linker may have some issue to find the library.

The libavago.so.0 is a symbolic link to libavago.so. the libavago.so must also exists.
ls -al $BF_SDE_INSTALL/lib/libavago*
-rwxr-xr-x 1 root root 1185264 Mar 12 04:19 libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0 -> libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0 -> libavago.so




--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200326/97c16ac9/attachment-0001.html>

From max at opennetworking.org  Sat Mar 28 01:43:29 2020
From: max at opennetworking.org (Maximilian Pudelko)
Date: Fri, 27 Mar 2020 18:43:29 -0700
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <01010171190c9981-833ae934-2420-4a40-abde-3f9542415656-000000@us-west-2.amazonses.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <08df48cbcfc3462fa41128f05c60db07@kau.se>
 <CAOyFVR3-vjAwOKDuQ1R5+z9s1Y3zZUD+UX_AQoK8-jJ3q5T5_g@mail.gmail.com>
 <a6d7c4b6ed894c31bc007500efbf8b71@kau.se>
 <CAOyFVR0wZCAN+RQQybzGydK6rNwyyjqmdy9kBrk8wSBGASYDRQ@mail.gmail.com>
 <01010171190c9981-833ae934-2420-4a40-abde-3f9542415656-000000@us-west-2.amazonses.com>
Message-ID: <CAFh9Y_NuM3SnxdpU_PamscwO8e7F_cnp5etZ2Z=XMFwzb+O-MQ@mail.gmail.com>

Hi Deval,

can you run this command on the switch: ss -tlnp
Should output something like this:
State      Recv-Q Send-Q      Local Address:Port                     Peer
Address:Port
LISTEN     0      128                     *:22
     *:*                   users:(("sshd",pid=4116,fd=3))
LISTEN     0      128                    :::22
    :::*                   users:(("sshd",pid=4116,fd=4))
LISTEN     0      128      ::ffff:127.0.0.1:28000
   :::*                   users:(("stratum_bcm",pid=26872,fd=19))
LISTEN     0      128                    :::28001
   :::*                   users:(("stratum_bcm",pid=26872,fd=20))
LISTEN     0      128      ::ffff:127.0.0.1:28003
   :::*                   users:(("stratum_bcm",pid=26872,fd=6))

Also, do you have any logs from Stratum? Run with -v=1 -stderrthreshold=0

Since you're using docker, I assume there is some issue with port
forwarding/mapping. Follow these steps to check the port mapping:
https://docs.docker.com/engine/reference/commandline/port/
And these steps to fix it:
https://stackoverflow.com/questions/22111060/what-is-the-difference-between-expose-and-publish-in-docker
https://docs.docker.com/config/containers/container-networking/#published-ports

Max


On Thu, Mar 26, 2020 at 3:53 PM Deval Bhamare via stratum-dev <
stratum-dev at lists.stratumproject.org> wrote:

> Hello Yi,
>
>
> I am running both ONOS and stratum container on the same machine, that is
> the tofino switch with public IP 192.168.60.131.
>
>
> So I tried with grpc://192.168.60.131:28000?device_id=1
> <http://192.168.0.101:28000/?device_id=1>", as well now. This time
> message is connection refused and still no connectivity.
>
>
>
>
> 2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background |
> DeviceManager                    | 193 - org.onosproject.onos-core-net -
> 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino,
> but this node cannot reach the device.  Relinquishing role.
>
> 2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       | StreamClientImpl
>             | 237 - org.onosproject.onos-protocols-p4runtime-ctl -
> 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true,
> newElectionId=20, masterElectionId=null, sessionOpen=false
>
> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
> ModelCache                       | 211 -
> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
> device:tofino not found as a UiDevice
>
> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
> ModelCache                       | 211 -
> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
> device:tofino not found as a UiDevice
>
> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
> ModelCache                       | 211 -
> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
> device:tofino not found as a UiDevice
>
> 2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager
>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
> Topology DefaultTopology{time=2264511977012, creationTime=1585262479736,
> computeCost=117691, clusters=0, devices=0, links=0} changed
>
> 2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager
>             | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
> Device device:tofino registered
>
> 2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 |
> StreamClientImpl                 | 237 -
> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | *device:tofino
> is unreachable (Connection refused: /192.168.60.131:28000
> <http://192.168.60.131:28000>)*
>
> 2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager
>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
> Topology DefaultTopology{time=2264549921343, creationTime=1585262479774,
> computeCost=101378, clusters=0, devices=0, links=0} changed
>
> With grpc://127.0.0.1:28000?device_id=1
> <http://192.168.0.101:28000/?device_id=1>", the error is
>
>
> *onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on
> StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for
> unknown reason*
>
> Also Stratum logs say
>
>
> bf_switchd: processing P4 configuration...
>
> *P4 profile for dev_id 0*
>
>
> while starting, so I doubt device ID maybe 0 and hence tried with both
> device_id=1 <http://192.168.0.101:28000/?device_id=1> and device_id=
> <http://192.168.0.101:28000/?device_id=1>0 but no luck.
>
>
>
> Thanks,
>
>
> Deval.
> ------------------------------
> *From:* Yi Tseng <yi at opennetworking.org>
> *Sent:* Thursday, March 26, 2020 9:10:49 PM
> *To:* Deval Bhamare
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
> Hi Deval,
>
> Where you are running the ONOS controller? If you are running the ONOS
> controller on a server, you need to set the management address to your
> switch IP address.
>
> For example, you run the ONOS on a server with IP address 192.168.0.100
> and running the Stratum on a switch with IP address 192.168.0.101. (And I
> assume that you have connectivity between the server and the switch)
>
> The netcfg.json will look like:
>
> {
>   "devices": {
>     "device:tofino": {
>       "basic": {
>         "managementAddress": "grpc://192.168.0.101:28000?device_id=1",
>         "driver": "stratum-tofino",
>         "pipeconf": "[your pipeconf name]"
>        }
>     }
>    }
> }
>
> Please also note that the device ID is 1 in the Stratum
>
> Yi
>
>
> On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se>
> wrote:
>
>> Hello Yi,
>>
>>
>> We have received a reply from Stordis and as per their suggestion, we can
>> ignore the syseeprom error
>>
>>
>> *You see only syseeprom errorr please ignore that :*
>> *Tcl server: listen socket created*
>> *Tcl server: bind done on port 8008, listening...*
>> *Tcl server: waiting for incoming connections...*
>> *sh: 1: onie-syseeprom: not found <Ignore this error>*
>> *Health monitor started *
>> *Operational mode set to ASIC*
>>
>>
>> So, now when I try to push the netcfg.json for our device to Onos, I get
>> following message:
>>
>>
>> 2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl
>>               | 237 - org.onosproject.onos-protocols-p4runtime-ctl -
>> 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true,
>> newElectionId=20, masterElectionId=null, sessionOpen=false
>>
>> 2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 |
>> ModelCache                       | 211 -
>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>> device:tofino not found as a UiDevice
>>
>> 2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 |
>> ModelCache                       | 211 -
>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>> device:tofino not found as a UiDevice
>>
>> 2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 |
>> ModelCache                       | 211 -
>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>> device:tofino not found as a UiDevice
>>
>> 2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager
>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
>> Topology DefaultTopology{time=20452353961040, creationTime=1585173541276,
>> computeCost=427068, clusters=0, devices=0, links=0} changed
>>
>> 2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager
>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |*
>> Device device:tofino registered*
>>
>> 2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 |
>> StreamClientImpl                 | 237 -
>> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT |* Error
>> on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for
>> unknown reason*
>>
>> 2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager
>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
>> Topology DefaultTopology{time=20452397561034, creationTime=1585173541319,
>> computeCost=112832, clusters=0, devices=0, links=0} changed
>>
>>
>>
>> ONOS CLI show, device available=false.
>>
>>
>> tofino at root > devices
>>     21:58:49
>>
>> id=device:tofino, *available=false*, local-status=disconnected 37s ago,
>> role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum,
>> serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf,
>> locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0,
>> name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI
>>
>>
>> Netcfg.json contents are:
>>
>> {
>> "devices": {
>> "device:tofino": {
>> "basic": {
>> "managementAddress": "grpc://127.0.0.1?device_id=0",
>> "driver": "stratum-tofino",
>> "pipeconf": "vepg-pipeconf"
>> }
>> }
>> }
>> }
>>
>> Command is:
>>
>>
>> curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H
>> 'Content-Type:application/json' '
>> http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json
>>
>>
>>
>> Any idea what may be the issue?
>>
>>
>> Thanks,
>>
>> Deval.
>>
>>
>> ------------------------------
>> *From:* Yi Tseng <yi at opennetworking.org>
>> *Sent:* Tuesday, March 24, 2020 3:25:06 PM
>> *To:* Deval Bhamare
>> *Cc:* stratum-dev at lists.stratumproject.org
>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>
>> Hi Deval,
>>
>> I am now working on updating the script to support the custom platform
>> parameter <https://github.com/stratum/stratum/pull/150> since the
>> Stratum cannot detect the platform without the ONLP.
>>
>> Should be merged soon.
>>
>> On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se>
>> wrote:
>>
>>> Hello Yi,
>>>
>>>
>>> I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux,
>>> however, the error still persists:
>>>
>>>
>>> + KERNEL_VERSION=3.16.64-OpenNetworkLinux
>>>
>>> + DOCKER_IMAGE=stratumproject/stratum-bf
>>>
>>> + DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux
>>>
>>> ++ uname -r
>>>
>>> ++ uname -r
>>>
>>> + docker run -it --privileged -v /dev:/dev -v /sys:/sys -v
>>> /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux
>>> -v
>>> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so
>>> -v
>>> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1
>>> -v
>>> /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so
>>> -v
>>> /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1
>>> -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v
>>> /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v
>>> /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p
>>> 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs
>>> stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux
>>>
>>> *Use default flag file*
>>>
>>> *Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json*
>>>
>>>
>>> I also had peek at the script *start-stratum-container.sh* and found an
>>> option of *ONLP_ARG="--env WITH_ONLP=false"*
>>> . So I wanted to ask whether I can set this option with Docker to force
>>> BSP usage, let us say, by hard-coding it in the script itself (also similar
>>> approach to set PORT_MAP in *stratume_entrypoint.sh*). I tried this and
>>> the error message in this case is:
>>>
>>>
>>> *Use default flag file*
>>>
>>> *Cannot find /usr/local/share/stratum/.json *
>>>
>>> Please suggest.
>>>
>>> Thanks,
>>> Deval.
>>>
>>> ------------------------------
>>> *From:* Yi Tseng <yi at opennetworking.org>
>>> *Sent:* Thursday, March 12, 2020 6:57 AM
>>> *To:* Deval Bhamare
>>> *Cc:* Narada Hess; stratum-dev at lists.stratumproject.org
>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>
>>> Hi Deval,
>>>
>>> We don't support Barefoot thrift APIs in Stratum. We support some
>>> Barefoot API like port API via gNMI and the chassis config.
>>>
>>> For missing JSON file, I can confirm that our internal CI did not
>>> include the latest Stratum with kernel 3.16.56
>>>
>>> I just rebuild it and uploaded the new container image to the Docker hub
>>> <https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>,
>>> feel free to let me know if the issue still exists.
>>>
>>> About the missing library, can you run this command in your shell?
>>>
>>> *LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd
>>> ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf*
>>>
>>> I think the system linker may have some issue to find the library.
>>>
>>> The *libavago.so.0 *is a symbolic link to *libavago.so*. the
>>> libavago.so must also exists.
>>>
>>>
>>>
>>> *ls -al $BF_SDE_INSTALL/lib/libavago* -rwxr-xr-x 1 root root 1185264 Mar
>>> 12 04:19 libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>>> libavago.so.0 -> libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>>> libavago.so.0.0.0 -> libavago.so*
>>>
>>>
>>>
>>
>> --
>> Yi Tseng
>> Member of Technical Staff
>> Open Networking Foundation
>> https://www.opennetworking.org/
>>
>
>
> --
> Yi Tseng
> Member of Technical Staff
> Open Networking Foundation
> https://www.opennetworking.org/
> _______________________________________________
> stratum-dev mailing list
> stratum-dev at lists.stratumproject.org
> https://lists.stratumproject.org/listinfo/stratum-dev
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200327/a66a0934/attachment-0001.html>

From Deval.Bhamare at kau.se  Sat Mar 28 13:22:08 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Sat, 28 Mar 2020 13:22:08 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAFh9Y_NuM3SnxdpU_PamscwO8e7F_cnp5etZ2Z=XMFwzb+O-MQ@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <08df48cbcfc3462fa41128f05c60db07@kau.se>
 <CAOyFVR3-vjAwOKDuQ1R5+z9s1Y3zZUD+UX_AQoK8-jJ3q5T5_g@mail.gmail.com>
 <a6d7c4b6ed894c31bc007500efbf8b71@kau.se>
 <CAOyFVR0wZCAN+RQQybzGydK6rNwyyjqmdy9kBrk8wSBGASYDRQ@mail.gmail.com>
 <01010171190c9981-833ae934-2420-4a40-abde-3f9542415656-000000@us-west-2.amazonses.com>,
 <CAFh9Y_NuM3SnxdpU_PamscwO8e7F_cnp5etZ2Z=XMFwzb+O-MQ@mail.gmail.com>
Message-ID: <b8ddb7904491468ab3efdd46c1b22f5b@kau.se>

Hello Maximilian,


Thank you for your reply and the useful suggestions. So as a first step I executed on switch ss -tnlp and below is the output. Surprisingly, there is no Stratum anywhere there, however statrum is also running in a container and the short logs are displayed below. I also executed ss command inside the container and those are also pasted below, if that may help.


ss -tnlp outputs in different times are as follows:


- from tofino, before anything is started:


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010                                    *:*

LISTEN     0      128                                      :::22                                      :::*



- from tofino after stratum container is started


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from tofino after stratum is running


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from stratum container, after running it in background


tofino at ced0c4d7ef8f:/stratum$ ss -tnlp

State      Recv-Q Send-Q Local Address:Port                Peer Address:Port

LISTEN     0      1                  *:8008                           *:*                   users:(("stratum_bf",pid=323,fd=26)) << #IS this useful?

LISTEN     0      128        127.0.0.1:41418                          *:*                   users:(("java",pid=21,fd=110))


Why there is no 28000 port here in Stratum container SS output. Or should I bind 8008 to 28000 on switch?

As you have mentioned, I have already taken care of port mapping. So I run the container with -p28000:2000. It is verified in the outputs above as well.


- Docker output on switch


tofino at localhost:~$ docker ps

CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                      NAMES

ced0c4d7ef8f        stratum-dev         "bash"              16 minutes ago      Up 16 minutes       0.0.0.0:28000->28000/tcp   goofy_hamilton



- Stratum log output after it started.


bf_sysfs_fname /sys/class/bf/bf0/device/dev_add

Install dir: /stratum/bf-sde-8.9.0/install (0x7f876b794b60)

bf_switchd: system services initialized

bf_switchd: loading conf_file stratum/hal/bin/barefoot/tofino_skip_p4.conf...

bf_switchd: processing device configuration...

Configuration for dev_id 0

  Family        : Tofino

  pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0

  pci_domain    : 0

  pci_bus       : 5

  pci_fn        : 0

  pci_dev       : 0

  pci_int_mode  : 1

  sbus_master_fw: /stratum/bf-sde-8.9.0/install/

  pcie_fw       : /stratum/bf-sde-8.9.0/install/

  serdes_fw     : /stratum/bf-sde-8.9.0/install/

  sds_fw_path   : /stratum/bf-sde-8.9.0/install/

  microp_fw_path:

bf_switchd: processing P4 configuration...

P4 profile for dev_id 0

  p4_name: dummy

    libpd:

    libpdthrift:

    context:

    config:

  Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so

  diag:

  mavericks diag:

  non_default_port_ppgs: 0

  SAI default initialize: 1

bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so loaded

bf_switchd: agent[0] initialized

Tcl server started..

Tcl server: listen socket created

Tcl server: bind done on port 8008, listening...

Tcl server: waiting for incoming connections...

sh: 1: onie-syseeprom: not found

2020-03-28 13:06:53.584090 BF_PLTFM ERROR - Error in cp2112 initialization


2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?



Thank you.

Deval


________________________________
From: Maximilian Pudelko <max at opennetworking.org>
Sent: Saturday, March 28, 2020 3:43:29 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

can you run this command on the switch: ss -tlnp
Should output something like this:
State      Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN     0      128                     *:22                                  *:*                   users:(("sshd",pid=4116,fd=3))
LISTEN     0      128                    :::22                                 :::*                   users:(("sshd",pid=4116,fd=4))
LISTEN     0      128      ::ffff:127.0.0.1:28000<http://127.0.0.1:28000>                              :::*                   users:(("stratum_bcm",pid=26872,fd=19))
LISTEN     0      128                    :::28001                              :::*                   users:(("stratum_bcm",pid=26872,fd=20))
LISTEN     0      128      ::ffff:127.0.0.1:28003<http://127.0.0.1:28003>                              :::*                   users:(("stratum_bcm",pid=26872,fd=6))

Also, do you have any logs from Stratum? Run with -v=1 -stderrthreshold=0

Since you're using docker, I assume there is some issue with port forwarding/mapping. Follow these steps to check the port mapping: https://docs.docker.com/engine/reference/commandline/port/
And these steps to fix it:
https://stackoverflow.com/questions/22111060/what-is-the-difference-between-expose-and-publish-in-docker
https://docs.docker.com/config/containers/container-networking/#published-ports

Max


On Thu, Mar 26, 2020 at 3:53 PM Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:

Hello Yi,


I am running both ONOS and stratum container on the same machine, that is the tofino switch with public IP 192.168.60.131.


So I tried with grpc://192.168.60.131:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", as well now. This time message is connection refused and still no connectivity.




2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.

2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264511977012, creationTime=1585262479736, computeCost=117691, clusters=0, devices=0, links=0} changed

2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | device:tofino is unreachable (Connection refused: /192.168.60.131:28000<http://192.168.60.131:28000>)

2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264549921343, creationTime=1585262479774, computeCost=101378, clusters=0, devices=0, links=0} changed


With grpc://127.0.0.1:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", the error is


onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason


Also Stratum logs say


bf_switchd: processing P4 configuration...

P4 profile for dev_id 0


while starting, so I doubt device ID maybe 0 and hence tried with both device_id=1<http://192.168.0.101:28000/?device_id=1> and device_id=<http://192.168.0.101:28000/?device_id=1>0 but no luck.



Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 26, 2020 9:10:49 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

Where you are running the ONOS controller? If you are running the ONOS controller on a server, you need to set the management address to your switch IP address.

For example, you run the ONOS on a server with IP address 192.168.0.100 and running the Stratum on a switch with IP address 192.168.0.101. (And I assume that you have connectivity between the server and the switch)

The netcfg.json will look like:

{
  "devices": {
    "device:tofino": {
      "basic": {
        "managementAddress": "grpc://192.168.0.101:28000?device_id=1<http://192.168.0.101:28000?device_id=1>",
        "driver": "stratum-tofino",
        "pipeconf": "[your pipeconf name]"
       }
    }
   }
}

Please also note that the device ID is 1 in the Stratum

Yi


On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


We have received a reply from Stordis and as per their suggestion, we can ignore the syseeprom error


You see only syseeprom errorr please ignore that :
Tcl server: listen socket created
Tcl server: bind done on port 8008, listening...
Tcl server: waiting for incoming connections...
sh: 1: onie-syseeprom: not found <Ignore this error>
Health monitor started
Operational mode set to ASIC



So, now when I try to push the netcfg.json for our device to Onos, I get following message:


2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452353961040, creationTime=1585173541276, computeCost=427068, clusters=0, devices=0, links=0} changed

2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason

2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452397561034, creationTime=1585173541319, computeCost=112832, clusters=0, devices=0, links=0} changed



ONOS CLI show, device available=false.


tofino at root > devices                                                        21:58:49

id=device:tofino, available=false, local-status=disconnected 37s ago, role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0<http://127.0.0.1:28000?device_id=0>, name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI



Netcfg.json contents are:

{
        "devices": {
        "device:tofino": {
        "basic": {
        "managementAddress": "grpc://127.0.0.1?device_id=0<http://127.0.0.1?device_id=0>",
        "driver": "stratum-tofino",
        "pipeconf": "vepg-pipeconf"
        }
        }
        }
        }


Command is:


curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H 'Content-Type:application/json' 'http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json



Any idea what may be the issue?


Thanks,

Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Tuesday, March 24, 2020 3:25:06 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

I am now working on updating the script to support the custom platform parameter<https://github.com/stratum/stratum/pull/150> since the Stratum cannot detect the platform without the ONLP.

Should be merged soon.

On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux, however, the error still persists:


+ KERNEL_VERSION=3.16.64-OpenNetworkLinux

+ DOCKER_IMAGE=stratumproject/stratum-bf

+ DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux

++ uname -r

++ uname -r

+ docker run -it --privileged -v /dev:/dev -v /sys:/sys -v /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1 -v /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so -v /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1 -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux

Use default flag file

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json



I also had peek at the script start-stratum-container.sh and found an option of ONLP_ARG="--env WITH_ONLP=false"
. So I wanted to ask whether I can set this option with Docker to force BSP usage, let us say, by hard-coding it in the script itself (also similar approach to set PORT_MAP in stratume_entrypoint.sh). I tried this and the error message in this case is:


Use default flag file

Cannot find /usr/local/share/stratum/.json

Please suggest.

Thanks,
Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 12, 2020 6:57 AM
To: Deval Bhamare
Cc: Narada Hess; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>, feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf

I think the system linker may have some issue to find the library.

The libavago.so.0 is a symbolic link to libavago.so. the libavago.so must also exists.
ls -al $BF_SDE_INSTALL/lib/libavago*
-rwxr-xr-x 1 root root 1185264 Mar 12 04:19 libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0 -> libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0 -> libavago.so




--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200328/0bbd129c/attachment-0001.html>

From Deval.Bhamare at kau.se  Sat Mar 28 14:31:19 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Sat, 28 Mar 2020 14:31:19 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <01010171214eab35-94a8581f-ed3b-4aae-abb9-58b7f2151df3-000000@us-west-2.amazonses.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <08df48cbcfc3462fa41128f05c60db07@kau.se>
 <CAOyFVR3-vjAwOKDuQ1R5+z9s1Y3zZUD+UX_AQoK8-jJ3q5T5_g@mail.gmail.com>
 <a6d7c4b6ed894c31bc007500efbf8b71@kau.se>
 <CAOyFVR0wZCAN+RQQybzGydK6rNwyyjqmdy9kBrk8wSBGASYDRQ@mail.gmail.com>
 <01010171190c9981-833ae934-2420-4a40-abde-3f9542415656-000000@us-west-2.amazonses.com>,
 <CAFh9Y_NuM3SnxdpU_PamscwO8e7F_cnp5etZ2Z=XMFwzb+O-MQ@mail.gmail.com>,
 <01010171214eab35-94a8581f-ed3b-4aae-abb9-58b7f2151df3-000000@us-west-2.amazonses.com>
Message-ID: <cd881b8db56449b5a9e1a6477cd46398@kau.se>

Hello again,


Since I could not any port activity on 28000 inside stratum and stratum logs shown only listen activity on 8008, I used following command to do explicitly map the IP/ports to host:


./setup_dev_env.sh  --pull --  -p 192.168.60.131:28008:8008


Then I tried to push the netcfg.json with following URL and this time the communication channel is established. Logs from ONOS and stratum are below (BOLD RED).


URL:


"managementAddress": "grpc://192.168.60.131:28008?device_id=0",


(I tired both deviceID 0 and 1, but it must be 0 as bf_shell and stratum Log both confirm: )



ONOS:


2020-03-28T13:49:46,158 | WARN  | onos-gdp-0       | PiPipeconfManager                | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Ignoring PortStatisticsDiscovery behaviour from pipeconf vepg-pipeconf, but using the one provided by stratum-tofino driver...

2020-03-28T13:49:46,184 | INFO  | onos-gdp-0       | GrpcChannelControllerImpl        | 230 - org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Creating new gRPC channel grpc://192.168.60.131:28008?device_id=0... << #THERE IS SUCCESS HERE THIS TIME AS COMPARED TO PREVIOUS TIME


Stratum:


Tcl server: connection accepted on port 8008

Partial recv: 30 of 40 so far..  <<#STRATUM CONFIRMS IT



However, I am not sure, it is the correct entry point? The reason is ONOS still cannot find the device:tofino (highlighted Yellow RED)


2020-03-28T13:49:46,306 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Local role is MASTER for device:tofino

2020-03-28T13:49:46,311 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,313 | INFO  | onos-gdp-0       | GeneralDeviceProvider            | 235 - org.onosproject.onos-providers-general-device - 2.4.0.SNAPSHOT | Notifying role MASTER (preference 0) for term 1 to device:tofino

2020-03-28T13:49:46,315 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,316 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.    <<#STILL NO DEVICE FOUND. I TRIED BOTH ID 0 and 1 in the URL

2020-03-28T13:49:46,317 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-28T13:49:46,320 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,336 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=12233603415182, creationTime=1585403386336, computeCost=124274, clusters=0, devices=0, links=0} changed

2020-03-28T13:49:46,365 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered




Please confirm, is it in the right direction or port 8008 is completely different? What can be the reason for device:tofino not able to find?


Thank you,

Deval.


________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org>
Sent: Saturday, March 28, 2020 3:22:16 PM
To: Maximilian Pudelko
Cc: stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Maximilian,


Thank you for your reply and the useful suggestions. So as a first step I executed on switch ss -tnlp and below is the output. Surprisingly, there is no Stratum anywhere there, however statrum is also running in a container and the short logs are displayed below. I also executed ss command inside the container and those are also pasted below, if that may help.


ss -tnlp outputs in different times are as follows:


- from tofino, before anything is started:


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010                                    *:*

LISTEN     0      128                                      :::22                                      :::*



- from tofino after stratum container is started


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from tofino after stratum is running


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from stratum container, after running it in background


tofino at ced0c4d7ef8f:/stratum$ ss -tnlp

State      Recv-Q Send-Q Local Address:Port                Peer Address:Port

LISTEN     0      1                  *:8008                           *:*                   users:(("stratum_bf",pid=323,fd=26)) << #IS this useful?

LISTEN     0      128        127.0.0.1:41418                          *:*                   users:(("java",pid=21,fd=110))


Why there is no 28000 port here in Stratum container SS output. Or should I bind 8008 to 28000 on switch?

As you have mentioned, I have already taken care of port mapping. So I run the container with -p28000:2000. It is verified in the outputs above as well.


- Docker output on switch


tofino at localhost:~$ docker ps

CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                      NAMES

ced0c4d7ef8f        stratum-dev         "bash"              16 minutes ago      Up 16 minutes       0.0.0.0:28000->28000/tcp   goofy_hamilton



- Stratum log output after it started.


bf_sysfs_fname /sys/class/bf/bf0/device/dev_add

Install dir: /stratum/bf-sde-8.9.0/install (0x7f876b794b60)

bf_switchd: system services initialized

bf_switchd: loading conf_file stratum/hal/bin/barefoot/tofino_skip_p4.conf...

bf_switchd: processing device configuration...

Configuration for dev_id 0

  Family        : Tofino

  pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0

  pci_domain    : 0

  pci_bus       : 5

  pci_fn        : 0

  pci_dev       : 0

  pci_int_mode  : 1

  sbus_master_fw: /stratum/bf-sde-8.9.0/install/

  pcie_fw       : /stratum/bf-sde-8.9.0/install/

  serdes_fw     : /stratum/bf-sde-8.9.0/install/

  sds_fw_path   : /stratum/bf-sde-8.9.0/install/

  microp_fw_path:

bf_switchd: processing P4 configuration...

P4 profile for dev_id 0

  p4_name: dummy

    libpd:

    libpdthrift:

    context:

    config:

  Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so

  diag:

  mavericks diag:

  non_default_port_ppgs: 0

  SAI default initialize: 1

bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so loaded

bf_switchd: agent[0] initialized

Tcl server started..

Tcl server: listen socket created

Tcl server: bind done on port 8008, listening...

Tcl server: waiting for incoming connections...

sh: 1: onie-syseeprom: not found

2020-03-28 13:06:53.584090 BF_PLTFM ERROR - Error in cp2112 initialization


2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?



Thank you.

Deval


________________________________
From: Maximilian Pudelko <max at opennetworking.org>
Sent: Saturday, March 28, 2020 3:43:29 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

can you run this command on the switch: ss -tlnp
Should output something like this:
State      Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN     0      128                     *:22                                  *:*                   users:(("sshd",pid=4116,fd=3))
LISTEN     0      128                    :::22                                 :::*                   users:(("sshd",pid=4116,fd=4))
LISTEN     0      128      ::ffff:127.0.0.1:28000<http://127.0.0.1:28000>                              :::*                   users:(("stratum_bcm",pid=26872,fd=19))
LISTEN     0      128                    :::28001                              :::*                   users:(("stratum_bcm",pid=26872,fd=20))
LISTEN     0      128      ::ffff:127.0.0.1:28003<http://127.0.0.1:28003>                              :::*                   users:(("stratum_bcm",pid=26872,fd=6))

Also, do you have any logs from Stratum? Run with -v=1 -stderrthreshold=0

Since you're using docker, I assume there is some issue with port forwarding/mapping. Follow these steps to check the port mapping: https://docs.docker.com/engine/reference/commandline/port/
And these steps to fix it:
https://stackoverflow.com/questions/22111060/what-is-the-difference-between-expose-and-publish-in-docker
https://docs.docker.com/config/containers/container-networking/#published-ports

Max


On Thu, Mar 26, 2020 at 3:53 PM Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:

Hello Yi,


I am running both ONOS and stratum container on the same machine, that is the tofino switch with public IP 192.168.60.131.


So I tried with grpc://192.168.60.131:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", as well now. This time message is connection refused and still no connectivity.




2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.

2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264511977012, creationTime=1585262479736, computeCost=117691, clusters=0, devices=0, links=0} changed

2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | device:tofino is unreachable (Connection refused: /192.168.60.131:28000<http://192.168.60.131:28000>)

2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264549921343, creationTime=1585262479774, computeCost=101378, clusters=0, devices=0, links=0} changed


With grpc://127.0.0.1:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", the error is


onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason


Also Stratum logs say


bf_switchd: processing P4 configuration...

P4 profile for dev_id 0


while starting, so I doubt device ID maybe 0 and hence tried with both device_id=1<http://192.168.0.101:28000/?device_id=1> and device_id=<http://192.168.0.101:28000/?device_id=1>0 but no luck.



Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 26, 2020 9:10:49 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

Where you are running the ONOS controller? If you are running the ONOS controller on a server, you need to set the management address to your switch IP address.

For example, you run the ONOS on a server with IP address 192.168.0.100 and running the Stratum on a switch with IP address 192.168.0.101. (And I assume that you have connectivity between the server and the switch)

The netcfg.json will look like:

{
  "devices": {
    "device:tofino": {
      "basic": {
        "managementAddress": "grpc://192.168.0.101:28000?device_id=1<http://192.168.0.101:28000?device_id=1>",
        "driver": "stratum-tofino",
        "pipeconf": "[your pipeconf name]"
       }
    }
   }
}

Please also note that the device ID is 1 in the Stratum

Yi


On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


We have received a reply from Stordis and as per their suggestion, we can ignore the syseeprom error


You see only syseeprom errorr please ignore that :
Tcl server: listen socket created
Tcl server: bind done on port 8008, listening...
Tcl server: waiting for incoming connections...
sh: 1: onie-syseeprom: not found <Ignore this error>
Health monitor started
Operational mode set to ASIC



So, now when I try to push the netcfg.json for our device to Onos, I get following message:


2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452353961040, creationTime=1585173541276, computeCost=427068, clusters=0, devices=0, links=0} changed

2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason

2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452397561034, creationTime=1585173541319, computeCost=112832, clusters=0, devices=0, links=0} changed



ONOS CLI show, device available=false.


tofino at root > devices                                                        21:58:49

id=device:tofino, available=false, local-status=disconnected 37s ago, role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0<http://127.0.0.1:28000?device_id=0>, name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI



Netcfg.json contents are:

{
        "devices": {
        "device:tofino": {
        "basic": {
        "managementAddress": "grpc://127.0.0.1?device_id=0<http://127.0.0.1?device_id=0>",
        "driver": "stratum-tofino",
        "pipeconf": "vepg-pipeconf"
        }
        }
        }
        }


Command is:


curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H 'Content-Type:application/json' 'http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json



Any idea what may be the issue?


Thanks,

Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Tuesday, March 24, 2020 3:25:06 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

I am now working on updating the script to support the custom platform parameter<https://github.com/stratum/stratum/pull/150> since the Stratum cannot detect the platform without the ONLP.

Should be merged soon.

On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux, however, the error still persists:


+ KERNEL_VERSION=3.16.64-OpenNetworkLinux

+ DOCKER_IMAGE=stratumproject/stratum-bf

+ DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux

++ uname -r

++ uname -r

+ docker run -it --privileged -v /dev:/dev -v /sys:/sys -v /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1 -v /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so -v /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1 -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux

Use default flag file

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json



I also had peek at the script start-stratum-container.sh and found an option of ONLP_ARG="--env WITH_ONLP=false"
. So I wanted to ask whether I can set this option with Docker to force BSP usage, let us say, by hard-coding it in the script itself (also similar approach to set PORT_MAP in stratume_entrypoint.sh). I tried this and the error message in this case is:


Use default flag file

Cannot find /usr/local/share/stratum/.json

Please suggest.

Thanks,
Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 12, 2020 6:57 AM
To: Deval Bhamare
Cc: Narada Hess; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>, feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf

I think the system linker may have some issue to find the library.

The libavago.so.0 is a symbolic link to libavago.so. the libavago.so must also exists.
ls -al $BF_SDE_INSTALL/lib/libavago*
-rwxr-xr-x 1 root root 1185264 Mar 12 04:19 libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0 -> libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0 -> libavago.so




--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200328/2651162b/attachment-0001.html>

From max at opennetworking.org  Sat Mar 28 23:46:04 2020
From: max at opennetworking.org (Maximilian Pudelko)
Date: Sat, 28 Mar 2020 16:46:04 -0700
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <cd881b8db56449b5a9e1a6477cd46398@kau.se>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <08df48cbcfc3462fa41128f05c60db07@kau.se>
 <CAOyFVR3-vjAwOKDuQ1R5+z9s1Y3zZUD+UX_AQoK8-jJ3q5T5_g@mail.gmail.com>
 <a6d7c4b6ed894c31bc007500efbf8b71@kau.se>
 <CAOyFVR0wZCAN+RQQybzGydK6rNwyyjqmdy9kBrk8wSBGASYDRQ@mail.gmail.com>
 <01010171190c9981-833ae934-2420-4a40-abde-3f9542415656-000000@us-west-2.amazonses.com>
 <CAFh9Y_NuM3SnxdpU_PamscwO8e7F_cnp5etZ2Z=XMFwzb+O-MQ@mail.gmail.com>
 <01010171214eab35-94a8581f-ed3b-4aae-abb9-58b7f2151df3-000000@us-west-2.amazonses.com>
 <cd881b8db56449b5a9e1a6477cd46398@kau.se>
Message-ID: <CAFh9Y_NLCng9zN3zak+nc1WjTjwyztN18gjZBOzeKQRvd+vXJQ@mail.gmail.com>

Hi Deval,

There are many things going on in your setup, let's do this step by step:

1. Port 8008 is NOT what you want for ONOS. I'm no Tofino expert, but this
seems to be a separate endpoint for something else (debugging?). We always
use port 28000.

2. *2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init
failed  #<<< CAN IT BE THE ISSUE?*
Depends. It's probably not good, but as long as you see this line in the
Stratum logs, ONOS should be able to connect:
E0328 23:08:15.903065    13 hal.cc:234] Stratum external facing services
are listening to 0.0.0.0:28000, localhost:28000...
Judging from the missing listening port, I'd say this could be the issue.

3. If you run ONOS in a container too, they have to reside in the same
network and you have to figure out the docker-internal IP for the Stratum
container:
# docker network ls
NETWORK ID          NAME                DRIVER              SCOPE
e737dd0dd90f        bridge              bridge              local
d2783152be24        host                host                local
7028e832e130        none                null                local

# docker network inspect bridge
[...]
"Containers": {

"518c901167919d34205959f1105aedebbb99a9452d191409ccf71a3908e14e56": {
                "Name": "zen_jennings",
                "EndpointID":
"a52025a671c9968372c52c7ed6b61df5a3168493466bd4b831c4728089b77163",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            }
        },
[...]

You could also try running them in the host network (--network=host), that
should make them behave like native processes with fully exposed networking.

4. I used a wrong switch in my previous post, here's how it looks on a
Tofino:

   -  ./start-stratum-container.sh (let it run and open new terminal tab)
   - docker container ls
   CONTAINER ID        IMAGE
          COMMAND                  CREATED             STATUS
    PORTS                      NAMES
   518c90116791
    stratumproject/stratum-bf:9.1.0-4.14.49-OpenNetworkLinux   "/bin/sh -c
   /stratum"   12 minutes ago      Up 12 minutes       0.0.0.0:28000
   ->28000/tcp   zen_jennings
   - ss -ltnp
   LISTEN      0      128                    :::28000
          :::*                   users:(("docker-proxy",pid=1179,fd=4))
   - docker exec -ti 518c90116791 bash (switch into the Stratum container)
   - apt update && apt install iproute
   - ss -tlnp
   State       Recv-Q Send-Q      Local Address:Port
   Peer Address:Port
   LISTEN      0      5                       *:9999
            *:*                   users:(("stratum_bf",pid=13,fd=27))
   LISTEN      0      128                     *:28000
           *:*                   users:(("stratum_bf",pid=13,fd=40))
   LISTEN      0      128             127.0.0.1:28000
           *:*                   users:(("stratum_bf",pid=13,fd=39))
   LISTEN      0      1                       *:9001
            *:*                   users:(("stratum_bf",pid=13,fd=28))
   - exit (leave container)
   - docker run -ti debian:9 bash (Start new container to simulate ONOS)
   - apt update && apt install netcat
   - nc -v 172.17.0.2 28000
   172.17.0.2: inverse host lookup failed: Unknown host
   (UNKNOWN) [172.17.0.2] 28000 (?) open


For reference, the used versions:

# docker images
REPOSITORY                  TAG                              IMAGE ID
     CREATED             SIZE
stratumproject/stratum-bf   9.1.0-4.14.49-OpenNetworkLinux   e4615d64018f
     2 weeks ago         214MB

For reference, these are the versions we use:
# docker version
Client: Docker Engine - Community
 Version:           19.03.2
 API version:       1.40
 Go version:        go1.12.8
 Git commit:        6a30dfca03
 Built:             Thu Aug 29 05:29:49 2019
 OS/Arch:           linux/amd64
 Experimental:      false

Server: Docker Engine - Community
 Engine:
  Version:          19.03.2
  API version:      1.40 (minimum version 1.12)
  Go version:       go1.12.8
  Git commit:       6a30dfca03
  Built:            Thu Aug 29 05:28:23 2019
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.2.6
  GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
 runc:
  Version:          1.0.0-rc8
  GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
 docker-init:
  Version:          0.18.0
  GitCommit:        fec3683

# uname -a
Linux Stordis 4.14.49-OpenNetworkLinux #1 SMP Thu Jul 18 08:52:25 UTC 2019
x86_64 GNU/Linux


Max

On Sat, Mar 28, 2020 at 7:31 AM Deval Bhamare <Deval.Bhamare at kau.se> wrote:

> Hello again,
>
>
> Since I could not any port activity on 28000 inside stratum and stratum
> logs shown only listen activity on *8008*, I used following command to do
> explicitly map the IP/ports to host:
>
>
> *./setup_dev_env.sh  --pull --  -p 192.168.60.131:28008
> <http://192.168.60.131:28008>:8008*
>
>
> Then I tried to push the netcfg.json with following URL and this time the
> communication channel is established. Logs from ONOS and stratum are below
> (BOLD RED).
>
>
> *URL*:
>
>
> *"managementAddress": "grpc://192.168.60.131:28008?device_id=0
> <http://192.168.60.131:28008?device_id=0>",*
>
> (I tired both deviceID 0 and 1, but it must be 0 as bf_shell and stratum
> Log both confirm: )
>
>
>
> *ONOS*:
>
>
> 2020-03-28T13:49:46,158 | WARN  | onos-gdp-0       | PiPipeconfManager
>             | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
> Ignoring PortStatisticsDiscovery behaviour from pipeconf vepg-pipeconf, but
> using the one provided by stratum-tofino driver...
>
> 2020-03-28T13:49:46,184 | INFO  | onos-gdp-0       |
> GrpcChannelControllerImpl        | 230 -
> org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | *Creating new
> gRPC channel grpc://192.168.60.131:28008?device_id=0.
> <http://192.168.60.131:28008?device_id=0.>.. << #THERE IS SUCCESS HERE THIS
> TIME AS COMPARED TO PREVIOUS TIME *
>
> *Stratum*:
>
>
> *Tcl server: connection accepted on port 8008*
>
> *Partial recv: 30 of 40 so far..  <<#STRATUM CONFIRMS IT*
>
>
> However, I am not sure, it is the correct entry point? The reason is ONOS
> still cannot find the device:tofino (highlighted Yellow RED)
>
>
> 2020-03-28T13:49:46,306 | INFO  | onos-gdp-0       | DeviceManager
>             | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
> Local role is MASTER for device:tofino
>
> 2020-03-28T13:49:46,311 | WARN  | onos-event-dispatch-default0 |
> ModelCache                       | 211 -
> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
> device:tofino not found as a UiDevice
>
> 2020-03-28T13:49:46,313 | INFO  | onos-gdp-0       | GeneralDeviceProvider
>           | 235 - org.onosproject.onos-providers-general-device -
> 2.4.0.SNAPSHOT | Notifying role MASTER (preference 0) for term 1 to
> device:tofino
>
> 2020-03-28T13:49:46,315 | WARN  | onos-event-dispatch-default0 |
> ModelCache                       | 211 -
> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | *DeviceID
> device:tofino not found as a UiDevice*
>
> 2020-03-28T13:49:46,316 | WARN  | onos-device-manager-background |
> DeviceManager                    | 193 - org.onosproject.onos-core-net -
> 2.4.0.SNAPSHOT | *Node was instructed to be MASTER role for
> device:tofino, but this node cannot reach the device.*  Relinquishing
> role.    *<<#STILL NO DEVICE FOUND. I TRIED BOTH ID 0 and 1 in the URL *
>
> 2020-03-28T13:49:46,317 | INFO  | onos-gdp-0       | StreamClientImpl
>             | 237 - org.onosproject.onos-protocols-p4runtime-ctl -
> 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true,
> newElectionId=20, masterElectionId=null, sessionOpen=false
>
> 2020-03-28T13:49:46,320 | WARN  | onos-event-dispatch-default0 |
> ModelCache                       | 211 -
> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
> device:tofino not found as a UiDevice
>
> 2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 |
> ModelCache                       | 211 -
> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
> device:tofino not found as a UiDevice
>
> 2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 |
> ModelCache                       | 211 -
> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
> device:tofino not found as a UiDevice
>
> 2020-03-28T13:49:46,336 | INFO  | onos-topo-build-1 | TopologyManager
>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
> Topology DefaultTopology{time=12233603415182, creationTime=1585403386336,
> computeCost=124274, clusters=0, devices=0, links=0} changed
>
> 2020-03-28T13:49:46,365 | INFO  | onos-gdp-0       | DeviceManager
>             | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
> Device device:tofino registered
>
>
>
>
> Please confirm, is it in the right direction or port 8008 is completely
> different? What can be the reason for device:tofino not able to find?
>
>
> Thank you,
>
> Deval.
>
>
> ------------------------------
> *From:* stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on
> behalf of Deval Bhamare via stratum-dev <
> stratum-dev at lists.stratumproject.org>
> *Sent:* Saturday, March 28, 2020 3:22:16 PM
> *To:* Maximilian Pudelko
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
>
> Hello Maximilian,
>
>
> Thank you for your reply and the useful suggestions. So as a first step I
> executed on switch ss -tnlp and below is the output. Surprisingly, there is *no
> Stratum anywhere there, however statrum is also running in a container*
> and the short logs are displayed below. I also executed ss command inside
> the container and those are also pasted below, if that may help.
>
>
> ss -tnlp outputs in different times are as follows:
>
>
> *- from tofino, before anything is started:*
>
>
> tofino at localhost:~$ ss -tnlp
>
> State      Recv-Q Send-Q                        Local Address:Port
>                   Peer Address:Port
>
> LISTEN     0      128                                       *:17
>                               *:*
>
> LISTEN     0      128                                       *:22
>                               *:*
>
> LISTEN     0      128                                       *:23
>                               *:*
>
> LISTEN     0      128                          192.168.60.131:10010
>                               *:*
>
> LISTEN     0      128                                      :::22
>                             :::*
>
>
> *- from tofino after stratum container is started*
>
>
> tofino at localhost:~$ ss -tnlp
>
> State      Recv-Q Send-Q                        Local Address:Port
>                   Peer Address:Port
>
> LISTEN     0      128                                       *:17
>                               *:*
>
> LISTEN     0      128                                       *:22
>                               *:*
>
> LISTEN     0      128                                       *:23
>                               *:*
>
> LISTEN     0      128                          192.168.60.131:10010
>                               *:*
>
> LISTEN     0      128                                      :::22
>                             :::*
>
> LISTEN     0      *128                                      :::28000 *
>                               :::*
>
>
> *- from tofino after stratum is running *
>
>
> tofino at localhost:~$ ss -tnlp
>
> State      Recv-Q Send-Q                        Local Address:Port
>                   Peer Address:Port
>
> LISTEN     0      128                                       *:17
>                               *:*
>
> LISTEN     0      128                                       *:22
>                               *:*
>
> LISTEN     0      128                                       *:23
>                               *:*
>
> LISTEN     0      128                          192.168.60.131:10010
>                               *:*
>
> LISTEN     0      128                                      :::22
>                             :::*
>
> LISTEN     0      128                                      :::28000
>                             :::*
>
>
> *- from stratum container, after running it in background *
>
>
> tofino at ced0c4d7ef8f:/stratum$ ss -tnlp
>
> State      Recv-Q Send-Q Local Address:Port                Peer
> Address:Port
>
> LISTEN     *0      1                  *:8008
> *:*                   users:(("stratum_bf",pid=323,fd=26)) << #IS this
> useful? *
>
> LISTEN     0      128        127.0.0.1:41418                          *:*
>                 users:(("java",pid=21,fd=110))
>
> Why there is no 28000 port here in Stratum container SS output. Or should
> I bind 8008 to 28000 on switch?
>
> As you have mentioned, I have already taken care of port mapping. So I run
> the container with -p28000:2000. It is verified in the outputs above as
> well.
>
>
> *- Docker output on switch *
>
>
> tofino at localhost:~$ docker ps
>
> CONTAINER ID        IMAGE               COMMAND             CREATED
>       STATUS              PORTS                      NAMES
>
> ced0c4d7ef8f        stratum-dev         "bash"              16 minutes ago
>     Up 16 minutes       *0.0.0.0:28000->28000/tcp*   goofy_hamilton
>
>
> *- Stratum log output after it started. *
>
>
> bf_sysfs_fname /sys/class/bf/bf0/device/dev_add
>
> Install dir: /stratum/bf-sde-8.9.0/install (0x7f876b794b60)
>
> bf_switchd: system services initialized
>
> bf_switchd: loading conf_file
> stratum/hal/bin/barefoot/tofino_skip_p4.conf...
>
> bf_switchd: processing device configuration...
>
> Configuration for dev_id 0
>
>   Family        : Tofino
>
>   pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0
>
>   pci_domain    : 0
>
>   pci_bus       : 5
>
>   pci_fn        : 0
>
>   pci_dev       : 0
>
>   pci_int_mode  : 1
>
>   sbus_master_fw: /stratum/bf-sde-8.9.0/install/
>
>   pcie_fw       : /stratum/bf-sde-8.9.0/install/
>
>   serdes_fw     : /stratum/bf-sde-8.9.0/install/
>
>   sds_fw_path   : /stratum/bf-sde-8.9.0/install/
>
>   microp_fw_path:
>
> bf_switchd: processing P4 configuration...
>
> P4 profile for dev_id 0
>
>   p4_name: dummy
>
>     libpd:
>
>     libpdthrift:
>
>     context:
>
>     config:
>
>   Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
>
>   diag:
>
>   mavericks diag:
>
>   non_default_port_ppgs: 0
>
>   SAI default initialize: 1
>
> bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
> loaded
>
> bf_switchd: agent[0] initialized
>
> Tcl server started..
>
> Tcl server: listen socket created
>
> Tcl server: bind done on port 8008, listening...
>
> Tcl server: waiting for incoming connections...
>
> sh: 1: onie-syseeprom: not found
>
> *2020-03-28 13:06:53.584090 BF_PLTFM ERROR - Error in cp2112
> initialization*
>
>
> *2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init
> failed  #<<< CAN IT BE THE ISSUE?*
>
>
> Thank you.
>
> Deval
>
>
> ------------------------------
> *From:* Maximilian Pudelko <max at opennetworking.org>
> *Sent:* Saturday, March 28, 2020 3:43:29 AM
> *To:* Deval Bhamare
> *Cc:* Yi Tseng; stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
> Hi Deval,
>
> can you run this command on the switch: ss -tlnp
> Should output something like this:
> State      Recv-Q Send-Q      Local Address:Port                     Peer
> Address:Port
> LISTEN     0      128                     *:22
>      *:*                   users:(("sshd",pid=4116,fd=3))
> LISTEN     0      128                    :::22
>     :::*                   users:(("sshd",pid=4116,fd=4))
> LISTEN     0      128      ::ffff:127.0.0.1:28000
>      :::*                   users:(("stratum_bcm",pid=26872,fd=19))
> LISTEN     0      128                    :::28001
>      :::*                   users:(("stratum_bcm",pid=26872,fd=20))
> LISTEN     0      128      ::ffff:127.0.0.1:28003
>      :::*                   users:(("stratum_bcm",pid=26872,fd=6))
>
> Also, do you have any logs from Stratum? Run with -v=1 -stderrthreshold=0
>
> Since you're using docker, I assume there is some issue with port
> forwarding/mapping. Follow these steps to check the port mapping:
> https://docs.docker.com/engine/reference/commandline/port/
> And these steps to fix it:
>
> https://stackoverflow.com/questions/22111060/what-is-the-difference-between-expose-and-publish-in-docker
>
> https://docs.docker.com/config/containers/container-networking/#published-ports
>
> Max
>
>
> On Thu, Mar 26, 2020 at 3:53 PM Deval Bhamare via stratum-dev <
> stratum-dev at lists.stratumproject.org> wrote:
>
>> Hello Yi,
>>
>>
>> I am running both ONOS and stratum container on the same machine, that is
>> the tofino switch with public IP 192.168.60.131.
>>
>>
>> So I tried with grpc://192.168.60.131:28000?device_id=1
>> <http://192.168.0.101:28000/?device_id=1>", as well now. This time
>> message is connection refused and still no connectivity.
>>
>>
>>
>>
>> 2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background |
>> DeviceManager                    | 193 - org.onosproject.onos-core-net -
>> 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino,
>> but this node cannot reach the device.  Relinquishing role.
>>
>> 2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       | StreamClientImpl
>>               | 237 - org.onosproject.onos-protocols-p4runtime-ctl -
>> 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true,
>> newElectionId=20, masterElectionId=null, sessionOpen=false
>>
>> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
>> ModelCache                       | 211 -
>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>> device:tofino not found as a UiDevice
>>
>> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
>> ModelCache                       | 211 -
>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>> device:tofino not found as a UiDevice
>>
>> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
>> ModelCache                       | 211 -
>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>> device:tofino not found as a UiDevice
>>
>> 2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager
>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
>> Topology DefaultTopology{time=2264511977012, creationTime=1585262479736,
>> computeCost=117691, clusters=0, devices=0, links=0} changed
>>
>> 2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager
>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
>> Device device:tofino registered
>>
>> 2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 |
>> StreamClientImpl                 | 237 -
>> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | *device:tofino
>> is unreachable (Connection refused: /192.168.60.131:28000
>> <http://192.168.60.131:28000>)*
>>
>> 2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager
>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
>> Topology DefaultTopology{time=2264549921343, creationTime=1585262479774,
>> computeCost=101378, clusters=0, devices=0, links=0} changed
>>
>> With grpc://127.0.0.1:28000?device_id=1
>> <http://192.168.0.101:28000/?device_id=1>", the error is
>>
>>
>> *onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on
>> StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for
>> unknown reason*
>>
>> Also Stratum logs say
>>
>>
>> bf_switchd: processing P4 configuration...
>>
>> *P4 profile for dev_id 0*
>>
>>
>> while starting, so I doubt device ID maybe 0 and hence tried with both
>> device_id=1 <http://192.168.0.101:28000/?device_id=1> and device_id=
>> <http://192.168.0.101:28000/?device_id=1>0 but no luck.
>>
>>
>>
>> Thanks,
>>
>>
>> Deval.
>> ------------------------------
>> *From:* Yi Tseng <yi at opennetworking.org>
>> *Sent:* Thursday, March 26, 2020 9:10:49 PM
>> *To:* Deval Bhamare
>> *Cc:* stratum-dev at lists.stratumproject.org
>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>
>> Hi Deval,
>>
>> Where you are running the ONOS controller? If you are running the ONOS
>> controller on a server, you need to set the management address to your
>> switch IP address.
>>
>> For example, you run the ONOS on a server with IP address 192.168.0.100
>> and running the Stratum on a switch with IP address 192.168.0.101. (And I
>> assume that you have connectivity between the server and the switch)
>>
>> The netcfg.json will look like:
>>
>> {
>>   "devices": {
>>     "device:tofino": {
>>       "basic": {
>>         "managementAddress": "grpc://192.168.0.101:28000?device_id=1",
>>         "driver": "stratum-tofino",
>>         "pipeconf": "[your pipeconf name]"
>>        }
>>     }
>>    }
>> }
>>
>> Please also note that the device ID is 1 in the Stratum
>>
>> Yi
>>
>>
>> On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se>
>> wrote:
>>
>>> Hello Yi,
>>>
>>>
>>> We have received a reply from Stordis and as per their suggestion, we
>>> can ignore the syseeprom error
>>>
>>>
>>> *You see only syseeprom errorr please ignore that :*
>>> *Tcl server: listen socket created*
>>> *Tcl server: bind done on port 8008, listening...*
>>> *Tcl server: waiting for incoming connections...*
>>> *sh: 1: onie-syseeprom: not found <Ignore this error>*
>>> *Health monitor started *
>>> *Operational mode set to ASIC*
>>>
>>>
>>> So, now when I try to push the netcfg.json for our device to Onos, I get
>>> following message:
>>>
>>>
>>> 2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl
>>>               | 237 - org.onosproject.onos-protocols-p4runtime-ctl -
>>> 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true,
>>> newElectionId=20, masterElectionId=null, sessionOpen=false
>>>
>>> 2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 |
>>> ModelCache                       | 211 -
>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>> device:tofino not found as a UiDevice
>>>
>>> 2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 |
>>> ModelCache                       | 211 -
>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>> device:tofino not found as a UiDevice
>>>
>>> 2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 |
>>> ModelCache                       | 211 -
>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>> device:tofino not found as a UiDevice
>>>
>>> 2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager
>>>                 | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT
>>> | Topology DefaultTopology{time=20452353961040, creationTime=1585173541276,
>>> computeCost=427068, clusters=0, devices=0, links=0} changed
>>>
>>> 2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager
>>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |*
>>> Device device:tofino registered*
>>>
>>> 2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 |
>>> StreamClientImpl                 | 237 -
>>> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT |* Error
>>> on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for
>>> unknown reason*
>>>
>>> 2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager
>>>                 | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT
>>> | Topology DefaultTopology{time=20452397561034, creationTime=1585173541319,
>>> computeCost=112832, clusters=0, devices=0, links=0} changed
>>>
>>>
>>>
>>> ONOS CLI show, device available=false.
>>>
>>>
>>> tofino at root > devices
>>>       21:58:49
>>>
>>> id=device:tofino, *available=false*, local-status=disconnected 37s ago,
>>> role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum,
>>> serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf,
>>> locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0,
>>> name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI
>>>
>>>
>>> Netcfg.json contents are:
>>>
>>> {
>>> "devices": {
>>> "device:tofino": {
>>> "basic": {
>>> "managementAddress": "grpc://127.0.0.1?device_id=0",
>>> "driver": "stratum-tofino",
>>> "pipeconf": "vepg-pipeconf"
>>> }
>>> }
>>> }
>>> }
>>>
>>> Command is:
>>>
>>>
>>> curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H
>>> 'Content-Type:application/json' '
>>> http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json
>>>
>>>
>>>
>>> Any idea what may be the issue?
>>>
>>>
>>> Thanks,
>>>
>>> Deval.
>>>
>>>
>>> ------------------------------
>>> *From:* Yi Tseng <yi at opennetworking.org>
>>> *Sent:* Tuesday, March 24, 2020 3:25:06 PM
>>> *To:* Deval Bhamare
>>> *Cc:* stratum-dev at lists.stratumproject.org
>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>
>>> Hi Deval,
>>>
>>> I am now working on updating the script to support the custom platform
>>> parameter <https://github.com/stratum/stratum/pull/150> since the
>>> Stratum cannot detect the platform without the ONLP.
>>>
>>> Should be merged soon.
>>>
>>> On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se>
>>> wrote:
>>>
>>>> Hello Yi,
>>>>
>>>>
>>>> I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux,
>>>> however, the error still persists:
>>>>
>>>>
>>>> + KERNEL_VERSION=3.16.64-OpenNetworkLinux
>>>>
>>>> + DOCKER_IMAGE=stratumproject/stratum-bf
>>>>
>>>> + DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux
>>>>
>>>> ++ uname -r
>>>>
>>>> ++ uname -r
>>>>
>>>> + docker run -it --privileged -v /dev:/dev -v /sys:/sys -v
>>>> /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux
>>>> -v
>>>> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so
>>>> -v
>>>> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1
>>>> -v
>>>> /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so
>>>> -v
>>>> /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1
>>>> -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v
>>>> /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v
>>>> /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p
>>>> 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs
>>>> stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux
>>>>
>>>> *Use default flag file*
>>>>
>>>> *Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json*
>>>>
>>>>
>>>> I also had peek at the script *start-stratum-container.sh* and found
>>>> an option of *ONLP_ARG="--env WITH_ONLP=false"*
>>>> . So I wanted to ask whether I can set this option with Docker to force
>>>> BSP usage, let us say, by hard-coding it in the script itself (also similar
>>>> approach to set PORT_MAP in *stratume_entrypoint.sh*). I tried this
>>>> and the error message in this case is:
>>>>
>>>>
>>>> *Use default flag file*
>>>>
>>>> *Cannot find /usr/local/share/stratum/.json *
>>>>
>>>> Please suggest.
>>>>
>>>> Thanks,
>>>> Deval.
>>>>
>>>> ------------------------------
>>>> *From:* Yi Tseng <yi at opennetworking.org>
>>>> *Sent:* Thursday, March 12, 2020 6:57 AM
>>>> *To:* Deval Bhamare
>>>> *Cc:* Narada Hess; stratum-dev at lists.stratumproject.org
>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>
>>>> Hi Deval,
>>>>
>>>> We don't support Barefoot thrift APIs in Stratum. We support some
>>>> Barefoot API like port API via gNMI and the chassis config.
>>>>
>>>> For missing JSON file, I can confirm that our internal CI did not
>>>> include the latest Stratum with kernel 3.16.56
>>>>
>>>> I just rebuild it and uploaded the new container image to the Docker
>>>> hub
>>>> <https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>,
>>>> feel free to let me know if the issue still exists.
>>>>
>>>> About the missing library, can you run this command in your shell?
>>>>
>>>> *LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd
>>>> ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf*
>>>>
>>>> I think the system linker may have some issue to find the library.
>>>>
>>>> The *libavago.so.0 *is a symbolic link to *libavago.so*. the
>>>> libavago.so must also exists.
>>>>
>>>>
>>>>
>>>> *ls -al $BF_SDE_INSTALL/lib/libavago* -rwxr-xr-x 1 root root 1185264
>>>> Mar 12 04:19 libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>>>> libavago.so.0 -> libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>>>> libavago.so.0.0.0 -> libavago.so*
>>>>
>>>>
>>>>
>>>
>>> --
>>> Yi Tseng
>>> Member of Technical Staff
>>> Open Networking Foundation
>>> https://www.opennetworking.org/
>>>
>>
>>
>> --
>> Yi Tseng
>> Member of Technical Staff
>> Open Networking Foundation
>> https://www.opennetworking.org/
>> _______________________________________________
>> stratum-dev mailing list
>> stratum-dev at lists.stratumproject.org
>> https://lists.stratumproject.org/listinfo/stratum-dev
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200328/516eef5d/attachment-0001.html>

From Deval.Bhamare at kau.se  Sun Mar 29 09:20:10 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Sun, 29 Mar 2020 09:20:10 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAFh9Y_NLCng9zN3zak+nc1WjTjwyztN18gjZBOzeKQRvd+vXJQ@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <08df48cbcfc3462fa41128f05c60db07@kau.se>
 <CAOyFVR3-vjAwOKDuQ1R5+z9s1Y3zZUD+UX_AQoK8-jJ3q5T5_g@mail.gmail.com>
 <a6d7c4b6ed894c31bc007500efbf8b71@kau.se>
 <CAOyFVR0wZCAN+RQQybzGydK6rNwyyjqmdy9kBrk8wSBGASYDRQ@mail.gmail.com>
 <01010171190c9981-833ae934-2420-4a40-abde-3f9542415656-000000@us-west-2.amazonses.com>
 <CAFh9Y_NuM3SnxdpU_PamscwO8e7F_cnp5etZ2Z=XMFwzb+O-MQ@mail.gmail.com>
 <01010171214eab35-94a8581f-ed3b-4aae-abb9-58b7f2151df3-000000@us-west-2.amazonses.com>
 <cd881b8db56449b5a9e1a6477cd46398@kau.se>,
 <CAFh9Y_NLCng9zN3zak+nc1WjTjwyztN18gjZBOzeKQRvd+vXJQ@mail.gmail.com>
Message-ID: <0421bf65803443d39b0f64b037b72282@kau.se>

Hello Maximilian,


There is a littler confusion here. I am not using pre-built containerized version of Stratum.

However, I am locally building it by starting a development container with command "./setup_dev_env.sh  --pull -- -p 28000:28000" (I have mentioned it in the earlier image as well) as mentioned here: https://github.com/stratum/stratum

and then I try to build and run stratum as mentioned here: https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md



Now with the build-from-scratch using development container approach, I followed your steps, however, when I run ss -tnlp from the container (afterdocker exec -ti bash), I get below and listen on  127.0.0.1:28000 is missing. I get only below.



tofino at 39e19c57ea27:/stratum$ ss -tlnp

State       Recv-Q Send-Q     Local Address:Port                    Peer Address:Port

LISTEN      0      128            127.0.0.1:56929                              *:*                   users:(("java",pid=21,fd=110))

LISTEN      0      1                      *:8008                               *:*                   users:(("stratum_bf",pid=310,fd=26))

Command to build Stratum is: bazel build //stratum/hal/bin/barefoot:stratum_bf --define phal_with_onlp=false --define sde_ver=8.9.2

Command to run Stratum is:

     ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
       --external_stratum_urls=0.0.0.0:28000 \
       --grpc_max_recv_msg_size=256 \
       --bf_sde_install=$BF_SDE_INSTALL \
       --persistent_config_dir=/stratum/config/ \
       --forwarding_pipeline_configs_file=/stratum/config/p4_pipeline.pb.txt \
       --chassis_config_file=/stratum/config/chassis_config.pb.txt \
       --write_req_log_file=/stratum/config/p4_writes.pb.txt \
       --bf_sim




[Note: I had also tried the option of using pre-built docker container, with 8.9.1-3.16.56-OpenNetworkLinux, however, in this case I get error:

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json

I had reported that also and tried new container but didn't work]


Thanks,

Deval.


________________________________
From: Maximilian Pudelko <max at opennetworking.org>
Sent: Sunday, March 29, 2020 1:46:04 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org; Andreas Kassler
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

There are many things going on in your setup, let's do this step by step:

1. Port 8008 is NOT what you want for ONOS. I'm no Tofino expert, but this seems to be a separate endpoint for something else (debugging?). We always use port 28000.

2. 2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?
Depends. It's probably not good, but as long as you see this line in the Stratum logs, ONOS should be able to connect:
E0328 23:08:15.903065    13 hal.cc:234] Stratum external facing services are listening to 0.0.0.0:28000<http://0.0.0.0:28000>, localhost:28000...
Judging from the missing listening port, I'd say this could be the issue.

3. If you run ONOS in a container too, they have to reside in the same network and you have to figure out the docker-internal IP for the Stratum container:
# docker network ls
NETWORK ID          NAME                DRIVER              SCOPE
e737dd0dd90f        bridge              bridge              local
d2783152be24        host                host                local
7028e832e130        none                null                local

# docker network inspect bridge
[...]
"Containers": {
            "518c901167919d34205959f1105aedebbb99a9452d191409ccf71a3908e14e56": {
                "Name": "zen_jennings",
                "EndpointID": "a52025a671c9968372c52c7ed6b61df5a3168493466bd4b831c4728089b77163",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            }
        },
[...]

You could also try running them in the host network (--network=host), that should make them behave like native processes with fully exposed networking.

4. I used a wrong switch in my previous post, here's how it looks on a Tofino:

  *    ./start-stratum-container.sh (let it run and open new terminal tab)
  *   docker container ls
CONTAINER ID        IMAGE                                                      COMMAND                  CREATED             STATUS              PORTS                      NAMES
518c90116791        stratumproject/stratum-bf:9.1.0-4.14.49-OpenNetworkLinux   "/bin/sh -c /stratum"   12 minutes ago      Up 12 minutes       0.0.0.0:28000->28000/tcp   zen_jennings
  *   ss -ltnp
LISTEN      0      128                    :::28000                              :::*                   users:(("docker-proxy",pid=1179,fd=4))
  *   docker exec -ti 518c90116791 bash (switch into the Stratum container)
  *   apt update && apt install iproute
  *   ss -tlnp
State       Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN      0      5                       *:9999                                *:*                   users:(("stratum_bf",pid=13,fd=27))
LISTEN      0      128                     *:28000                               *:*                   users:(("stratum_bf",pid=13,fd=40))
LISTEN      0      128             127.0.0.1:28000<http://127.0.0.1:28000>                               *:*                   users:(("stratum_bf",pid=13,fd=39))
LISTEN      0      1                       *:9001                                *:*                   users:(("stratum_bf",pid=13,fd=28))
  *   exit (leave container)
  *   docker run -ti debian:9 bash (Start new container to simulate ONOS)
  *   apt update && apt install netcat
  *   nc -v 172.17.0.2 28000
172.17.0.2<http://172.17.0.2>: inverse host lookup failed: Unknown host
(UNKNOWN) [172.17.0.2] 28000 (?) open

For reference, the used versions:

# docker images
REPOSITORY                  TAG                              IMAGE ID            CREATED             SIZE
stratumproject/stratum-bf   9.1.0-4.14.49-OpenNetworkLinux   e4615d64018f        2 weeks ago         214MB

For reference, these are the versions we use:
# docker version
Client: Docker Engine - Community
 Version:           19.03.2
 API version:       1.40
 Go version:        go1.12.8
 Git commit:        6a30dfca03
 Built:             Thu Aug 29 05:29:49 2019
 OS/Arch:           linux/amd64
 Experimental:      false

Server: Docker Engine - Community
 Engine:
  Version:          19.03.2
  API version:      1.40 (minimum version 1.12)
  Go version:       go1.12.8
  Git commit:       6a30dfca03
  Built:            Thu Aug 29 05:28:23 2019
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.2.6
  GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
 runc:
  Version:          1.0.0-rc8
  GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
 docker-init:
  Version:          0.18.0
  GitCommit:        fec3683

# uname -a
Linux Stordis 4.14.49-OpenNetworkLinux #1 SMP Thu Jul 18 08:52:25 UTC 2019 x86_64 GNU/Linux


Max

On Sat, Mar 28, 2020 at 7:31 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,


Since I could not any port activity on 28000 inside stratum and stratum logs shown only listen activity on 8008, I used following command to do explicitly map the IP/ports to host:


./setup_dev_env.sh  --pull --  -p 192.168.60.131:28008<http://192.168.60.131:28008>:8008


Then I tried to push the netcfg.json with following URL and this time the communication channel is established. Logs from ONOS and stratum are below (BOLD RED).


URL:


"managementAddress": "grpc://192.168.60.131:28008?device_id=0<http://192.168.60.131:28008?device_id=0>",


(I tired both deviceID 0 and 1, but it must be 0 as bf_shell and stratum Log both confirm: )



ONOS:


2020-03-28T13:49:46,158 | WARN  | onos-gdp-0       | PiPipeconfManager                | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Ignoring PortStatisticsDiscovery behaviour from pipeconf vepg-pipeconf, but using the one provided by stratum-tofino driver...

2020-03-28T13:49:46,184 | INFO  | onos-gdp-0       | GrpcChannelControllerImpl        | 230 - org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Creating new gRPC channel grpc://192.168.60.131:28008?device_id=0.<http://192.168.60.131:28008?device_id=0.>.. << #THERE IS SUCCESS HERE THIS TIME AS COMPARED TO PREVIOUS TIME


Stratum:


Tcl server: connection accepted on port 8008

Partial recv: 30 of 40 so far..  <<#STRATUM CONFIRMS IT



However, I am not sure, it is the correct entry point? The reason is ONOS still cannot find the device:tofino (highlighted Yellow RED)


2020-03-28T13:49:46,306 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Local role is MASTER for device:tofino

2020-03-28T13:49:46,311 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,313 | INFO  | onos-gdp-0       | GeneralDeviceProvider            | 235 - org.onosproject.onos-providers-general-device - 2.4.0.SNAPSHOT | Notifying role MASTER (preference 0) for term 1 to device:tofino

2020-03-28T13:49:46,315 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,316 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.    <<#STILL NO DEVICE FOUND. I TRIED BOTH ID 0 and 1 in the URL

2020-03-28T13:49:46,317 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-28T13:49:46,320 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,336 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=12233603415182, creationTime=1585403386336, computeCost=124274, clusters=0, devices=0, links=0} changed

2020-03-28T13:49:46,365 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered




Please confirm, is it in the right direction or port 8008 is completely different? What can be the reason for device:tofino not able to find?


Thank you,

Deval.


________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org<mailto:stratum-dev-bounces at lists.stratumproject.org>> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>>
Sent: Saturday, March 28, 2020 3:22:16 PM
To: Maximilian Pudelko
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Maximilian,


Thank you for your reply and the useful suggestions. So as a first step I executed on switch ss -tnlp and below is the output. Surprisingly, there is no Stratum anywhere there, however statrum is also running in a container and the short logs are displayed below. I also executed ss command inside the container and those are also pasted below, if that may help.


ss -tnlp outputs in different times are as follows:


- from tofino, before anything is started:


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*



- from tofino after stratum container is started


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from tofino after stratum is running


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from stratum container, after running it in background


tofino at ced0c4d7ef8f:/stratum$ ss -tnlp

State      Recv-Q Send-Q Local Address:Port                Peer Address:Port

LISTEN     0      1                  *:8008                           *:*                   users:(("stratum_bf",pid=323,fd=26)) << #IS this useful?

LISTEN     0      128        127.0.0.1:41418<http://127.0.0.1:41418>                          *:*                   users:(("java",pid=21,fd=110))


Why there is no 28000 port here in Stratum container SS output. Or should I bind 8008 to 28000 on switch?

As you have mentioned, I have already taken care of port mapping. So I run the container with -p28000:2000. It is verified in the outputs above as well.


- Docker output on switch


tofino at localhost:~$ docker ps

CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                      NAMES

ced0c4d7ef8f        stratum-dev         "bash"              16 minutes ago      Up 16 minutes       0.0.0.0:28000->28000/tcp   goofy_hamilton



- Stratum log output after it started.


bf_sysfs_fname /sys/class/bf/bf0/device/dev_add

Install dir: /stratum/bf-sde-8.9.0/install (0x7f876b794b60)

bf_switchd: system services initialized

bf_switchd: loading conf_file stratum/hal/bin/barefoot/tofino_skip_p4.conf...

bf_switchd: processing device configuration...

Configuration for dev_id 0

  Family        : Tofino

  pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0

  pci_domain    : 0

  pci_bus       : 5

  pci_fn        : 0

  pci_dev       : 0

  pci_int_mode  : 1

  sbus_master_fw: /stratum/bf-sde-8.9.0/install/

  pcie_fw       : /stratum/bf-sde-8.9.0/install/

  serdes_fw     : /stratum/bf-sde-8.9.0/install/

  sds_fw_path   : /stratum/bf-sde-8.9.0/install/

  microp_fw_path:

bf_switchd: processing P4 configuration...

P4 profile for dev_id 0

  p4_name: dummy

    libpd:

    libpdthrift:

    context:

    config:

  Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so

  diag:

  mavericks diag:

  non_default_port_ppgs: 0

  SAI default initialize: 1

bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so loaded

bf_switchd: agent[0] initialized

Tcl server started..

Tcl server: listen socket created

Tcl server: bind done on port 8008, listening...

Tcl server: waiting for incoming connections...

sh: 1: onie-syseeprom: not found

2020-03-28 13:06:53.584090 BF_PLTFM ERROR - Error in cp2112 initialization


2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?



Thank you.

Deval


________________________________
From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Saturday, March 28, 2020 3:43:29 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

can you run this command on the switch: ss -tlnp
Should output something like this:
State      Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN     0      128                     *:22                                  *:*                   users:(("sshd",pid=4116,fd=3))
LISTEN     0      128                    :::22                                 :::*                   users:(("sshd",pid=4116,fd=4))
LISTEN     0      128      ::ffff:127.0.0.1:28000<http://127.0.0.1:28000>                              :::*                   users:(("stratum_bcm",pid=26872,fd=19))
LISTEN     0      128                    :::28001                              :::*                   users:(("stratum_bcm",pid=26872,fd=20))
LISTEN     0      128      ::ffff:127.0.0.1:28003<http://127.0.0.1:28003>                              :::*                   users:(("stratum_bcm",pid=26872,fd=6))

Also, do you have any logs from Stratum? Run with -v=1 -stderrthreshold=0

Since you're using docker, I assume there is some issue with port forwarding/mapping. Follow these steps to check the port mapping: https://docs.docker.com/engine/reference/commandline/port/
And these steps to fix it:
https://stackoverflow.com/questions/22111060/what-is-the-difference-between-expose-and-publish-in-docker
https://docs.docker.com/config/containers/container-networking/#published-ports

Max


On Thu, Mar 26, 2020 at 3:53 PM Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:

Hello Yi,


I am running both ONOS and stratum container on the same machine, that is the tofino switch with public IP 192.168.60.131.


So I tried with grpc://192.168.60.131:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", as well now. This time message is connection refused and still no connectivity.




2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.

2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264511977012, creationTime=1585262479736, computeCost=117691, clusters=0, devices=0, links=0} changed

2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | device:tofino is unreachable (Connection refused: /192.168.60.131:28000<http://192.168.60.131:28000>)

2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264549921343, creationTime=1585262479774, computeCost=101378, clusters=0, devices=0, links=0} changed


With grpc://127.0.0.1:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", the error is


onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason


Also Stratum logs say


bf_switchd: processing P4 configuration...

P4 profile for dev_id 0


while starting, so I doubt device ID maybe 0 and hence tried with both device_id=1<http://192.168.0.101:28000/?device_id=1> and device_id=<http://192.168.0.101:28000/?device_id=1>0 but no luck.



Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 26, 2020 9:10:49 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

Where you are running the ONOS controller? If you are running the ONOS controller on a server, you need to set the management address to your switch IP address.

For example, you run the ONOS on a server with IP address 192.168.0.100 and running the Stratum on a switch with IP address 192.168.0.101. (And I assume that you have connectivity between the server and the switch)

The netcfg.json will look like:

{
  "devices": {
    "device:tofino": {
      "basic": {
        "managementAddress": "grpc://192.168.0.101:28000?device_id=1<http://192.168.0.101:28000?device_id=1>",
        "driver": "stratum-tofino",
        "pipeconf": "[your pipeconf name]"
       }
    }
   }
}

Please also note that the device ID is 1 in the Stratum

Yi


On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


We have received a reply from Stordis and as per their suggestion, we can ignore the syseeprom error


You see only syseeprom errorr please ignore that :
Tcl server: listen socket created
Tcl server: bind done on port 8008, listening...
Tcl server: waiting for incoming connections...
sh: 1: onie-syseeprom: not found <Ignore this error>
Health monitor started
Operational mode set to ASIC



So, now when I try to push the netcfg.json for our device to Onos, I get following message:


2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452353961040, creationTime=1585173541276, computeCost=427068, clusters=0, devices=0, links=0} changed

2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason

2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452397561034, creationTime=1585173541319, computeCost=112832, clusters=0, devices=0, links=0} changed



ONOS CLI show, device available=false.


tofino at root > devices                                                        21:58:49

id=device:tofino, available=false, local-status=disconnected 37s ago, role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0<http://127.0.0.1:28000?device_id=0>, name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI



Netcfg.json contents are:

{
        "devices": {
        "device:tofino": {
        "basic": {
        "managementAddress": "grpc://127.0.0.1?device_id=0<http://127.0.0.1?device_id=0>",
        "driver": "stratum-tofino",
        "pipeconf": "vepg-pipeconf"
        }
        }
        }
        }


Command is:


curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H 'Content-Type:application/json' 'http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json



Any idea what may be the issue?


Thanks,

Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Tuesday, March 24, 2020 3:25:06 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

I am now working on updating the script to support the custom platform parameter<https://github.com/stratum/stratum/pull/150> since the Stratum cannot detect the platform without the ONLP.

Should be merged soon.

On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux, however, the error still persists:


+ KERNEL_VERSION=3.16.64-OpenNetworkLinux

+ DOCKER_IMAGE=stratumproject/stratum-bf

+ DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux

++ uname -r

++ uname -r

+ docker run -it --privileged -v /dev:/dev -v /sys:/sys -v /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1 -v /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so -v /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1 -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux

Use default flag file

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json



I also had peek at the script start-stratum-container.sh and found an option of ONLP_ARG="--env WITH_ONLP=false"
. So I wanted to ask whether I can set this option with Docker to force BSP usage, let us say, by hard-coding it in the script itself (also similar approach to set PORT_MAP in stratume_entrypoint.sh). I tried this and the error message in this case is:


Use default flag file

Cannot find /usr/local/share/stratum/.json

Please suggest.

Thanks,
Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 12, 2020 6:57 AM
To: Deval Bhamare
Cc: Narada Hess; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>, feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf

I think the system linker may have some issue to find the library.

The libavago.so.0 is a symbolic link to libavago.so. the libavago.so must also exists.
ls -al $BF_SDE_INSTALL/lib/libavago*
-rwxr-xr-x 1 root root 1185264 Mar 12 04:19 libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0 -> libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0 -> libavago.so




--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200329/4caaa50e/attachment-0001.html>

From yi at opennetworking.org  Mon Mar 30 04:32:05 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Mon, 30 Mar 2020 12:32:05 +0800
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <e14ebcb4f1cc4c11a3a48af5acc4801b@kau.se>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <08df48cbcfc3462fa41128f05c60db07@kau.se>
 <CAOyFVR3-vjAwOKDuQ1R5+z9s1Y3zZUD+UX_AQoK8-jJ3q5T5_g@mail.gmail.com>
 <a6d7c4b6ed894c31bc007500efbf8b71@kau.se>
 <CAOyFVR0wZCAN+RQQybzGydK6rNwyyjqmdy9kBrk8wSBGASYDRQ@mail.gmail.com>
 <01010171190c9981-833ae934-2420-4a40-abde-3f9542415656-000000@us-west-2.amazonses.com>
 <CAFh9Y_NuM3SnxdpU_PamscwO8e7F_cnp5etZ2Z=XMFwzb+O-MQ@mail.gmail.com>
 <01010171214eab35-94a8581f-ed3b-4aae-abb9-58b7f2151df3-000000@us-west-2.amazonses.com>
 <cd881b8db56449b5a9e1a6477cd46398@kau.se>
 <CAFh9Y_NLCng9zN3zak+nc1WjTjwyztN18gjZBOzeKQRvd+vXJQ@mail.gmail.com>
 <0421bf65803443d39b0f64b037b72282@kau.se>
 <e14ebcb4f1cc4c11a3a48af5acc4801b@kau.se>
Message-ID: <CAOyFVR0xekODA96sMZxUXLPd0UA_h=BjWe1REBW2SpAgO=sTmw@mail.gmail.com>

Hi Deval,

We've updated the container image and the script to start the container:
https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/start-stratum-container.sh

You can now try the following command to start the Stratum container with
no ONLP support:
*PLATFORM=x86-64-stordis-bf2556x-1t-r0 SDE_VERSION=8.9.2
./start-stratum-container.sh*

For the "unimplemented" message you saw, the SDE 8.9.2 uses old version PI
library which doesn't implement some features (reading default entry from a
table).
You can ignore that warning or use a newer version of Stratum (with SDE >=
9.0.0)

Yi


On Sun, Mar 29, 2020 at 8:31 PM Deval Bhamare <Deval.Bhamare at kau.se> wrote:

> Hello again,
>
>
>
> Just don't want to overload with the information, but I wanted to mention
> that, with the *pre-built docker image option*, I had a look a the
> ./start-stratum-container.sh
>
>
> Since I want to run Stratum with BSP, I made a change as:
>
>
> ONLP_ARG="--env WITH_ONLP=false"
>
> Then I started the container 8.9.2-3.16.56-OpenNetworkLinux and it
> executed the Stratum successfully. Stratum open bf-sde prompt.
>
>
> *Also ss ouptput is: *
>
>
> State      Recv-Q Send-Q          Local Address:Port
>     Peer Address:Port
>
> LISTEN     0      128                         *:28000
>               *:*
> users:(("stratum_bf_no_o",pid=10,fd=36))
>
> LISTEN     0      128                 127.0.0.1:28000
>               *:*
> users:(("stratum_bf_no_o",pid=10,fd=35))
>
> LISTEN     0      128                 127.0.0.1:28003
>               *:*
> users:(("stratum_bf_no_o",pid=10,fd=32))
>
> LISTEN     0      5                           *:9999
>               *:*
> users:(("stratum_bf_no_o",pid=10,fd=27))
>
> I am getting following messages now:
>
>
>  ONOS-CLI logs for the confirmation below:
>
>
> tofino at root > devices
>                             22:02:35
>
> id=device:tofino, *available=true*, local-status=connected 4m52s ago,
> role=MASTER, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum,
> serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf,
> locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=1,
> name=device:tofino, p4DeviceId=1, protocol=P4Runtime, gNMI, gNOI
>
> Logs on stratum bf-sde are:
>
>
> bf-sde.lld> E0329 22:01:52.649449   249 PI-device_mgr.cpp:0] Reading
> default entry not supported yet
>
> E0329 22:01:52.649509   249 pi_node.cc:187] Return Error:
> toUtilStatus(status, details) failed with generic::unimplemented:
>
> E0329 22:01:52.649549   249 p4_service.cc:307] Failed to read forwarding
> entries from node 1:
>
> ONOS Logs:
>
>
> 2020-03-29T22:08:22,649 | WARN  | grpc-default-executor-4 |
> P4RuntimeClientImpl              | 230 -
> org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Error while
> performing READ on device:tofino: UNIMPLEMENTED
>
>
>
> So, now ONOS can talk to Tofino through Stratum, but there are a few
> errors. First of all, is it OK to explicitly use this option: "--env
> WITH_ONLP=false" If yes, am I missing some steps here?  Any suggestion?
>
>
>
> (Note: If I use default value of ONLP_ARG as per the original script, I
> get error as:
>
>
> Use default flag file
>
> Cannot find /usr/local/lib/modules/bf_kdrv.ko, skip installing the Kernel
> module
>
> /usr/local/bin/stratum_bf: symbol lookup error: /usr/local/bin/stratum_bf:
> undefined symbol: onlp_sw_init
> )
>
>
>
> Thank you,
>
>
> Deval.
>
>
> ------------------------------
> *From:* Deval Bhamare
> *Sent:* Sunday, March 29, 2020 12:20:10 PM
> *To:* Maximilian Pudelko
> *Cc:* Yi Tseng; stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
>
> Hello Maximilian,
>
>
> There is a littler confusion here. I am *not using pre-built
> containerized version of Stratum*.
>
> However, I am locally *building it by starting a development container*
> with command "*./setup_dev_env.sh  --pull -- -p 28000:28000*" (I have
> mentioned it in the earlier image as well) as mentioned here:
> https://github.com/stratum/stratum
>
> and then I try to build and run stratum as mentioned here:
> https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md
>
>
>
> Now with the build-from-scratch using development container approach, I
> followed your steps, however, when I run *ss -tnlp* from the container
> (afterdocker exec -ti bash), I get below and listen on  127.0.0.1:28000
> is *missing*. I get only below.
>
>
>
> tofino at 39e19c57ea27:/stratum$ ss -tlnp
>
> State       Recv-Q Send-Q     Local Address:Port                    Peer
> Address:Port
>
> LISTEN      0      128            127.0.0.1:56929
>       *:*                   users:(("java",pid=21,fd=110))
>
> LISTEN      0      1                      *:8008
>       *:*                   users:(("stratum_bf",pid=310,fd=26))
>
> *Command to build Stratum is*: bazel build
> //stratum/hal/bin/barefoot:stratum_bf --define phal_with_onlp=false
> --define sde_ver=8.9.2
>
> *Command to run Stratum is*:
>
>      ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
>        --external_stratum_urls=0.0.0.0:28000 \
>        --grpc_max_recv_msg_size=256 \
>        --bf_sde_install=$BF_SDE_INSTALL \
>        --persistent_config_dir=/stratum/config/ \
>
>  --forwarding_pipeline_configs_file=/stratum/config/p4_pipeline.pb.txt \
>        --chassis_config_file=/stratum/config/chassis_config.pb.txt \
>        --write_req_log_file=/stratum/config/p4_writes.pb.txt \
>        --bf_sim
>
>
>
>
> [*Note*: I had also tried the option of using pre-built docker container,
> with 8.9.1-3.16.56-OpenNetworkLinux, however, in this case I get error:
>
> Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json
>
> I had reported that also and tried new container but didn't work]
>
> Thanks,
>
> Deval.
>
>
> ------------------------------
> *From:* Maximilian Pudelko <max at opennetworking.org>
> *Sent:* Sunday, March 29, 2020 1:46:04 AM
> *To:* Deval Bhamare
> *Cc:* Yi Tseng; stratum-dev at lists.stratumproject.org; Andreas Kassler
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
> Hi Deval,
>
> There are many things going on in your setup, let's do this step by step:
>
> 1. Port 8008 is NOT what you want for ONOS. I'm no Tofino expert, but this
> seems to be a separate endpoint for something else (debugging?). We always
> use port 28000.
>
> 2. *2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init
> failed  #<<< CAN IT BE THE ISSUE?*
> Depends. It's probably not good, but as long as you see this line in the
> Stratum logs, ONOS should be able to connect:
> E0328 23:08:15.903065    13 hal.cc:234] Stratum external facing services
> are listening to 0.0.0.0:28000, localhost:28000...
> Judging from the missing listening port, I'd say this could be the issue.
>
> 3. If you run ONOS in a container too, they have to reside in the same
> network and you have to figure out the docker-internal IP for the Stratum
> container:
> # docker network ls
> NETWORK ID          NAME                DRIVER              SCOPE
> e737dd0dd90f        bridge              bridge              local
> d2783152be24        host                host                local
> 7028e832e130        none                null                local
>
> # docker network inspect bridge
> [...]
> "Containers": {
>
> "518c901167919d34205959f1105aedebbb99a9452d191409ccf71a3908e14e56": {
>                 "Name": "zen_jennings",
>                 "EndpointID":
> "a52025a671c9968372c52c7ed6b61df5a3168493466bd4b831c4728089b77163",
>                 "MacAddress": "02:42:ac:11:00:02",
>                 "IPv4Address": "172.17.0.2/16",
>                 "IPv6Address": ""
>             }
>         },
> [...]
>
> You could also try running them in the host network (--network=host), that
> should make them behave like native processes with fully exposed networking.
>
> 4. I used a wrong switch in my previous post, here's how it looks on a
> Tofino:
>
>    -  ./start-stratum-container.sh (let it run and open new terminal tab)
>    - docker container ls
>    CONTAINER ID        IMAGE
>             COMMAND                  CREATED             STATUS
>     PORTS                      NAMES
>    518c90116791
>     stratumproject/stratum-bf:9.1.0-4.14.49-OpenNetworkLinux   "/bin/sh -c
>    /stratum"   12 minutes ago      Up 12 minutes       0.0.0.0:28000
>    ->28000/tcp   zen_jennings
>    - ss -ltnp
>    LISTEN      0      128                    :::28000
>             :::*                   users:(("docker-proxy",pid=1179,fd=4))
>    - docker exec -ti 518c90116791 bash (switch into the Stratum container)
>    - apt update && apt install iproute
>    - ss -tlnp
>    State       Recv-Q Send-Q      Local Address:Port
>    Peer Address:Port
>    LISTEN      0      5                       *:9999
>               *:*                   users:(("stratum_bf",pid=13,fd=27))
>    LISTEN      0      128                     *:28000
>              *:*                   users:(("stratum_bf",pid=13,fd=40))
>    LISTEN      0      128             127.0.0.1:28000
>              *:*                   users:(("stratum_bf",pid=13,fd=39))
>    LISTEN      0      1                       *:9001
>               *:*                   users:(("stratum_bf",pid=13,fd=28))
>    - exit (leave container)
>    - docker run -ti debian:9 bash (Start new container to simulate ONOS)
>    - apt update && apt install netcat
>    - nc -v 172.17.0.2 28000
>    172.17.0.2: inverse host lookup failed: Unknown host
>    (UNKNOWN) [172.17.0.2] 28000 (?) open
>
>
> For reference, the used versions:
>
> # docker images
> REPOSITORY                  TAG                              IMAGE ID
>        CREATED             SIZE
> stratumproject/stratum-bf   9.1.0-4.14.49-OpenNetworkLinux   e4615d64018f
>        2 weeks ago         214MB
>
> For reference, these are the versions we use:
> # docker version
> Client: Docker Engine - Community
>  Version:           19.03.2
>  API version:       1.40
>  Go version:        go1.12.8
>  Git commit:        6a30dfca03
>  Built:             Thu Aug 29 05:29:49 2019
>  OS/Arch:           linux/amd64
>  Experimental:      false
>
> Server: Docker Engine - Community
>  Engine:
>   Version:          19.03.2
>   API version:      1.40 (minimum version 1.12)
>   Go version:       go1.12.8
>   Git commit:       6a30dfca03
>   Built:            Thu Aug 29 05:28:23 2019
>   OS/Arch:          linux/amd64
>   Experimental:     false
>  containerd:
>   Version:          1.2.6
>   GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
>  runc:
>   Version:          1.0.0-rc8
>   GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
>  docker-init:
>   Version:          0.18.0
>   GitCommit:        fec3683
>
> # uname -a
> Linux Stordis 4.14.49-OpenNetworkLinux #1 SMP Thu Jul 18 08:52:25 UTC 2019
> x86_64 GNU/Linux
>
>
> Max
>
> On Sat, Mar 28, 2020 at 7:31 AM Deval Bhamare <Deval.Bhamare at kau.se>
> wrote:
>
>> Hello again,
>>
>>
>> Since I could not any port activity on 28000 inside stratum and stratum
>> logs shown only listen activity on *8008*, I used following command to
>> do explicitly map the IP/ports to host:
>>
>>
>> *./setup_dev_env.sh  --pull --  -p 192.168.60.131:28008
>> <http://192.168.60.131:28008>:8008*
>>
>>
>> Then I tried to push the netcfg.json with following URL and this time the
>> communication channel is established. Logs from ONOS and stratum are below
>> (BOLD RED).
>>
>>
>> *URL*:
>>
>>
>> *"managementAddress": "grpc://192.168.60.131:28008?device_id=0
>> <http://192.168.60.131:28008?device_id=0>",*
>>
>> (I tired both deviceID 0 and 1, but it must be 0 as bf_shell and stratum
>> Log both confirm: )
>>
>>
>>
>> *ONOS*:
>>
>>
>> 2020-03-28T13:49:46,158 | WARN  | onos-gdp-0       | PiPipeconfManager
>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
>> Ignoring PortStatisticsDiscovery behaviour from pipeconf vepg-pipeconf, but
>> using the one provided by stratum-tofino driver...
>>
>> 2020-03-28T13:49:46,184 | INFO  | onos-gdp-0       |
>> GrpcChannelControllerImpl        | 230 -
>> org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | *Creating new
>> gRPC channel grpc://192.168.60.131:28008?device_id=0.
>> <http://192.168.60.131:28008?device_id=0.>.. << #THERE IS SUCCESS HERE THIS
>> TIME AS COMPARED TO PREVIOUS TIME *
>>
>> *Stratum*:
>>
>>
>> *Tcl server: connection accepted on port 8008*
>>
>> *Partial recv: 30 of 40 so far..  <<#STRATUM CONFIRMS IT*
>>
>>
>> However, I am not sure, it is the correct entry point? The reason is ONOS
>> still cannot find the device:tofino (highlighted Yellow RED)
>>
>>
>> 2020-03-28T13:49:46,306 | INFO  | onos-gdp-0       | DeviceManager
>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
>> Local role is MASTER for device:tofino
>>
>> 2020-03-28T13:49:46,311 | WARN  | onos-event-dispatch-default0 |
>> ModelCache                       | 211 -
>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>> device:tofino not found as a UiDevice
>>
>> 2020-03-28T13:49:46,313 | INFO  | onos-gdp-0       |
>> GeneralDeviceProvider            | 235 -
>> org.onosproject.onos-providers-general-device - 2.4.0.SNAPSHOT | Notifying
>> role MASTER (preference 0) for term 1 to device:tofino
>>
>> 2020-03-28T13:49:46,315 | WARN  | onos-event-dispatch-default0 |
>> ModelCache                       | 211 -
>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | *DeviceID
>> device:tofino not found as a UiDevice*
>>
>> 2020-03-28T13:49:46,316 | WARN  | onos-device-manager-background |
>> DeviceManager                    | 193 - org.onosproject.onos-core-net -
>> 2.4.0.SNAPSHOT | *Node was instructed to be MASTER role for
>> device:tofino, but this node cannot reach the device.*  Relinquishing
>> role.    *<<#STILL NO DEVICE FOUND. I TRIED BOTH ID 0 and 1 in the URL *
>>
>> 2020-03-28T13:49:46,317 | INFO  | onos-gdp-0       | StreamClientImpl
>>               | 237 - org.onosproject.onos-protocols-p4runtime-ctl -
>> 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true,
>> newElectionId=20, masterElectionId=null, sessionOpen=false
>>
>> 2020-03-28T13:49:46,320 | WARN  | onos-event-dispatch-default0 |
>> ModelCache                       | 211 -
>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>> device:tofino not found as a UiDevice
>>
>> 2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 |
>> ModelCache                       | 211 -
>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>> device:tofino not found as a UiDevice
>>
>> 2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 |
>> ModelCache                       | 211 -
>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>> device:tofino not found as a UiDevice
>>
>> 2020-03-28T13:49:46,336 | INFO  | onos-topo-build-1 | TopologyManager
>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
>> Topology DefaultTopology{time=12233603415182, creationTime=1585403386336,
>> computeCost=124274, clusters=0, devices=0, links=0} changed
>>
>> 2020-03-28T13:49:46,365 | INFO  | onos-gdp-0       | DeviceManager
>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
>> Device device:tofino registered
>>
>>
>>
>>
>> Please confirm, is it in the right direction or port 8008 is completely
>> different? What can be the reason for device:tofino not able to find?
>>
>>
>> Thank you,
>>
>> Deval.
>>
>>
>> ------------------------------
>> *From:* stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on
>> behalf of Deval Bhamare via stratum-dev <
>> stratum-dev at lists.stratumproject.org>
>> *Sent:* Saturday, March 28, 2020 3:22:16 PM
>> *To:* Maximilian Pudelko
>> *Cc:* stratum-dev at lists.stratumproject.org
>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>
>>
>> Hello Maximilian,
>>
>>
>> Thank you for your reply and the useful suggestions. So as a first step I
>> executed on switch ss -tnlp and below is the output. Surprisingly, there is *no
>> Stratum anywhere there, however statrum is also running in a container*
>> and the short logs are displayed below. I also executed ss command inside
>> the container and those are also pasted below, if that may help.
>>
>>
>> ss -tnlp outputs in different times are as follows:
>>
>>
>> *- from tofino, before anything is started:*
>>
>>
>> tofino at localhost:~$ ss -tnlp
>>
>> State      Recv-Q Send-Q                        Local Address:Port
>>                     Peer Address:Port
>>
>> LISTEN     0      128                                       *:17
>>                               *:*
>>
>> LISTEN     0      128                                       *:22
>>                               *:*
>>
>> LISTEN     0      128                                       *:23
>>                               *:*
>>
>> LISTEN     0      128                          192.168.60.131:10010
>>                               *:*
>>
>> LISTEN     0      128                                      :::22
>>                               :::*
>>
>>
>> *- from tofino after stratum container is started*
>>
>>
>> tofino at localhost:~$ ss -tnlp
>>
>> State      Recv-Q Send-Q                        Local Address:Port
>>                     Peer Address:Port
>>
>> LISTEN     0      128                                       *:17
>>                               *:*
>>
>> LISTEN     0      128                                       *:22
>>                               *:*
>>
>> LISTEN     0      128                                       *:23
>>                               *:*
>>
>> LISTEN     0      128                          192.168.60.131:10010
>>                               *:*
>>
>> LISTEN     0      128                                      :::22
>>                               :::*
>>
>> LISTEN     0      *128                                      :::28000 *
>>                                 :::*
>>
>>
>> *- from tofino after stratum is running *
>>
>>
>> tofino at localhost:~$ ss -tnlp
>>
>> State      Recv-Q Send-Q                        Local Address:Port
>>                     Peer Address:Port
>>
>> LISTEN     0      128                                       *:17
>>                               *:*
>>
>> LISTEN     0      128                                       *:22
>>                               *:*
>>
>> LISTEN     0      128                                       *:23
>>                               *:*
>>
>> LISTEN     0      128                          192.168.60.131:10010
>>                               *:*
>>
>> LISTEN     0      128                                      :::22
>>                               :::*
>>
>> LISTEN     0      128                                      :::28000
>>                               :::*
>>
>>
>> *- from stratum container, after running it in background *
>>
>>
>> tofino at ced0c4d7ef8f:/stratum$ ss -tnlp
>>
>> State      Recv-Q Send-Q Local Address:Port                Peer
>> Address:Port
>>
>> LISTEN     *0      1                  *:8008
>> *:*                   users:(("stratum_bf",pid=323,fd=26)) << #IS this
>> useful? *
>>
>> LISTEN     0      128        127.0.0.1:41418                          *:*
>>                   users:(("java",pid=21,fd=110))
>>
>> Why there is no 28000 port here in Stratum container SS output. Or should
>> I bind 8008 to 28000 on switch?
>>
>> As you have mentioned, I have already taken care of port mapping. So I
>> run the container with -p28000:2000. It is verified in the outputs above as
>> well.
>>
>>
>> *- Docker output on switch *
>>
>>
>> tofino at localhost:~$ docker ps
>>
>> CONTAINER ID        IMAGE               COMMAND             CREATED
>>         STATUS              PORTS                      NAMES
>>
>> ced0c4d7ef8f        stratum-dev         "bash"              16 minutes
>> ago      Up 16 minutes       *0.0.0.0:28000->28000/tcp*   goofy_hamilton
>>
>>
>> *- Stratum log output after it started. *
>>
>>
>> bf_sysfs_fname /sys/class/bf/bf0/device/dev_add
>>
>> Install dir: /stratum/bf-sde-8.9.0/install (0x7f876b794b60)
>>
>> bf_switchd: system services initialized
>>
>> bf_switchd: loading conf_file
>> stratum/hal/bin/barefoot/tofino_skip_p4.conf...
>>
>> bf_switchd: processing device configuration...
>>
>> Configuration for dev_id 0
>>
>>   Family        : Tofino
>>
>>   pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0
>>
>>   pci_domain    : 0
>>
>>   pci_bus       : 5
>>
>>   pci_fn        : 0
>>
>>   pci_dev       : 0
>>
>>   pci_int_mode  : 1
>>
>>   sbus_master_fw: /stratum/bf-sde-8.9.0/install/
>>
>>   pcie_fw       : /stratum/bf-sde-8.9.0/install/
>>
>>   serdes_fw     : /stratum/bf-sde-8.9.0/install/
>>
>>   sds_fw_path   : /stratum/bf-sde-8.9.0/install/
>>
>>   microp_fw_path:
>>
>> bf_switchd: processing P4 configuration...
>>
>> P4 profile for dev_id 0
>>
>>   p4_name: dummy
>>
>>     libpd:
>>
>>     libpdthrift:
>>
>>     context:
>>
>>     config:
>>
>>   Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
>>
>>   diag:
>>
>>   mavericks diag:
>>
>>   non_default_port_ppgs: 0
>>
>>   SAI default initialize: 1
>>
>> bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
>> loaded
>>
>> bf_switchd: agent[0] initialized
>>
>> Tcl server started..
>>
>> Tcl server: listen socket created
>>
>> Tcl server: bind done on port 8008, listening...
>>
>> Tcl server: waiting for incoming connections...
>>
>> sh: 1: onie-syseeprom: not found
>>
>> *2020-03-28 13:06:53.584090 BF_PLTFM ERROR - Error in cp2112
>> initialization*
>>
>>
>> *2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init
>> failed  #<<< CAN IT BE THE ISSUE?*
>>
>>
>> Thank you.
>>
>> Deval
>>
>>
>> ------------------------------
>> *From:* Maximilian Pudelko <max at opennetworking.org>
>> *Sent:* Saturday, March 28, 2020 3:43:29 AM
>> *To:* Deval Bhamare
>> *Cc:* Yi Tseng; stratum-dev at lists.stratumproject.org
>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>
>> Hi Deval,
>>
>> can you run this command on the switch: ss -tlnp
>> Should output something like this:
>> State      Recv-Q Send-Q      Local Address:Port                     Peer
>> Address:Port
>> LISTEN     0      128                     *:22
>>        *:*                   users:(("sshd",pid=4116,fd=3))
>> LISTEN     0      128                    :::22
>>       :::*                   users:(("sshd",pid=4116,fd=4))
>> LISTEN     0      128      ::ffff:127.0.0.1:28000
>>        :::*                   users:(("stratum_bcm",pid=26872,fd=19))
>> LISTEN     0      128                    :::28001
>>      :::*                   users:(("stratum_bcm",pid=26872,fd=20))
>> LISTEN     0      128      ::ffff:127.0.0.1:28003
>>        :::*                   users:(("stratum_bcm",pid=26872,fd=6))
>>
>> Also, do you have any logs from Stratum? Run with -v=1 -stderrthreshold=0
>>
>> Since you're using docker, I assume there is some issue with port
>> forwarding/mapping. Follow these steps to check the port mapping:
>> https://docs.docker.com/engine/reference/commandline/port/
>> And these steps to fix it:
>>
>> https://stackoverflow.com/questions/22111060/what-is-the-difference-between-expose-and-publish-in-docker
>>
>> https://docs.docker.com/config/containers/container-networking/#published-ports
>>
>> Max
>>
>>
>> On Thu, Mar 26, 2020 at 3:53 PM Deval Bhamare via stratum-dev <
>> stratum-dev at lists.stratumproject.org> wrote:
>>
>>> Hello Yi,
>>>
>>>
>>> I am running both ONOS and stratum container on the same machine, that
>>> is the tofino switch with public IP 192.168.60.131.
>>>
>>>
>>> So I tried with grpc://192.168.60.131:28000?device_id=1
>>> <http://192.168.0.101:28000/?device_id=1>", as well now. This time
>>> message is connection refused and still no connectivity.
>>>
>>>
>>>
>>>
>>> 2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background |
>>> DeviceManager                    | 193 - org.onosproject.onos-core-net
>>> - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino,
>>> but this node cannot reach the device.  Relinquishing role.
>>>
>>> 2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       | StreamClientImpl
>>>               | 237 - org.onosproject.onos-protocols-p4runtime-ctl -
>>> 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true,
>>> newElectionId=20, masterElectionId=null, sessionOpen=false
>>>
>>> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
>>> ModelCache                       | 211 -
>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>> device:tofino not found as a UiDevice
>>>
>>> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
>>> ModelCache                       | 211 -
>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>> device:tofino not found as a UiDevice
>>>
>>> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
>>> ModelCache                       | 211 -
>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>> device:tofino not found as a UiDevice
>>>
>>> 2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager
>>>                 | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT
>>> | Topology DefaultTopology{time=2264511977012, creationTime=1585262479736,
>>> computeCost=117691, clusters=0, devices=0, links=0} changed
>>>
>>> 2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager
>>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
>>> Device device:tofino registered
>>>
>>> 2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 |
>>> StreamClientImpl                 | 237 -
>>> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | *device:tofino
>>> is unreachable (Connection refused: /192.168.60.131:28000
>>> <http://192.168.60.131:28000>)*
>>>
>>> 2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager
>>>                 | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT
>>> | Topology DefaultTopology{time=2264549921343, creationTime=1585262479774,
>>> computeCost=101378, clusters=0, devices=0, links=0} changed
>>>
>>> With grpc://127.0.0.1:28000?device_id=1
>>> <http://192.168.0.101:28000/?device_id=1>", the error is
>>>
>>>
>>> *onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on
>>> StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for
>>> unknown reason*
>>>
>>> Also Stratum logs say
>>>
>>>
>>> bf_switchd: processing P4 configuration...
>>>
>>> *P4 profile for dev_id 0*
>>>
>>>
>>> while starting, so I doubt device ID maybe 0 and hence tried with both
>>> device_id=1 <http://192.168.0.101:28000/?device_id=1> and device_id=
>>> <http://192.168.0.101:28000/?device_id=1>0 but no luck.
>>>
>>>
>>>
>>> Thanks,
>>>
>>>
>>> Deval.
>>> ------------------------------
>>> *From:* Yi Tseng <yi at opennetworking.org>
>>> *Sent:* Thursday, March 26, 2020 9:10:49 PM
>>> *To:* Deval Bhamare
>>> *Cc:* stratum-dev at lists.stratumproject.org
>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>
>>> Hi Deval,
>>>
>>> Where you are running the ONOS controller? If you are running the ONOS
>>> controller on a server, you need to set the management address to your
>>> switch IP address.
>>>
>>> For example, you run the ONOS on a server with IP address 192.168.0.100
>>> and running the Stratum on a switch with IP address 192.168.0.101. (And I
>>> assume that you have connectivity between the server and the switch)
>>>
>>> The netcfg.json will look like:
>>>
>>> {
>>>   "devices": {
>>>     "device:tofino": {
>>>       "basic": {
>>>         "managementAddress": "grpc://192.168.0.101:28000?device_id=1",
>>>         "driver": "stratum-tofino",
>>>         "pipeconf": "[your pipeconf name]"
>>>        }
>>>     }
>>>    }
>>> }
>>>
>>> Please also note that the device ID is 1 in the Stratum
>>>
>>> Yi
>>>
>>>
>>> On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se>
>>> wrote:
>>>
>>>> Hello Yi,
>>>>
>>>>
>>>> We have received a reply from Stordis and as per their suggestion, we
>>>> can ignore the syseeprom error
>>>>
>>>>
>>>> *You see only syseeprom errorr please ignore that :*
>>>> *Tcl server: listen socket created*
>>>> *Tcl server: bind done on port 8008, listening...*
>>>> *Tcl server: waiting for incoming connections...*
>>>> *sh: 1: onie-syseeprom: not found <Ignore this error>*
>>>> *Health monitor started *
>>>> *Operational mode set to ASIC*
>>>>
>>>>
>>>> So, now when I try to push the netcfg.json for our device to Onos, I
>>>> get following message:
>>>>
>>>>
>>>> 2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl
>>>>               | 237 - org.onosproject.onos-protocols-p4runtime-ctl -
>>>> 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true,
>>>> newElectionId=20, masterElectionId=null, sessionOpen=false
>>>>
>>>> 2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 |
>>>> ModelCache                       | 211 -
>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>> device:tofino not found as a UiDevice
>>>>
>>>> 2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 |
>>>> ModelCache                       | 211 -
>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>> device:tofino not found as a UiDevice
>>>>
>>>> 2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 |
>>>> ModelCache                       | 211 -
>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>> device:tofino not found as a UiDevice
>>>>
>>>> 2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager
>>>>                 | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT
>>>> | Topology DefaultTopology{time=20452353961040, creationTime=1585173541276,
>>>> computeCost=427068, clusters=0, devices=0, links=0} changed
>>>>
>>>> 2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager
>>>>                 | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT
>>>> |* Device device:tofino registered*
>>>>
>>>> 2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 |
>>>> StreamClientImpl                 | 237 -
>>>> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT |* Error
>>>> on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for
>>>> unknown reason*
>>>>
>>>> 2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager
>>>>                 | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT
>>>> | Topology DefaultTopology{time=20452397561034, creationTime=1585173541319,
>>>> computeCost=112832, clusters=0, devices=0, links=0} changed
>>>>
>>>>
>>>>
>>>> ONOS CLI show, device available=false.
>>>>
>>>>
>>>> tofino at root > devices
>>>>       21:58:49
>>>>
>>>> id=device:tofino, *available=false*, local-status=disconnected 37s
>>>> ago, role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum,
>>>> serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf,
>>>> locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0,
>>>> name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI
>>>>
>>>>
>>>> Netcfg.json contents are:
>>>>
>>>> {
>>>> "devices": {
>>>> "device:tofino": {
>>>> "basic": {
>>>> "managementAddress": "grpc://127.0.0.1?device_id=0",
>>>> "driver": "stratum-tofino",
>>>> "pipeconf": "vepg-pipeconf"
>>>> }
>>>> }
>>>> }
>>>> }
>>>>
>>>> Command is:
>>>>
>>>>
>>>> curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H
>>>> 'Content-Type:application/json' '
>>>> http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json
>>>>
>>>>
>>>>
>>>> Any idea what may be the issue?
>>>>
>>>>
>>>> Thanks,
>>>>
>>>> Deval.
>>>>
>>>>
>>>> ------------------------------
>>>> *From:* Yi Tseng <yi at opennetworking.org>
>>>> *Sent:* Tuesday, March 24, 2020 3:25:06 PM
>>>> *To:* Deval Bhamare
>>>> *Cc:* stratum-dev at lists.stratumproject.org
>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>
>>>> Hi Deval,
>>>>
>>>> I am now working on updating the script to support the custom platform
>>>> parameter <https://github.com/stratum/stratum/pull/150> since the
>>>> Stratum cannot detect the platform without the ONLP.
>>>>
>>>> Should be merged soon.
>>>>
>>>> On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se>
>>>> wrote:
>>>>
>>>>> Hello Yi,
>>>>>
>>>>>
>>>>> I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux,
>>>>> however, the error still persists:
>>>>>
>>>>>
>>>>> + KERNEL_VERSION=3.16.64-OpenNetworkLinux
>>>>>
>>>>> + DOCKER_IMAGE=stratumproject/stratum-bf
>>>>>
>>>>> + DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux
>>>>>
>>>>> ++ uname -r
>>>>>
>>>>> ++ uname -r
>>>>>
>>>>> + docker run -it --privileged -v /dev:/dev -v /sys:/sys -v
>>>>> /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux
>>>>> -v
>>>>> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so
>>>>> -v
>>>>> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1
>>>>> -v
>>>>> /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so
>>>>> -v
>>>>> /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1
>>>>> -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v
>>>>> /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v
>>>>> /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p
>>>>> 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs
>>>>> stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux
>>>>>
>>>>> *Use default flag file*
>>>>>
>>>>> *Cannot find
>>>>> /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json*
>>>>>
>>>>>
>>>>> I also had peek at the script *start-stratum-container.sh* and found
>>>>> an option of *ONLP_ARG="--env WITH_ONLP=false"*
>>>>> . So I wanted to ask whether I can set this option with Docker to
>>>>> force BSP usage, let us say, by hard-coding it in the script itself (also
>>>>> similar approach to set PORT_MAP in *stratume_entrypoint.sh*). I
>>>>> tried this and the error message in this case is:
>>>>>
>>>>>
>>>>> *Use default flag file*
>>>>>
>>>>> *Cannot find /usr/local/share/stratum/.json *
>>>>>
>>>>> Please suggest.
>>>>>
>>>>> Thanks,
>>>>> Deval.
>>>>>
>>>>> ------------------------------
>>>>> *From:* Yi Tseng <yi at opennetworking.org>
>>>>> *Sent:* Thursday, March 12, 2020 6:57 AM
>>>>> *To:* Deval Bhamare
>>>>> *Cc:* Narada Hess; stratum-dev at lists.stratumproject.org
>>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>>
>>>>> Hi Deval,
>>>>>
>>>>> We don't support Barefoot thrift APIs in Stratum. We support some
>>>>> Barefoot API like port API via gNMI and the chassis config.
>>>>>
>>>>> For missing JSON file, I can confirm that our internal CI did not
>>>>> include the latest Stratum with kernel 3.16.56
>>>>>
>>>>> I just rebuild it and uploaded the new container image to the Docker
>>>>> hub
>>>>> <https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>,
>>>>> feel free to let me know if the issue still exists.
>>>>>
>>>>> About the missing library, can you run this command in your shell?
>>>>>
>>>>> *LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd
>>>>> ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf*
>>>>>
>>>>> I think the system linker may have some issue to find the library.
>>>>>
>>>>> The *libavago.so.0 *is a symbolic link to *libavago.so*. the
>>>>> libavago.so must also exists.
>>>>>
>>>>>
>>>>>
>>>>> *ls -al $BF_SDE_INSTALL/lib/libavago* -rwxr-xr-x 1 root root 1185264
>>>>> Mar 12 04:19 libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>>>>> libavago.so.0 -> libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>>>>> libavago.so.0.0.0 -> libavago.so*
>>>>>
>>>>>
>>>>>
>>>>
>>>> --
>>>> Yi Tseng
>>>> Member of Technical Staff
>>>> Open Networking Foundation
>>>> https://www.opennetworking.org/
>>>>
>>>
>>>
>>> --
>>> Yi Tseng
>>> Member of Technical Staff
>>> Open Networking Foundation
>>> https://www.opennetworking.org/
>>> _______________________________________________
>>> stratum-dev mailing list
>>> stratum-dev at lists.stratumproject.org
>>> https://lists.stratumproject.org/listinfo/stratum-dev
>>
>>

-- 
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200330/b36a2e20/attachment-0001.html>

From Deval.Bhamare at kau.se  Mon Mar 30 10:50:32 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Mon, 30 Mar 2020 10:50:32 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR0xekODA96sMZxUXLPd0UA_h=BjWe1REBW2SpAgO=sTmw@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <08df48cbcfc3462fa41128f05c60db07@kau.se>
 <CAOyFVR3-vjAwOKDuQ1R5+z9s1Y3zZUD+UX_AQoK8-jJ3q5T5_g@mail.gmail.com>
 <a6d7c4b6ed894c31bc007500efbf8b71@kau.se>
 <CAOyFVR0wZCAN+RQQybzGydK6rNwyyjqmdy9kBrk8wSBGASYDRQ@mail.gmail.com>
 <01010171190c9981-833ae934-2420-4a40-abde-3f9542415656-000000@us-west-2.amazonses.com>
 <CAFh9Y_NuM3SnxdpU_PamscwO8e7F_cnp5etZ2Z=XMFwzb+O-MQ@mail.gmail.com>
 <01010171214eab35-94a8581f-ed3b-4aae-abb9-58b7f2151df3-000000@us-west-2.amazonses.com>
 <cd881b8db56449b5a9e1a6477cd46398@kau.se>
 <CAFh9Y_NLCng9zN3zak+nc1WjTjwyztN18gjZBOzeKQRvd+vXJQ@mail.gmail.com>
 <0421bf65803443d39b0f64b037b72282@kau.se>
 <e14ebcb4f1cc4c11a3a48af5acc4801b@kau.se>,
 <CAOyFVR0xekODA96sMZxUXLPd0UA_h=BjWe1REBW2SpAgO=sTmw@mail.gmail.com>
Message-ID: <ff3ec02d08304f75a3813633077fe56e@kau.se>

Hello Yi,


Thank you. I will try to move ahead with the current setup and PLATFORM flag set as you have mentioned.


Will get back to you with the further updates.


Regards,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Monday, March 30, 2020 7:32:05 AM
To: Deval Bhamare
Cc: max at opennetworking.org; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We've updated the container image and the script to start the container:
https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/start-stratum-container.sh

You can now try the following command to start the Stratum container with no ONLP support:
PLATFORM=x86-64-stordis-bf2556x-1t-r0 SDE_VERSION=8.9.2 ./start-stratum-container.sh

For the "unimplemented" message you saw, the SDE 8.9.2 uses old version PI library which doesn't implement some features (reading default entry from a table).
You can ignore that warning or use a newer version of Stratum (with SDE >= 9.0.0)

Yi


On Sun, Mar 29, 2020 at 8:31 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,



Just don't want to overload with the information, but I wanted to mention that, with the pre-built docker image option, I had a look a the ./start-stratum-container.sh


Since I want to run Stratum with BSP, I made a change as:


ONLP_ARG="--env WITH_ONLP=false"


Then I started the container 8.9.2-3.16.56-OpenNetworkLinux and it executed the Stratum successfully. Stratum open bf-sde prompt.


Also ss ouptput is:


State      Recv-Q Send-Q          Local Address:Port                         Peer Address:Port

LISTEN     0      128                         *:28000                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=36))

LISTEN     0      128                 127.0.0.1:28000<http://127.0.0.1:28000>                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=35))

LISTEN     0      128                 127.0.0.1:28003<http://127.0.0.1:28003>                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=32))

LISTEN     0      5                           *:9999                                    *:*                   users:(("stratum_bf_no_o",pid=10,fd=27))


I am getting following messages now:


 ONOS-CLI logs for the confirmation below:


tofino at root > devices                                                                                 22:02:35

id=device:tofino, available=true, local-status=connected 4m52s ago, role=MASTER, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=1<http://127.0.0.1:28000?device_id=1>, name=device:tofino, p4DeviceId=1, protocol=P4Runtime, gNMI, gNOI


Logs on stratum bf-sde are:


bf-sde.lld> E0329 22:01:52.649449   249 PI-device_mgr.cpp:0] Reading default entry not supported yet

E0329 22:01:52.649509   249 pi_node.cc:187] Return Error: toUtilStatus(status, details) failed with generic::unimplemented:

E0329 22:01:52.649549   249 p4_service.cc:307] Failed to read forwarding entries from node 1:


ONOS Logs:


2020-03-29T22:08:22,649 | WARN  | grpc-default-executor-4 | P4RuntimeClientImpl              | 230 - org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Error while performing READ on device:tofino: UNIMPLEMENTED



So, now ONOS can talk to Tofino through Stratum, but there are a few errors. First of all, is it OK to explicitly use this option: "--env WITH_ONLP=false" If yes, am I missing some steps here?  Any suggestion?



(Note: If I use default value of ONLP_ARG as per the original script, I get error as:


Use default flag file

Cannot find /usr/local/lib/modules/bf_kdrv.ko, skip installing the Kernel module

/usr/local/bin/stratum_bf: symbol lookup error: /usr/local/bin/stratum_bf: undefined symbol: onlp_sw_init

)



Thank you,


Deval.


________________________________
From: Deval Bhamare
Sent: Sunday, March 29, 2020 12:20:10 PM
To: Maximilian Pudelko
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Maximilian,


There is a littler confusion here. I am not using pre-built containerized version of Stratum.

However, I am locally building it by starting a development container with command "./setup_dev_env.sh  --pull -- -p 28000:28000" (I have mentioned it in the earlier image as well) as mentioned here: https://github.com/stratum/stratum

and then I try to build and run stratum as mentioned here: https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md



Now with the build-from-scratch using development container approach, I followed your steps, however, when I run ss -tnlp from the container (afterdocker exec -ti bash), I get below and listen on  127.0.0.1:28000<http://127.0.0.1:28000> is missing. I get only below.



tofino at 39e19c57ea27:/stratum$ ss -tlnp

State       Recv-Q Send-Q     Local Address:Port                    Peer Address:Port

LISTEN      0      128            127.0.0.1:56929<http://127.0.0.1:56929>                              *:*                   users:(("java",pid=21,fd=110))

LISTEN      0      1                      *:8008                               *:*                   users:(("stratum_bf",pid=310,fd=26))

Command to build Stratum is: bazel build //stratum/hal/bin/barefoot:stratum_bf --define phal_with_onlp=false --define sde_ver=8.9.2

Command to run Stratum is:

     ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
       --external_stratum_urls=0.0.0.0:28000<http://0.0.0.0:28000> \
       --grpc_max_recv_msg_size=256 \
       --bf_sde_install=$BF_SDE_INSTALL \
       --persistent_config_dir=/stratum/config/ \
       --forwarding_pipeline_configs_file=/stratum/config/p4_pipeline.pb.txt \
       --chassis_config_file=/stratum/config/chassis_config.pb.txt \
       --write_req_log_file=/stratum/config/p4_writes.pb.txt \
       --bf_sim




[Note: I had also tried the option of using pre-built docker container, with 8.9.1-3.16.56-OpenNetworkLinux, however, in this case I get error:

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json

I had reported that also and tried new container but didn't work]


Thanks,

Deval.


________________________________
From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Sunday, March 29, 2020 1:46:04 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>; Andreas Kassler
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

There are many things going on in your setup, let's do this step by step:

1. Port 8008 is NOT what you want for ONOS. I'm no Tofino expert, but this seems to be a separate endpoint for something else (debugging?). We always use port 28000.

2. 2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?
Depends. It's probably not good, but as long as you see this line in the Stratum logs, ONOS should be able to connect:
E0328 23:08:15.903065    13 hal.cc:234] Stratum external facing services are listening to 0.0.0.0:28000<http://0.0.0.0:28000>, localhost:28000...
Judging from the missing listening port, I'd say this could be the issue.

3. If you run ONOS in a container too, they have to reside in the same network and you have to figure out the docker-internal IP for the Stratum container:
# docker network ls
NETWORK ID          NAME                DRIVER              SCOPE
e737dd0dd90f        bridge              bridge              local
d2783152be24        host                host                local
7028e832e130        none                null                local

# docker network inspect bridge
[...]
"Containers": {
            "518c901167919d34205959f1105aedebbb99a9452d191409ccf71a3908e14e56": {
                "Name": "zen_jennings",
                "EndpointID": "a52025a671c9968372c52c7ed6b61df5a3168493466bd4b831c4728089b77163",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            }
        },
[...]

You could also try running them in the host network (--network=host), that should make them behave like native processes with fully exposed networking.

4. I used a wrong switch in my previous post, here's how it looks on a Tofino:

  *    ./start-stratum-container.sh (let it run and open new terminal tab)
  *   docker container ls
CONTAINER ID        IMAGE                                                      COMMAND                  CREATED             STATUS              PORTS                      NAMES
518c90116791        stratumproject/stratum-bf:9.1.0-4.14.49-OpenNetworkLinux   "/bin/sh -c /stratum"   12 minutes ago      Up 12 minutes       0.0.0.0:28000->28000/tcp   zen_jennings
  *   ss -ltnp
LISTEN      0      128                    :::28000                              :::*                   users:(("docker-proxy",pid=1179,fd=4))
  *   docker exec -ti 518c90116791 bash (switch into the Stratum container)
  *   apt update && apt install iproute
  *   ss -tlnp
State       Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN      0      5                       *:9999                                *:*                   users:(("stratum_bf",pid=13,fd=27))
LISTEN      0      128                     *:28000                               *:*                   users:(("stratum_bf",pid=13,fd=40))
LISTEN      0      128             127.0.0.1:28000<http://127.0.0.1:28000>                               *:*                   users:(("stratum_bf",pid=13,fd=39))
LISTEN      0      1                       *:9001                                *:*                   users:(("stratum_bf",pid=13,fd=28))
  *   exit (leave container)
  *   docker run -ti debian:9 bash (Start new container to simulate ONOS)
  *   apt update && apt install netcat
  *   nc -v 172.17.0.2 28000
172.17.0.2<http://172.17.0.2>: inverse host lookup failed: Unknown host
(UNKNOWN) [172.17.0.2] 28000 (?) open

For reference, the used versions:

# docker images
REPOSITORY                  TAG                              IMAGE ID            CREATED             SIZE
stratumproject/stratum-bf   9.1.0-4.14.49-OpenNetworkLinux   e4615d64018f        2 weeks ago         214MB

For reference, these are the versions we use:
# docker version
Client: Docker Engine - Community
 Version:           19.03.2
 API version:       1.40
 Go version:        go1.12.8
 Git commit:        6a30dfca03
 Built:             Thu Aug 29 05:29:49 2019
 OS/Arch:           linux/amd64
 Experimental:      false

Server: Docker Engine - Community
 Engine:
  Version:          19.03.2
  API version:      1.40 (minimum version 1.12)
  Go version:       go1.12.8
  Git commit:       6a30dfca03
  Built:            Thu Aug 29 05:28:23 2019
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.2.6
  GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
 runc:
  Version:          1.0.0-rc8
  GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
 docker-init:
  Version:          0.18.0
  GitCommit:        fec3683

# uname -a
Linux Stordis 4.14.49-OpenNetworkLinux #1 SMP Thu Jul 18 08:52:25 UTC 2019 x86_64 GNU/Linux


Max

On Sat, Mar 28, 2020 at 7:31 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,


Since I could not any port activity on 28000 inside stratum and stratum logs shown only listen activity on 8008, I used following command to do explicitly map the IP/ports to host:


./setup_dev_env.sh  --pull --  -p 192.168.60.131:28008<http://192.168.60.131:28008>:8008


Then I tried to push the netcfg.json with following URL and this time the communication channel is established. Logs from ONOS and stratum are below (BOLD RED).


URL:


"managementAddress": "grpc://192.168.60.131:28008?device_id=0<http://192.168.60.131:28008?device_id=0>",


(I tired both deviceID 0 and 1, but it must be 0 as bf_shell and stratum Log both confirm: )



ONOS:


2020-03-28T13:49:46,158 | WARN  | onos-gdp-0       | PiPipeconfManager                | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Ignoring PortStatisticsDiscovery behaviour from pipeconf vepg-pipeconf, but using the one provided by stratum-tofino driver...

2020-03-28T13:49:46,184 | INFO  | onos-gdp-0       | GrpcChannelControllerImpl        | 230 - org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Creating new gRPC channel grpc://192.168.60.131:28008?device_id=0.<http://192.168.60.131:28008?device_id=0.>.. << #THERE IS SUCCESS HERE THIS TIME AS COMPARED TO PREVIOUS TIME


Stratum:


Tcl server: connection accepted on port 8008

Partial recv: 30 of 40 so far..  <<#STRATUM CONFIRMS IT



However, I am not sure, it is the correct entry point? The reason is ONOS still cannot find the device:tofino (highlighted Yellow RED)


2020-03-28T13:49:46,306 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Local role is MASTER for device:tofino

2020-03-28T13:49:46,311 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,313 | INFO  | onos-gdp-0       | GeneralDeviceProvider            | 235 - org.onosproject.onos-providers-general-device - 2.4.0.SNAPSHOT | Notifying role MASTER (preference 0) for term 1 to device:tofino

2020-03-28T13:49:46,315 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,316 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.    <<#STILL NO DEVICE FOUND. I TRIED BOTH ID 0 and 1 in the URL

2020-03-28T13:49:46,317 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-28T13:49:46,320 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,336 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=12233603415182, creationTime=1585403386336, computeCost=124274, clusters=0, devices=0, links=0} changed

2020-03-28T13:49:46,365 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered




Please confirm, is it in the right direction or port 8008 is completely different? What can be the reason for device:tofino not able to find?


Thank you,

Deval.


________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org<mailto:stratum-dev-bounces at lists.stratumproject.org>> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>>
Sent: Saturday, March 28, 2020 3:22:16 PM
To: Maximilian Pudelko
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Maximilian,


Thank you for your reply and the useful suggestions. So as a first step I executed on switch ss -tnlp and below is the output. Surprisingly, there is no Stratum anywhere there, however statrum is also running in a container and the short logs are displayed below. I also executed ss command inside the container and those are also pasted below, if that may help.


ss -tnlp outputs in different times are as follows:


- from tofino, before anything is started:


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*



- from tofino after stratum container is started


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from tofino after stratum is running


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from stratum container, after running it in background


tofino at ced0c4d7ef8f:/stratum$ ss -tnlp

State      Recv-Q Send-Q Local Address:Port                Peer Address:Port

LISTEN     0      1                  *:8008                           *:*                   users:(("stratum_bf",pid=323,fd=26)) << #IS this useful?

LISTEN     0      128        127.0.0.1:41418<http://127.0.0.1:41418>                          *:*                   users:(("java",pid=21,fd=110))


Why there is no 28000 port here in Stratum container SS output. Or should I bind 8008 to 28000 on switch?

As you have mentioned, I have already taken care of port mapping. So I run the container with -p28000:2000. It is verified in the outputs above as well.


- Docker output on switch


tofino at localhost:~$ docker ps

CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                      NAMES

ced0c4d7ef8f        stratum-dev         "bash"              16 minutes ago      Up 16 minutes       0.0.0.0:28000->28000/tcp   goofy_hamilton



- Stratum log output after it started.


bf_sysfs_fname /sys/class/bf/bf0/device/dev_add

Install dir: /stratum/bf-sde-8.9.0/install (0x7f876b794b60)

bf_switchd: system services initialized

bf_switchd: loading conf_file stratum/hal/bin/barefoot/tofino_skip_p4.conf...

bf_switchd: processing device configuration...

Configuration for dev_id 0

  Family        : Tofino

  pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0

  pci_domain    : 0

  pci_bus       : 5

  pci_fn        : 0

  pci_dev       : 0

  pci_int_mode  : 1

  sbus_master_fw: /stratum/bf-sde-8.9.0/install/

  pcie_fw       : /stratum/bf-sde-8.9.0/install/

  serdes_fw     : /stratum/bf-sde-8.9.0/install/

  sds_fw_path   : /stratum/bf-sde-8.9.0/install/

  microp_fw_path:

bf_switchd: processing P4 configuration...

P4 profile for dev_id 0

  p4_name: dummy

    libpd:

    libpdthrift:

    context:

    config:

  Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so

  diag:

  mavericks diag:

  non_default_port_ppgs: 0

  SAI default initialize: 1

bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so loaded

bf_switchd: agent[0] initialized

Tcl server started..

Tcl server: listen socket created

Tcl server: bind done on port 8008, listening...

Tcl server: waiting for incoming connections...

sh: 1: onie-syseeprom: not found

2020-03-28 13:06:53.584090 BF_PLTFM ERROR - Error in cp2112 initialization


2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?



Thank you.

Deval


________________________________
From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Saturday, March 28, 2020 3:43:29 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

can you run this command on the switch: ss -tlnp
Should output something like this:
State      Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN     0      128                     *:22                                  *:*                   users:(("sshd",pid=4116,fd=3))
LISTEN     0      128                    :::22                                 :::*                   users:(("sshd",pid=4116,fd=4))
LISTEN     0      128      ::ffff:127.0.0.1:28000<http://127.0.0.1:28000>                              :::*                   users:(("stratum_bcm",pid=26872,fd=19))
LISTEN     0      128                    :::28001                              :::*                   users:(("stratum_bcm",pid=26872,fd=20))
LISTEN     0      128      ::ffff:127.0.0.1:28003<http://127.0.0.1:28003>                              :::*                   users:(("stratum_bcm",pid=26872,fd=6))

Also, do you have any logs from Stratum? Run with -v=1 -stderrthreshold=0

Since you're using docker, I assume there is some issue with port forwarding/mapping. Follow these steps to check the port mapping: https://docs.docker.com/engine/reference/commandline/port/
And these steps to fix it:
https://stackoverflow.com/questions/22111060/what-is-the-difference-between-expose-and-publish-in-docker
https://docs.docker.com/config/containers/container-networking/#published-ports

Max


On Thu, Mar 26, 2020 at 3:53 PM Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:

Hello Yi,


I am running both ONOS and stratum container on the same machine, that is the tofino switch with public IP 192.168.60.131.


So I tried with grpc://192.168.60.131:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", as well now. This time message is connection refused and still no connectivity.




2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.

2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264511977012, creationTime=1585262479736, computeCost=117691, clusters=0, devices=0, links=0} changed

2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | device:tofino is unreachable (Connection refused: /192.168.60.131:28000<http://192.168.60.131:28000>)

2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264549921343, creationTime=1585262479774, computeCost=101378, clusters=0, devices=0, links=0} changed


With grpc://127.0.0.1:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", the error is


onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason


Also Stratum logs say


bf_switchd: processing P4 configuration...

P4 profile for dev_id 0


while starting, so I doubt device ID maybe 0 and hence tried with both device_id=1<http://192.168.0.101:28000/?device_id=1> and device_id=<http://192.168.0.101:28000/?device_id=1>0 but no luck.



Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 26, 2020 9:10:49 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

Where you are running the ONOS controller? If you are running the ONOS controller on a server, you need to set the management address to your switch IP address.

For example, you run the ONOS on a server with IP address 192.168.0.100 and running the Stratum on a switch with IP address 192.168.0.101. (And I assume that you have connectivity between the server and the switch)

The netcfg.json will look like:

{
  "devices": {
    "device:tofino": {
      "basic": {
        "managementAddress": "grpc://192.168.0.101:28000?device_id=1<http://192.168.0.101:28000?device_id=1>",
        "driver": "stratum-tofino",
        "pipeconf": "[your pipeconf name]"
       }
    }
   }
}

Please also note that the device ID is 1 in the Stratum

Yi


On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


We have received a reply from Stordis and as per their suggestion, we can ignore the syseeprom error


You see only syseeprom errorr please ignore that :
Tcl server: listen socket created
Tcl server: bind done on port 8008, listening...
Tcl server: waiting for incoming connections...
sh: 1: onie-syseeprom: not found <Ignore this error>
Health monitor started
Operational mode set to ASIC



So, now when I try to push the netcfg.json for our device to Onos, I get following message:


2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452353961040, creationTime=1585173541276, computeCost=427068, clusters=0, devices=0, links=0} changed

2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason

2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452397561034, creationTime=1585173541319, computeCost=112832, clusters=0, devices=0, links=0} changed



ONOS CLI show, device available=false.


tofino at root > devices                                                        21:58:49

id=device:tofino, available=false, local-status=disconnected 37s ago, role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0<http://127.0.0.1:28000?device_id=0>, name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI



Netcfg.json contents are:

{
        "devices": {
        "device:tofino": {
        "basic": {
        "managementAddress": "grpc://127.0.0.1?device_id=0<http://127.0.0.1?device_id=0>",
        "driver": "stratum-tofino",
        "pipeconf": "vepg-pipeconf"
        }
        }
        }
        }


Command is:


curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H 'Content-Type:application/json' 'http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json



Any idea what may be the issue?


Thanks,

Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Tuesday, March 24, 2020 3:25:06 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

I am now working on updating the script to support the custom platform parameter<https://github.com/stratum/stratum/pull/150> since the Stratum cannot detect the platform without the ONLP.

Should be merged soon.

On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux, however, the error still persists:


+ KERNEL_VERSION=3.16.64-OpenNetworkLinux

+ DOCKER_IMAGE=stratumproject/stratum-bf

+ DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux

++ uname -r

++ uname -r

+ docker run -it --privileged -v /dev:/dev -v /sys:/sys -v /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1 -v /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so -v /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1 -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux

Use default flag file

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json



I also had peek at the script start-stratum-container.sh and found an option of ONLP_ARG="--env WITH_ONLP=false"
. So I wanted to ask whether I can set this option with Docker to force BSP usage, let us say, by hard-coding it in the script itself (also similar approach to set PORT_MAP in stratume_entrypoint.sh). I tried this and the error message in this case is:


Use default flag file

Cannot find /usr/local/share/stratum/.json

Please suggest.

Thanks,
Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 12, 2020 6:57 AM
To: Deval Bhamare
Cc: Narada Hess; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>, feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf

I think the system linker may have some issue to find the library.

The libavago.so.0 is a symbolic link to libavago.so. the libavago.so must also exists.
ls -al $BF_SDE_INSTALL/lib/libavago*
-rwxr-xr-x 1 root root 1185264 Mar 12 04:19 libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0 -> libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0 -> libavago.so




--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200330/e4a981d7/attachment-0001.html>

From Deval.Bhamare at kau.se  Mon Mar 30 12:25:36 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Mon, 30 Mar 2020 12:25:36 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR0xekODA96sMZxUXLPd0UA_h=BjWe1REBW2SpAgO=sTmw@mail.gmail.com>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <08df48cbcfc3462fa41128f05c60db07@kau.se>
 <CAOyFVR3-vjAwOKDuQ1R5+z9s1Y3zZUD+UX_AQoK8-jJ3q5T5_g@mail.gmail.com>
 <a6d7c4b6ed894c31bc007500efbf8b71@kau.se>
 <CAOyFVR0wZCAN+RQQybzGydK6rNwyyjqmdy9kBrk8wSBGASYDRQ@mail.gmail.com>
 <01010171190c9981-833ae934-2420-4a40-abde-3f9542415656-000000@us-west-2.amazonses.com>
 <CAFh9Y_NuM3SnxdpU_PamscwO8e7F_cnp5etZ2Z=XMFwzb+O-MQ@mail.gmail.com>
 <01010171214eab35-94a8581f-ed3b-4aae-abb9-58b7f2151df3-000000@us-west-2.amazonses.com>
 <cd881b8db56449b5a9e1a6477cd46398@kau.se>
 <CAFh9Y_NLCng9zN3zak+nc1WjTjwyztN18gjZBOzeKQRvd+vXJQ@mail.gmail.com>
 <0421bf65803443d39b0f64b037b72282@kau.se>
 <e14ebcb4f1cc4c11a3a48af5acc4801b@kau.se>,
 <CAOyFVR0xekODA96sMZxUXLPd0UA_h=BjWe1REBW2SpAgO=sTmw@mail.gmail.com>
Message-ID: <4497e28827f44eebbab214abfb0d0cfa@kau.se>

Hello again,


So as per my understanding, when we use pre-built docker version of the Stratum, it doesn't refer to local locally built BSP and BF-SDE. Instead it uses its own pre-build BF-SDE and BSP. Is it correct?


In that case, with reference to the email from Stordis-support below, I would like to confirm that below point have been taken care of while building the updated docker image.


Stordis_support message:


"It is important that you build the BSP with the --with-tof-brgup-plat option that you can also pass through the p4studio_build script (see installation guide). Be sure to spell it correctly, or else p4studio_build will silently ignore the option and build the BSP incorrectly (there will be just a log entry in the installation log saying that the option was unknown)

Note too that there was a problem in the BSP zip file that is available on our FTP server  the bf-platforms.tgz in the packages directory was actually the reference BSP version. If you had used this tgz (instead of the bf-platforms directory that is present in the directory above), the BSP would have been built incorrectly too. In the meantime I have uploaded a corrected version of the zip file to our FTP server."



Can you please confirm?


Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Monday, March 30, 2020 7:32:05 AM
To: Deval Bhamare
Cc: max at opennetworking.org; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We've updated the container image and the script to start the container:
https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/start-stratum-container.sh

You can now try the following command to start the Stratum container with no ONLP support:
PLATFORM=x86-64-stordis-bf2556x-1t-r0 SDE_VERSION=8.9.2 ./start-stratum-container.sh

For the "unimplemented" message you saw, the SDE 8.9.2 uses old version PI library which doesn't implement some features (reading default entry from a table).
You can ignore that warning or use a newer version of Stratum (with SDE >= 9.0.0)

Yi


On Sun, Mar 29, 2020 at 8:31 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,



Just don't want to overload with the information, but I wanted to mention that, with the pre-built docker image option, I had a look a the ./start-stratum-container.sh


Since I want to run Stratum with BSP, I made a change as:


ONLP_ARG="--env WITH_ONLP=false"


Then I started the container 8.9.2-3.16.56-OpenNetworkLinux and it executed the Stratum successfully. Stratum open bf-sde prompt.


Also ss ouptput is:


State      Recv-Q Send-Q          Local Address:Port                         Peer Address:Port

LISTEN     0      128                         *:28000                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=36))

LISTEN     0      128                 127.0.0.1:28000<http://127.0.0.1:28000>                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=35))

LISTEN     0      128                 127.0.0.1:28003<http://127.0.0.1:28003>                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=32))

LISTEN     0      5                           *:9999                                    *:*                   users:(("stratum_bf_no_o",pid=10,fd=27))


I am getting following messages now:


 ONOS-CLI logs for the confirmation below:


tofino at root > devices                                                                                 22:02:35

id=device:tofino, available=true, local-status=connected 4m52s ago, role=MASTER, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=1<http://127.0.0.1:28000?device_id=1>, name=device:tofino, p4DeviceId=1, protocol=P4Runtime, gNMI, gNOI


Logs on stratum bf-sde are:


bf-sde.lld> E0329 22:01:52.649449   249 PI-device_mgr.cpp:0] Reading default entry not supported yet

E0329 22:01:52.649509   249 pi_node.cc:187] Return Error: toUtilStatus(status, details) failed with generic::unimplemented:

E0329 22:01:52.649549   249 p4_service.cc:307] Failed to read forwarding entries from node 1:


ONOS Logs:


2020-03-29T22:08:22,649 | WARN  | grpc-default-executor-4 | P4RuntimeClientImpl              | 230 - org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Error while performing READ on device:tofino: UNIMPLEMENTED



So, now ONOS can talk to Tofino through Stratum, but there are a few errors. First of all, is it OK to explicitly use this option: "--env WITH_ONLP=false" If yes, am I missing some steps here?  Any suggestion?



(Note: If I use default value of ONLP_ARG as per the original script, I get error as:


Use default flag file

Cannot find /usr/local/lib/modules/bf_kdrv.ko, skip installing the Kernel module

/usr/local/bin/stratum_bf: symbol lookup error: /usr/local/bin/stratum_bf: undefined symbol: onlp_sw_init

)



Thank you,


Deval.


________________________________
From: Deval Bhamare
Sent: Sunday, March 29, 2020 12:20:10 PM
To: Maximilian Pudelko
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Maximilian,


There is a littler confusion here. I am not using pre-built containerized version of Stratum.

However, I am locally building it by starting a development container with command "./setup_dev_env.sh  --pull -- -p 28000:28000" (I have mentioned it in the earlier image as well) as mentioned here: https://github.com/stratum/stratum

and then I try to build and run stratum as mentioned here: https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md



Now with the build-from-scratch using development container approach, I followed your steps, however, when I run ss -tnlp from the container (afterdocker exec -ti bash), I get below and listen on  127.0.0.1:28000<http://127.0.0.1:28000> is missing. I get only below.



tofino at 39e19c57ea27:/stratum$ ss -tlnp

State       Recv-Q Send-Q     Local Address:Port                    Peer Address:Port

LISTEN      0      128            127.0.0.1:56929<http://127.0.0.1:56929>                              *:*                   users:(("java",pid=21,fd=110))

LISTEN      0      1                      *:8008                               *:*                   users:(("stratum_bf",pid=310,fd=26))

Command to build Stratum is: bazel build //stratum/hal/bin/barefoot:stratum_bf --define phal_with_onlp=false --define sde_ver=8.9.2

Command to run Stratum is:

     ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
       --external_stratum_urls=0.0.0.0:28000<http://0.0.0.0:28000> \
       --grpc_max_recv_msg_size=256 \
       --bf_sde_install=$BF_SDE_INSTALL \
       --persistent_config_dir=/stratum/config/ \
       --forwarding_pipeline_configs_file=/stratum/config/p4_pipeline.pb.txt \
       --chassis_config_file=/stratum/config/chassis_config.pb.txt \
       --write_req_log_file=/stratum/config/p4_writes.pb.txt \
       --bf_sim




[Note: I had also tried the option of using pre-built docker container, with 8.9.1-3.16.56-OpenNetworkLinux, however, in this case I get error:

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json

I had reported that also and tried new container but didn't work]


Thanks,

Deval.


________________________________
From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Sunday, March 29, 2020 1:46:04 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>; Andreas Kassler
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

There are many things going on in your setup, let's do this step by step:

1. Port 8008 is NOT what you want for ONOS. I'm no Tofino expert, but this seems to be a separate endpoint for something else (debugging?). We always use port 28000.

2. 2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?
Depends. It's probably not good, but as long as you see this line in the Stratum logs, ONOS should be able to connect:
E0328 23:08:15.903065    13 hal.cc:234] Stratum external facing services are listening to 0.0.0.0:28000<http://0.0.0.0:28000>, localhost:28000...
Judging from the missing listening port, I'd say this could be the issue.

3. If you run ONOS in a container too, they have to reside in the same network and you have to figure out the docker-internal IP for the Stratum container:
# docker network ls
NETWORK ID          NAME                DRIVER              SCOPE
e737dd0dd90f        bridge              bridge              local
d2783152be24        host                host                local
7028e832e130        none                null                local

# docker network inspect bridge
[...]
"Containers": {
            "518c901167919d34205959f1105aedebbb99a9452d191409ccf71a3908e14e56": {
                "Name": "zen_jennings",
                "EndpointID": "a52025a671c9968372c52c7ed6b61df5a3168493466bd4b831c4728089b77163",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            }
        },
[...]

You could also try running them in the host network (--network=host), that should make them behave like native processes with fully exposed networking.

4. I used a wrong switch in my previous post, here's how it looks on a Tofino:

  *    ./start-stratum-container.sh (let it run and open new terminal tab)
  *   docker container ls
CONTAINER ID        IMAGE                                                      COMMAND                  CREATED             STATUS              PORTS                      NAMES
518c90116791        stratumproject/stratum-bf:9.1.0-4.14.49-OpenNetworkLinux   "/bin/sh -c /stratum"   12 minutes ago      Up 12 minutes       0.0.0.0:28000->28000/tcp   zen_jennings
  *   ss -ltnp
LISTEN      0      128                    :::28000                              :::*                   users:(("docker-proxy",pid=1179,fd=4))
  *   docker exec -ti 518c90116791 bash (switch into the Stratum container)
  *   apt update && apt install iproute
  *   ss -tlnp
State       Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN      0      5                       *:9999                                *:*                   users:(("stratum_bf",pid=13,fd=27))
LISTEN      0      128                     *:28000                               *:*                   users:(("stratum_bf",pid=13,fd=40))
LISTEN      0      128             127.0.0.1:28000<http://127.0.0.1:28000>                               *:*                   users:(("stratum_bf",pid=13,fd=39))
LISTEN      0      1                       *:9001                                *:*                   users:(("stratum_bf",pid=13,fd=28))
  *   exit (leave container)
  *   docker run -ti debian:9 bash (Start new container to simulate ONOS)
  *   apt update && apt install netcat
  *   nc -v 172.17.0.2 28000
172.17.0.2<http://172.17.0.2>: inverse host lookup failed: Unknown host
(UNKNOWN) [172.17.0.2] 28000 (?) open

For reference, the used versions:

# docker images
REPOSITORY                  TAG                              IMAGE ID            CREATED             SIZE
stratumproject/stratum-bf   9.1.0-4.14.49-OpenNetworkLinux   e4615d64018f        2 weeks ago         214MB

For reference, these are the versions we use:
# docker version
Client: Docker Engine - Community
 Version:           19.03.2
 API version:       1.40
 Go version:        go1.12.8
 Git commit:        6a30dfca03
 Built:             Thu Aug 29 05:29:49 2019
 OS/Arch:           linux/amd64
 Experimental:      false

Server: Docker Engine - Community
 Engine:
  Version:          19.03.2
  API version:      1.40 (minimum version 1.12)
  Go version:       go1.12.8
  Git commit:       6a30dfca03
  Built:            Thu Aug 29 05:28:23 2019
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.2.6
  GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
 runc:
  Version:          1.0.0-rc8
  GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
 docker-init:
  Version:          0.18.0
  GitCommit:        fec3683

# uname -a
Linux Stordis 4.14.49-OpenNetworkLinux #1 SMP Thu Jul 18 08:52:25 UTC 2019 x86_64 GNU/Linux


Max

On Sat, Mar 28, 2020 at 7:31 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,


Since I could not any port activity on 28000 inside stratum and stratum logs shown only listen activity on 8008, I used following command to do explicitly map the IP/ports to host:


./setup_dev_env.sh  --pull --  -p 192.168.60.131:28008<http://192.168.60.131:28008>:8008


Then I tried to push the netcfg.json with following URL and this time the communication channel is established. Logs from ONOS and stratum are below (BOLD RED).


URL:


"managementAddress": "grpc://192.168.60.131:28008?device_id=0<http://192.168.60.131:28008?device_id=0>",


(I tired both deviceID 0 and 1, but it must be 0 as bf_shell and stratum Log both confirm: )



ONOS:


2020-03-28T13:49:46,158 | WARN  | onos-gdp-0       | PiPipeconfManager                | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Ignoring PortStatisticsDiscovery behaviour from pipeconf vepg-pipeconf, but using the one provided by stratum-tofino driver...

2020-03-28T13:49:46,184 | INFO  | onos-gdp-0       | GrpcChannelControllerImpl        | 230 - org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Creating new gRPC channel grpc://192.168.60.131:28008?device_id=0.<http://192.168.60.131:28008?device_id=0.>.. << #THERE IS SUCCESS HERE THIS TIME AS COMPARED TO PREVIOUS TIME


Stratum:


Tcl server: connection accepted on port 8008

Partial recv: 30 of 40 so far..  <<#STRATUM CONFIRMS IT



However, I am not sure, it is the correct entry point? The reason is ONOS still cannot find the device:tofino (highlighted Yellow RED)


2020-03-28T13:49:46,306 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Local role is MASTER for device:tofino

2020-03-28T13:49:46,311 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,313 | INFO  | onos-gdp-0       | GeneralDeviceProvider            | 235 - org.onosproject.onos-providers-general-device - 2.4.0.SNAPSHOT | Notifying role MASTER (preference 0) for term 1 to device:tofino

2020-03-28T13:49:46,315 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,316 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.    <<#STILL NO DEVICE FOUND. I TRIED BOTH ID 0 and 1 in the URL

2020-03-28T13:49:46,317 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-28T13:49:46,320 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,336 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=12233603415182, creationTime=1585403386336, computeCost=124274, clusters=0, devices=0, links=0} changed

2020-03-28T13:49:46,365 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered




Please confirm, is it in the right direction or port 8008 is completely different? What can be the reason for device:tofino not able to find?


Thank you,

Deval.


________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org<mailto:stratum-dev-bounces at lists.stratumproject.org>> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>>
Sent: Saturday, March 28, 2020 3:22:16 PM
To: Maximilian Pudelko
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Maximilian,


Thank you for your reply and the useful suggestions. So as a first step I executed on switch ss -tnlp and below is the output. Surprisingly, there is no Stratum anywhere there, however statrum is also running in a container and the short logs are displayed below. I also executed ss command inside the container and those are also pasted below, if that may help.


ss -tnlp outputs in different times are as follows:


- from tofino, before anything is started:


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*



- from tofino after stratum container is started


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from tofino after stratum is running


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from stratum container, after running it in background


tofino at ced0c4d7ef8f:/stratum$ ss -tnlp

State      Recv-Q Send-Q Local Address:Port                Peer Address:Port

LISTEN     0      1                  *:8008                           *:*                   users:(("stratum_bf",pid=323,fd=26)) << #IS this useful?

LISTEN     0      128        127.0.0.1:41418<http://127.0.0.1:41418>                          *:*                   users:(("java",pid=21,fd=110))


Why there is no 28000 port here in Stratum container SS output. Or should I bind 8008 to 28000 on switch?

As you have mentioned, I have already taken care of port mapping. So I run the container with -p28000:2000. It is verified in the outputs above as well.


- Docker output on switch


tofino at localhost:~$ docker ps

CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                      NAMES

ced0c4d7ef8f        stratum-dev         "bash"              16 minutes ago      Up 16 minutes       0.0.0.0:28000->28000/tcp   goofy_hamilton



- Stratum log output after it started.


bf_sysfs_fname /sys/class/bf/bf0/device/dev_add

Install dir: /stratum/bf-sde-8.9.0/install (0x7f876b794b60)

bf_switchd: system services initialized

bf_switchd: loading conf_file stratum/hal/bin/barefoot/tofino_skip_p4.conf...

bf_switchd: processing device configuration...

Configuration for dev_id 0

  Family        : Tofino

  pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0

  pci_domain    : 0

  pci_bus       : 5

  pci_fn        : 0

  pci_dev       : 0

  pci_int_mode  : 1

  sbus_master_fw: /stratum/bf-sde-8.9.0/install/

  pcie_fw       : /stratum/bf-sde-8.9.0/install/

  serdes_fw     : /stratum/bf-sde-8.9.0/install/

  sds_fw_path   : /stratum/bf-sde-8.9.0/install/

  microp_fw_path:

bf_switchd: processing P4 configuration...

P4 profile for dev_id 0

  p4_name: dummy

    libpd:

    libpdthrift:

    context:

    config:

  Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so

  diag:

  mavericks diag:

  non_default_port_ppgs: 0

  SAI default initialize: 1

bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so loaded

bf_switchd: agent[0] initialized

Tcl server started..

Tcl server: listen socket created

Tcl server: bind done on port 8008, listening...

Tcl server: waiting for incoming connections...

sh: 1: onie-syseeprom: not found

2020-03-28 13:06:53.584090 BF_PLTFM ERROR - Error in cp2112 initialization


2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?



Thank you.

Deval


________________________________
From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Saturday, March 28, 2020 3:43:29 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

can you run this command on the switch: ss -tlnp
Should output something like this:
State      Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN     0      128                     *:22                                  *:*                   users:(("sshd",pid=4116,fd=3))
LISTEN     0      128                    :::22                                 :::*                   users:(("sshd",pid=4116,fd=4))
LISTEN     0      128      ::ffff:127.0.0.1:28000<http://127.0.0.1:28000>                              :::*                   users:(("stratum_bcm",pid=26872,fd=19))
LISTEN     0      128                    :::28001                              :::*                   users:(("stratum_bcm",pid=26872,fd=20))
LISTEN     0      128      ::ffff:127.0.0.1:28003<http://127.0.0.1:28003>                              :::*                   users:(("stratum_bcm",pid=26872,fd=6))

Also, do you have any logs from Stratum? Run with -v=1 -stderrthreshold=0

Since you're using docker, I assume there is some issue with port forwarding/mapping. Follow these steps to check the port mapping: https://docs.docker.com/engine/reference/commandline/port/
And these steps to fix it:
https://stackoverflow.com/questions/22111060/what-is-the-difference-between-expose-and-publish-in-docker
https://docs.docker.com/config/containers/container-networking/#published-ports

Max


On Thu, Mar 26, 2020 at 3:53 PM Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:

Hello Yi,


I am running both ONOS and stratum container on the same machine, that is the tofino switch with public IP 192.168.60.131.


So I tried with grpc://192.168.60.131:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", as well now. This time message is connection refused and still no connectivity.




2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.

2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264511977012, creationTime=1585262479736, computeCost=117691, clusters=0, devices=0, links=0} changed

2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | device:tofino is unreachable (Connection refused: /192.168.60.131:28000<http://192.168.60.131:28000>)

2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264549921343, creationTime=1585262479774, computeCost=101378, clusters=0, devices=0, links=0} changed


With grpc://127.0.0.1:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", the error is


onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason


Also Stratum logs say


bf_switchd: processing P4 configuration...

P4 profile for dev_id 0


while starting, so I doubt device ID maybe 0 and hence tried with both device_id=1<http://192.168.0.101:28000/?device_id=1> and device_id=<http://192.168.0.101:28000/?device_id=1>0 but no luck.



Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 26, 2020 9:10:49 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

Where you are running the ONOS controller? If you are running the ONOS controller on a server, you need to set the management address to your switch IP address.

For example, you run the ONOS on a server with IP address 192.168.0.100 and running the Stratum on a switch with IP address 192.168.0.101. (And I assume that you have connectivity between the server and the switch)

The netcfg.json will look like:

{
  "devices": {
    "device:tofino": {
      "basic": {
        "managementAddress": "grpc://192.168.0.101:28000?device_id=1<http://192.168.0.101:28000?device_id=1>",
        "driver": "stratum-tofino",
        "pipeconf": "[your pipeconf name]"
       }
    }
   }
}

Please also note that the device ID is 1 in the Stratum

Yi


On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


We have received a reply from Stordis and as per their suggestion, we can ignore the syseeprom error


You see only syseeprom errorr please ignore that :
Tcl server: listen socket created
Tcl server: bind done on port 8008, listening...
Tcl server: waiting for incoming connections...
sh: 1: onie-syseeprom: not found <Ignore this error>
Health monitor started
Operational mode set to ASIC



So, now when I try to push the netcfg.json for our device to Onos, I get following message:


2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452353961040, creationTime=1585173541276, computeCost=427068, clusters=0, devices=0, links=0} changed

2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason

2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452397561034, creationTime=1585173541319, computeCost=112832, clusters=0, devices=0, links=0} changed



ONOS CLI show, device available=false.


tofino at root > devices                                                        21:58:49

id=device:tofino, available=false, local-status=disconnected 37s ago, role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0<http://127.0.0.1:28000?device_id=0>, name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI



Netcfg.json contents are:

{
        "devices": {
        "device:tofino": {
        "basic": {
        "managementAddress": "grpc://127.0.0.1?device_id=0<http://127.0.0.1?device_id=0>",
        "driver": "stratum-tofino",
        "pipeconf": "vepg-pipeconf"
        }
        }
        }
        }


Command is:


curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H 'Content-Type:application/json' 'http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json



Any idea what may be the issue?


Thanks,

Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Tuesday, March 24, 2020 3:25:06 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

I am now working on updating the script to support the custom platform parameter<https://github.com/stratum/stratum/pull/150> since the Stratum cannot detect the platform without the ONLP.

Should be merged soon.

On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux, however, the error still persists:


+ KERNEL_VERSION=3.16.64-OpenNetworkLinux

+ DOCKER_IMAGE=stratumproject/stratum-bf

+ DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux

++ uname -r

++ uname -r

+ docker run -it --privileged -v /dev:/dev -v /sys:/sys -v /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1 -v /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so -v /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1 -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux

Use default flag file

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json



I also had peek at the script start-stratum-container.sh and found an option of ONLP_ARG="--env WITH_ONLP=false"
. So I wanted to ask whether I can set this option with Docker to force BSP usage, let us say, by hard-coding it in the script itself (also similar approach to set PORT_MAP in stratume_entrypoint.sh). I tried this and the error message in this case is:


Use default flag file

Cannot find /usr/local/share/stratum/.json

Please suggest.

Thanks,
Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 12, 2020 6:57 AM
To: Deval Bhamare
Cc: Narada Hess; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>, feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf

I think the system linker may have some issue to find the library.

The libavago.so.0 is a symbolic link to libavago.so. the libavago.so must also exists.
ls -al $BF_SDE_INSTALL/lib/libavago*
-rwxr-xr-x 1 root root 1185264 Mar 12 04:19 libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0 -> libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0 -> libavago.so




--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200330/bccfeabd/attachment-0001.html>

