From bocon at opennetworking.org  Thu Apr  2 07:36:32 2020
From: bocon at opennetworking.org (bocon at opennetworking.org)
Date: Thu, 02 Apr 2020 07:36:32 +0000
Subject: [stratum-dev] Updated invitation with note: Stratum TST Meeting @
 Weekly from 12:30pm to 1pm on Thursday (PDT)
 (stratum-dev@lists.stratumproject.org)
Message-ID: <00000000000019c10805a249dc67@google.com>

This event has been changed with this note:
"Moving to 12:30pm PDT per last week's decision. Sorry that I didn't send  
this out earlier."

Title: Stratum TST Meeting
Stratum Technical Steering Team MeetingAgenda and Meeting  
Noteshttps://docs.google.com/document/d/1ret8Vbnl-xbLgNsnDEH-jWP2_WwDYym4zDn6me3tiTA/editThe  
plan is to reserve the 1st and 3rd Thursdays of each month for  
presentations and community updates. If you can only attend some of these  
meetings, those will be more interesting. The other meetings will be more  
informal&nbsp;sync ups to discuss current issues, progress, and status. You  
can see what presentations are planned by checking the agenda  
above.Supporting Slides and Previous  
Recordingshttps://drive.google.com/drive/folders/1ZeYp6RwIGYi9VnIctvnKF1c1NxiAXeOT----------------------------------------------------------------Join  
Zoom Meetinghttps://zoom.us/j/787501745Meeting ID: 787 501 745One tap  
mobile+16699006833,,787501745# US (San Jose)+19292056099,,787501745# US  
(New York)Dial by your location&nbsp; &nbsp; &nbsp; &nbsp; +1 669 900 6833  
US (San Jose)&nbsp; &nbsp; &nbsp; &nbsp; +1 929 205 6099 US (New  
York)&nbsp; &nbsp; &nbsp; &nbsp; 888 788 0099 US Toll-free&nbsp; &nbsp;  
&nbsp; &nbsp; 877 853 5247 US Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +61 3  
7018 2005 Australia&nbsp; &nbsp; &nbsp; &nbsp; +61 8 7150 1149  
Australia&nbsp; &nbsp; &nbsp; &nbsp; +61 2 8015 6011 Australia&nbsp; &nbsp;  
&nbsp; &nbsp; 1800 945 157 Australia Toll-free&nbsp; &nbsp; &nbsp; &nbsp;  
1800 893 423 Australia Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +81 524 564 439  
Japan&nbsp; &nbsp; &nbsp; &nbsp; +81 3 4578 1488 Japan&nbsp; &nbsp; &nbsp;  
&nbsp; 0 800 100 5040 Japan Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 00 663 381  
4092 Japan Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +49 695 050 2596  
Germany&nbsp; &nbsp; &nbsp; &nbsp; +49 69 7104 9922 Germany&nbsp; &nbsp;  
&nbsp; &nbsp; +49 30 5679 5800 Germany&nbsp; &nbsp; &nbsp; &nbsp; 0 800  
1800 150 Germany Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 0 800 000 6954  
Germany Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +886 (2) 7741 7473  
Taiwan&nbsp; &nbsp; &nbsp; &nbsp; 08 0909 9864 Taiwan Toll-free&nbsp;  
&nbsp; &nbsp; &nbsp; +48 22 398 7356 Poland&nbsp; &nbsp; &nbsp; &nbsp; +48  
22 307 3488 Poland&nbsp; &nbsp; &nbsp; &nbsp; 00 800 321 1464 Poland  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 00 800 112 5171 Poland Toll-free&nbsp;  
&nbsp; &nbsp; &nbsp; +44 203 481 5240 United Kingdom&nbsp; &nbsp; &nbsp;  
&nbsp; +44 131 460 1196 United Kingdom&nbsp; &nbsp; &nbsp; &nbsp; +44 203  
051 2874 United Kingdom&nbsp; &nbsp; &nbsp; &nbsp; +44 203 481 5237 United  
Kingdom&nbsp; &nbsp; &nbsp; &nbsp; 0 800 260 5801 United Kingdom  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 0 800 031 5717 United Kingdom  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +353 1 653 3895 Ireland&nbsp; &nbsp;  
&nbsp; &nbsp; +353 6 163 9031 Ireland&nbsp; &nbsp; &nbsp; &nbsp; +353 1 536  
9320 Ireland&nbsp; &nbsp; &nbsp; &nbsp; 1800 949 238 Ireland  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 1800 901 561 Ireland Toll-freeMeeting  
ID: 787 501 745Find your local number:  
https://zoom.us/u/adqQM87Zrg----------------------------------------------------------------If  
you would like to get added to the calendar invite, please ask Brian.
When: Weekly from 12:30pm to 1pm on Thursday Pacific Time - Los Angeles  
(changed)
Where: MP-1-Large Conference Room (25), (Online conference room)-Zoom-3
Calendar: stratum-dev at lists.stratumproject.org
Who:
     * bocon at opennetworking.org - creator
     * stratum-dev at lists.stratumproject.org
     * max at opennetworking.org
     * bill at opennetworking.org
     * maksym.kovaliov at plvision.eu
     * mohammed.habeeb at inventec.com
     * craig.stevens at dell.com
     * yi at opennetworking.org
     * carmelo at opennetworking.org
     * maksym.tropets at plvision.eu
     * xiao.david at inventec.com
     * Rich Renner
     * Devjit Gopalpur
     * Alireza Ghaffarkhah
     * Leonid Khedyk
     * niloofar at opennetworking.org
     * hsuanchung.lee at qct.io
     * jeff_catlin at edge-core.com
     * Arkadiy Shapiro
     * you at opennetworking.org
     * abhilash at opennetworking.org

Event details:  
https://www.google.com/calendar/event?action=VIEW&eid=MTVxdHRrZTdoOGNrZG9ycHYzaDJoZ3VvZGogc3RyYXR1bS1kZXZAbGlzdHMuc3RyYXR1bXByb2plY3Qub3Jn&tok=NzEjb3Blbm5ldHdvcmtpbmcub3JnX3Z2M2xmdDg5ZTc5NGI0amxtcjNqOXAxcGVzQGdyb3VwLmNhbGVuZGFyLmdvb2dsZS5jb21lM2VkZjFiZTA5Zjg3MGU3YmEyMTUzYzlkNTMyNTA5NGJkNGIwMzg0&ctz=America%2FLos_Angeles&hl=en&es=0

Invitation from Google Calendar: https://www.google.com/calendar/

You are receiving this courtesy email at the account  
stratum-dev at lists.stratumproject.org because you are an attendee of this  
event.

To stop receiving future updates for this event, decline this event.  
Alternatively you can sign up for a Google account at  
https://www.google.com/calendar/ and control your notification settings for  
your entire calendar.

Forwarding this invitation could allow any recipient to send a response to  
the organizer and be added to the guest list, or invite others regardless  
of their own invitation status, or to modify your RSVP. Learn more at  
https://support.google.com/calendar/answer/37135#forwarding
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200402/8440c7cd/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: text/calendar
Size: 9228 bytes
Desc: not available
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200402/8440c7cd/attachment-0001.ics>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: invite.ics
Type: application/ics
Size: 9387 bytes
Desc: not available
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200402/8440c7cd/attachment-0001.bin>

From bocon at opennetworking.org  Thu Apr  2 07:36:32 2020
From: bocon at opennetworking.org (bocon at opennetworking.org)
Date: Thu, 02 Apr 2020 07:36:32 +0000
Subject: [stratum-dev] Updated invitation: Stratum TST Meeting @ Weekly from
 11:30am to 12pm on Thursday from Thu Jan 16 to Wed Apr 1 (PST)
 (stratum-dev@lists.stratumproject.org)
Message-ID: <0000000000001b23d305a249dcda@google.com>

This event has been changed.

Title: Stratum TST Meeting
Stratum Technical Steering Team MeetingAgenda and Meeting  
Noteshttps://docs.google.com/document/d/1ret8Vbnl-xbLgNsnDEH-jWP2_WwDYym4zDn6me3tiTA/editThe  
plan is to reserve the 1st and 3rd Thursdays of each month for  
presentations and community updates. If you can only attend some of these  
meetings, those will be more interesting. The other meetings will be more  
informal&nbsp;sync ups to discuss current issues, progress, and status. You  
can see what presentations are planned by checking the agenda  
above.Supporting Slides and Previous  
Recordingshttps://drive.google.com/drive/folders/1ZeYp6RwIGYi9VnIctvnKF1c1NxiAXeOT----------------------------------------------------------------Join  
Zoom Meetinghttps://zoom.us/j/787501745Meeting ID: 787 501 745One tap  
mobile+16699006833,,787501745# US (San Jose)+19292056099,,787501745# US  
(New York)Dial by your location&nbsp; &nbsp; &nbsp; &nbsp; +1 669 900 6833  
US (San Jose)&nbsp; &nbsp; &nbsp; &nbsp; +1 929 205 6099 US (New  
York)&nbsp; &nbsp; &nbsp; &nbsp; 888 788 0099 US Toll-free&nbsp; &nbsp;  
&nbsp; &nbsp; 877 853 5247 US Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +61 3  
7018 2005 Australia&nbsp; &nbsp; &nbsp; &nbsp; +61 8 7150 1149  
Australia&nbsp; &nbsp; &nbsp; &nbsp; +61 2 8015 6011 Australia&nbsp; &nbsp;  
&nbsp; &nbsp; 1800 945 157 Australia Toll-free&nbsp; &nbsp; &nbsp; &nbsp;  
1800 893 423 Australia Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +81 524 564 439  
Japan&nbsp; &nbsp; &nbsp; &nbsp; +81 3 4578 1488 Japan&nbsp; &nbsp; &nbsp;  
&nbsp; 0 800 100 5040 Japan Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 00 663 381  
4092 Japan Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +49 695 050 2596  
Germany&nbsp; &nbsp; &nbsp; &nbsp; +49 69 7104 9922 Germany&nbsp; &nbsp;  
&nbsp; &nbsp; +49 30 5679 5800 Germany&nbsp; &nbsp; &nbsp; &nbsp; 0 800  
1800 150 Germany Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 0 800 000 6954  
Germany Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +886 (2) 7741 7473  
Taiwan&nbsp; &nbsp; &nbsp; &nbsp; 08 0909 9864 Taiwan Toll-free&nbsp;  
&nbsp; &nbsp; &nbsp; +48 22 398 7356 Poland&nbsp; &nbsp; &nbsp; &nbsp; +48  
22 307 3488 Poland&nbsp; &nbsp; &nbsp; &nbsp; 00 800 321 1464 Poland  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 00 800 112 5171 Poland Toll-free&nbsp;  
&nbsp; &nbsp; &nbsp; +44 203 481 5240 United Kingdom&nbsp; &nbsp; &nbsp;  
&nbsp; +44 131 460 1196 United Kingdom&nbsp; &nbsp; &nbsp; &nbsp; +44 203  
051 2874 United Kingdom&nbsp; &nbsp; &nbsp; &nbsp; +44 203 481 5237 United  
Kingdom&nbsp; &nbsp; &nbsp; &nbsp; 0 800 260 5801 United Kingdom  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 0 800 031 5717 United Kingdom  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +353 1 653 3895 Ireland&nbsp; &nbsp;  
&nbsp; &nbsp; +353 6 163 9031 Ireland&nbsp; &nbsp; &nbsp; &nbsp; +353 1 536  
9320 Ireland&nbsp; &nbsp; &nbsp; &nbsp; 1800 949 238 Ireland  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 1800 901 561 Ireland Toll-freeMeeting  
ID: 787 501 745Find your local number:  
https://zoom.us/u/adqQM87Zrg----------------------------------------------------------------If  
you would like to get added to the calendar invite, please ask Brian.
When: Weekly from 11:30am to 12pm on Thursday from Thu Jan 16 to Wed Apr 1  
Pacific Time - Los Angeles (changed)
Where: MP-1-Large Conference Room (25), (Online conference room)-Zoom-3
Calendar: stratum-dev at lists.stratumproject.org
Who:
     * bocon at opennetworking.org - creator
     * maksym.tropets at plvision.eu
     * mohammed.habeeb at inventec.com
     * stratum-dev at lists.stratumproject.org
     * Devjit Gopalpur
     * yi at opennetworking.org
     * Rich Renner
     * you at opennetworking.org
     * max at opennetworking.org
     * abhilash at opennetworking.org
     * Alireza Ghaffarkhah
     * maksym.kovaliov at plvision.eu
     * Arkadiy Shapiro
     * craig.stevens at dell.com
     * carmelo at opennetworking.org
     * Leonid Khedyk
     * hsuanchung.lee at qct.io
     * bill at opennetworking.org
     * xiao.david at inventec.com
     * jeff_catlin at edge-core.com

Event details:  
https://www.google.com/calendar/event?action=VIEW&eid=NXNlYXJjbXJvOWtibWRpNTNmNzVnNXRlYXIgc3RyYXR1bS1kZXZAbGlzdHMuc3RyYXR1bXByb2plY3Qub3Jn&tok=NzEjb3Blbm5ldHdvcmtpbmcub3JnX3Z2M2xmdDg5ZTc5NGI0amxtcjNqOXAxcGVzQGdyb3VwLmNhbGVuZGFyLmdvb2dsZS5jb21mMTNmYjk1ZjIxYmY1YjlmNTQzMDc2YmJkMjI1NjA0ZGU5OTI1YTE5&ctz=America%2FLos_Angeles&hl=en&es=0

Invitation from Google Calendar: https://www.google.com/calendar/

You are receiving this courtesy email at the account  
stratum-dev at lists.stratumproject.org because you are an attendee of this  
event.

To stop receiving future updates for this event, decline this event.  
Alternatively you can sign up for a Google account at  
https://www.google.com/calendar/ and control your notification settings for  
your entire calendar.

Forwarding this invitation could allow any recipient to send a response to  
the organizer and be added to the guest list, or invite others regardless  
of their own invitation status, or to modify your RSVP. Learn more at  
https://support.google.com/calendar/answer/37135#forwarding
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200402/3b384242/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: text/calendar
Size: 9053 bytes
Desc: not available
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200402/3b384242/attachment-0001.ics>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: invite.ics
Type: application/ics
Size: 9208 bytes
Desc: not available
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200402/3b384242/attachment-0001.bin>

From bocon at opennetworking.org  Thu Apr  2 07:36:32 2020
From: bocon at opennetworking.org (bocon at opennetworking.org)
Date: Thu, 02 Apr 2020 07:36:32 +0000
Subject: [stratum-dev] Updated invitation: Stratum TST Meeting @ Weekly from
 11:30am to 12pm on Thursday from Thu Jan 23 to Wed Apr 1 (PST)
 (stratum-dev@lists.stratumproject.org)
Message-ID: <0000000000001c92da05a249dc79@google.com>

This event has been changed.

Title: Stratum TST Meeting
Stratum Technical Steering Team MeetingAgenda and Meeting  
Noteshttps://docs.google.com/document/d/1ret8Vbnl-xbLgNsnDEH-jWP2_WwDYym4zDn6me3tiTA/editThe  
plan is to reserve the 1st and 3rd Thursdays of each month for  
presentations and community updates. If you can only attend some of these  
meetings, those will be more interesting. The other meetings will be more  
informal&nbsp;sync ups to discuss current issues, progress, and status. You  
can see what presentations are planned by checking the agenda  
above.Supporting Slides and Previous  
Recordingshttps://drive.google.com/drive/folders/1ZeYp6RwIGYi9VnIctvnKF1c1NxiAXeOT----------------------------------------------------------------Join  
Zoom Meetinghttps://zoom.us/j/787501745Meeting ID: 787 501 745One tap  
mobile+16699006833,,787501745# US (San Jose)+19292056099,,787501745# US  
(New York)Dial by your location&nbsp; &nbsp; &nbsp; &nbsp; +1 669 900 6833  
US (San Jose)&nbsp; &nbsp; &nbsp; &nbsp; +1 929 205 6099 US (New  
York)&nbsp; &nbsp; &nbsp; &nbsp; 888 788 0099 US Toll-free&nbsp; &nbsp;  
&nbsp; &nbsp; 877 853 5247 US Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +61 3  
7018 2005 Australia&nbsp; &nbsp; &nbsp; &nbsp; +61 8 7150 1149  
Australia&nbsp; &nbsp; &nbsp; &nbsp; +61 2 8015 6011 Australia&nbsp; &nbsp;  
&nbsp; &nbsp; 1800 945 157 Australia Toll-free&nbsp; &nbsp; &nbsp; &nbsp;  
1800 893 423 Australia Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +81 524 564 439  
Japan&nbsp; &nbsp; &nbsp; &nbsp; +81 3 4578 1488 Japan&nbsp; &nbsp; &nbsp;  
&nbsp; 0 800 100 5040 Japan Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 00 663 381  
4092 Japan Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +49 695 050 2596  
Germany&nbsp; &nbsp; &nbsp; &nbsp; +49 69 7104 9922 Germany&nbsp; &nbsp;  
&nbsp; &nbsp; +49 30 5679 5800 Germany&nbsp; &nbsp; &nbsp; &nbsp; 0 800  
1800 150 Germany Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 0 800 000 6954  
Germany Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +886 (2) 7741 7473  
Taiwan&nbsp; &nbsp; &nbsp; &nbsp; 08 0909 9864 Taiwan Toll-free&nbsp;  
&nbsp; &nbsp; &nbsp; +48 22 398 7356 Poland&nbsp; &nbsp; &nbsp; &nbsp; +48  
22 307 3488 Poland&nbsp; &nbsp; &nbsp; &nbsp; 00 800 321 1464 Poland  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 00 800 112 5171 Poland Toll-free&nbsp;  
&nbsp; &nbsp; &nbsp; +44 203 481 5240 United Kingdom&nbsp; &nbsp; &nbsp;  
&nbsp; +44 131 460 1196 United Kingdom&nbsp; &nbsp; &nbsp; &nbsp; +44 203  
051 2874 United Kingdom&nbsp; &nbsp; &nbsp; &nbsp; +44 203 481 5237 United  
Kingdom&nbsp; &nbsp; &nbsp; &nbsp; 0 800 260 5801 United Kingdom  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 0 800 031 5717 United Kingdom  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; +353 1 653 3895 Ireland&nbsp; &nbsp;  
&nbsp; &nbsp; +353 6 163 9031 Ireland&nbsp; &nbsp; &nbsp; &nbsp; +353 1 536  
9320 Ireland&nbsp; &nbsp; &nbsp; &nbsp; 1800 949 238 Ireland  
Toll-free&nbsp; &nbsp; &nbsp; &nbsp; 1800 901 561 Ireland Toll-freeMeeting  
ID: 787 501 745Find your local number:  
https://zoom.us/u/adqQM87Zrg----------------------------------------------------------------If  
you would like to get added to the calendar invite, please ask Brian.
When: Weekly from 11:30am to 12pm on Thursday from Thu Jan 23 to Wed Apr 1  
Pacific Time - Los Angeles (changed)
Where: MP-1-Large Conference Room (25), (Online conference room)-Zoom-3
Calendar: stratum-dev at lists.stratumproject.org
Who:
     * bocon at opennetworking.org - creator
     * max at opennetworking.org
     * bill at opennetworking.org
     * mohammed.habeeb at inventec.com
     * yi at opennetworking.org
     * carmelo at opennetworking.org
     * xiao.david at inventec.com
     * Rich Renner
     * Devjit Gopalpur
     * Alireza Ghaffarkhah
     * Leonid Khedyk
     * niloofar at opennetworking.org
     * hsuanchung.lee at qct.io
     * Arkadiy Shapiro
     * you at opennetworking.org
     * abhilash at opennetworking.org
     * stratum-dev at lists.stratumproject.org
     * maksym.kovaliov at plvision.eu
     * craig.stevens at dell.com
     * maksym.tropets at plvision.eu
     * jeff_catlin at edge-core.com

Event details:  
https://www.google.com/calendar/event?action=VIEW&eid=NXNlYXJjbXJvOWtibWRpNTNmNzVnNXRlYXJfUjIwMjAwMTIzVDE5MzAwMCBzdHJhdHVtLWRldkBsaXN0cy5zdHJhdHVtcHJvamVjdC5vcmc&tok=NzEjb3Blbm5ldHdvcmtpbmcub3JnX3Z2M2xmdDg5ZTc5NGI0amxtcjNqOXAxcGVzQGdyb3VwLmNhbGVuZGFyLmdvb2dsZS5jb21iZjA2YWY5MDgzMmIxMGE5ZjUwNjdmZDgzYTNlNDQ4Y2QxZjQ2MzIx&ctz=America%2FLos_Angeles&hl=en&es=0

Invitation from Google Calendar: https://www.google.com/calendar/

You are receiving this courtesy email at the account  
stratum-dev at lists.stratumproject.org because you are an attendee of this  
event.

To stop receiving future updates for this event, decline this event.  
Alternatively you can sign up for a Google account at  
https://www.google.com/calendar/ and control your notification settings for  
your entire calendar.

Forwarding this invitation could allow any recipient to send a response to  
the organizer and be added to the guest list, or invite others regardless  
of their own invitation status, or to modify your RSVP. Learn more at  
https://support.google.com/calendar/answer/37135#forwarding
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200402/9f79c9ca/attachment-0001.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: text/calendar
Size: 9240 bytes
Desc: not available
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200402/9f79c9ca/attachment-0001.ics>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: invite.ics
Type: application/ics
Size: 9397 bytes
Desc: not available
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200402/9f79c9ca/attachment-0001.bin>

From bocon at opennetworking.org  Thu Apr  2 10:16:59 2020
From: bocon at opennetworking.org (Brian O'Connor)
Date: Thu, 2 Apr 2020 03:16:59 -0700
Subject: [stratum-dev] Reminder: TST moving to 12:30pm PDT
Message-ID: <CACKOpD=yE0Nr=ZFPegxzzjOxmYRPMcPRHknDYZizKy18cFytpA@mail.gmail.com>

Sorry for the calendar spam, but just wanted to remind everyone that we
have moved to the TST to 12:30pm PDT.

Thanks!
Brian
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200402/3a5ca05c/attachment.html>

From yi at opennetworking.org  Thu Apr  2 11:02:40 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Thu, 2 Apr 2020 19:02:40 +0800
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <4497e28827f44eebbab214abfb0d0cfa@kau.se>
References: <01010170a807989e-646af7e2-9182-463c-b838-6f52d52d300a-000000@us-west-2.amazonses.com>
 <62eb173564ba43b8ba5497605c0d4cf9@kau.se>
 <01010170aacc6df4-3635415f-2b74-4c8e-9424-cee4f29e4465-000000@us-west-2.amazonses.com>
 <01010170ab3fc934-a2775e26-3f3c-4f84-b1e0-15e23ac73278-000000@us-west-2.amazonses.com>
 <ec543d4d92fb4206b830a19262960255@kau.se>
 <CAOyFVR3z4XnQdVQhJVevDaZVz9XtY8UgPRfUyx+PnducmSqFuA@mail.gmail.com>
 <01010170af3ea5c5-1c8ef057-44bb-4598-8282-83a93dec047f-000000@us-west-2.amazonses.com>
 <57d375bcb0914fa6a4f064cea2a51f36@kau.se>
 <CAOyFVR1hVL0THuSsV+0Ld3DoDxafqAzzJLyYfBXZjpR3jWXygQ@mail.gmail.com>
 <280d12daac4a4957b30144e3b7720db4@kau.se>
 <CAOyFVR3d8VkRRBjY_QxPfn5nxZ0iyTRnqxnPqOd808YAHvvr3A@mail.gmail.com>
 <01010170b91b4477-5ebf3eee-9989-4f79-a483-530f3b00d9c4-000000@us-west-2.amazonses.com>
 <6a72d675258e4056b510ac74fab4eef0@kau.se>
 <CAOyFVR2DS+FbC24uDBWU4n4ZH6YnfgY0NPuHcjROHCNpgd3OjA@mail.gmail.com>
 <3334ec1599bd419d8b996bac91ec36eb@kau.se>
 <CAOyFVR107OBTLm2WR2HK1VS7xRdZYMq5GoWM=fhoygDRhPVO1A@mail.gmail.com>
 <01010170c62142dc-c9f9ca21-db18-4799-8b04-f0213cff79ba-000000@us-west-2.amazonses.com>
 <SN6PR04MB54556D0A6C181B3520B8FAB7ADFF0@SN6PR04MB5455.namprd04.prod.outlook.com>
 <e81d1a6b4e5147ffb923e6269d47e252@kau.se>
 <CAOyFVR0k5_Z9GnKAC+Lf2EW0C8QhJUDM=MQfqoV3fztNgaxKFA@mail.gmail.com>
 <08df48cbcfc3462fa41128f05c60db07@kau.se>
 <CAOyFVR3-vjAwOKDuQ1R5+z9s1Y3zZUD+UX_AQoK8-jJ3q5T5_g@mail.gmail.com>
 <a6d7c4b6ed894c31bc007500efbf8b71@kau.se>
 <CAOyFVR0wZCAN+RQQybzGydK6rNwyyjqmdy9kBrk8wSBGASYDRQ@mail.gmail.com>
 <01010171190c9981-833ae934-2420-4a40-abde-3f9542415656-000000@us-west-2.amazonses.com>
 <CAFh9Y_NuM3SnxdpU_PamscwO8e7F_cnp5etZ2Z=XMFwzb+O-MQ@mail.gmail.com>
 <01010171214eab35-94a8581f-ed3b-4aae-abb9-58b7f2151df3-000000@us-west-2.amazonses.com>
 <cd881b8db56449b5a9e1a6477cd46398@kau.se>
 <CAFh9Y_NLCng9zN3zak+nc1WjTjwyztN18gjZBOzeKQRvd+vXJQ@mail.gmail.com>
 <0421bf65803443d39b0f64b037b72282@kau.se>
 <e14ebcb4f1cc4c11a3a48af5acc4801b@kau.se>
 <CAOyFVR0xekODA96sMZxUXLPd0UA_h=BjWe1REBW2SpAgO=sTmw@mail.gmail.com>
 <4497e28827f44eebbab214abfb0d0cfa@kau.se>
Message-ID: <CAOyFVR26WzkbQJHqvXZa=_o58HQ-L_K6n-ajQjKSv4WssMK1dw@mail.gmail.com>

Hi Deval,

The Stratum container image does not include the BSP library from each
vendor since the origin goal is to use a general open-source platform
library from ONL.

The current way to support Stratum + BSP is to build the SDE, BSP, and
Stratum on the switch (you can also build it on the server and copy every
necessary libraries and files to the switch). Also, I believed that you can
build everything(SDE, BSP, Stratum) on a Ubuntu-based switch and run it.

I've tested to build SDE, BSP, and Stratum on out BF2556X and I can confirm
that ONOS can connect to the Stratum.
Currently, we are using ONL-based OS in our lab. I can try re-installed the
switch to Ubuntu-based once I can access the hardware.

Yi


On Mon, Mar 30, 2020 at 8:25 PM Deval Bhamare <Deval.Bhamare at kau.se> wrote:

> Hello again,
>
>
> So as per my understanding, when we use pre-built docker version of the
> Stratum, it doesn't refer to local locally built BSP and BF-SDE. Instead it
> uses its own pre-build BF-SDE and BSP. Is it correct?
>
>
> In that case, with reference to the email from Stordis-support below, I
> would like to confirm that below point have been taken care of while
> building the updated docker image.
>
>
> Stordis_support message:
>
>
> "*It is important that you build the BSP with the --with-tof-brgup-plat
> option that you can also pass through the p4studio_build script (see
> installation guide). Be sure to spell it correctly, or else p4studio_build
> will silently ignore the option and build the BSP incorrectly… (there will
> be just a log entry in the installation log saying that the option was
> unknown)*
>
> *Note too that there was a problem in the BSP zip file that is available
> on our FTP server – the bf-platforms.tgz in the packages directory was
> actually the reference BSP version. If you had used this tgz (instead of
> the bf-platforms directory that is present in the directory above), the BSP
> would have been built incorrectly too. In the meantime I have uploaded a
> corrected version of the zip file to our FTP server.*"
>
>
> Can you please confirm?
>
>
> Thanks,
>
>
> Deval.
> ------------------------------
> *From:* Yi Tseng <yi at opennetworking.org>
> *Sent:* Monday, March 30, 2020 7:32:05 AM
> *To:* Deval Bhamare
> *Cc:* max at opennetworking.org; stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
> Hi Deval,
>
> We've updated the container image and the script to start the container:
>
> https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/start-stratum-container.sh
>
> You can now try the following command to start the Stratum container with
> no ONLP support:
> *PLATFORM=x86-64-stordis-bf2556x-1t-r0 SDE_VERSION=8.9.2
> ./start-stratum-container.sh*
>
> For the "unimplemented" message you saw, the SDE 8.9.2 uses old version PI
> library which doesn't implement some features (reading default entry from a
> table).
> You can ignore that warning or use a newer version of Stratum (with SDE >=
> 9.0.0)
>
> Yi
>
>
> On Sun, Mar 29, 2020 at 8:31 PM Deval Bhamare <Deval.Bhamare at kau.se>
> wrote:
>
>> Hello again,
>>
>>
>>
>> Just don't want to overload with the information, but I wanted to mention
>> that, with the *pre-built docker image option*, I had a look a the
>> ./start-stratum-container.sh
>>
>>
>> Since I want to run Stratum with BSP, I made a change as:
>>
>>
>> ONLP_ARG="--env WITH_ONLP=false"
>>
>> Then I started the container 8.9.2-3.16.56-OpenNetworkLinux and it
>> executed the Stratum successfully. Stratum open bf-sde prompt.
>>
>>
>> *Also ss ouptput is: *
>>
>>
>> State      Recv-Q Send-Q          Local Address:Port
>>     Peer Address:Port
>>
>> LISTEN     0      128                         *:28000
>>                 *:*
>> users:(("stratum_bf_no_o",pid=10,fd=36))
>>
>> LISTEN     0      128                 127.0.0.1:28000
>>                 *:*
>> users:(("stratum_bf_no_o",pid=10,fd=35))
>>
>> LISTEN     0      128                 127.0.0.1:28003
>>                 *:*
>> users:(("stratum_bf_no_o",pid=10,fd=32))
>>
>> LISTEN     0      5                           *:9999
>>                 *:*
>> users:(("stratum_bf_no_o",pid=10,fd=27))
>>
>> I am getting following messages now:
>>
>>
>>  ONOS-CLI logs for the confirmation below:
>>
>>
>> tofino at root > devices
>>                               22:02:35
>>
>> id=device:tofino, *available=true*, local-status=connected 4m52s ago,
>> role=MASTER, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum,
>> serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf,
>> locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=1,
>> name=device:tofino, p4DeviceId=1, protocol=P4Runtime, gNMI, gNOI
>>
>> Logs on stratum bf-sde are:
>>
>>
>> bf-sde.lld> E0329 22:01:52.649449   249 PI-device_mgr.cpp:0] Reading
>> default entry not supported yet
>>
>> E0329 22:01:52.649509   249 pi_node.cc:187] Return Error:
>> toUtilStatus(status, details) failed with generic::unimplemented:
>>
>> E0329 22:01:52.649549   249 p4_service.cc:307] Failed to read forwarding
>> entries from node 1:
>>
>> ONOS Logs:
>>
>>
>> 2020-03-29T22:08:22,649 | WARN  | grpc-default-executor-4 |
>> P4RuntimeClientImpl              | 230 -
>> org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Error while
>> performing READ on device:tofino: UNIMPLEMENTED
>>
>>
>>
>> So, now ONOS can talk to Tofino through Stratum, but there are a few
>> errors. First of all, is it OK to explicitly use this option: "--env
>> WITH_ONLP=false" If yes, am I missing some steps here?  Any suggestion?
>>
>>
>>
>> (Note: If I use default value of ONLP_ARG as per the original script, I
>> get error as:
>>
>>
>> Use default flag file
>>
>> Cannot find /usr/local/lib/modules/bf_kdrv.ko, skip installing the Kernel
>> module
>>
>> /usr/local/bin/stratum_bf: symbol lookup error:
>> /usr/local/bin/stratum_bf: undefined symbol: onlp_sw_init
>> )
>>
>>
>>
>> Thank you,
>>
>>
>> Deval.
>>
>>
>> ------------------------------
>> *From:* Deval Bhamare
>> *Sent:* Sunday, March 29, 2020 12:20:10 PM
>> *To:* Maximilian Pudelko
>> *Cc:* Yi Tseng; stratum-dev at lists.stratumproject.org
>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>
>>
>> Hello Maximilian,
>>
>>
>> There is a littler confusion here. I am *not using pre-built
>> containerized version of Stratum*.
>>
>> However, I am locally *building it by starting a development container*
>> with command "*./setup_dev_env.sh  --pull -- -p 28000:28000*" (I have
>> mentioned it in the earlier image as well) as mentioned here:
>> https://github.com/stratum/stratum
>>
>> and then I try to build and run stratum as mentioned here:
>> https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md
>>
>>
>>
>> Now with the build-from-scratch using development container approach, I
>> followed your steps, however, when I run *ss -tnlp* from the container
>> (afterdocker exec -ti bash), I get below and listen on  127.0.0.1:28000
>> is *missing*. I get only below.
>>
>>
>>
>> tofino at 39e19c57ea27:/stratum$ ss -tlnp
>>
>> State       Recv-Q Send-Q     Local Address:Port                    Peer
>> Address:Port
>>
>> LISTEN      0      128            127.0.0.1:56929
>>       *:*                   users:(("java",pid=21,fd=110))
>>
>> LISTEN      0      1                      *:8008
>>       *:*                   users:(("stratum_bf",pid=310,fd=26))
>>
>> *Command to build Stratum is*: bazel build
>> //stratum/hal/bin/barefoot:stratum_bf --define phal_with_onlp=false
>> --define sde_ver=8.9.2
>>
>> *Command to run Stratum is*:
>>
>>      ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
>>        --external_stratum_urls=0.0.0.0:28000 \
>>        --grpc_max_recv_msg_size=256 \
>>        --bf_sde_install=$BF_SDE_INSTALL \
>>        --persistent_config_dir=/stratum/config/ \
>>
>>  --forwarding_pipeline_configs_file=/stratum/config/p4_pipeline.pb.txt \
>>        --chassis_config_file=/stratum/config/chassis_config.pb.txt \
>>        --write_req_log_file=/stratum/config/p4_writes.pb.txt \
>>        --bf_sim
>>
>>
>>
>>
>> [*Note*: I had also tried the option of using pre-built docker
>> container, with 8.9.1-3.16.56-OpenNetworkLinux, however, in this case I get
>> error:
>>
>> Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json
>>
>> I had reported that also and tried new container but didn't work]
>>
>> Thanks,
>>
>> Deval.
>>
>>
>> ------------------------------
>> *From:* Maximilian Pudelko <max at opennetworking.org>
>> *Sent:* Sunday, March 29, 2020 1:46:04 AM
>> *To:* Deval Bhamare
>> *Cc:* Yi Tseng; stratum-dev at lists.stratumproject.org; Andreas Kassler
>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>
>> Hi Deval,
>>
>> There are many things going on in your setup, let's do this step by step:
>>
>> 1. Port 8008 is NOT what you want for ONOS. I'm no Tofino expert, but
>> this seems to be a separate endpoint for something else (debugging?). We
>> always use port 28000.
>>
>> 2. *2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init
>> failed  #<<< CAN IT BE THE ISSUE?*
>> Depends. It's probably not good, but as long as you see this line in the
>> Stratum logs, ONOS should be able to connect:
>> E0328 23:08:15.903065    13 hal.cc:234] Stratum external facing services
>> are listening to 0.0.0.0:28000, localhost:28000...
>> Judging from the missing listening port, I'd say this could be the issue.
>>
>> 3. If you run ONOS in a container too, they have to reside in the same
>> network and you have to figure out the docker-internal IP for the Stratum
>> container:
>> # docker network ls
>> NETWORK ID          NAME                DRIVER              SCOPE
>> e737dd0dd90f        bridge              bridge              local
>> d2783152be24        host                host                local
>> 7028e832e130        none                null                local
>>
>> # docker network inspect bridge
>> [...]
>> "Containers": {
>>
>> "518c901167919d34205959f1105aedebbb99a9452d191409ccf71a3908e14e56": {
>>                 "Name": "zen_jennings",
>>                 "EndpointID":
>> "a52025a671c9968372c52c7ed6b61df5a3168493466bd4b831c4728089b77163",
>>                 "MacAddress": "02:42:ac:11:00:02",
>>                 "IPv4Address": "172.17.0.2/16",
>>                 "IPv6Address": ""
>>             }
>>         },
>> [...]
>>
>> You could also try running them in the host network (--network=host),
>> that should make them behave like native processes with fully exposed
>> networking.
>>
>> 4. I used a wrong switch in my previous post, here's how it looks on a
>> Tofino:
>>
>>    -  ./start-stratum-container.sh (let it run and open new terminal tab)
>>    - docker container ls
>>    CONTAINER ID        IMAGE
>>             COMMAND                  CREATED             STATUS
>>     PORTS                      NAMES
>>    518c90116791
>>     stratumproject/stratum-bf:9.1.0-4.14.49-OpenNetworkLinux   "/bin/sh -c
>>    /stratum…"   12 minutes ago      Up 12 minutes       0.0.0.0:28000
>>    ->28000/tcp   zen_jennings
>>    - ss -ltnp
>>    LISTEN      0      128                    :::28000
>>               :::*                   users:(("docker-proxy",pid=1179,fd=4))
>>    - docker exec -ti 518c90116791 bash (switch into the Stratum
>>    container)
>>    - apt update && apt install iproute
>>    - ss -tlnp
>>    State       Recv-Q Send-Q      Local Address:Port
>>    Peer Address:Port
>>    LISTEN      0      5                       *:9999
>>               *:*                   users:(("stratum_bf",pid=13,fd=27))
>>    LISTEN      0      128                     *:28000
>>                *:*                   users:(("stratum_bf",pid=13,fd=40))
>>    LISTEN      0      128             127.0.0.1:28000
>>                *:*                   users:(("stratum_bf",pid=13,fd=39))
>>    LISTEN      0      1                       *:9001
>>               *:*                   users:(("stratum_bf",pid=13,fd=28))
>>    - exit (leave container)
>>    - docker run -ti debian:9 bash (Start new container to simulate ONOS)
>>    - apt update && apt install netcat
>>    - nc -v 172.17.0.2 28000
>>    172.17.0.2: inverse host lookup failed: Unknown host
>>    (UNKNOWN) [172.17.0.2] 28000 (?) open
>>
>>
>> For reference, the used versions:
>>
>> # docker images
>> REPOSITORY                  TAG                              IMAGE ID
>>        CREATED             SIZE
>> stratumproject/stratum-bf   9.1.0-4.14.49-OpenNetworkLinux   e4615d64018f
>>        2 weeks ago         214MB
>>
>> For reference, these are the versions we use:
>> # docker version
>> Client: Docker Engine - Community
>>  Version:           19.03.2
>>  API version:       1.40
>>  Go version:        go1.12.8
>>  Git commit:        6a30dfca03
>>  Built:             Thu Aug 29 05:29:49 2019
>>  OS/Arch:           linux/amd64
>>  Experimental:      false
>>
>> Server: Docker Engine - Community
>>  Engine:
>>   Version:          19.03.2
>>   API version:      1.40 (minimum version 1.12)
>>   Go version:       go1.12.8
>>   Git commit:       6a30dfca03
>>   Built:            Thu Aug 29 05:28:23 2019
>>   OS/Arch:          linux/amd64
>>   Experimental:     false
>>  containerd:
>>   Version:          1.2.6
>>   GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
>>  runc:
>>   Version:          1.0.0-rc8
>>   GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
>>  docker-init:
>>   Version:          0.18.0
>>   GitCommit:        fec3683
>>
>> # uname -a
>> Linux Stordis 4.14.49-OpenNetworkLinux #1 SMP Thu Jul 18 08:52:25 UTC
>> 2019 x86_64 GNU/Linux
>>
>>
>> Max
>>
>> On Sat, Mar 28, 2020 at 7:31 AM Deval Bhamare <Deval.Bhamare at kau.se>
>> wrote:
>>
>>> Hello again,
>>>
>>>
>>> Since I could not any port activity on 28000 inside stratum and stratum
>>> logs shown only listen activity on *8008*, I used following command to
>>> do explicitly map the IP/ports to host:
>>>
>>>
>>> *./setup_dev_env.sh  --pull --  -p 192.168.60.131:28008
>>> <http://192.168.60.131:28008>:8008*
>>>
>>>
>>> Then I tried to push the netcfg.json with following URL and this time
>>> the communication channel is established. Logs from ONOS and stratum are
>>> below (BOLD RED).
>>>
>>>
>>> *URL*:
>>>
>>>
>>> *"managementAddress": "grpc://192.168.60.131:28008?device_id=0
>>> <http://192.168.60.131:28008?device_id=0>",*
>>>
>>> (I tired both deviceID 0 and 1, but it must be 0 as bf_shell and stratum
>>> Log both confirm: )
>>>
>>>
>>>
>>> *ONOS*:
>>>
>>>
>>> 2020-03-28T13:49:46,158 | WARN  | onos-gdp-0       | PiPipeconfManager
>>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
>>> Ignoring PortStatisticsDiscovery behaviour from pipeconf vepg-pipeconf, but
>>> using the one provided by stratum-tofino driver...
>>>
>>> 2020-03-28T13:49:46,184 | INFO  | onos-gdp-0       |
>>> GrpcChannelControllerImpl        | 230 -
>>> org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | *Creating
>>> new gRPC channel grpc://192.168.60.131:28008?device_id=0.
>>> <http://192.168.60.131:28008?device_id=0.>.. << #THERE IS SUCCESS HERE THIS
>>> TIME AS COMPARED TO PREVIOUS TIME *
>>>
>>> *Stratum*:
>>>
>>>
>>> *Tcl server: connection accepted on port 8008*
>>>
>>> *Partial recv: 30 of 40 so far..  <<#STRATUM CONFIRMS IT*
>>>
>>>
>>> However, I am not sure, it is the correct entry point? The reason is
>>> ONOS still cannot find the device:tofino (highlighted Yellow RED)
>>>
>>>
>>> 2020-03-28T13:49:46,306 | INFO  | onos-gdp-0       | DeviceManager
>>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
>>> Local role is MASTER for device:tofino
>>>
>>> 2020-03-28T13:49:46,311 | WARN  | onos-event-dispatch-default0 |
>>> ModelCache                       | 211 -
>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>> device:tofino not found as a UiDevice
>>>
>>> 2020-03-28T13:49:46,313 | INFO  | onos-gdp-0       |
>>> GeneralDeviceProvider            | 235 -
>>> org.onosproject.onos-providers-general-device - 2.4.0.SNAPSHOT | Notifying
>>> role MASTER (preference 0) for term 1 to device:tofino
>>>
>>> 2020-03-28T13:49:46,315 | WARN  | onos-event-dispatch-default0 |
>>> ModelCache                       | 211 -
>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | *DeviceID
>>> device:tofino not found as a UiDevice*
>>>
>>> 2020-03-28T13:49:46,316 | WARN  | onos-device-manager-background |
>>> DeviceManager                    | 193 - org.onosproject.onos-core-net
>>> - 2.4.0.SNAPSHOT | *Node was instructed to be MASTER role for
>>> device:tofino, but this node cannot reach the device.*  Relinquishing
>>> role.    *<<#STILL NO DEVICE FOUND. I TRIED BOTH ID 0 and 1 in the URL *
>>>
>>> 2020-03-28T13:49:46,317 | INFO  | onos-gdp-0       | StreamClientImpl
>>>               | 237 - org.onosproject.onos-protocols-p4runtime-ctl -
>>> 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true,
>>> newElectionId=20, masterElectionId=null, sessionOpen=false
>>>
>>> 2020-03-28T13:49:46,320 | WARN  | onos-event-dispatch-default0 |
>>> ModelCache                       | 211 -
>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>> device:tofino not found as a UiDevice
>>>
>>> 2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 |
>>> ModelCache                       | 211 -
>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>> device:tofino not found as a UiDevice
>>>
>>> 2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 |
>>> ModelCache                       | 211 -
>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>> device:tofino not found as a UiDevice
>>>
>>> 2020-03-28T13:49:46,336 | INFO  | onos-topo-build-1 | TopologyManager
>>>                 | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT
>>> | Topology DefaultTopology{time=12233603415182, creationTime=1585403386336,
>>> computeCost=124274, clusters=0, devices=0, links=0} changed
>>>
>>> 2020-03-28T13:49:46,365 | INFO  | onos-gdp-0       | DeviceManager
>>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
>>> Device device:tofino registered
>>>
>>>
>>>
>>>
>>> Please confirm, is it in the right direction or port 8008 is completely
>>> different? What can be the reason for device:tofino not able to find?
>>>
>>>
>>> Thank you,
>>>
>>> Deval.
>>>
>>>
>>> ------------------------------
>>> *From:* stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on
>>> behalf of Deval Bhamare via stratum-dev <
>>> stratum-dev at lists.stratumproject.org>
>>> *Sent:* Saturday, March 28, 2020 3:22:16 PM
>>> *To:* Maximilian Pudelko
>>> *Cc:* stratum-dev at lists.stratumproject.org
>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>
>>>
>>> Hello Maximilian,
>>>
>>>
>>> Thank you for your reply and the useful suggestions. So as a first step
>>> I executed on switch ss -tnlp and below is the output. Surprisingly, there
>>> is *no Stratum anywhere there, however statrum is also running in a
>>> container* and the short logs are displayed below. I also executed ss
>>> command inside the container and those are also pasted below, if that may
>>> help.
>>>
>>>
>>> ss -tnlp outputs in different times are as follows:
>>>
>>>
>>> *- from tofino, before anything is started:*
>>>
>>>
>>> tofino at localhost:~$ ss -tnlp
>>>
>>> State      Recv-Q Send-Q                        Local Address:Port
>>>                     Peer Address:Port
>>>
>>> LISTEN     0      128                                       *:17
>>>                                 *:*
>>>
>>> LISTEN     0      128                                       *:22
>>>                                 *:*
>>>
>>> LISTEN     0      128                                       *:23
>>>                                 *:*
>>>
>>> LISTEN     0      128                          192.168.60.131:10010
>>>                                 *:*
>>>
>>> LISTEN     0      128                                      :::22
>>>                               :::*
>>>
>>>
>>> *- from tofino after stratum container is started*
>>>
>>>
>>> tofino at localhost:~$ ss -tnlp
>>>
>>> State      Recv-Q Send-Q                        Local Address:Port
>>>                     Peer Address:Port
>>>
>>> LISTEN     0      128                                       *:17
>>>                                 *:*
>>>
>>> LISTEN     0      128                                       *:22
>>>                                 *:*
>>>
>>> LISTEN     0      128                                       *:23
>>>                                 *:*
>>>
>>> LISTEN     0      128                          192.168.60.131:10010
>>>                                 *:*
>>>
>>> LISTEN     0      128                                      :::22
>>>                               :::*
>>>
>>> LISTEN     0      *128                                      :::28000 *
>>>                                 :::*
>>>
>>>
>>> *- from tofino after stratum is running *
>>>
>>>
>>> tofino at localhost:~$ ss -tnlp
>>>
>>> State      Recv-Q Send-Q                        Local Address:Port
>>>                     Peer Address:Port
>>>
>>> LISTEN     0      128                                       *:17
>>>                                 *:*
>>>
>>> LISTEN     0      128                                       *:22
>>>                                 *:*
>>>
>>> LISTEN     0      128                                       *:23
>>>                                 *:*
>>>
>>> LISTEN     0      128                          192.168.60.131:10010
>>>                                 *:*
>>>
>>> LISTEN     0      128                                      :::22
>>>                               :::*
>>>
>>> LISTEN     0      128                                      :::28000
>>>                               :::*
>>>
>>>
>>> *- from stratum container, after running it in background *
>>>
>>>
>>> tofino at ced0c4d7ef8f:/stratum$ ss -tnlp
>>>
>>> State      Recv-Q Send-Q Local Address:Port                Peer
>>> Address:Port
>>>
>>> LISTEN     *0      1                  *:8008
>>> *:*                   users:(("stratum_bf",pid=323,fd=26)) << #IS this
>>> useful? *
>>>
>>> LISTEN     0      128        127.0.0.1:41418                          *:*
>>>                   users:(("java",pid=21,fd=110))
>>>
>>> Why there is no 28000 port here in Stratum container SS output. Or
>>> should I bind 8008 to 28000 on switch?
>>>
>>> As you have mentioned, I have already taken care of port mapping. So I
>>> run the container with -p28000:2000. It is verified in the outputs above as
>>> well.
>>>
>>>
>>> *- Docker output on switch *
>>>
>>>
>>> tofino at localhost:~$ docker ps
>>>
>>> CONTAINER ID        IMAGE               COMMAND             CREATED
>>>         STATUS              PORTS                      NAMES
>>>
>>> ced0c4d7ef8f        stratum-dev         "bash"              16 minutes
>>> ago      Up 16 minutes       *0.0.0.0:28000->28000/tcp*   goofy_hamilton
>>>
>>>
>>> *- Stratum log output after it started. *
>>>
>>>
>>> bf_sysfs_fname /sys/class/bf/bf0/device/dev_add
>>>
>>> Install dir: /stratum/bf-sde-8.9.0/install (0x7f876b794b60)
>>>
>>> bf_switchd: system services initialized
>>>
>>> bf_switchd: loading conf_file
>>> stratum/hal/bin/barefoot/tofino_skip_p4.conf...
>>>
>>> bf_switchd: processing device configuration...
>>>
>>> Configuration for dev_id 0
>>>
>>>   Family        : Tofino
>>>
>>>   pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0
>>>
>>>   pci_domain    : 0
>>>
>>>   pci_bus       : 5
>>>
>>>   pci_fn        : 0
>>>
>>>   pci_dev       : 0
>>>
>>>   pci_int_mode  : 1
>>>
>>>   sbus_master_fw: /stratum/bf-sde-8.9.0/install/
>>>
>>>   pcie_fw       : /stratum/bf-sde-8.9.0/install/
>>>
>>>   serdes_fw     : /stratum/bf-sde-8.9.0/install/
>>>
>>>   sds_fw_path   : /stratum/bf-sde-8.9.0/install/
>>>
>>>   microp_fw_path:
>>>
>>> bf_switchd: processing P4 configuration...
>>>
>>> P4 profile for dev_id 0
>>>
>>>   p4_name: dummy
>>>
>>>     libpd:
>>>
>>>     libpdthrift:
>>>
>>>     context:
>>>
>>>     config:
>>>
>>>   Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
>>>
>>>   diag:
>>>
>>>   mavericks diag:
>>>
>>>   non_default_port_ppgs: 0
>>>
>>>   SAI default initialize: 1
>>>
>>> bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
>>> loaded
>>>
>>> bf_switchd: agent[0] initialized
>>>
>>> Tcl server started..
>>>
>>> Tcl server: listen socket created
>>>
>>> Tcl server: bind done on port 8008, listening...
>>>
>>> Tcl server: waiting for incoming connections...
>>>
>>> sh: 1: onie-syseeprom: not found
>>>
>>> *2020-03-28 13:06:53.584090 BF_PLTFM ERROR - Error in cp2112
>>> initialization*
>>>
>>>
>>> *2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init
>>> failed  #<<< CAN IT BE THE ISSUE?*
>>>
>>>
>>> Thank you.
>>>
>>> Deval
>>>
>>>
>>> ------------------------------
>>> *From:* Maximilian Pudelko <max at opennetworking.org>
>>> *Sent:* Saturday, March 28, 2020 3:43:29 AM
>>> *To:* Deval Bhamare
>>> *Cc:* Yi Tseng; stratum-dev at lists.stratumproject.org
>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>
>>> Hi Deval,
>>>
>>> can you run this command on the switch: ss -tlnp
>>> Should output something like this:
>>> State      Recv-Q Send-Q      Local Address:Port
>>> Peer Address:Port
>>> LISTEN     0      128                     *:22
>>>        *:*                   users:(("sshd",pid=4116,fd=3))
>>> LISTEN     0      128                    :::22
>>>       :::*                   users:(("sshd",pid=4116,fd=4))
>>> LISTEN     0      128      ::ffff:127.0.0.1:28000
>>>        :::*                   users:(("stratum_bcm",pid=26872,fd=19))
>>> LISTEN     0      128                    :::28001
>>>        :::*                   users:(("stratum_bcm",pid=26872,fd=20))
>>> LISTEN     0      128      ::ffff:127.0.0.1:28003
>>>        :::*                   users:(("stratum_bcm",pid=26872,fd=6))
>>>
>>> Also, do you have any logs from Stratum? Run with -v=1
>>> -stderrthreshold=0
>>>
>>> Since you're using docker, I assume there is some issue with port
>>> forwarding/mapping. Follow these steps to check the port mapping:
>>> https://docs.docker.com/engine/reference/commandline/port/
>>> And these steps to fix it:
>>>
>>> https://stackoverflow.com/questions/22111060/what-is-the-difference-between-expose-and-publish-in-docker
>>>
>>> https://docs.docker.com/config/containers/container-networking/#published-ports
>>>
>>> Max
>>>
>>>
>>> On Thu, Mar 26, 2020 at 3:53 PM Deval Bhamare via stratum-dev <
>>> stratum-dev at lists.stratumproject.org> wrote:
>>>
>>>> Hello Yi,
>>>>
>>>>
>>>> I am running both ONOS and stratum container on the same machine, that
>>>> is the tofino switch with public IP 192.168.60.131.
>>>>
>>>>
>>>> So I tried with grpc://192.168.60.131:28000?device_id=1
>>>> <http://192.168.0.101:28000/?device_id=1>", as well now. This time
>>>> message is connection refused and still no connectivity.
>>>>
>>>>
>>>>
>>>>
>>>> 2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background |
>>>> DeviceManager                    | 193 - org.onosproject.onos-core-net
>>>> - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino,
>>>> but this node cannot reach the device.  Relinquishing role.
>>>>
>>>> 2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       | StreamClientImpl
>>>>               | 237 - org.onosproject.onos-protocols-p4runtime-ctl -
>>>> 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true,
>>>> newElectionId=20, masterElectionId=null, sessionOpen=false
>>>>
>>>> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
>>>> ModelCache                       | 211 -
>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>> device:tofino not found as a UiDevice
>>>>
>>>> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
>>>> ModelCache                       | 211 -
>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>> device:tofino not found as a UiDevice
>>>>
>>>> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
>>>> ModelCache                       | 211 -
>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>> device:tofino not found as a UiDevice
>>>>
>>>> 2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager
>>>>                 | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT
>>>> | Topology DefaultTopology{time=2264511977012, creationTime=1585262479736,
>>>> computeCost=117691, clusters=0, devices=0, links=0} changed
>>>>
>>>> 2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager
>>>>                 | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT
>>>> | Device device:tofino registered
>>>>
>>>> 2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 |
>>>> StreamClientImpl                 | 237 -
>>>> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | *device:tofino
>>>> is unreachable (Connection refused: /192.168.60.131:28000
>>>> <http://192.168.60.131:28000>)*
>>>>
>>>> 2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager
>>>>                 | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT
>>>> | Topology DefaultTopology{time=2264549921343, creationTime=1585262479774,
>>>> computeCost=101378, clusters=0, devices=0, links=0} changed
>>>>
>>>> With grpc://127.0.0.1:28000?device_id=1
>>>> <http://192.168.0.101:28000/?device_id=1>", the error is
>>>>
>>>>
>>>> *onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on
>>>> StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for
>>>> unknown reason*
>>>>
>>>> Also Stratum logs say
>>>>
>>>>
>>>> bf_switchd: processing P4 configuration...
>>>>
>>>> *P4 profile for dev_id 0*
>>>>
>>>>
>>>> while starting, so I doubt device ID maybe 0 and hence tried with both
>>>> device_id=1 <http://192.168.0.101:28000/?device_id=1> and device_id=
>>>> <http://192.168.0.101:28000/?device_id=1>0 but no luck.
>>>>
>>>>
>>>>
>>>> Thanks,
>>>>
>>>>
>>>> Deval.
>>>> ------------------------------
>>>> *From:* Yi Tseng <yi at opennetworking.org>
>>>> *Sent:* Thursday, March 26, 2020 9:10:49 PM
>>>> *To:* Deval Bhamare
>>>> *Cc:* stratum-dev at lists.stratumproject.org
>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>
>>>> Hi Deval,
>>>>
>>>> Where you are running the ONOS controller? If you are running the ONOS
>>>> controller on a server, you need to set the management address to your
>>>> switch IP address.
>>>>
>>>> For example, you run the ONOS on a server with IP address 192.168.0.100
>>>> and running the Stratum on a switch with IP address 192.168.0.101. (And I
>>>> assume that you have connectivity between the server and the switch)
>>>>
>>>> The netcfg.json will look like:
>>>>
>>>> {
>>>>   "devices": {
>>>>     "device:tofino": {
>>>>       "basic": {
>>>>         "managementAddress": "grpc://192.168.0.101:28000?device_id=1",
>>>>         "driver": "stratum-tofino",
>>>>         "pipeconf": "[your pipeconf name]"
>>>>        }
>>>>     }
>>>>    }
>>>> }
>>>>
>>>> Please also note that the device ID is 1 in the Stratum
>>>>
>>>> Yi
>>>>
>>>>
>>>> On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se>
>>>> wrote:
>>>>
>>>>> Hello Yi,
>>>>>
>>>>>
>>>>> We have received a reply from Stordis and as per their suggestion, we
>>>>> can ignore the syseeprom error
>>>>>
>>>>>
>>>>> *You see only syseeprom errorr please ignore that :*
>>>>> *Tcl server: listen socket created*
>>>>> *Tcl server: bind done on port 8008, listening...*
>>>>> *Tcl server: waiting for incoming connections...*
>>>>> *sh: 1: onie-syseeprom: not found <Ignore this error>*
>>>>> *Health monitor started *
>>>>> *Operational mode set to ASIC*
>>>>>
>>>>>
>>>>> So, now when I try to push the netcfg.json for our device to Onos, I
>>>>> get following message:
>>>>>
>>>>>
>>>>> 2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl
>>>>>               | 237 - org.onosproject.onos-protocols-p4runtime-ctl -
>>>>> 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true,
>>>>> newElectionId=20, masterElectionId=null, sessionOpen=false
>>>>>
>>>>> 2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 |
>>>>> ModelCache                       | 211 -
>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>> device:tofino not found as a UiDevice
>>>>>
>>>>> 2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 |
>>>>> ModelCache                       | 211 -
>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>> device:tofino not found as a UiDevice
>>>>>
>>>>> 2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 |
>>>>> ModelCache                       | 211 -
>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>> device:tofino not found as a UiDevice
>>>>>
>>>>> 2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager
>>>>>                 | 193 - org.onosproject.onos-core-net -
>>>>> 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452353961040,
>>>>> creationTime=1585173541276, computeCost=427068, clusters=0, devices=0,
>>>>> links=0} changed
>>>>>
>>>>> 2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager
>>>>>                 | 193 - org.onosproject.onos-core-net -
>>>>> 2.4.0.SNAPSHOT |* Device device:tofino registered*
>>>>>
>>>>> 2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 |
>>>>> StreamClientImpl                 | 237 -
>>>>> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT |*
>>>>> Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed
>>>>> for unknown reason*
>>>>>
>>>>> 2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager
>>>>>                 | 193 - org.onosproject.onos-core-net -
>>>>> 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452397561034,
>>>>> creationTime=1585173541319, computeCost=112832, clusters=0, devices=0,
>>>>> links=0} changed
>>>>>
>>>>>
>>>>>
>>>>> ONOS CLI show, device available=false.
>>>>>
>>>>>
>>>>> tofino at root > devices
>>>>>         21:58:49
>>>>>
>>>>> id=device:tofino, *available=false*, local-status=disconnected 37s
>>>>> ago, role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum,
>>>>> serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf,
>>>>> locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0,
>>>>> name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI
>>>>>
>>>>>
>>>>> Netcfg.json contents are:
>>>>>
>>>>> {
>>>>> "devices": {
>>>>> "device:tofino": {
>>>>> "basic": {
>>>>> "managementAddress": "grpc://127.0.0.1?device_id=0",
>>>>> "driver": "stratum-tofino",
>>>>> "pipeconf": "vepg-pipeconf"
>>>>> }
>>>>> }
>>>>> }
>>>>> }
>>>>>
>>>>> Command is:
>>>>>
>>>>>
>>>>> curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H
>>>>> 'Content-Type:application/json' '
>>>>> http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json
>>>>>
>>>>>
>>>>>
>>>>> Any idea what may be the issue?
>>>>>
>>>>>
>>>>> Thanks,
>>>>>
>>>>> Deval.
>>>>>
>>>>>
>>>>> ------------------------------
>>>>> *From:* Yi Tseng <yi at opennetworking.org>
>>>>> *Sent:* Tuesday, March 24, 2020 3:25:06 PM
>>>>> *To:* Deval Bhamare
>>>>> *Cc:* stratum-dev at lists.stratumproject.org
>>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>>
>>>>> Hi Deval,
>>>>>
>>>>> I am now working on updating the script to support the custom platform
>>>>> parameter <https://github.com/stratum/stratum/pull/150> since the
>>>>> Stratum cannot detect the platform without the ONLP.
>>>>>
>>>>> Should be merged soon.
>>>>>
>>>>> On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se>
>>>>> wrote:
>>>>>
>>>>>> Hello Yi,
>>>>>>
>>>>>>
>>>>>> I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux,
>>>>>> however, the error still persists:
>>>>>>
>>>>>>
>>>>>> + KERNEL_VERSION=3.16.64-OpenNetworkLinux
>>>>>>
>>>>>> + DOCKER_IMAGE=stratumproject/stratum-bf
>>>>>>
>>>>>> + DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux
>>>>>>
>>>>>> ++ uname -r
>>>>>>
>>>>>> ++ uname -r
>>>>>>
>>>>>> + docker run -it --privileged -v /dev:/dev -v /sys:/sys -v
>>>>>> /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux
>>>>>> -v
>>>>>> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so
>>>>>> -v
>>>>>> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1
>>>>>> -v
>>>>>> /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so
>>>>>> -v
>>>>>> /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1
>>>>>> -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v
>>>>>> /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v
>>>>>> /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p
>>>>>> 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs
>>>>>> stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux
>>>>>>
>>>>>> *Use default flag file*
>>>>>>
>>>>>> *Cannot find
>>>>>> /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json*
>>>>>>
>>>>>>
>>>>>> I also had peek at the script *start-stratum-container.sh* and found
>>>>>> an option of *ONLP_ARG="--env WITH_ONLP=false"*
>>>>>> . So I wanted to ask whether I can set this option with Docker to
>>>>>> force BSP usage, let us say, by hard-coding it in the script itself (also
>>>>>> similar approach to set PORT_MAP in *stratume_entrypoint.sh*). I
>>>>>> tried this and the error message in this case is:
>>>>>>
>>>>>>
>>>>>> *Use default flag file*
>>>>>>
>>>>>> *Cannot find /usr/local/share/stratum/.json *
>>>>>>
>>>>>> Please suggest.
>>>>>>
>>>>>> Thanks,
>>>>>> Deval.
>>>>>>
>>>>>> ------------------------------
>>>>>> *From:* Yi Tseng <yi at opennetworking.org>
>>>>>> *Sent:* Thursday, March 12, 2020 6:57 AM
>>>>>> *To:* Deval Bhamare
>>>>>> *Cc:* Narada Hess; stratum-dev at lists.stratumproject.org
>>>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>>>
>>>>>> Hi Deval,
>>>>>>
>>>>>> We don't support Barefoot thrift APIs in Stratum. We support some
>>>>>> Barefoot API like port API via gNMI and the chassis config.
>>>>>>
>>>>>> For missing JSON file, I can confirm that our internal CI did not
>>>>>> include the latest Stratum with kernel 3.16.56
>>>>>>
>>>>>> I just rebuild it and uploaded the new container image to the Docker
>>>>>> hub
>>>>>> <https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>,
>>>>>> feel free to let me know if the issue still exists.
>>>>>>
>>>>>> About the missing library, can you run this command in your shell?
>>>>>>
>>>>>> *LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd
>>>>>> ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf*
>>>>>>
>>>>>> I think the system linker may have some issue to find the library.
>>>>>>
>>>>>> The *libavago.so.0 *is a symbolic link to *libavago.so*. the
>>>>>> libavago.so must also exists.
>>>>>>
>>>>>>
>>>>>>
>>>>>> *ls -al $BF_SDE_INSTALL/lib/libavago* -rwxr-xr-x 1 root root 1185264
>>>>>> Mar 12 04:19 libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>>>>>> libavago.so.0 -> libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>>>>>> libavago.so.0.0.0 -> libavago.so*
>>>>>>
>>>>>>
>>>>>>
>>>>>
>>>>> --
>>>>> Yi Tseng
>>>>> Member of Technical Staff
>>>>> Open Networking Foundation
>>>>> https://www.opennetworking.org/
>>>>>
>>>>
>>>>
>>>> --
>>>> Yi Tseng
>>>> Member of Technical Staff
>>>> Open Networking Foundation
>>>> https://www.opennetworking.org/
>>>> _______________________________________________
>>>> stratum-dev mailing list
>>>> stratum-dev at lists.stratumproject.org
>>>> https://lists.stratumproject.org/listinfo/stratum-dev
>>>
>>>
>
> --
> Yi Tseng
> Member of Technical Staff
> Open Networking Foundation
> https://www.opennetworking.org/
>


-- 
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200402/be4526a6/attachment-0001.html>

From Deval.Bhamare at kau.se  Thu Apr  2 14:02:33 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Thu, 2 Apr 2020 14:02:33 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR26WzkbQJHqvXZa=_o58HQ-L_K6n-ajQjKSv4WssMK1dw@mail.gmail.com>
References: <4497e28827f44eebbab214abfb0d0cfa@kau.se>,
 <CAOyFVR26WzkbQJHqvXZa=_o58HQ-L_K6n-ajQjKSv4WssMK1dw@mail.gmail.com>
Message-ID: <3856b2a527cd4c5fa07263f9ff9c4c24@kau.se>

Hello Yi,


yes, we have been also able to run stratum with BF-SDE 8.9.0 and BSP local build and the communication is successful.


A few extra steps such as setting up the environment are needed though.


Thank you,

Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Thursday, April 2, 2020 2:02:40 PM
To: Deval Bhamare
Cc: max at opennetworking.org; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

The Stratum container image does not include the BSP library from each vendor since the origin goal is to use a general open-source platform library from ONL.

The current way to support Stratum + BSP is to build the SDE, BSP, and Stratum on the switch (you can also build it on the server and copy every necessary libraries and files to the switch). Also, I believed that you can build everything(SDE, BSP, Stratum) on a Ubuntu-based switch and run it.

I've tested to build SDE, BSP, and Stratum on out BF2556X and I can confirm that ONOS can connect to the Stratum.
Currently, we are using ONL-based OS in our lab. I can try re-installed the switch to Ubuntu-based once I can access the hardware.

Yi


On Mon, Mar 30, 2020 at 8:25 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,


So as per my understanding, when we use pre-built docker version of the Stratum, it doesn't refer to local locally built BSP and BF-SDE. Instead it uses its own pre-build BF-SDE and BSP. Is it correct?


In that case, with reference to the email from Stordis-support below, I would like to confirm that below point have been taken care of while building the updated docker image.


Stordis_support message:


"It is important that you build the BSP with the --with-tof-brgup-plat option that you can also pass through the p4studio_build script (see installation guide). Be sure to spell it correctly, or else p4studio_build will silently ignore the option and build the BSP incorrectly… (there will be just a log entry in the installation log saying that the option was unknown)

Note too that there was a problem in the BSP zip file that is available on our FTP server – the bf-platforms.tgz in the packages directory was actually the reference BSP version. If you had used this tgz (instead of the bf-platforms directory that is present in the directory above), the BSP would have been built incorrectly too. In the meantime I have uploaded a corrected version of the zip file to our FTP server."



Can you please confirm?


Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Monday, March 30, 2020 7:32:05 AM
To: Deval Bhamare
Cc: max at opennetworking.org<mailto:max at opennetworking.org>; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We've updated the container image and the script to start the container:
https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/start-stratum-container.sh

You can now try the following command to start the Stratum container with no ONLP support:
PLATFORM=x86-64-stordis-bf2556x-1t-r0 SDE_VERSION=8.9.2 ./start-stratum-container.sh

For the "unimplemented" message you saw, the SDE 8.9.2 uses old version PI library which doesn't implement some features (reading default entry from a table).
You can ignore that warning or use a newer version of Stratum (with SDE >= 9.0.0)

Yi


On Sun, Mar 29, 2020 at 8:31 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,



Just don't want to overload with the information, but I wanted to mention that, with the pre-built docker image option, I had a look a the ./start-stratum-container.sh


Since I want to run Stratum with BSP, I made a change as:


ONLP_ARG="--env WITH_ONLP=false"


Then I started the container 8.9.2-3.16.56-OpenNetworkLinux and it executed the Stratum successfully. Stratum open bf-sde prompt.


Also ss ouptput is:


State      Recv-Q Send-Q          Local Address:Port                         Peer Address:Port

LISTEN     0      128                         *:28000                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=36))

LISTEN     0      128                 127.0.0.1:28000<http://127.0.0.1:28000>                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=35))

LISTEN     0      128                 127.0.0.1:28003<http://127.0.0.1:28003>                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=32))

LISTEN     0      5                           *:9999                                    *:*                   users:(("stratum_bf_no_o",pid=10,fd=27))


I am getting following messages now:


 ONOS-CLI logs for the confirmation below:


tofino at root > devices                                                                                 22:02:35

id=device:tofino, available=true, local-status=connected 4m52s ago, role=MASTER, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=1<http://127.0.0.1:28000?device_id=1>, name=device:tofino, p4DeviceId=1, protocol=P4Runtime, gNMI, gNOI


Logs on stratum bf-sde are:


bf-sde.lld> E0329 22:01:52.649449   249 PI-device_mgr.cpp:0] Reading default entry not supported yet

E0329 22:01:52.649509   249 pi_node.cc:187] Return Error: toUtilStatus(status, details) failed with generic::unimplemented:

E0329 22:01:52.649549   249 p4_service.cc:307] Failed to read forwarding entries from node 1:


ONOS Logs:


2020-03-29T22:08:22,649 | WARN  | grpc-default-executor-4 | P4RuntimeClientImpl              | 230 - org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Error while performing READ on device:tofino: UNIMPLEMENTED



So, now ONOS can talk to Tofino through Stratum, but there are a few errors. First of all, is it OK to explicitly use this option: "--env WITH_ONLP=false" If yes, am I missing some steps here?  Any suggestion?



(Note: If I use default value of ONLP_ARG as per the original script, I get error as:


Use default flag file

Cannot find /usr/local/lib/modules/bf_kdrv.ko, skip installing the Kernel module

/usr/local/bin/stratum_bf: symbol lookup error: /usr/local/bin/stratum_bf: undefined symbol: onlp_sw_init

)



Thank you,


Deval.


________________________________
From: Deval Bhamare
Sent: Sunday, March 29, 2020 12:20:10 PM
To: Maximilian Pudelko
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Maximilian,


There is a littler confusion here. I am not using pre-built containerized version of Stratum.

However, I am locally building it by starting a development container with command "./setup_dev_env.sh  --pull -- -p 28000:28000" (I have mentioned it in the earlier image as well) as mentioned here: https://github.com/stratum/stratum

and then I try to build and run stratum as mentioned here: https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md



Now with the build-from-scratch using development container approach, I followed your steps, however, when I run ss -tnlp from the container (afterdocker exec -ti bash), I get below and listen on  127.0.0.1:28000<http://127.0.0.1:28000> is missing. I get only below.



tofino at 39e19c57ea27:/stratum$ ss -tlnp

State       Recv-Q Send-Q     Local Address:Port                    Peer Address:Port

LISTEN      0      128            127.0.0.1:56929<http://127.0.0.1:56929>                              *:*                   users:(("java",pid=21,fd=110))

LISTEN      0      1                      *:8008                               *:*                   users:(("stratum_bf",pid=310,fd=26))

Command to build Stratum is: bazel build //stratum/hal/bin/barefoot:stratum_bf --define phal_with_onlp=false --define sde_ver=8.9.2

Command to run Stratum is:

     ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
       --external_stratum_urls=0.0.0.0:28000<http://0.0.0.0:28000> \
       --grpc_max_recv_msg_size=256 \
       --bf_sde_install=$BF_SDE_INSTALL \
       --persistent_config_dir=/stratum/config/ \
       --forwarding_pipeline_configs_file=/stratum/config/p4_pipeline.pb.txt \
       --chassis_config_file=/stratum/config/chassis_config.pb.txt \
       --write_req_log_file=/stratum/config/p4_writes.pb.txt \
       --bf_sim




[Note: I had also tried the option of using pre-built docker container, with 8.9.1-3.16.56-OpenNetworkLinux, however, in this case I get error:

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json

I had reported that also and tried new container but didn't work]


Thanks,

Deval.


________________________________
From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Sunday, March 29, 2020 1:46:04 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>; Andreas Kassler
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

There are many things going on in your setup, let's do this step by step:

1. Port 8008 is NOT what you want for ONOS. I'm no Tofino expert, but this seems to be a separate endpoint for something else (debugging?). We always use port 28000.

2. 2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?
Depends. It's probably not good, but as long as you see this line in the Stratum logs, ONOS should be able to connect:
E0328 23:08:15.903065    13 hal.cc:234] Stratum external facing services are listening to 0.0.0.0:28000<http://0.0.0.0:28000>, localhost:28000...
Judging from the missing listening port, I'd say this could be the issue.

3. If you run ONOS in a container too, they have to reside in the same network and you have to figure out the docker-internal IP for the Stratum container:
# docker network ls
NETWORK ID          NAME                DRIVER              SCOPE
e737dd0dd90f        bridge              bridge              local
d2783152be24        host                host                local
7028e832e130        none                null                local

# docker network inspect bridge
[...]
"Containers": {
            "518c901167919d34205959f1105aedebbb99a9452d191409ccf71a3908e14e56": {
                "Name": "zen_jennings",
                "EndpointID": "a52025a671c9968372c52c7ed6b61df5a3168493466bd4b831c4728089b77163",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            }
        },
[...]

You could also try running them in the host network (--network=host), that should make them behave like native processes with fully exposed networking.

4. I used a wrong switch in my previous post, here's how it looks on a Tofino:

  *    ./start-stratum-container.sh (let it run and open new terminal tab)
  *   docker container ls
CONTAINER ID        IMAGE                                                      COMMAND                  CREATED             STATUS              PORTS                      NAMES
518c90116791        stratumproject/stratum-bf:9.1.0-4.14.49-OpenNetworkLinux   "/bin/sh -c /stratum…"   12 minutes ago      Up 12 minutes       0.0.0.0:28000->28000/tcp   zen_jennings
  *   ss -ltnp
LISTEN      0      128                    :::28000                              :::*                   users:(("docker-proxy",pid=1179,fd=4))
  *   docker exec -ti 518c90116791 bash (switch into the Stratum container)
  *   apt update && apt install iproute
  *   ss -tlnp
State       Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN      0      5                       *:9999                                *:*                   users:(("stratum_bf",pid=13,fd=27))
LISTEN      0      128                     *:28000                               *:*                   users:(("stratum_bf",pid=13,fd=40))
LISTEN      0      128             127.0.0.1:28000<http://127.0.0.1:28000>                               *:*                   users:(("stratum_bf",pid=13,fd=39))
LISTEN      0      1                       *:9001                                *:*                   users:(("stratum_bf",pid=13,fd=28))
  *   exit (leave container)
  *   docker run -ti debian:9 bash (Start new container to simulate ONOS)
  *   apt update && apt install netcat
  *   nc -v 172.17.0.2 28000
172.17.0.2<http://172.17.0.2>: inverse host lookup failed: Unknown host
(UNKNOWN) [172.17.0.2] 28000 (?) open

For reference, the used versions:

# docker images
REPOSITORY                  TAG                              IMAGE ID            CREATED             SIZE
stratumproject/stratum-bf   9.1.0-4.14.49-OpenNetworkLinux   e4615d64018f        2 weeks ago         214MB

For reference, these are the versions we use:
# docker version
Client: Docker Engine - Community
 Version:           19.03.2
 API version:       1.40
 Go version:        go1.12.8
 Git commit:        6a30dfca03
 Built:             Thu Aug 29 05:29:49 2019
 OS/Arch:           linux/amd64
 Experimental:      false

Server: Docker Engine - Community
 Engine:
  Version:          19.03.2
  API version:      1.40 (minimum version 1.12)
  Go version:       go1.12.8
  Git commit:       6a30dfca03
  Built:            Thu Aug 29 05:28:23 2019
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.2.6
  GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
 runc:
  Version:          1.0.0-rc8
  GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
 docker-init:
  Version:          0.18.0
  GitCommit:        fec3683

# uname -a
Linux Stordis 4.14.49-OpenNetworkLinux #1 SMP Thu Jul 18 08:52:25 UTC 2019 x86_64 GNU/Linux


Max

On Sat, Mar 28, 2020 at 7:31 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,


Since I could not any port activity on 28000 inside stratum and stratum logs shown only listen activity on 8008, I used following command to do explicitly map the IP/ports to host:


./setup_dev_env.sh  --pull --  -p 192.168.60.131:28008<http://192.168.60.131:28008>:8008


Then I tried to push the netcfg.json with following URL and this time the communication channel is established. Logs from ONOS and stratum are below (BOLD RED).


URL:


"managementAddress": "grpc://192.168.60.131:28008?device_id=0<http://192.168.60.131:28008?device_id=0>",


(I tired both deviceID 0 and 1, but it must be 0 as bf_shell and stratum Log both confirm: )



ONOS:


2020-03-28T13:49:46,158 | WARN  | onos-gdp-0       | PiPipeconfManager                | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Ignoring PortStatisticsDiscovery behaviour from pipeconf vepg-pipeconf, but using the one provided by stratum-tofino driver...

2020-03-28T13:49:46,184 | INFO  | onos-gdp-0       | GrpcChannelControllerImpl        | 230 - org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Creating new gRPC channel grpc://192.168.60.131:28008?device_id=0.<http://192.168.60.131:28008?device_id=0.>.. << #THERE IS SUCCESS HERE THIS TIME AS COMPARED TO PREVIOUS TIME


Stratum:


Tcl server: connection accepted on port 8008

Partial recv: 30 of 40 so far..  <<#STRATUM CONFIRMS IT



However, I am not sure, it is the correct entry point? The reason is ONOS still cannot find the device:tofino (highlighted Yellow RED)


2020-03-28T13:49:46,306 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Local role is MASTER for device:tofino

2020-03-28T13:49:46,311 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,313 | INFO  | onos-gdp-0       | GeneralDeviceProvider            | 235 - org.onosproject.onos-providers-general-device - 2.4.0.SNAPSHOT | Notifying role MASTER (preference 0) for term 1 to device:tofino

2020-03-28T13:49:46,315 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,316 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.    <<#STILL NO DEVICE FOUND. I TRIED BOTH ID 0 and 1 in the URL

2020-03-28T13:49:46,317 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-28T13:49:46,320 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,336 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=12233603415182, creationTime=1585403386336, computeCost=124274, clusters=0, devices=0, links=0} changed

2020-03-28T13:49:46,365 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered




Please confirm, is it in the right direction or port 8008 is completely different? What can be the reason for device:tofino not able to find?


Thank you,

Deval.


________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org<mailto:stratum-dev-bounces at lists.stratumproject.org>> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>>
Sent: Saturday, March 28, 2020 3:22:16 PM
To: Maximilian Pudelko
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Maximilian,


Thank you for your reply and the useful suggestions. So as a first step I executed on switch ss -tnlp and below is the output. Surprisingly, there is no Stratum anywhere there, however statrum is also running in a container and the short logs are displayed below. I also executed ss command inside the container and those are also pasted below, if that may help.


ss -tnlp outputs in different times are as follows:


- from tofino, before anything is started:


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*



- from tofino after stratum container is started


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from tofino after stratum is running


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from stratum container, after running it in background


tofino at ced0c4d7ef8f:/stratum$ ss -tnlp

State      Recv-Q Send-Q Local Address:Port                Peer Address:Port

LISTEN     0      1                  *:8008                           *:*                   users:(("stratum_bf",pid=323,fd=26)) << #IS this useful?

LISTEN     0      128        127.0.0.1:41418<http://127.0.0.1:41418>                          *:*                   users:(("java",pid=21,fd=110))


Why there is no 28000 port here in Stratum container SS output. Or should I bind 8008 to 28000 on switch?

As you have mentioned, I have already taken care of port mapping. So I run the container with -p28000:2000. It is verified in the outputs above as well.


- Docker output on switch


tofino at localhost:~$ docker ps

CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                      NAMES

ced0c4d7ef8f        stratum-dev         "bash"              16 minutes ago      Up 16 minutes       0.0.0.0:28000->28000/tcp   goofy_hamilton



- Stratum log output after it started.


bf_sysfs_fname /sys/class/bf/bf0/device/dev_add

Install dir: /stratum/bf-sde-8.9.0/install (0x7f876b794b60)

bf_switchd: system services initialized

bf_switchd: loading conf_file stratum/hal/bin/barefoot/tofino_skip_p4.conf...

bf_switchd: processing device configuration...

Configuration for dev_id 0

  Family        : Tofino

  pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0

  pci_domain    : 0

  pci_bus       : 5

  pci_fn        : 0

  pci_dev       : 0

  pci_int_mode  : 1

  sbus_master_fw: /stratum/bf-sde-8.9.0/install/

  pcie_fw       : /stratum/bf-sde-8.9.0/install/

  serdes_fw     : /stratum/bf-sde-8.9.0/install/

  sds_fw_path   : /stratum/bf-sde-8.9.0/install/

  microp_fw_path:

bf_switchd: processing P4 configuration...

P4 profile for dev_id 0

  p4_name: dummy

    libpd:

    libpdthrift:

    context:

    config:

  Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so

  diag:

  mavericks diag:

  non_default_port_ppgs: 0

  SAI default initialize: 1

bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so loaded

bf_switchd: agent[0] initialized

Tcl server started..

Tcl server: listen socket created

Tcl server: bind done on port 8008, listening...

Tcl server: waiting for incoming connections...

sh: 1: onie-syseeprom: not found

2020-03-28 13:06:53.584090 BF_PLTFM ERROR - Error in cp2112 initialization


2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?



Thank you.

Deval


________________________________
From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Saturday, March 28, 2020 3:43:29 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

can you run this command on the switch: ss -tlnp
Should output something like this:
State      Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN     0      128                     *:22                                  *:*                   users:(("sshd",pid=4116,fd=3))
LISTEN     0      128                    :::22                                 :::*                   users:(("sshd",pid=4116,fd=4))
LISTEN     0      128      ::ffff:127.0.0.1:28000<http://127.0.0.1:28000>                              :::*                   users:(("stratum_bcm",pid=26872,fd=19))
LISTEN     0      128                    :::28001                              :::*                   users:(("stratum_bcm",pid=26872,fd=20))
LISTEN     0      128      ::ffff:127.0.0.1:28003<http://127.0.0.1:28003>                              :::*                   users:(("stratum_bcm",pid=26872,fd=6))

Also, do you have any logs from Stratum? Run with -v=1 -stderrthreshold=0

Since you're using docker, I assume there is some issue with port forwarding/mapping. Follow these steps to check the port mapping: https://docs.docker.com/engine/reference/commandline/port/
And these steps to fix it:
https://stackoverflow.com/questions/22111060/what-is-the-difference-between-expose-and-publish-in-docker
https://docs.docker.com/config/containers/container-networking/#published-ports

Max


On Thu, Mar 26, 2020 at 3:53 PM Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:

Hello Yi,


I am running both ONOS and stratum container on the same machine, that is the tofino switch with public IP 192.168.60.131.


So I tried with grpc://192.168.60.131:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", as well now. This time message is connection refused and still no connectivity.




2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.

2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264511977012, creationTime=1585262479736, computeCost=117691, clusters=0, devices=0, links=0} changed

2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | device:tofino is unreachable (Connection refused: /192.168.60.131:28000<http://192.168.60.131:28000>)

2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264549921343, creationTime=1585262479774, computeCost=101378, clusters=0, devices=0, links=0} changed


With grpc://127.0.0.1:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", the error is


onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason


Also Stratum logs say


bf_switchd: processing P4 configuration...

P4 profile for dev_id 0


while starting, so I doubt device ID maybe 0 and hence tried with both device_id=1<http://192.168.0.101:28000/?device_id=1> and device_id=<http://192.168.0.101:28000/?device_id=1>0 but no luck.



Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 26, 2020 9:10:49 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

Where you are running the ONOS controller? If you are running the ONOS controller on a server, you need to set the management address to your switch IP address.

For example, you run the ONOS on a server with IP address 192.168.0.100 and running the Stratum on a switch with IP address 192.168.0.101. (And I assume that you have connectivity between the server and the switch)

The netcfg.json will look like:

{
  "devices": {
    "device:tofino": {
      "basic": {
        "managementAddress": "grpc://192.168.0.101:28000?device_id=1<http://192.168.0.101:28000?device_id=1>",
        "driver": "stratum-tofino",
        "pipeconf": "[your pipeconf name]"
       }
    }
   }
}

Please also note that the device ID is 1 in the Stratum

Yi


On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


We have received a reply from Stordis and as per their suggestion, we can ignore the syseeprom error


You see only syseeprom errorr please ignore that :
Tcl server: listen socket created
Tcl server: bind done on port 8008, listening...
Tcl server: waiting for incoming connections...
sh: 1: onie-syseeprom: not found <Ignore this error>
Health monitor started
Operational mode set to ASIC



So, now when I try to push the netcfg.json for our device to Onos, I get following message:


2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452353961040, creationTime=1585173541276, computeCost=427068, clusters=0, devices=0, links=0} changed

2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason

2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452397561034, creationTime=1585173541319, computeCost=112832, clusters=0, devices=0, links=0} changed



ONOS CLI show, device available=false.


tofino at root > devices                                                        21:58:49

id=device:tofino, available=false, local-status=disconnected 37s ago, role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0<http://127.0.0.1:28000?device_id=0>, name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI



Netcfg.json contents are:

{
        "devices": {
        "device:tofino": {
        "basic": {
        "managementAddress": "grpc://127.0.0.1?device_id=0<http://127.0.0.1?device_id=0>",
        "driver": "stratum-tofino",
        "pipeconf": "vepg-pipeconf"
        }
        }
        }
        }


Command is:


curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H 'Content-Type:application/json' 'http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json



Any idea what may be the issue?


Thanks,

Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Tuesday, March 24, 2020 3:25:06 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

I am now working on updating the script to support the custom platform parameter<https://github.com/stratum/stratum/pull/150> since the Stratum cannot detect the platform without the ONLP.

Should be merged soon.

On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux, however, the error still persists:


+ KERNEL_VERSION=3.16.64-OpenNetworkLinux

+ DOCKER_IMAGE=stratumproject/stratum-bf

+ DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux

++ uname -r

++ uname -r

+ docker run -it --privileged -v /dev:/dev -v /sys:/sys -v /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1 -v /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so -v /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1 -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux

Use default flag file

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json



I also had peek at the script start-stratum-container.sh and found an option of ONLP_ARG="--env WITH_ONLP=false"
. So I wanted to ask whether I can set this option with Docker to force BSP usage, let us say, by hard-coding it in the script itself (also similar approach to set PORT_MAP in stratume_entrypoint.sh). I tried this and the error message in this case is:


Use default flag file

Cannot find /usr/local/share/stratum/.json

Please suggest.

Thanks,
Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 12, 2020 6:57 AM
To: Deval Bhamare
Cc: Narada Hess; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>, feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf

I think the system linker may have some issue to find the library.

The libavago.so.0 is a symbolic link to libavago.so. the libavago.so must also exists.
ls -al $BF_SDE_INSTALL/lib/libavago*
-rwxr-xr-x 1 root root 1185264 Mar 12 04:19 libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0 -> libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0 -> libavago.so




--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200402/08d77c77/attachment-0001.html>

From Deval.Bhamare at kau.se  Sun Apr 12 13:27:22 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Sun, 12 Apr 2020 13:27:22 +0000
Subject: [stratum-dev] Stratum Logs - table entries population.
Message-ID: <9e56ce93cb244f1d90c15ae12e17224f@kau.se>

Hello Yi,


Hope you are well.


I wanted to ask a specific question about Stratum logs, especially the timing information about at what time the table entries are actually populated, etc.

Is there any way to know it? I checked the logs in /tmp from the docker container of Stratum, but couldn't find the needed information.


Thank you,


Deval.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200412/ca30718b/attachment.html>

From Deval.Bhamare at kau.se  Thu Apr 16 12:50:39 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Thu, 16 Apr 2020 12:50:39 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR26WzkbQJHqvXZa=_o58HQ-L_K6n-ajQjKSv4WssMK1dw@mail.gmail.com>
References: <4497e28827f44eebbab214abfb0d0cfa@kau.se>,
 <CAOyFVR26WzkbQJHqvXZa=_o58HQ-L_K6n-ajQjKSv4WssMK1dw@mail.gmail.com>
Message-ID: <4c4e0a1056704cecac75294f81017fe0@kau.se>

Hello Yi and team,


With reference to your email below:


The current way to support Stratum + BSP is to build the SDE, BSP, and Stratum on the switch


>> Does it mean, pre-built Stratum container cannot be used with BSP? Then what is the meaning of below flag in the container start script?


ONLP_ARG="--env WITH_ONLP=false \ -
-env PLATFORM=x86-64-accton-wedge100bf-32x-r0"




Isn't the above option mean stratum will use BSP?  If not, then with ONLP false and without BSP, how will switch work? Is it by reading the JSON for the specified platform above (x86-64-accton-wedge100bf-32x-r0)?


can you please explain?


Note: We still are facing errors when we tr yo build stratum with BSP.


Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Thursday, April 2, 2020 2:02:40 PM
To: Deval Bhamare
Cc: max at opennetworking.org; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

The Stratum container image does not include the BSP library from each vendor since the origin goal is to use a general open-source platform library from ONL.

The current way to support Stratum + BSP is to build the SDE, BSP, and Stratum on the switch (you can also build it on the server and copy every necessary libraries and files to the switch). Also, I believed that you can build everything(SDE, BSP, Stratum) on a Ubuntu-based switch and run it.

I've tested to build SDE, BSP, and Stratum on out BF2556X and I can confirm that ONOS can connect to the Stratum.
Currently, we are using ONL-based OS in our lab. I can try re-installed the switch to Ubuntu-based once I can access the hardware.

Yi


On Mon, Mar 30, 2020 at 8:25 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,


So as per my understanding, when we use pre-built docker version of the Stratum, it doesn't refer to local locally built BSP and BF-SDE. Instead it uses its own pre-build BF-SDE and BSP. Is it correct?


In that case, with reference to the email from Stordis-support below, I would like to confirm that below point have been taken care of while building the updated docker image.


Stordis_support message:


"It is important that you build the BSP with the --with-tof-brgup-plat option that you can also pass through the p4studio_build script (see installation guide). Be sure to spell it correctly, or else p4studio_build will silently ignore the option and build the BSP incorrectly… (there will be just a log entry in the installation log saying that the option was unknown)

Note too that there was a problem in the BSP zip file that is available on our FTP server – the bf-platforms.tgz in the packages directory was actually the reference BSP version. If you had used this tgz (instead of the bf-platforms directory that is present in the directory above), the BSP would have been built incorrectly too. In the meantime I have uploaded a corrected version of the zip file to our FTP server."



Can you please confirm?


Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Monday, March 30, 2020 7:32:05 AM
To: Deval Bhamare
Cc: max at opennetworking.org<mailto:max at opennetworking.org>; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We've updated the container image and the script to start the container:
https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/start-stratum-container.sh

You can now try the following command to start the Stratum container with no ONLP support:
PLATFORM=x86-64-stordis-bf2556x-1t-r0 SDE_VERSION=8.9.2 ./start-stratum-container.sh

For the "unimplemented" message you saw, the SDE 8.9.2 uses old version PI library which doesn't implement some features (reading default entry from a table).
You can ignore that warning or use a newer version of Stratum (with SDE >= 9.0.0)

Yi


On Sun, Mar 29, 2020 at 8:31 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,



Just don't want to overload with the information, but I wanted to mention that, with the pre-built docker image option, I had a look a the ./start-stratum-container.sh


Since I want to run Stratum with BSP, I made a change as:


ONLP_ARG="--env WITH_ONLP=false"


Then I started the container 8.9.2-3.16.56-OpenNetworkLinux and it executed the Stratum successfully. Stratum open bf-sde prompt.


Also ss ouptput is:


State      Recv-Q Send-Q          Local Address:Port                         Peer Address:Port

LISTEN     0      128                         *:28000                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=36))

LISTEN     0      128                 127.0.0.1:28000<http://127.0.0.1:28000>                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=35))

LISTEN     0      128                 127.0.0.1:28003<http://127.0.0.1:28003>                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=32))

LISTEN     0      5                           *:9999                                    *:*                   users:(("stratum_bf_no_o",pid=10,fd=27))


I am getting following messages now:


 ONOS-CLI logs for the confirmation below:


tofino at root > devices                                                                                 22:02:35

id=device:tofino, available=true, local-status=connected 4m52s ago, role=MASTER, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=1<http://127.0.0.1:28000?device_id=1>, name=device:tofino, p4DeviceId=1, protocol=P4Runtime, gNMI, gNOI


Logs on stratum bf-sde are:


bf-sde.lld> E0329 22:01:52.649449   249 PI-device_mgr.cpp:0] Reading default entry not supported yet

E0329 22:01:52.649509   249 pi_node.cc:187] Return Error: toUtilStatus(status, details) failed with generic::unimplemented:

E0329 22:01:52.649549   249 p4_service.cc:307] Failed to read forwarding entries from node 1:


ONOS Logs:


2020-03-29T22:08:22,649 | WARN  | grpc-default-executor-4 | P4RuntimeClientImpl              | 230 - org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Error while performing READ on device:tofino: UNIMPLEMENTED



So, now ONOS can talk to Tofino through Stratum, but there are a few errors. First of all, is it OK to explicitly use this option: "--env WITH_ONLP=false" If yes, am I missing some steps here?  Any suggestion?



(Note: If I use default value of ONLP_ARG as per the original script, I get error as:


Use default flag file

Cannot find /usr/local/lib/modules/bf_kdrv.ko, skip installing the Kernel module

/usr/local/bin/stratum_bf: symbol lookup error: /usr/local/bin/stratum_bf: undefined symbol: onlp_sw_init

)



Thank you,


Deval.


________________________________
From: Deval Bhamare
Sent: Sunday, March 29, 2020 12:20:10 PM
To: Maximilian Pudelko
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Maximilian,


There is a littler confusion here. I am not using pre-built containerized version of Stratum.

However, I am locally building it by starting a development container with command "./setup_dev_env.sh  --pull -- -p 28000:28000" (I have mentioned it in the earlier image as well) as mentioned here: https://github.com/stratum/stratum

and then I try to build and run stratum as mentioned here: https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md



Now with the build-from-scratch using development container approach, I followed your steps, however, when I run ss -tnlp from the container (afterdocker exec -ti bash), I get below and listen on  127.0.0.1:28000<http://127.0.0.1:28000> is missing. I get only below.



tofino at 39e19c57ea27:/stratum$ ss -tlnp

State       Recv-Q Send-Q     Local Address:Port                    Peer Address:Port

LISTEN      0      128            127.0.0.1:56929<http://127.0.0.1:56929>                              *:*                   users:(("java",pid=21,fd=110))

LISTEN      0      1                      *:8008                               *:*                   users:(("stratum_bf",pid=310,fd=26))

Command to build Stratum is: bazel build //stratum/hal/bin/barefoot:stratum_bf --define phal_with_onlp=false --define sde_ver=8.9.2

Command to run Stratum is:

     ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
       --external_stratum_urls=0.0.0.0:28000<http://0.0.0.0:28000> \
       --grpc_max_recv_msg_size=256 \
       --bf_sde_install=$BF_SDE_INSTALL \
       --persistent_config_dir=/stratum/config/ \
       --forwarding_pipeline_configs_file=/stratum/config/p4_pipeline.pb.txt \
       --chassis_config_file=/stratum/config/chassis_config.pb.txt \
       --write_req_log_file=/stratum/config/p4_writes.pb.txt \
       --bf_sim




[Note: I had also tried the option of using pre-built docker container, with 8.9.1-3.16.56-OpenNetworkLinux, however, in this case I get error:

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json

I had reported that also and tried new container but didn't work]


Thanks,

Deval.


________________________________
From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Sunday, March 29, 2020 1:46:04 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>; Andreas Kassler
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

There are many things going on in your setup, let's do this step by step:

1. Port 8008 is NOT what you want for ONOS. I'm no Tofino expert, but this seems to be a separate endpoint for something else (debugging?). We always use port 28000.

2. 2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?
Depends. It's probably not good, but as long as you see this line in the Stratum logs, ONOS should be able to connect:
E0328 23:08:15.903065    13 hal.cc:234] Stratum external facing services are listening to 0.0.0.0:28000<http://0.0.0.0:28000>, localhost:28000...
Judging from the missing listening port, I'd say this could be the issue.

3. If you run ONOS in a container too, they have to reside in the same network and you have to figure out the docker-internal IP for the Stratum container:
# docker network ls
NETWORK ID          NAME                DRIVER              SCOPE
e737dd0dd90f        bridge              bridge              local
d2783152be24        host                host                local
7028e832e130        none                null                local

# docker network inspect bridge
[...]
"Containers": {
            "518c901167919d34205959f1105aedebbb99a9452d191409ccf71a3908e14e56": {
                "Name": "zen_jennings",
                "EndpointID": "a52025a671c9968372c52c7ed6b61df5a3168493466bd4b831c4728089b77163",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            }
        },
[...]

You could also try running them in the host network (--network=host), that should make them behave like native processes with fully exposed networking.

4. I used a wrong switch in my previous post, here's how it looks on a Tofino:

  *    ./start-stratum-container.sh (let it run and open new terminal tab)
  *   docker container ls
CONTAINER ID        IMAGE                                                      COMMAND                  CREATED             STATUS              PORTS                      NAMES
518c90116791        stratumproject/stratum-bf:9.1.0-4.14.49-OpenNetworkLinux   "/bin/sh -c /stratum…"   12 minutes ago      Up 12 minutes       0.0.0.0:28000->28000/tcp   zen_jennings
  *   ss -ltnp
LISTEN      0      128                    :::28000                              :::*                   users:(("docker-proxy",pid=1179,fd=4))
  *   docker exec -ti 518c90116791 bash (switch into the Stratum container)
  *   apt update && apt install iproute
  *   ss -tlnp
State       Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN      0      5                       *:9999                                *:*                   users:(("stratum_bf",pid=13,fd=27))
LISTEN      0      128                     *:28000                               *:*                   users:(("stratum_bf",pid=13,fd=40))
LISTEN      0      128             127.0.0.1:28000<http://127.0.0.1:28000>                               *:*                   users:(("stratum_bf",pid=13,fd=39))
LISTEN      0      1                       *:9001                                *:*                   users:(("stratum_bf",pid=13,fd=28))
  *   exit (leave container)
  *   docker run -ti debian:9 bash (Start new container to simulate ONOS)
  *   apt update && apt install netcat
  *   nc -v 172.17.0.2 28000
172.17.0.2<http://172.17.0.2>: inverse host lookup failed: Unknown host
(UNKNOWN) [172.17.0.2] 28000 (?) open

For reference, the used versions:

# docker images
REPOSITORY                  TAG                              IMAGE ID            CREATED             SIZE
stratumproject/stratum-bf   9.1.0-4.14.49-OpenNetworkLinux   e4615d64018f        2 weeks ago         214MB

For reference, these are the versions we use:
# docker version
Client: Docker Engine - Community
 Version:           19.03.2
 API version:       1.40
 Go version:        go1.12.8
 Git commit:        6a30dfca03
 Built:             Thu Aug 29 05:29:49 2019
 OS/Arch:           linux/amd64
 Experimental:      false

Server: Docker Engine - Community
 Engine:
  Version:          19.03.2
  API version:      1.40 (minimum version 1.12)
  Go version:       go1.12.8
  Git commit:       6a30dfca03
  Built:            Thu Aug 29 05:28:23 2019
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.2.6
  GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
 runc:
  Version:          1.0.0-rc8
  GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
 docker-init:
  Version:          0.18.0
  GitCommit:        fec3683

# uname -a
Linux Stordis 4.14.49-OpenNetworkLinux #1 SMP Thu Jul 18 08:52:25 UTC 2019 x86_64 GNU/Linux


Max

On Sat, Mar 28, 2020 at 7:31 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,


Since I could not any port activity on 28000 inside stratum and stratum logs shown only listen activity on 8008, I used following command to do explicitly map the IP/ports to host:


./setup_dev_env.sh  --pull --  -p 192.168.60.131:28008<http://192.168.60.131:28008>:8008


Then I tried to push the netcfg.json with following URL and this time the communication channel is established. Logs from ONOS and stratum are below (BOLD RED).


URL:


"managementAddress": "grpc://192.168.60.131:28008?device_id=0<http://192.168.60.131:28008?device_id=0>",


(I tired both deviceID 0 and 1, but it must be 0 as bf_shell and stratum Log both confirm: )



ONOS:


2020-03-28T13:49:46,158 | WARN  | onos-gdp-0       | PiPipeconfManager                | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Ignoring PortStatisticsDiscovery behaviour from pipeconf vepg-pipeconf, but using the one provided by stratum-tofino driver...

2020-03-28T13:49:46,184 | INFO  | onos-gdp-0       | GrpcChannelControllerImpl        | 230 - org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Creating new gRPC channel grpc://192.168.60.131:28008?device_id=0.<http://192.168.60.131:28008?device_id=0.>.. << #THERE IS SUCCESS HERE THIS TIME AS COMPARED TO PREVIOUS TIME


Stratum:


Tcl server: connection accepted on port 8008

Partial recv: 30 of 40 so far..  <<#STRATUM CONFIRMS IT



However, I am not sure, it is the correct entry point? The reason is ONOS still cannot find the device:tofino (highlighted Yellow RED)


2020-03-28T13:49:46,306 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Local role is MASTER for device:tofino

2020-03-28T13:49:46,311 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,313 | INFO  | onos-gdp-0       | GeneralDeviceProvider            | 235 - org.onosproject.onos-providers-general-device - 2.4.0.SNAPSHOT | Notifying role MASTER (preference 0) for term 1 to device:tofino

2020-03-28T13:49:46,315 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,316 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.    <<#STILL NO DEVICE FOUND. I TRIED BOTH ID 0 and 1 in the URL

2020-03-28T13:49:46,317 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-28T13:49:46,320 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,336 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=12233603415182, creationTime=1585403386336, computeCost=124274, clusters=0, devices=0, links=0} changed

2020-03-28T13:49:46,365 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered




Please confirm, is it in the right direction or port 8008 is completely different? What can be the reason for device:tofino not able to find?


Thank you,

Deval.


________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org<mailto:stratum-dev-bounces at lists.stratumproject.org>> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>>
Sent: Saturday, March 28, 2020 3:22:16 PM
To: Maximilian Pudelko
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Maximilian,


Thank you for your reply and the useful suggestions. So as a first step I executed on switch ss -tnlp and below is the output. Surprisingly, there is no Stratum anywhere there, however statrum is also running in a container and the short logs are displayed below. I also executed ss command inside the container and those are also pasted below, if that may help.


ss -tnlp outputs in different times are as follows:


- from tofino, before anything is started:


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*



- from tofino after stratum container is started


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from tofino after stratum is running


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from stratum container, after running it in background


tofino at ced0c4d7ef8f:/stratum$ ss -tnlp

State      Recv-Q Send-Q Local Address:Port                Peer Address:Port

LISTEN     0      1                  *:8008                           *:*                   users:(("stratum_bf",pid=323,fd=26)) << #IS this useful?

LISTEN     0      128        127.0.0.1:41418<http://127.0.0.1:41418>                          *:*                   users:(("java",pid=21,fd=110))


Why there is no 28000 port here in Stratum container SS output. Or should I bind 8008 to 28000 on switch?

As you have mentioned, I have already taken care of port mapping. So I run the container with -p28000:2000. It is verified in the outputs above as well.


- Docker output on switch


tofino at localhost:~$ docker ps

CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                      NAMES

ced0c4d7ef8f        stratum-dev         "bash"              16 minutes ago      Up 16 minutes       0.0.0.0:28000->28000/tcp   goofy_hamilton



- Stratum log output after it started.


bf_sysfs_fname /sys/class/bf/bf0/device/dev_add

Install dir: /stratum/bf-sde-8.9.0/install (0x7f876b794b60)

bf_switchd: system services initialized

bf_switchd: loading conf_file stratum/hal/bin/barefoot/tofino_skip_p4.conf...

bf_switchd: processing device configuration...

Configuration for dev_id 0

  Family        : Tofino

  pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0

  pci_domain    : 0

  pci_bus       : 5

  pci_fn        : 0

  pci_dev       : 0

  pci_int_mode  : 1

  sbus_master_fw: /stratum/bf-sde-8.9.0/install/

  pcie_fw       : /stratum/bf-sde-8.9.0/install/

  serdes_fw     : /stratum/bf-sde-8.9.0/install/

  sds_fw_path   : /stratum/bf-sde-8.9.0/install/

  microp_fw_path:

bf_switchd: processing P4 configuration...

P4 profile for dev_id 0

  p4_name: dummy

    libpd:

    libpdthrift:

    context:

    config:

  Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so

  diag:

  mavericks diag:

  non_default_port_ppgs: 0

  SAI default initialize: 1

bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so loaded

bf_switchd: agent[0] initialized

Tcl server started..

Tcl server: listen socket created

Tcl server: bind done on port 8008, listening...

Tcl server: waiting for incoming connections...

sh: 1: onie-syseeprom: not found

2020-03-28 13:06:53.584090 BF_PLTFM ERROR - Error in cp2112 initialization


2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?



Thank you.

Deval


________________________________
From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Saturday, March 28, 2020 3:43:29 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

can you run this command on the switch: ss -tlnp
Should output something like this:
State      Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN     0      128                     *:22                                  *:*                   users:(("sshd",pid=4116,fd=3))
LISTEN     0      128                    :::22                                 :::*                   users:(("sshd",pid=4116,fd=4))
LISTEN     0      128      ::ffff:127.0.0.1:28000<http://127.0.0.1:28000>                              :::*                   users:(("stratum_bcm",pid=26872,fd=19))
LISTEN     0      128                    :::28001                              :::*                   users:(("stratum_bcm",pid=26872,fd=20))
LISTEN     0      128      ::ffff:127.0.0.1:28003<http://127.0.0.1:28003>                              :::*                   users:(("stratum_bcm",pid=26872,fd=6))

Also, do you have any logs from Stratum? Run with -v=1 -stderrthreshold=0

Since you're using docker, I assume there is some issue with port forwarding/mapping. Follow these steps to check the port mapping: https://docs.docker.com/engine/reference/commandline/port/
And these steps to fix it:
https://stackoverflow.com/questions/22111060/what-is-the-difference-between-expose-and-publish-in-docker
https://docs.docker.com/config/containers/container-networking/#published-ports

Max


On Thu, Mar 26, 2020 at 3:53 PM Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:

Hello Yi,


I am running both ONOS and stratum container on the same machine, that is the tofino switch with public IP 192.168.60.131.


So I tried with grpc://192.168.60.131:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", as well now. This time message is connection refused and still no connectivity.




2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.

2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264511977012, creationTime=1585262479736, computeCost=117691, clusters=0, devices=0, links=0} changed

2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | device:tofino is unreachable (Connection refused: /192.168.60.131:28000<http://192.168.60.131:28000>)

2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264549921343, creationTime=1585262479774, computeCost=101378, clusters=0, devices=0, links=0} changed


With grpc://127.0.0.1:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", the error is


onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason


Also Stratum logs say


bf_switchd: processing P4 configuration...

P4 profile for dev_id 0


while starting, so I doubt device ID maybe 0 and hence tried with both device_id=1<http://192.168.0.101:28000/?device_id=1> and device_id=<http://192.168.0.101:28000/?device_id=1>0 but no luck.



Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 26, 2020 9:10:49 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

Where you are running the ONOS controller? If you are running the ONOS controller on a server, you need to set the management address to your switch IP address.

For example, you run the ONOS on a server with IP address 192.168.0.100 and running the Stratum on a switch with IP address 192.168.0.101. (And I assume that you have connectivity between the server and the switch)

The netcfg.json will look like:

{
  "devices": {
    "device:tofino": {
      "basic": {
        "managementAddress": "grpc://192.168.0.101:28000?device_id=1<http://192.168.0.101:28000?device_id=1>",
        "driver": "stratum-tofino",
        "pipeconf": "[your pipeconf name]"
       }
    }
   }
}

Please also note that the device ID is 1 in the Stratum

Yi


On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


We have received a reply from Stordis and as per their suggestion, we can ignore the syseeprom error


You see only syseeprom errorr please ignore that :
Tcl server: listen socket created
Tcl server: bind done on port 8008, listening...
Tcl server: waiting for incoming connections...
sh: 1: onie-syseeprom: not found <Ignore this error>
Health monitor started
Operational mode set to ASIC



So, now when I try to push the netcfg.json for our device to Onos, I get following message:


2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452353961040, creationTime=1585173541276, computeCost=427068, clusters=0, devices=0, links=0} changed

2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason

2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452397561034, creationTime=1585173541319, computeCost=112832, clusters=0, devices=0, links=0} changed



ONOS CLI show, device available=false.


tofino at root > devices                                                        21:58:49

id=device:tofino, available=false, local-status=disconnected 37s ago, role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0<http://127.0.0.1:28000?device_id=0>, name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI



Netcfg.json contents are:

{
        "devices": {
        "device:tofino": {
        "basic": {
        "managementAddress": "grpc://127.0.0.1?device_id=0<http://127.0.0.1?device_id=0>",
        "driver": "stratum-tofino",
        "pipeconf": "vepg-pipeconf"
        }
        }
        }
        }


Command is:


curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H 'Content-Type:application/json' 'http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json



Any idea what may be the issue?


Thanks,

Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Tuesday, March 24, 2020 3:25:06 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

I am now working on updating the script to support the custom platform parameter<https://github.com/stratum/stratum/pull/150> since the Stratum cannot detect the platform without the ONLP.

Should be merged soon.

On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux, however, the error still persists:


+ KERNEL_VERSION=3.16.64-OpenNetworkLinux

+ DOCKER_IMAGE=stratumproject/stratum-bf

+ DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux

++ uname -r

++ uname -r

+ docker run -it --privileged -v /dev:/dev -v /sys:/sys -v /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1 -v /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so -v /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1 -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux

Use default flag file

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json



I also had peek at the script start-stratum-container.sh and found an option of ONLP_ARG="--env WITH_ONLP=false"
. So I wanted to ask whether I can set this option with Docker to force BSP usage, let us say, by hard-coding it in the script itself (also similar approach to set PORT_MAP in stratume_entrypoint.sh). I tried this and the error message in this case is:


Use default flag file

Cannot find /usr/local/share/stratum/.json

Please suggest.

Thanks,
Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 12, 2020 6:57 AM
To: Deval Bhamare
Cc: Narada Hess; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>, feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf

I think the system linker may have some issue to find the library.

The libavago.so.0 is a symbolic link to libavago.so. the libavago.so must also exists.
ls -al $BF_SDE_INSTALL/lib/libavago*
-rwxr-xr-x 1 root root 1185264 Mar 12 04:19 libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0 -> libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0 -> libavago.so




--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200416/25118409/attachment-0001.html>

From yi at opennetworking.org  Fri Apr 17 06:51:35 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Fri, 17 Apr 2020 14:51:35 +0800
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <4c4e0a1056704cecac75294f81017fe0@kau.se>
References: <4497e28827f44eebbab214abfb0d0cfa@kau.se>
 <CAOyFVR26WzkbQJHqvXZa=_o58HQ-L_K6n-ajQjKSv4WssMK1dw@mail.gmail.com>
 <4c4e0a1056704cecac75294f81017fe0@kau.se>
Message-ID: <CAOyFVR3wZVuHZcBJ9i3g2oB=aRCom9-F89M3ePyaDi=P0454OA@mail.gmail.com>

Hi Deval,

The container script tells the container entry point to use the Stratum
binary which doesn't link to ONLP library and uses a specific port map for
the platform.

To include the BSP to current container, you can modify the build script
<https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/build-stratum-bf-container.sh>
and the Dockerfile
<https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/Dockerfile.builder#L39>
to include the BSP option when it invokes the p4studio script.

Yi

On Thu, Apr 16, 2020 at 8:50 PM Deval Bhamare <Deval.Bhamare at kau.se> wrote:

> Hello Yi and team,
>
>
> With reference to your email below:
>
>
> The current way to support Stratum + BSP is to build the SDE, BSP, and
> Stratum on the switch
>
>
> >> Does it mean, pre-built Stratum container cannot be used with BSP? Then
> what is the meaning of below flag in the container start script?
>
>
> ONLP_ARG="--env WITH_ONLP=false \ -
> -env PLATFORM=x86-64-accton-wedge100bf-32x-r0"
>
> Isn't the above option mean stratum will use BSP?  If not, then with ONLP
> false and without BSP, how will switch work? Is it by reading the JSON for
> the specified platform above (x86-64-accton-wedge100bf-32x-r0)?
>
>
> can you please explain?
>
>
> Note: We still are facing errors when we tr yo build stratum with BSP.
>
>
> Thanks,
>
>
> Deval.
> ------------------------------
> *From:* Yi Tseng <yi at opennetworking.org>
> *Sent:* Thursday, April 2, 2020 2:02:40 PM
> *To:* Deval Bhamare
> *Cc:* max at opennetworking.org; stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
> Hi Deval,
>
> The Stratum container image does not include the BSP library from each
> vendor since the origin goal is to use a general open-source platform
> library from ONL.
>
> The current way to support Stratum + BSP is to build the SDE, BSP, and
> Stratum on the switch (you can also build it on the server and copy every
> necessary libraries and files to the switch). Also, I believed that you can
> build everything(SDE, BSP, Stratum) on a Ubuntu-based switch and run it.
>
> I've tested to build SDE, BSP, and Stratum on out BF2556X and I can
> confirm that ONOS can connect to the Stratum.
> Currently, we are using ONL-based OS in our lab. I can try re-installed
> the switch to Ubuntu-based once I can access the hardware.
>
> Yi
>
>
> On Mon, Mar 30, 2020 at 8:25 PM Deval Bhamare <Deval.Bhamare at kau.se>
> wrote:
>
>> Hello again,
>>
>>
>> So as per my understanding, when we use pre-built docker version of the
>> Stratum, it doesn't refer to local locally built BSP and BF-SDE. Instead it
>> uses its own pre-build BF-SDE and BSP. Is it correct?
>>
>>
>> In that case, with reference to the email from Stordis-support below, I
>> would like to confirm that below point have been taken care of while
>> building the updated docker image.
>>
>>
>> Stordis_support message:
>>
>>
>> "*It is important that you build the BSP with the --with-tof-brgup-plat
>> option that you can also pass through the p4studio_build script (see
>> installation guide). Be sure to spell it correctly, or else p4studio_build
>> will silently ignore the option and build the BSP incorrectly… (there will
>> be just a log entry in the installation log saying that the option was
>> unknown)*
>>
>> *Note too that there was a problem in the BSP zip file that is available
>> on our FTP server – the bf-platforms.tgz in the packages directory was
>> actually the reference BSP version. If you had used this tgz (instead of
>> the bf-platforms directory that is present in the directory above), the BSP
>> would have been built incorrectly too. In the meantime I have uploaded a
>> corrected version of the zip file to our FTP server.*"
>>
>>
>> Can you please confirm?
>>
>>
>> Thanks,
>>
>>
>> Deval.
>> ------------------------------
>> *From:* Yi Tseng <yi at opennetworking.org>
>> *Sent:* Monday, March 30, 2020 7:32:05 AM
>> *To:* Deval Bhamare
>> *Cc:* max at opennetworking.org; stratum-dev at lists.stratumproject.org
>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>
>> Hi Deval,
>>
>> We've updated the container image and the script to start the container:
>>
>> https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/start-stratum-container.sh
>>
>> You can now try the following command to start the Stratum container with
>> no ONLP support:
>> *PLATFORM=x86-64-stordis-bf2556x-1t-r0 SDE_VERSION=8.9.2
>> ./start-stratum-container.sh*
>>
>> For the "unimplemented" message you saw, the SDE 8.9.2 uses old version
>> PI library which doesn't implement some features (reading default entry
>> from a table).
>> You can ignore that warning or use a newer version of Stratum (with SDE
>> >= 9.0.0)
>>
>> Yi
>>
>>
>> On Sun, Mar 29, 2020 at 8:31 PM Deval Bhamare <Deval.Bhamare at kau.se>
>> wrote:
>>
>>> Hello again,
>>>
>>>
>>>
>>> Just don't want to overload with the information, but I wanted to
>>> mention that, with the *pre-built docker image option*, I had a look a
>>> the ./start-stratum-container.sh
>>>
>>>
>>> Since I want to run Stratum with BSP, I made a change as:
>>>
>>>
>>> ONLP_ARG="--env WITH_ONLP=false"
>>>
>>> Then I started the container 8.9.2-3.16.56-OpenNetworkLinux and it
>>> executed the Stratum successfully. Stratum open bf-sde prompt.
>>>
>>>
>>> *Also ss ouptput is: *
>>>
>>>
>>> State      Recv-Q Send-Q          Local Address:Port
>>>       Peer Address:Port
>>>
>>> LISTEN     0      128                         *:28000
>>>                 *:*
>>> users:(("stratum_bf_no_o",pid=10,fd=36))
>>>
>>> LISTEN     0      128                 127.0.0.1:28000
>>>                 *:*
>>> users:(("stratum_bf_no_o",pid=10,fd=35))
>>>
>>> LISTEN     0      128                 127.0.0.1:28003
>>>                 *:*
>>> users:(("stratum_bf_no_o",pid=10,fd=32))
>>>
>>> LISTEN     0      5                           *:9999
>>>                 *:*
>>> users:(("stratum_bf_no_o",pid=10,fd=27))
>>>
>>> I am getting following messages now:
>>>
>>>
>>>  ONOS-CLI logs for the confirmation below:
>>>
>>>
>>> tofino at root > devices
>>>                               22:02:35
>>>
>>> id=device:tofino, *available=true*, local-status=connected 4m52s ago,
>>> role=MASTER, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum,
>>> serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf,
>>> locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=1,
>>> name=device:tofino, p4DeviceId=1, protocol=P4Runtime, gNMI, gNOI
>>>
>>> Logs on stratum bf-sde are:
>>>
>>>
>>> bf-sde.lld> E0329 22:01:52.649449   249 PI-device_mgr.cpp:0] Reading
>>> default entry not supported yet
>>>
>>> E0329 22:01:52.649509   249 pi_node.cc:187] Return Error:
>>> toUtilStatus(status, details) failed with generic::unimplemented:
>>>
>>> E0329 22:01:52.649549   249 p4_service.cc:307] Failed to read
>>> forwarding entries from node 1:
>>>
>>> ONOS Logs:
>>>
>>>
>>> 2020-03-29T22:08:22,649 | WARN  | grpc-default-executor-4 |
>>> P4RuntimeClientImpl              | 230 -
>>> org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Error while
>>> performing READ on device:tofino: UNIMPLEMENTED
>>>
>>>
>>>
>>> So, now ONOS can talk to Tofino through Stratum, but there are a few
>>> errors. First of all, is it OK to explicitly use this option: "--env
>>> WITH_ONLP=false" If yes, am I missing some steps here?  Any suggestion?
>>>
>>>
>>>
>>> (Note: If I use default value of ONLP_ARG as per the original script, I
>>> get error as:
>>>
>>>
>>> Use default flag file
>>>
>>> Cannot find /usr/local/lib/modules/bf_kdrv.ko, skip installing the
>>> Kernel module
>>>
>>> /usr/local/bin/stratum_bf: symbol lookup error:
>>> /usr/local/bin/stratum_bf: undefined symbol: onlp_sw_init
>>> )
>>>
>>>
>>>
>>> Thank you,
>>>
>>>
>>> Deval.
>>>
>>>
>>> ------------------------------
>>> *From:* Deval Bhamare
>>> *Sent:* Sunday, March 29, 2020 12:20:10 PM
>>> *To:* Maximilian Pudelko
>>> *Cc:* Yi Tseng; stratum-dev at lists.stratumproject.org
>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>
>>>
>>> Hello Maximilian,
>>>
>>>
>>> There is a littler confusion here. I am *not using pre-built
>>> containerized version of Stratum*.
>>>
>>> However, I am locally *building it by starting a development container*
>>> with command "*./setup_dev_env.sh  --pull -- -p 28000:28000*" (I have
>>> mentioned it in the earlier image as well) as mentioned here:
>>> https://github.com/stratum/stratum
>>>
>>> and then I try to build and run stratum as mentioned here:
>>> https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md
>>>
>>>
>>>
>>> Now with the build-from-scratch using development container approach, I
>>> followed your steps, however, when I run *ss -tnlp* from the container
>>> (afterdocker exec -ti bash), I get below and listen on  127.0.0.1:28000
>>> is *missing*. I get only below.
>>>
>>>
>>>
>>> tofino at 39e19c57ea27:/stratum$ ss -tlnp
>>>
>>> State       Recv-Q Send-Q     Local Address:Port                    Peer
>>> Address:Port
>>>
>>> LISTEN      0      128            127.0.0.1:56929
>>>         *:*                   users:(("java",pid=21,fd=110))
>>>
>>> LISTEN      0      1                      *:8008
>>>         *:*                   users:(("stratum_bf",pid=310,fd=26))
>>>
>>> *Command to build Stratum is*: bazel build
>>> //stratum/hal/bin/barefoot:stratum_bf --define phal_with_onlp=false
>>> --define sde_ver=8.9.2
>>>
>>> *Command to run Stratum is*:
>>>
>>>      ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
>>>        --external_stratum_urls=0.0.0.0:28000 \
>>>        --grpc_max_recv_msg_size=256 \
>>>        --bf_sde_install=$BF_SDE_INSTALL \
>>>        --persistent_config_dir=/stratum/config/ \
>>>
>>>  --forwarding_pipeline_configs_file=/stratum/config/p4_pipeline.pb.txt \
>>>        --chassis_config_file=/stratum/config/chassis_config.pb.txt \
>>>        --write_req_log_file=/stratum/config/p4_writes.pb.txt \
>>>        --bf_sim
>>>
>>>
>>>
>>>
>>> [*Note*: I had also tried the option of using pre-built docker
>>> container, with 8.9.1-3.16.56-OpenNetworkLinux, however, in this case I get
>>> error:
>>>
>>> Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json
>>>
>>> I had reported that also and tried new container but didn't work]
>>>
>>> Thanks,
>>>
>>> Deval.
>>>
>>>
>>> ------------------------------
>>> *From:* Maximilian Pudelko <max at opennetworking.org>
>>> *Sent:* Sunday, March 29, 2020 1:46:04 AM
>>> *To:* Deval Bhamare
>>> *Cc:* Yi Tseng; stratum-dev at lists.stratumproject.org; Andreas Kassler
>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>
>>> Hi Deval,
>>>
>>> There are many things going on in your setup, let's do this step by step:
>>>
>>> 1. Port 8008 is NOT what you want for ONOS. I'm no Tofino expert, but
>>> this seems to be a separate endpoint for something else (debugging?). We
>>> always use port 28000.
>>>
>>> 2. *2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform
>>> init failed  #<<< CAN IT BE THE ISSUE?*
>>> Depends. It's probably not good, but as long as you see this line in the
>>> Stratum logs, ONOS should be able to connect:
>>> E0328 23:08:15.903065    13 hal.cc:234] Stratum external facing services
>>> are listening to 0.0.0.0:28000, localhost:28000...
>>> Judging from the missing listening port, I'd say this could be the issue.
>>>
>>> 3. If you run ONOS in a container too, they have to reside in the same
>>> network and you have to figure out the docker-internal IP for the Stratum
>>> container:
>>> # docker network ls
>>> NETWORK ID          NAME                DRIVER              SCOPE
>>> e737dd0dd90f        bridge              bridge              local
>>> d2783152be24        host                host                local
>>> 7028e832e130        none                null                local
>>>
>>> # docker network inspect bridge
>>> [...]
>>> "Containers": {
>>>
>>> "518c901167919d34205959f1105aedebbb99a9452d191409ccf71a3908e14e56": {
>>>                 "Name": "zen_jennings",
>>>                 "EndpointID":
>>> "a52025a671c9968372c52c7ed6b61df5a3168493466bd4b831c4728089b77163",
>>>                 "MacAddress": "02:42:ac:11:00:02",
>>>                 "IPv4Address": "172.17.0.2/16",
>>>                 "IPv6Address": ""
>>>             }
>>>         },
>>> [...]
>>>
>>> You could also try running them in the host network (--network=host),
>>> that should make them behave like native processes with fully exposed
>>> networking.
>>>
>>> 4. I used a wrong switch in my previous post, here's how it looks on a
>>> Tofino:
>>>
>>>    -  ./start-stratum-container.sh (let it run and open new terminal
>>>    tab)
>>>    - docker container ls
>>>    CONTAINER ID        IMAGE
>>>               COMMAND                  CREATED             STATUS
>>>     PORTS                      NAMES
>>>    518c90116791
>>>     stratumproject/stratum-bf:9.1.0-4.14.49-OpenNetworkLinux   "/bin/sh -c
>>>    /stratum…"   12 minutes ago      Up 12 minutes       0.0.0.0:28000
>>>    ->28000/tcp   zen_jennings
>>>    - ss -ltnp
>>>    LISTEN      0      128                    :::28000
>>>               :::*                   users:(("docker-proxy",pid=1179,fd=4))
>>>    - docker exec -ti 518c90116791 bash (switch into the Stratum
>>>    container)
>>>    - apt update && apt install iproute
>>>    - ss -tlnp
>>>    State       Recv-Q Send-Q      Local Address:Port
>>>      Peer Address:Port
>>>    LISTEN      0      5                       *:9999
>>>                 *:*                   users:(("stratum_bf",pid=13,fd=27))
>>>    LISTEN      0      128                     *:28000
>>>                *:*                   users:(("stratum_bf",pid=13,fd=40))
>>>    LISTEN      0      128             127.0.0.1:28000
>>>                *:*                   users:(("stratum_bf",pid=13,fd=39))
>>>    LISTEN      0      1                       *:9001
>>>                 *:*                   users:(("stratum_bf",pid=13,fd=28))
>>>    - exit (leave container)
>>>    - docker run -ti debian:9 bash (Start new container to simulate ONOS)
>>>    - apt update && apt install netcat
>>>    - nc -v 172.17.0.2 28000
>>>    172.17.0.2: inverse host lookup failed: Unknown host
>>>    (UNKNOWN) [172.17.0.2] 28000 (?) open
>>>
>>>
>>> For reference, the used versions:
>>>
>>> # docker images
>>> REPOSITORY                  TAG                              IMAGE ID
>>>          CREATED             SIZE
>>> stratumproject/stratum-bf   9.1.0-4.14.49-OpenNetworkLinux
>>> e4615d64018f        2 weeks ago         214MB
>>>
>>> For reference, these are the versions we use:
>>> # docker version
>>> Client: Docker Engine - Community
>>>  Version:           19.03.2
>>>  API version:       1.40
>>>  Go version:        go1.12.8
>>>  Git commit:        6a30dfca03
>>>  Built:             Thu Aug 29 05:29:49 2019
>>>  OS/Arch:           linux/amd64
>>>  Experimental:      false
>>>
>>> Server: Docker Engine - Community
>>>  Engine:
>>>   Version:          19.03.2
>>>   API version:      1.40 (minimum version 1.12)
>>>   Go version:       go1.12.8
>>>   Git commit:       6a30dfca03
>>>   Built:            Thu Aug 29 05:28:23 2019
>>>   OS/Arch:          linux/amd64
>>>   Experimental:     false
>>>  containerd:
>>>   Version:          1.2.6
>>>   GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
>>>  runc:
>>>   Version:          1.0.0-rc8
>>>   GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
>>>  docker-init:
>>>   Version:          0.18.0
>>>   GitCommit:        fec3683
>>>
>>> # uname -a
>>> Linux Stordis 4.14.49-OpenNetworkLinux #1 SMP Thu Jul 18 08:52:25 UTC
>>> 2019 x86_64 GNU/Linux
>>>
>>>
>>> Max
>>>
>>> On Sat, Mar 28, 2020 at 7:31 AM Deval Bhamare <Deval.Bhamare at kau.se>
>>> wrote:
>>>
>>>> Hello again,
>>>>
>>>>
>>>> Since I could not any port activity on 28000 inside stratum and stratum
>>>> logs shown only listen activity on *8008*, I used following command to
>>>> do explicitly map the IP/ports to host:
>>>>
>>>>
>>>> *./setup_dev_env.sh  --pull --  -p 192.168.60.131:28008
>>>> <http://192.168.60.131:28008>:8008*
>>>>
>>>>
>>>> Then I tried to push the netcfg.json with following URL and this time
>>>> the communication channel is established. Logs from ONOS and stratum are
>>>> below (BOLD RED).
>>>>
>>>>
>>>> *URL*:
>>>>
>>>>
>>>> *"managementAddress": "grpc://192.168.60.131:28008?device_id=0
>>>> <http://192.168.60.131:28008?device_id=0>",*
>>>>
>>>> (I tired both deviceID 0 and 1, but it must be 0 as bf_shell and
>>>> stratum Log both confirm: )
>>>>
>>>>
>>>>
>>>> *ONOS*:
>>>>
>>>>
>>>> 2020-03-28T13:49:46,158 | WARN  | onos-gdp-0       | PiPipeconfManager
>>>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT |
>>>> Ignoring PortStatisticsDiscovery behaviour from pipeconf vepg-pipeconf, but
>>>> using the one provided by stratum-tofino driver...
>>>>
>>>> 2020-03-28T13:49:46,184 | INFO  | onos-gdp-0       |
>>>> GrpcChannelControllerImpl        | 230 -
>>>> org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | *Creating
>>>> new gRPC channel grpc://192.168.60.131:28008?device_id=0.
>>>> <http://192.168.60.131:28008?device_id=0.>.. << #THERE IS SUCCESS HERE THIS
>>>> TIME AS COMPARED TO PREVIOUS TIME *
>>>>
>>>> *Stratum*:
>>>>
>>>>
>>>> *Tcl server: connection accepted on port 8008*
>>>>
>>>> *Partial recv: 30 of 40 so far..  <<#STRATUM CONFIRMS IT*
>>>>
>>>>
>>>> However, I am not sure, it is the correct entry point? The reason is
>>>> ONOS still cannot find the device:tofino (highlighted Yellow RED)
>>>>
>>>>
>>>> 2020-03-28T13:49:46,306 | INFO  | onos-gdp-0       | DeviceManager
>>>>                 | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT
>>>> | Local role is MASTER for device:tofino
>>>>
>>>> 2020-03-28T13:49:46,311 | WARN  | onos-event-dispatch-default0 |
>>>> ModelCache                       | 211 -
>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>> device:tofino not found as a UiDevice
>>>>
>>>> 2020-03-28T13:49:46,313 | INFO  | onos-gdp-0       |
>>>> GeneralDeviceProvider            | 235 -
>>>> org.onosproject.onos-providers-general-device - 2.4.0.SNAPSHOT | Notifying
>>>> role MASTER (preference 0) for term 1 to device:tofino
>>>>
>>>> 2020-03-28T13:49:46,315 | WARN  | onos-event-dispatch-default0 |
>>>> ModelCache                       | 211 -
>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | *DeviceID
>>>> device:tofino not found as a UiDevice*
>>>>
>>>> 2020-03-28T13:49:46,316 | WARN  | onos-device-manager-background |
>>>> DeviceManager                    | 193 - org.onosproject.onos-core-net
>>>> - 2.4.0.SNAPSHOT | *Node was instructed to be MASTER role for
>>>> device:tofino, but this node cannot reach the device.*  Relinquishing
>>>> role.    *<<#STILL NO DEVICE FOUND. I TRIED BOTH ID 0 and 1 in the
>>>> URL *
>>>>
>>>> 2020-03-28T13:49:46,317 | INFO  | onos-gdp-0       | StreamClientImpl
>>>>               | 237 - org.onosproject.onos-protocols-p4runtime-ctl -
>>>> 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true,
>>>> newElectionId=20, masterElectionId=null, sessionOpen=false
>>>>
>>>> 2020-03-28T13:49:46,320 | WARN  | onos-event-dispatch-default0 |
>>>> ModelCache                       | 211 -
>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>> device:tofino not found as a UiDevice
>>>>
>>>> 2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 |
>>>> ModelCache                       | 211 -
>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>> device:tofino not found as a UiDevice
>>>>
>>>> 2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 |
>>>> ModelCache                       | 211 -
>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>> device:tofino not found as a UiDevice
>>>>
>>>> 2020-03-28T13:49:46,336 | INFO  | onos-topo-build-1 | TopologyManager
>>>>                 | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT
>>>> | Topology DefaultTopology{time=12233603415182, creationTime=1585403386336,
>>>> computeCost=124274, clusters=0, devices=0, links=0} changed
>>>>
>>>> 2020-03-28T13:49:46,365 | INFO  | onos-gdp-0       | DeviceManager
>>>>                 | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT
>>>> | Device device:tofino registered
>>>>
>>>>
>>>>
>>>>
>>>> Please confirm, is it in the right direction or port 8008 is completely
>>>> different? What can be the reason for device:tofino not able to find?
>>>>
>>>>
>>>> Thank you,
>>>>
>>>> Deval.
>>>>
>>>>
>>>> ------------------------------
>>>> *From:* stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on
>>>> behalf of Deval Bhamare via stratum-dev <
>>>> stratum-dev at lists.stratumproject.org>
>>>> *Sent:* Saturday, March 28, 2020 3:22:16 PM
>>>> *To:* Maximilian Pudelko
>>>> *Cc:* stratum-dev at lists.stratumproject.org
>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>
>>>>
>>>> Hello Maximilian,
>>>>
>>>>
>>>> Thank you for your reply and the useful suggestions. So as a first step
>>>> I executed on switch ss -tnlp and below is the output. Surprisingly, there
>>>> is *no Stratum anywhere there, however statrum is also running in a
>>>> container* and the short logs are displayed below. I also executed ss
>>>> command inside the container and those are also pasted below, if that may
>>>> help.
>>>>
>>>>
>>>> ss -tnlp outputs in different times are as follows:
>>>>
>>>>
>>>> *- from tofino, before anything is started:*
>>>>
>>>>
>>>> tofino at localhost:~$ ss -tnlp
>>>>
>>>> State      Recv-Q Send-Q                        Local Address:Port
>>>>                       Peer Address:Port
>>>>
>>>> LISTEN     0      128                                       *:17
>>>>                                 *:*
>>>>
>>>> LISTEN     0      128                                       *:22
>>>>                                 *:*
>>>>
>>>> LISTEN     0      128                                       *:23
>>>>                                 *:*
>>>>
>>>> LISTEN     0      128                          192.168.60.131:10010
>>>>                                 *:*
>>>>
>>>> LISTEN     0      128                                      :::22
>>>>                                 :::*
>>>>
>>>>
>>>> *- from tofino after stratum container is started*
>>>>
>>>>
>>>> tofino at localhost:~$ ss -tnlp
>>>>
>>>> State      Recv-Q Send-Q                        Local Address:Port
>>>>                       Peer Address:Port
>>>>
>>>> LISTEN     0      128                                       *:17
>>>>                                 *:*
>>>>
>>>> LISTEN     0      128                                       *:22
>>>>                                 *:*
>>>>
>>>> LISTEN     0      128                                       *:23
>>>>                                 *:*
>>>>
>>>> LISTEN     0      128                          192.168.60.131:10010
>>>>                                 *:*
>>>>
>>>> LISTEN     0      128                                      :::22
>>>>                                 :::*
>>>>
>>>> LISTEN     0      *128                                      :::28000 *
>>>>                                 :::*
>>>>
>>>>
>>>> *- from tofino after stratum is running *
>>>>
>>>>
>>>> tofino at localhost:~$ ss -tnlp
>>>>
>>>> State      Recv-Q Send-Q                        Local Address:Port
>>>>                       Peer Address:Port
>>>>
>>>> LISTEN     0      128                                       *:17
>>>>                                 *:*
>>>>
>>>> LISTEN     0      128                                       *:22
>>>>                                 *:*
>>>>
>>>> LISTEN     0      128                                       *:23
>>>>                                 *:*
>>>>
>>>> LISTEN     0      128                          192.168.60.131:10010
>>>>                                 *:*
>>>>
>>>> LISTEN     0      128                                      :::22
>>>>                                 :::*
>>>>
>>>> LISTEN     0      128                                      :::28000
>>>>                                 :::*
>>>>
>>>>
>>>> *- from stratum container, after running it in background *
>>>>
>>>>
>>>> tofino at ced0c4d7ef8f:/stratum$ ss -tnlp
>>>>
>>>> State      Recv-Q Send-Q Local Address:Port                Peer
>>>> Address:Port
>>>>
>>>> LISTEN     *0      1                  *:8008
>>>> *:*                   users:(("stratum_bf",pid=323,fd=26)) << #IS this
>>>> useful? *
>>>>
>>>> LISTEN     0      128        127.0.0.1:41418                          *:*
>>>>                   users:(("java",pid=21,fd=110))
>>>>
>>>> Why there is no 28000 port here in Stratum container SS output. Or
>>>> should I bind 8008 to 28000 on switch?
>>>>
>>>> As you have mentioned, I have already taken care of port mapping. So I
>>>> run the container with -p28000:2000. It is verified in the outputs above as
>>>> well.
>>>>
>>>>
>>>> *- Docker output on switch *
>>>>
>>>>
>>>> tofino at localhost:~$ docker ps
>>>>
>>>> CONTAINER ID        IMAGE               COMMAND             CREATED
>>>>           STATUS              PORTS                      NAMES
>>>>
>>>> ced0c4d7ef8f        stratum-dev         "bash"              16 minutes
>>>> ago      Up 16 minutes       *0.0.0.0:28000->28000/tcp*
>>>> goofy_hamilton
>>>>
>>>>
>>>> *- Stratum log output after it started. *
>>>>
>>>>
>>>> bf_sysfs_fname /sys/class/bf/bf0/device/dev_add
>>>>
>>>> Install dir: /stratum/bf-sde-8.9.0/install (0x7f876b794b60)
>>>>
>>>> bf_switchd: system services initialized
>>>>
>>>> bf_switchd: loading conf_file
>>>> stratum/hal/bin/barefoot/tofino_skip_p4.conf...
>>>>
>>>> bf_switchd: processing device configuration...
>>>>
>>>> Configuration for dev_id 0
>>>>
>>>>   Family        : Tofino
>>>>
>>>>   pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0
>>>>
>>>>   pci_domain    : 0
>>>>
>>>>   pci_bus       : 5
>>>>
>>>>   pci_fn        : 0
>>>>
>>>>   pci_dev       : 0
>>>>
>>>>   pci_int_mode  : 1
>>>>
>>>>   sbus_master_fw: /stratum/bf-sde-8.9.0/install/
>>>>
>>>>   pcie_fw       : /stratum/bf-sde-8.9.0/install/
>>>>
>>>>   serdes_fw     : /stratum/bf-sde-8.9.0/install/
>>>>
>>>>   sds_fw_path   : /stratum/bf-sde-8.9.0/install/
>>>>
>>>>   microp_fw_path:
>>>>
>>>> bf_switchd: processing P4 configuration...
>>>>
>>>> P4 profile for dev_id 0
>>>>
>>>>   p4_name: dummy
>>>>
>>>>     libpd:
>>>>
>>>>     libpdthrift:
>>>>
>>>>     context:
>>>>
>>>>     config:
>>>>
>>>>   Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
>>>>
>>>>   diag:
>>>>
>>>>   mavericks diag:
>>>>
>>>>   non_default_port_ppgs: 0
>>>>
>>>>   SAI default initialize: 1
>>>>
>>>> bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
>>>> loaded
>>>>
>>>> bf_switchd: agent[0] initialized
>>>>
>>>> Tcl server started..
>>>>
>>>> Tcl server: listen socket created
>>>>
>>>> Tcl server: bind done on port 8008, listening...
>>>>
>>>> Tcl server: waiting for incoming connections...
>>>>
>>>> sh: 1: onie-syseeprom: not found
>>>>
>>>> *2020-03-28 13:06:53.584090 BF_PLTFM ERROR - Error in cp2112
>>>> initialization*
>>>>
>>>>
>>>> *2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init
>>>> failed  #<<< CAN IT BE THE ISSUE?*
>>>>
>>>>
>>>> Thank you.
>>>>
>>>> Deval
>>>>
>>>>
>>>> ------------------------------
>>>> *From:* Maximilian Pudelko <max at opennetworking.org>
>>>> *Sent:* Saturday, March 28, 2020 3:43:29 AM
>>>> *To:* Deval Bhamare
>>>> *Cc:* Yi Tseng; stratum-dev at lists.stratumproject.org
>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>
>>>> Hi Deval,
>>>>
>>>> can you run this command on the switch: ss -tlnp
>>>> Should output something like this:
>>>> State      Recv-Q Send-Q      Local Address:Port
>>>> Peer Address:Port
>>>> LISTEN     0      128                     *:22
>>>>          *:*                   users:(("sshd",pid=4116,fd=3))
>>>> LISTEN     0      128                    :::22
>>>>         :::*                   users:(("sshd",pid=4116,fd=4))
>>>> LISTEN     0      128      ::ffff:127.0.0.1:28000
>>>>          :::*                   users:(("stratum_bcm",pid=26872,fd=19))
>>>> LISTEN     0      128                    :::28001
>>>>        :::*                   users:(("stratum_bcm",pid=26872,fd=20))
>>>> LISTEN     0      128      ::ffff:127.0.0.1:28003
>>>>          :::*                   users:(("stratum_bcm",pid=26872,fd=6))
>>>>
>>>> Also, do you have any logs from Stratum? Run with -v=1
>>>> -stderrthreshold=0
>>>>
>>>> Since you're using docker, I assume there is some issue with port
>>>> forwarding/mapping. Follow these steps to check the port mapping:
>>>> https://docs.docker.com/engine/reference/commandline/port/
>>>> And these steps to fix it:
>>>>
>>>> https://stackoverflow.com/questions/22111060/what-is-the-difference-between-expose-and-publish-in-docker
>>>>
>>>> https://docs.docker.com/config/containers/container-networking/#published-ports
>>>>
>>>> Max
>>>>
>>>>
>>>> On Thu, Mar 26, 2020 at 3:53 PM Deval Bhamare via stratum-dev <
>>>> stratum-dev at lists.stratumproject.org> wrote:
>>>>
>>>>> Hello Yi,
>>>>>
>>>>>
>>>>> I am running both ONOS and stratum container on the same machine, that
>>>>> is the tofino switch with public IP 192.168.60.131.
>>>>>
>>>>>
>>>>> So I tried with grpc://192.168.60.131:28000?device_id=1
>>>>> <http://192.168.0.101:28000/?device_id=1>", as well now. This time
>>>>> message is connection refused and still no connectivity.
>>>>>
>>>>>
>>>>>
>>>>>
>>>>> 2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background |
>>>>> DeviceManager                    | 193 -
>>>>> org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be
>>>>> MASTER role for device:tofino, but this node cannot reach the device.
>>>>> Relinquishing role.
>>>>>
>>>>> 2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       | StreamClientImpl
>>>>>               | 237 - org.onosproject.onos-protocols-p4runtime-ctl -
>>>>> 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true,
>>>>> newElectionId=20, masterElectionId=null, sessionOpen=false
>>>>>
>>>>> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
>>>>> ModelCache                       | 211 -
>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>> device:tofino not found as a UiDevice
>>>>>
>>>>> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
>>>>> ModelCache                       | 211 -
>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>> device:tofino not found as a UiDevice
>>>>>
>>>>> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
>>>>> ModelCache                       | 211 -
>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>> device:tofino not found as a UiDevice
>>>>>
>>>>> 2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager
>>>>>                 | 193 - org.onosproject.onos-core-net -
>>>>> 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264511977012,
>>>>> creationTime=1585262479736, computeCost=117691, clusters=0, devices=0,
>>>>> links=0} changed
>>>>>
>>>>> 2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager
>>>>>                 | 193 - org.onosproject.onos-core-net -
>>>>> 2.4.0.SNAPSHOT | Device device:tofino registered
>>>>>
>>>>> 2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 |
>>>>> StreamClientImpl                 | 237 -
>>>>> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | *device:tofino
>>>>> is unreachable (Connection refused: /192.168.60.131:28000
>>>>> <http://192.168.60.131:28000>)*
>>>>>
>>>>> 2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager
>>>>>                 | 193 - org.onosproject.onos-core-net -
>>>>> 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264549921343,
>>>>> creationTime=1585262479774, computeCost=101378, clusters=0, devices=0,
>>>>> links=0} changed
>>>>>
>>>>> With grpc://127.0.0.1:28000?device_id=1
>>>>> <http://192.168.0.101:28000/?device_id=1>", the error is
>>>>>
>>>>>
>>>>> *onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on
>>>>> StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for
>>>>> unknown reason*
>>>>>
>>>>> Also Stratum logs say
>>>>>
>>>>>
>>>>> bf_switchd: processing P4 configuration...
>>>>>
>>>>> *P4 profile for dev_id 0*
>>>>>
>>>>>
>>>>> while starting, so I doubt device ID maybe 0 and hence tried with both
>>>>> device_id=1 <http://192.168.0.101:28000/?device_id=1> and device_id=
>>>>> <http://192.168.0.101:28000/?device_id=1>0 but no luck.
>>>>>
>>>>>
>>>>>
>>>>> Thanks,
>>>>>
>>>>>
>>>>> Deval.
>>>>> ------------------------------
>>>>> *From:* Yi Tseng <yi at opennetworking.org>
>>>>> *Sent:* Thursday, March 26, 2020 9:10:49 PM
>>>>> *To:* Deval Bhamare
>>>>> *Cc:* stratum-dev at lists.stratumproject.org
>>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>>
>>>>> Hi Deval,
>>>>>
>>>>> Where you are running the ONOS controller? If you are running the ONOS
>>>>> controller on a server, you need to set the management address to your
>>>>> switch IP address.
>>>>>
>>>>> For example, you run the ONOS on a server with IP address
>>>>> 192.168.0.100 and running the Stratum on a switch with IP address
>>>>> 192.168.0.101. (And I assume that you have connectivity between the server
>>>>> and the switch)
>>>>>
>>>>> The netcfg.json will look like:
>>>>>
>>>>> {
>>>>>   "devices": {
>>>>>     "device:tofino": {
>>>>>       "basic": {
>>>>>         "managementAddress": "grpc://192.168.0.101:28000?device_id=1",
>>>>>         "driver": "stratum-tofino",
>>>>>         "pipeconf": "[your pipeconf name]"
>>>>>        }
>>>>>     }
>>>>>    }
>>>>> }
>>>>>
>>>>> Please also note that the device ID is 1 in the Stratum
>>>>>
>>>>> Yi
>>>>>
>>>>>
>>>>> On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se>
>>>>> wrote:
>>>>>
>>>>>> Hello Yi,
>>>>>>
>>>>>>
>>>>>> We have received a reply from Stordis and as per their suggestion, we
>>>>>> can ignore the syseeprom error
>>>>>>
>>>>>>
>>>>>> *You see only syseeprom errorr please ignore that :*
>>>>>> *Tcl server: listen socket created*
>>>>>> *Tcl server: bind done on port 8008, listening...*
>>>>>> *Tcl server: waiting for incoming connections...*
>>>>>> *sh: 1: onie-syseeprom: not found <Ignore this error>*
>>>>>> *Health monitor started *
>>>>>> *Operational mode set to ASIC*
>>>>>>
>>>>>>
>>>>>> So, now when I try to push the netcfg.json for our device to Onos, I
>>>>>> get following message:
>>>>>>
>>>>>>
>>>>>> 2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       |
>>>>>> StreamClientImpl                 | 237 -
>>>>>> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting
>>>>>> mastership on device:tofino... master=true, newElectionId=20,
>>>>>> masterElectionId=null, sessionOpen=false
>>>>>>
>>>>>> 2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 |
>>>>>> ModelCache                       | 211 -
>>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>>> device:tofino not found as a UiDevice
>>>>>>
>>>>>> 2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 |
>>>>>> ModelCache                       | 211 -
>>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>>> device:tofino not found as a UiDevice
>>>>>>
>>>>>> 2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 |
>>>>>> ModelCache                       | 211 -
>>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>>> device:tofino not found as a UiDevice
>>>>>>
>>>>>> 2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager
>>>>>>                 | 193 - org.onosproject.onos-core-net -
>>>>>> 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452353961040,
>>>>>> creationTime=1585173541276, computeCost=427068, clusters=0, devices=0,
>>>>>> links=0} changed
>>>>>>
>>>>>> 2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager
>>>>>>                   | 193 - org.onosproject.onos-core-net -
>>>>>> 2.4.0.SNAPSHOT |* Device device:tofino registered*
>>>>>>
>>>>>> 2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 |
>>>>>> StreamClientImpl                 | 237 -
>>>>>> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT |*
>>>>>> Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed
>>>>>> for unknown reason*
>>>>>>
>>>>>> 2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager
>>>>>>                 | 193 - org.onosproject.onos-core-net -
>>>>>> 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452397561034,
>>>>>> creationTime=1585173541319, computeCost=112832, clusters=0, devices=0,
>>>>>> links=0} changed
>>>>>>
>>>>>>
>>>>>>
>>>>>> ONOS CLI show, device available=false.
>>>>>>
>>>>>>
>>>>>> tofino at root > devices
>>>>>>         21:58:49
>>>>>>
>>>>>> id=device:tofino, *available=false*, local-status=disconnected 37s
>>>>>> ago, role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum,
>>>>>> serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf,
>>>>>> locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0,
>>>>>> name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI
>>>>>>
>>>>>>
>>>>>> Netcfg.json contents are:
>>>>>>
>>>>>> {
>>>>>> "devices": {
>>>>>> "device:tofino": {
>>>>>> "basic": {
>>>>>> "managementAddress": "grpc://127.0.0.1?device_id=0",
>>>>>> "driver": "stratum-tofino",
>>>>>> "pipeconf": "vepg-pipeconf"
>>>>>> }
>>>>>> }
>>>>>> }
>>>>>> }
>>>>>>
>>>>>> Command is:
>>>>>>
>>>>>>
>>>>>> curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H
>>>>>> 'Content-Type:application/json' '
>>>>>> http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json
>>>>>>
>>>>>>
>>>>>>
>>>>>> Any idea what may be the issue?
>>>>>>
>>>>>>
>>>>>> Thanks,
>>>>>>
>>>>>> Deval.
>>>>>>
>>>>>>
>>>>>> ------------------------------
>>>>>> *From:* Yi Tseng <yi at opennetworking.org>
>>>>>> *Sent:* Tuesday, March 24, 2020 3:25:06 PM
>>>>>> *To:* Deval Bhamare
>>>>>> *Cc:* stratum-dev at lists.stratumproject.org
>>>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>>>
>>>>>> Hi Deval,
>>>>>>
>>>>>> I am now working on updating the script to support the custom platform
>>>>>> parameter <https://github.com/stratum/stratum/pull/150> since the
>>>>>> Stratum cannot detect the platform without the ONLP.
>>>>>>
>>>>>> Should be merged soon.
>>>>>>
>>>>>> On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se>
>>>>>> wrote:
>>>>>>
>>>>>>> Hello Yi,
>>>>>>>
>>>>>>>
>>>>>>> I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux,
>>>>>>> however, the error still persists:
>>>>>>>
>>>>>>>
>>>>>>> + KERNEL_VERSION=3.16.64-OpenNetworkLinux
>>>>>>>
>>>>>>> + DOCKER_IMAGE=stratumproject/stratum-bf
>>>>>>>
>>>>>>> + DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux
>>>>>>>
>>>>>>> ++ uname -r
>>>>>>>
>>>>>>> ++ uname -r
>>>>>>>
>>>>>>> + docker run -it --privileged -v /dev:/dev -v /sys:/sys -v
>>>>>>> /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux
>>>>>>> -v
>>>>>>> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so
>>>>>>> -v
>>>>>>> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1
>>>>>>> -v
>>>>>>> /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so
>>>>>>> -v
>>>>>>> /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1
>>>>>>> -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v
>>>>>>> /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v
>>>>>>> /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p
>>>>>>> 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs
>>>>>>> stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux
>>>>>>>
>>>>>>> *Use default flag file*
>>>>>>>
>>>>>>> *Cannot find
>>>>>>> /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json*
>>>>>>>
>>>>>>>
>>>>>>> I also had peek at the script *start-stratum-container.sh* and
>>>>>>> found an option of *ONLP_ARG="--env WITH_ONLP=false"*
>>>>>>> . So I wanted to ask whether I can set this option with Docker to
>>>>>>> force BSP usage, let us say, by hard-coding it in the script itself (also
>>>>>>> similar approach to set PORT_MAP in *stratume_entrypoint.sh*). I
>>>>>>> tried this and the error message in this case is:
>>>>>>>
>>>>>>>
>>>>>>> *Use default flag file*
>>>>>>>
>>>>>>> *Cannot find /usr/local/share/stratum/.json *
>>>>>>>
>>>>>>> Please suggest.
>>>>>>>
>>>>>>> Thanks,
>>>>>>> Deval.
>>>>>>>
>>>>>>> ------------------------------
>>>>>>> *From:* Yi Tseng <yi at opennetworking.org>
>>>>>>> *Sent:* Thursday, March 12, 2020 6:57 AM
>>>>>>> *To:* Deval Bhamare
>>>>>>> *Cc:* Narada Hess; stratum-dev at lists.stratumproject.org
>>>>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>>>>
>>>>>>> Hi Deval,
>>>>>>>
>>>>>>> We don't support Barefoot thrift APIs in Stratum. We support some
>>>>>>> Barefoot API like port API via gNMI and the chassis config.
>>>>>>>
>>>>>>> For missing JSON file, I can confirm that our internal CI did not
>>>>>>> include the latest Stratum with kernel 3.16.56
>>>>>>>
>>>>>>> I just rebuild it and uploaded the new container image to the Docker
>>>>>>> hub
>>>>>>> <https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>,
>>>>>>> feel free to let me know if the issue still exists.
>>>>>>>
>>>>>>> About the missing library, can you run this command in your shell?
>>>>>>>
>>>>>>> *LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd
>>>>>>> ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf*
>>>>>>>
>>>>>>> I think the system linker may have some issue to find the library.
>>>>>>>
>>>>>>> The *libavago.so.0 *is a symbolic link to *libavago.so*. the
>>>>>>> libavago.so must also exists.
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>> *ls -al $BF_SDE_INSTALL/lib/libavago* -rwxr-xr-x 1 root root 1185264
>>>>>>> Mar 12 04:19 libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>>>>>>> libavago.so.0 -> libavago.so lrwxrwxrwx 1 root root      11 Mar 12 04:19
>>>>>>> libavago.so.0.0.0 -> libavago.so*
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>
>>>>>> --
>>>>>> Yi Tseng
>>>>>> Member of Technical Staff
>>>>>> Open Networking Foundation
>>>>>> https://www.opennetworking.org/
>>>>>>
>>>>>
>>>>>
>>>>> --
>>>>> Yi Tseng
>>>>> Member of Technical Staff
>>>>> Open Networking Foundation
>>>>> https://www.opennetworking.org/
>>>>> _______________________________________________
>>>>> stratum-dev mailing list
>>>>> stratum-dev at lists.stratumproject.org
>>>>> https://lists.stratumproject.org/listinfo/stratum-dev
>>>>
>>>>
>>
>> --
>> Yi Tseng
>> Member of Technical Staff
>> Open Networking Foundation
>> https://www.opennetworking.org/
>>
>
>
> --
> Yi Tseng
> Member of Technical Staff
> Open Networking Foundation
> https://www.opennetworking.org/
>


-- 
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200417/ed0950fe/attachment-0001.html>

From Deval.Bhamare at kau.se  Fri Apr 17 10:54:25 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Fri, 17 Apr 2020 10:54:25 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <CAOyFVR3wZVuHZcBJ9i3g2oB=aRCom9-F89M3ePyaDi=P0454OA@mail.gmail.com>
References: <4497e28827f44eebbab214abfb0d0cfa@kau.se>
 <CAOyFVR26WzkbQJHqvXZa=_o58HQ-L_K6n-ajQjKSv4WssMK1dw@mail.gmail.com>
 <4c4e0a1056704cecac75294f81017fe0@kau.se>,
 <CAOyFVR3wZVuHZcBJ9i3g2oB=aRCom9-F89M3ePyaDi=P0454OA@mail.gmail.com>
Message-ID: <44319c03aa774868898d64f94fae926e@kau.se>

Ok, so it means standard pre-built container without ONL (with WITH_ONLP=false),  refers to


stratum/stratum/hal/bin/barefoot/platforms/x86-64-stordis-bf2556x-1t-r0.json ???


Also, does it make use of chasis_config.pb.txt in /stratum/stratum/hal/config/x86-64-stordis-bf2556x-1t-r0 as well?



Because when Strarum starts and we try to check the port status with bf-sde.pm> show, we don't see any port.  we tried modifying the chasis_config for the below options as stated in the git.


autoneg: TRI_STATE_TRUE
    fec_mode: FEC_MODE_ON

But it didn't work either.

________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Friday, April 17, 2020 9:51:35 AM
To: Deval Bhamare
Cc: max at opennetworking.org; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

The container script tells the container entry point to use the Stratum binary which doesn't link to ONLP library and uses a specific port map for the platform.

To include the BSP to current container, you can modify the build script<https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/build-stratum-bf-container.sh> and the Dockerfile<https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/Dockerfile.builder#L39> to include the BSP option when it invokes the p4studio script.

Yi

On Thu, Apr 16, 2020 at 8:50 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi and team,


With reference to your email below:


The current way to support Stratum + BSP is to build the SDE, BSP, and Stratum on the switch


>> Does it mean, pre-built Stratum container cannot be used with BSP? Then what is the meaning of below flag in the container start script?


ONLP_ARG="--env WITH_ONLP=false \ -
-env PLATFORM=x86-64-accton-wedge100bf-32x-r0"




Isn't the above option mean stratum will use BSP?  If not, then with ONLP false and without BSP, how will switch work? Is it by reading the JSON for the specified platform above (x86-64-accton-wedge100bf-32x-r0)?


can you please explain?


Note: We still are facing errors when we tr yo build stratum with BSP.


Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, April 2, 2020 2:02:40 PM
To: Deval Bhamare
Cc: max at opennetworking.org<mailto:max at opennetworking.org>; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

The Stratum container image does not include the BSP library from each vendor since the origin goal is to use a general open-source platform library from ONL.

The current way to support Stratum + BSP is to build the SDE, BSP, and Stratum on the switch (you can also build it on the server and copy every necessary libraries and files to the switch). Also, I believed that you can build everything(SDE, BSP, Stratum) on a Ubuntu-based switch and run it.

I've tested to build SDE, BSP, and Stratum on out BF2556X and I can confirm that ONOS can connect to the Stratum.
Currently, we are using ONL-based OS in our lab. I can try re-installed the switch to Ubuntu-based once I can access the hardware.

Yi


On Mon, Mar 30, 2020 at 8:25 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,


So as per my understanding, when we use pre-built docker version of the Stratum, it doesn't refer to local locally built BSP and BF-SDE. Instead it uses its own pre-build BF-SDE and BSP. Is it correct?


In that case, with reference to the email from Stordis-support below, I would like to confirm that below point have been taken care of while building the updated docker image.


Stordis_support message:


"It is important that you build the BSP with the --with-tof-brgup-plat option that you can also pass through the p4studio_build script (see installation guide). Be sure to spell it correctly, or else p4studio_build will silently ignore the option and build the BSP incorrectly… (there will be just a log entry in the installation log saying that the option was unknown)

Note too that there was a problem in the BSP zip file that is available on our FTP server – the bf-platforms.tgz in the packages directory was actually the reference BSP version. If you had used this tgz (instead of the bf-platforms directory that is present in the directory above), the BSP would have been built incorrectly too. In the meantime I have uploaded a corrected version of the zip file to our FTP server."



Can you please confirm?


Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Monday, March 30, 2020 7:32:05 AM
To: Deval Bhamare
Cc: max at opennetworking.org<mailto:max at opennetworking.org>; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We've updated the container image and the script to start the container:
https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/start-stratum-container.sh

You can now try the following command to start the Stratum container with no ONLP support:
PLATFORM=x86-64-stordis-bf2556x-1t-r0 SDE_VERSION=8.9.2 ./start-stratum-container.sh

For the "unimplemented" message you saw, the SDE 8.9.2 uses old version PI library which doesn't implement some features (reading default entry from a table).
You can ignore that warning or use a newer version of Stratum (with SDE >= 9.0.0)

Yi


On Sun, Mar 29, 2020 at 8:31 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,



Just don't want to overload with the information, but I wanted to mention that, with the pre-built docker image option, I had a look a the ./start-stratum-container.sh


Since I want to run Stratum with BSP, I made a change as:


ONLP_ARG="--env WITH_ONLP=false"


Then I started the container 8.9.2-3.16.56-OpenNetworkLinux and it executed the Stratum successfully. Stratum open bf-sde prompt.


Also ss ouptput is:


State      Recv-Q Send-Q          Local Address:Port                         Peer Address:Port

LISTEN     0      128                         *:28000                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=36))

LISTEN     0      128                 127.0.0.1:28000<http://127.0.0.1:28000>                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=35))

LISTEN     0      128                 127.0.0.1:28003<http://127.0.0.1:28003>                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=32))

LISTEN     0      5                           *:9999                                    *:*                   users:(("stratum_bf_no_o",pid=10,fd=27))


I am getting following messages now:


 ONOS-CLI logs for the confirmation below:


tofino at root > devices                                                                                 22:02:35

id=device:tofino, available=true, local-status=connected 4m52s ago, role=MASTER, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=1<http://127.0.0.1:28000?device_id=1>, name=device:tofino, p4DeviceId=1, protocol=P4Runtime, gNMI, gNOI


Logs on stratum bf-sde are:


bf-sde.lld> E0329 22:01:52.649449   249 PI-device_mgr.cpp:0] Reading default entry not supported yet

E0329 22:01:52.649509   249 pi_node.cc:187] Return Error: toUtilStatus(status, details) failed with generic::unimplemented:

E0329 22:01:52.649549   249 p4_service.cc:307] Failed to read forwarding entries from node 1:


ONOS Logs:


2020-03-29T22:08:22,649 | WARN  | grpc-default-executor-4 | P4RuntimeClientImpl              | 230 - org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Error while performing READ on device:tofino: UNIMPLEMENTED



So, now ONOS can talk to Tofino through Stratum, but there are a few errors. First of all, is it OK to explicitly use this option: "--env WITH_ONLP=false" If yes, am I missing some steps here?  Any suggestion?



(Note: If I use default value of ONLP_ARG as per the original script, I get error as:


Use default flag file

Cannot find /usr/local/lib/modules/bf_kdrv.ko, skip installing the Kernel module

/usr/local/bin/stratum_bf: symbol lookup error: /usr/local/bin/stratum_bf: undefined symbol: onlp_sw_init

)



Thank you,


Deval.


________________________________
From: Deval Bhamare
Sent: Sunday, March 29, 2020 12:20:10 PM
To: Maximilian Pudelko
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Maximilian,


There is a littler confusion here. I am not using pre-built containerized version of Stratum.

However, I am locally building it by starting a development container with command "./setup_dev_env.sh  --pull -- -p 28000:28000" (I have mentioned it in the earlier image as well) as mentioned here: https://github.com/stratum/stratum

and then I try to build and run stratum as mentioned here: https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md



Now with the build-from-scratch using development container approach, I followed your steps, however, when I run ss -tnlp from the container (afterdocker exec -ti bash), I get below and listen on  127.0.0.1:28000<http://127.0.0.1:28000> is missing. I get only below.



tofino at 39e19c57ea27:/stratum$ ss -tlnp

State       Recv-Q Send-Q     Local Address:Port                    Peer Address:Port

LISTEN      0      128            127.0.0.1:56929<http://127.0.0.1:56929>                              *:*                   users:(("java",pid=21,fd=110))

LISTEN      0      1                      *:8008                               *:*                   users:(("stratum_bf",pid=310,fd=26))

Command to build Stratum is: bazel build //stratum/hal/bin/barefoot:stratum_bf --define phal_with_onlp=false --define sde_ver=8.9.2

Command to run Stratum is:

     ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
       --external_stratum_urls=0.0.0.0:28000<http://0.0.0.0:28000> \
       --grpc_max_recv_msg_size=256 \
       --bf_sde_install=$BF_SDE_INSTALL \
       --persistent_config_dir=/stratum/config/ \
       --forwarding_pipeline_configs_file=/stratum/config/p4_pipeline.pb.txt \
       --chassis_config_file=/stratum/config/chassis_config.pb.txt \
       --write_req_log_file=/stratum/config/p4_writes.pb.txt \
       --bf_sim




[Note: I had also tried the option of using pre-built docker container, with 8.9.1-3.16.56-OpenNetworkLinux, however, in this case I get error:

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json

I had reported that also and tried new container but didn't work]


Thanks,

Deval.


________________________________
From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Sunday, March 29, 2020 1:46:04 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>; Andreas Kassler
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

There are many things going on in your setup, let's do this step by step:

1. Port 8008 is NOT what you want for ONOS. I'm no Tofino expert, but this seems to be a separate endpoint for something else (debugging?). We always use port 28000.

2. 2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?
Depends. It's probably not good, but as long as you see this line in the Stratum logs, ONOS should be able to connect:
E0328 23:08:15.903065    13 hal.cc:234] Stratum external facing services are listening to 0.0.0.0:28000<http://0.0.0.0:28000>, localhost:28000...
Judging from the missing listening port, I'd say this could be the issue.

3. If you run ONOS in a container too, they have to reside in the same network and you have to figure out the docker-internal IP for the Stratum container:
# docker network ls
NETWORK ID          NAME                DRIVER              SCOPE
e737dd0dd90f        bridge              bridge              local
d2783152be24        host                host                local
7028e832e130        none                null                local

# docker network inspect bridge
[...]
"Containers": {
            "518c901167919d34205959f1105aedebbb99a9452d191409ccf71a3908e14e56": {
                "Name": "zen_jennings",
                "EndpointID": "a52025a671c9968372c52c7ed6b61df5a3168493466bd4b831c4728089b77163",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            }
        },
[...]

You could also try running them in the host network (--network=host), that should make them behave like native processes with fully exposed networking.

4. I used a wrong switch in my previous post, here's how it looks on a Tofino:

  *    ./start-stratum-container.sh (let it run and open new terminal tab)
  *   docker container ls
CONTAINER ID        IMAGE                                                      COMMAND                  CREATED             STATUS              PORTS                      NAMES
518c90116791        stratumproject/stratum-bf:9.1.0-4.14.49-OpenNetworkLinux   "/bin/sh -c /stratum…"   12 minutes ago      Up 12 minutes       0.0.0.0:28000->28000/tcp   zen_jennings
  *   ss -ltnp
LISTEN      0      128                    :::28000                              :::*                   users:(("docker-proxy",pid=1179,fd=4))
  *   docker exec -ti 518c90116791 bash (switch into the Stratum container)
  *   apt update && apt install iproute
  *   ss -tlnp
State       Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN      0      5                       *:9999                                *:*                   users:(("stratum_bf",pid=13,fd=27))
LISTEN      0      128                     *:28000                               *:*                   users:(("stratum_bf",pid=13,fd=40))
LISTEN      0      128             127.0.0.1:28000<http://127.0.0.1:28000>                               *:*                   users:(("stratum_bf",pid=13,fd=39))
LISTEN      0      1                       *:9001                                *:*                   users:(("stratum_bf",pid=13,fd=28))
  *   exit (leave container)
  *   docker run -ti debian:9 bash (Start new container to simulate ONOS)
  *   apt update && apt install netcat
  *   nc -v 172.17.0.2 28000
172.17.0.2<http://172.17.0.2>: inverse host lookup failed: Unknown host
(UNKNOWN) [172.17.0.2] 28000 (?) open

For reference, the used versions:

# docker images
REPOSITORY                  TAG                              IMAGE ID            CREATED             SIZE
stratumproject/stratum-bf   9.1.0-4.14.49-OpenNetworkLinux   e4615d64018f        2 weeks ago         214MB

For reference, these are the versions we use:
# docker version
Client: Docker Engine - Community
 Version:           19.03.2
 API version:       1.40
 Go version:        go1.12.8
 Git commit:        6a30dfca03
 Built:             Thu Aug 29 05:29:49 2019
 OS/Arch:           linux/amd64
 Experimental:      false

Server: Docker Engine - Community
 Engine:
  Version:          19.03.2
  API version:      1.40 (minimum version 1.12)
  Go version:       go1.12.8
  Git commit:       6a30dfca03
  Built:            Thu Aug 29 05:28:23 2019
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.2.6
  GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
 runc:
  Version:          1.0.0-rc8
  GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
 docker-init:
  Version:          0.18.0
  GitCommit:        fec3683

# uname -a
Linux Stordis 4.14.49-OpenNetworkLinux #1 SMP Thu Jul 18 08:52:25 UTC 2019 x86_64 GNU/Linux


Max

On Sat, Mar 28, 2020 at 7:31 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,


Since I could not any port activity on 28000 inside stratum and stratum logs shown only listen activity on 8008, I used following command to do explicitly map the IP/ports to host:


./setup_dev_env.sh  --pull --  -p 192.168.60.131:28008<http://192.168.60.131:28008>:8008


Then I tried to push the netcfg.json with following URL and this time the communication channel is established. Logs from ONOS and stratum are below (BOLD RED).


URL:


"managementAddress": "grpc://192.168.60.131:28008?device_id=0<http://192.168.60.131:28008?device_id=0>",


(I tired both deviceID 0 and 1, but it must be 0 as bf_shell and stratum Log both confirm: )



ONOS:


2020-03-28T13:49:46,158 | WARN  | onos-gdp-0       | PiPipeconfManager                | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Ignoring PortStatisticsDiscovery behaviour from pipeconf vepg-pipeconf, but using the one provided by stratum-tofino driver...

2020-03-28T13:49:46,184 | INFO  | onos-gdp-0       | GrpcChannelControllerImpl        | 230 - org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Creating new gRPC channel grpc://192.168.60.131:28008?device_id=0.<http://192.168.60.131:28008?device_id=0.>.. << #THERE IS SUCCESS HERE THIS TIME AS COMPARED TO PREVIOUS TIME


Stratum:


Tcl server: connection accepted on port 8008

Partial recv: 30 of 40 so far..  <<#STRATUM CONFIRMS IT



However, I am not sure, it is the correct entry point? The reason is ONOS still cannot find the device:tofino (highlighted Yellow RED)


2020-03-28T13:49:46,306 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Local role is MASTER for device:tofino

2020-03-28T13:49:46,311 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,313 | INFO  | onos-gdp-0       | GeneralDeviceProvider            | 235 - org.onosproject.onos-providers-general-device - 2.4.0.SNAPSHOT | Notifying role MASTER (preference 0) for term 1 to device:tofino

2020-03-28T13:49:46,315 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,316 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.    <<#STILL NO DEVICE FOUND. I TRIED BOTH ID 0 and 1 in the URL

2020-03-28T13:49:46,317 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-28T13:49:46,320 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,336 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=12233603415182, creationTime=1585403386336, computeCost=124274, clusters=0, devices=0, links=0} changed

2020-03-28T13:49:46,365 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered




Please confirm, is it in the right direction or port 8008 is completely different? What can be the reason for device:tofino not able to find?


Thank you,

Deval.


________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org<mailto:stratum-dev-bounces at lists.stratumproject.org>> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>>
Sent: Saturday, March 28, 2020 3:22:16 PM
To: Maximilian Pudelko
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Maximilian,


Thank you for your reply and the useful suggestions. So as a first step I executed on switch ss -tnlp and below is the output. Surprisingly, there is no Stratum anywhere there, however statrum is also running in a container and the short logs are displayed below. I also executed ss command inside the container and those are also pasted below, if that may help.


ss -tnlp outputs in different times are as follows:


- from tofino, before anything is started:


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*



- from tofino after stratum container is started


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from tofino after stratum is running


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from stratum container, after running it in background


tofino at ced0c4d7ef8f:/stratum$ ss -tnlp

State      Recv-Q Send-Q Local Address:Port                Peer Address:Port

LISTEN     0      1                  *:8008                           *:*                   users:(("stratum_bf",pid=323,fd=26)) << #IS this useful?

LISTEN     0      128        127.0.0.1:41418<http://127.0.0.1:41418>                          *:*                   users:(("java",pid=21,fd=110))


Why there is no 28000 port here in Stratum container SS output. Or should I bind 8008 to 28000 on switch?

As you have mentioned, I have already taken care of port mapping. So I run the container with -p28000:2000. It is verified in the outputs above as well.


- Docker output on switch


tofino at localhost:~$ docker ps

CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                      NAMES

ced0c4d7ef8f        stratum-dev         "bash"              16 minutes ago      Up 16 minutes       0.0.0.0:28000->28000/tcp   goofy_hamilton



- Stratum log output after it started.


bf_sysfs_fname /sys/class/bf/bf0/device/dev_add

Install dir: /stratum/bf-sde-8.9.0/install (0x7f876b794b60)

bf_switchd: system services initialized

bf_switchd: loading conf_file stratum/hal/bin/barefoot/tofino_skip_p4.conf...

bf_switchd: processing device configuration...

Configuration for dev_id 0

  Family        : Tofino

  pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0

  pci_domain    : 0

  pci_bus       : 5

  pci_fn        : 0

  pci_dev       : 0

  pci_int_mode  : 1

  sbus_master_fw: /stratum/bf-sde-8.9.0/install/

  pcie_fw       : /stratum/bf-sde-8.9.0/install/

  serdes_fw     : /stratum/bf-sde-8.9.0/install/

  sds_fw_path   : /stratum/bf-sde-8.9.0/install/

  microp_fw_path:

bf_switchd: processing P4 configuration...

P4 profile for dev_id 0

  p4_name: dummy

    libpd:

    libpdthrift:

    context:

    config:

  Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so

  diag:

  mavericks diag:

  non_default_port_ppgs: 0

  SAI default initialize: 1

bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so loaded

bf_switchd: agent[0] initialized

Tcl server started..

Tcl server: listen socket created

Tcl server: bind done on port 8008, listening...

Tcl server: waiting for incoming connections...

sh: 1: onie-syseeprom: not found

2020-03-28 13:06:53.584090 BF_PLTFM ERROR - Error in cp2112 initialization


2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?



Thank you.

Deval


________________________________
From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Saturday, March 28, 2020 3:43:29 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

can you run this command on the switch: ss -tlnp
Should output something like this:
State      Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN     0      128                     *:22                                  *:*                   users:(("sshd",pid=4116,fd=3))
LISTEN     0      128                    :::22                                 :::*                   users:(("sshd",pid=4116,fd=4))
LISTEN     0      128      ::ffff:127.0.0.1:28000<http://127.0.0.1:28000>                              :::*                   users:(("stratum_bcm",pid=26872,fd=19))
LISTEN     0      128                    :::28001                              :::*                   users:(("stratum_bcm",pid=26872,fd=20))
LISTEN     0      128      ::ffff:127.0.0.1:28003<http://127.0.0.1:28003>                              :::*                   users:(("stratum_bcm",pid=26872,fd=6))

Also, do you have any logs from Stratum? Run with -v=1 -stderrthreshold=0

Since you're using docker, I assume there is some issue with port forwarding/mapping. Follow these steps to check the port mapping: https://docs.docker.com/engine/reference/commandline/port/
And these steps to fix it:
https://stackoverflow.com/questions/22111060/what-is-the-difference-between-expose-and-publish-in-docker
https://docs.docker.com/config/containers/container-networking/#published-ports

Max


On Thu, Mar 26, 2020 at 3:53 PM Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:

Hello Yi,


I am running both ONOS and stratum container on the same machine, that is the tofino switch with public IP 192.168.60.131.


So I tried with grpc://192.168.60.131:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", as well now. This time message is connection refused and still no connectivity.




2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.

2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264511977012, creationTime=1585262479736, computeCost=117691, clusters=0, devices=0, links=0} changed

2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | device:tofino is unreachable (Connection refused: /192.168.60.131:28000<http://192.168.60.131:28000>)

2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264549921343, creationTime=1585262479774, computeCost=101378, clusters=0, devices=0, links=0} changed


With grpc://127.0.0.1:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", the error is


onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason


Also Stratum logs say


bf_switchd: processing P4 configuration...

P4 profile for dev_id 0


while starting, so I doubt device ID maybe 0 and hence tried with both device_id=1<http://192.168.0.101:28000/?device_id=1> and device_id=<http://192.168.0.101:28000/?device_id=1>0 but no luck.



Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 26, 2020 9:10:49 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

Where you are running the ONOS controller? If you are running the ONOS controller on a server, you need to set the management address to your switch IP address.

For example, you run the ONOS on a server with IP address 192.168.0.100 and running the Stratum on a switch with IP address 192.168.0.101. (And I assume that you have connectivity between the server and the switch)

The netcfg.json will look like:

{
  "devices": {
    "device:tofino": {
      "basic": {
        "managementAddress": "grpc://192.168.0.101:28000?device_id=1<http://192.168.0.101:28000?device_id=1>",
        "driver": "stratum-tofino",
        "pipeconf": "[your pipeconf name]"
       }
    }
   }
}

Please also note that the device ID is 1 in the Stratum

Yi


On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


We have received a reply from Stordis and as per their suggestion, we can ignore the syseeprom error


You see only syseeprom errorr please ignore that :
Tcl server: listen socket created
Tcl server: bind done on port 8008, listening...
Tcl server: waiting for incoming connections...
sh: 1: onie-syseeprom: not found <Ignore this error>
Health monitor started
Operational mode set to ASIC



So, now when I try to push the netcfg.json for our device to Onos, I get following message:


2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452353961040, creationTime=1585173541276, computeCost=427068, clusters=0, devices=0, links=0} changed

2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason

2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452397561034, creationTime=1585173541319, computeCost=112832, clusters=0, devices=0, links=0} changed



ONOS CLI show, device available=false.


tofino at root > devices                                                        21:58:49

id=device:tofino, available=false, local-status=disconnected 37s ago, role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0<http://127.0.0.1:28000?device_id=0>, name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI



Netcfg.json contents are:

{
        "devices": {
        "device:tofino": {
        "basic": {
        "managementAddress": "grpc://127.0.0.1?device_id=0<http://127.0.0.1?device_id=0>",
        "driver": "stratum-tofino",
        "pipeconf": "vepg-pipeconf"
        }
        }
        }
        }


Command is:


curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H 'Content-Type:application/json' 'http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json



Any idea what may be the issue?


Thanks,

Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Tuesday, March 24, 2020 3:25:06 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

I am now working on updating the script to support the custom platform parameter<https://github.com/stratum/stratum/pull/150> since the Stratum cannot detect the platform without the ONLP.

Should be merged soon.

On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux, however, the error still persists:


+ KERNEL_VERSION=3.16.64-OpenNetworkLinux

+ DOCKER_IMAGE=stratumproject/stratum-bf

+ DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux

++ uname -r

++ uname -r

+ docker run -it --privileged -v /dev:/dev -v /sys:/sys -v /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1 -v /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so -v /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1 -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux

Use default flag file

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json



I also had peek at the script start-stratum-container.sh and found an option of ONLP_ARG="--env WITH_ONLP=false"
. So I wanted to ask whether I can set this option with Docker to force BSP usage, let us say, by hard-coding it in the script itself (also similar approach to set PORT_MAP in stratume_entrypoint.sh). I tried this and the error message in this case is:


Use default flag file

Cannot find /usr/local/share/stratum/.json

Please suggest.

Thanks,
Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 12, 2020 6:57 AM
To: Deval Bhamare
Cc: Narada Hess; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>, feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf

I think the system linker may have some issue to find the library.

The libavago.so.0 is a symbolic link to libavago.so. the libavago.so must also exists.
ls -al $BF_SDE_INSTALL/lib/libavago*
-rwxr-xr-x 1 root root 1185264 Mar 12 04:19 libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0 -> libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0 -> libavago.so




--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200417/075a2ebd/attachment-0001.html>

From Deval.Bhamare at kau.se  Mon Apr 20 09:26:58 2020
From: Deval.Bhamare at kau.se (Deval Bhamare)
Date: Mon, 20 Apr 2020 09:26:58 +0000
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <ba6c91b439bf4231818f53926615cb4d@kau.se>
References: <4497e28827f44eebbab214abfb0d0cfa@kau.se>
 <CAOyFVR26WzkbQJHqvXZa=_o58HQ-L_K6n-ajQjKSv4WssMK1dw@mail.gmail.com>
 <4c4e0a1056704cecac75294f81017fe0@kau.se>,
 <CAOyFVR3wZVuHZcBJ9i3g2oB=aRCom9-F89M3ePyaDi=P0454OA@mail.gmail.com>,
 <0101017187c6a088-c383d1d1-59af-4c92-8e14-305ed0ac43ef-000000@us-west-2.amazonses.com>,
 <ba6c91b439bf4231818f53926615cb4d@kau.se>
Message-ID: <f79a062822704b36883b51ff57d2dddd@kau.se>

Hello Team,


We are waiting for your reply. We need to know where we put updated JSON and CONFIG files on the local machine, so that we get them in the docker container?


(As I mentioned earlier, I have put updated json in stratum/stratum/hal/bin/barefoot/platforms/x86-64-stordis-bf2556x-1t-r0.json, but the docker container still shoes the old json)


We can't see any port, neither we get any traffic on the ports.


Thanks,


Deval.



________________________________
From: Deval Bhamare
Sent: Friday, April 17, 2020 9:29 PM
To: Yi Tseng
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hi Yi,


One more follow-up question:


I can see in Dockerfile.runtime, the following command:


cp $STRATUM_BF_BASE/platforms/*.json $OUTPUT_BASE/share/stratum/


I assume it copies all needed json files to the /usr/local/share/stratum/ directory of container from local stratum/hal/bin/barefoot/platforms directory. Is it correct?


because if I make any changes to the concerned json file, they are not getting reflected in docker container, nor in the stratum.  I still see the old original json in the container (using docker exec -ti command)


Can you please explain how this docker runfile works? where should I place the modified exactly?


Thanks,

Deval.


________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org>
Sent: Friday, April 17, 2020 1:54:33 PM
To: Yi Tseng
Cc: stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Ok, so it means standard pre-built container without ONL (with WITH_ONLP=false),  refers to


stratum/stratum/hal/bin/barefoot/platforms/x86-64-stordis-bf2556x-1t-r0.json ???


Also, does it make use of chasis_config.pb.txt in /stratum/stratum/hal/config/x86-64-stordis-bf2556x-1t-r0 as well?



Because when Strarum starts and we try to check the port status with bf-sde.pm> show, we don't see any port.  we tried modifying the chasis_config for the below options as stated in the git.


autoneg: TRI_STATE_TRUE
    fec_mode: FEC_MODE_ON

But it didn't work either.

________________________________
From: Yi Tseng <yi at opennetworking.org>
Sent: Friday, April 17, 2020 9:51:35 AM
To: Deval Bhamare
Cc: max at opennetworking.org; stratum-dev at lists.stratumproject.org
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

The container script tells the container entry point to use the Stratum binary which doesn't link to ONLP library and uses a specific port map for the platform.

To include the BSP to current container, you can modify the build script<https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/build-stratum-bf-container.sh> and the Dockerfile<https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/Dockerfile.builder#L39> to include the BSP option when it invokes the p4studio script.

Yi

On Thu, Apr 16, 2020 at 8:50 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi and team,


With reference to your email below:


The current way to support Stratum + BSP is to build the SDE, BSP, and Stratum on the switch


>> Does it mean, pre-built Stratum container cannot be used with BSP? Then what is the meaning of below flag in the container start script?


ONLP_ARG="--env WITH_ONLP=false \ -
-env PLATFORM=x86-64-accton-wedge100bf-32x-r0"




Isn't the above option mean stratum will use BSP?  If not, then with ONLP false and without BSP, how will switch work? Is it by reading the JSON for the specified platform above (x86-64-accton-wedge100bf-32x-r0)?


can you please explain?


Note: We still are facing errors when we tr yo build stratum with BSP.


Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, April 2, 2020 2:02:40 PM
To: Deval Bhamare
Cc: max at opennetworking.org<mailto:max at opennetworking.org>; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

The Stratum container image does not include the BSP library from each vendor since the origin goal is to use a general open-source platform library from ONL.

The current way to support Stratum + BSP is to build the SDE, BSP, and Stratum on the switch (you can also build it on the server and copy every necessary libraries and files to the switch). Also, I believed that you can build everything(SDE, BSP, Stratum) on a Ubuntu-based switch and run it.

I've tested to build SDE, BSP, and Stratum on out BF2556X and I can confirm that ONOS can connect to the Stratum.
Currently, we are using ONL-based OS in our lab. I can try re-installed the switch to Ubuntu-based once I can access the hardware.

Yi


On Mon, Mar 30, 2020 at 8:25 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,


So as per my understanding, when we use pre-built docker version of the Stratum, it doesn't refer to local locally built BSP and BF-SDE. Instead it uses its own pre-build BF-SDE and BSP. Is it correct?


In that case, with reference to the email from Stordis-support below, I would like to confirm that below point have been taken care of while building the updated docker image.


Stordis_support message:


"It is important that you build the BSP with the --with-tof-brgup-plat option that you can also pass through the p4studio_build script (see installation guide). Be sure to spell it correctly, or else p4studio_build will silently ignore the option and build the BSP incorrectly… (there will be just a log entry in the installation log saying that the option was unknown)

Note too that there was a problem in the BSP zip file that is available on our FTP server – the bf-platforms.tgz in the packages directory was actually the reference BSP version. If you had used this tgz (instead of the bf-platforms directory that is present in the directory above), the BSP would have been built incorrectly too. In the meantime I have uploaded a corrected version of the zip file to our FTP server."



Can you please confirm?


Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Monday, March 30, 2020 7:32:05 AM
To: Deval Bhamare
Cc: max at opennetworking.org<mailto:max at opennetworking.org>; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We've updated the container image and the script to start the container:
https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/start-stratum-container.sh

You can now try the following command to start the Stratum container with no ONLP support:
PLATFORM=x86-64-stordis-bf2556x-1t-r0 SDE_VERSION=8.9.2 ./start-stratum-container.sh

For the "unimplemented" message you saw, the SDE 8.9.2 uses old version PI library which doesn't implement some features (reading default entry from a table).
You can ignore that warning or use a newer version of Stratum (with SDE >= 9.0.0)

Yi


On Sun, Mar 29, 2020 at 8:31 PM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,



Just don't want to overload with the information, but I wanted to mention that, with the pre-built docker image option, I had a look a the ./start-stratum-container.sh


Since I want to run Stratum with BSP, I made a change as:


ONLP_ARG="--env WITH_ONLP=false"


Then I started the container 8.9.2-3.16.56-OpenNetworkLinux and it executed the Stratum successfully. Stratum open bf-sde prompt.


Also ss ouptput is:


State      Recv-Q Send-Q          Local Address:Port                         Peer Address:Port

LISTEN     0      128                         *:28000                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=36))

LISTEN     0      128                 127.0.0.1:28000<http://127.0.0.1:28000>                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=35))

LISTEN     0      128                 127.0.0.1:28003<http://127.0.0.1:28003>                                   *:*                   users:(("stratum_bf_no_o",pid=10,fd=32))

LISTEN     0      5                           *:9999                                    *:*                   users:(("stratum_bf_no_o",pid=10,fd=27))


I am getting following messages now:


 ONOS-CLI logs for the confirmation below:


tofino at root > devices                                                                                 22:02:35

id=device:tofino, available=true, local-status=connected 4m52s ago, role=MASTER, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=1<http://127.0.0.1:28000?device_id=1>, name=device:tofino, p4DeviceId=1, protocol=P4Runtime, gNMI, gNOI


Logs on stratum bf-sde are:


bf-sde.lld> E0329 22:01:52.649449   249 PI-device_mgr.cpp:0] Reading default entry not supported yet

E0329 22:01:52.649509   249 pi_node.cc:187] Return Error: toUtilStatus(status, details) failed with generic::unimplemented:

E0329 22:01:52.649549   249 p4_service.cc:307] Failed to read forwarding entries from node 1:


ONOS Logs:


2020-03-29T22:08:22,649 | WARN  | grpc-default-executor-4 | P4RuntimeClientImpl              | 230 - org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Error while performing READ on device:tofino: UNIMPLEMENTED



So, now ONOS can talk to Tofino through Stratum, but there are a few errors. First of all, is it OK to explicitly use this option: "--env WITH_ONLP=false" If yes, am I missing some steps here?  Any suggestion?



(Note: If I use default value of ONLP_ARG as per the original script, I get error as:


Use default flag file

Cannot find /usr/local/lib/modules/bf_kdrv.ko, skip installing the Kernel module

/usr/local/bin/stratum_bf: symbol lookup error: /usr/local/bin/stratum_bf: undefined symbol: onlp_sw_init

)



Thank you,


Deval.


________________________________
From: Deval Bhamare
Sent: Sunday, March 29, 2020 12:20:10 PM
To: Maximilian Pudelko
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Maximilian,


There is a littler confusion here. I am not using pre-built containerized version of Stratum.

However, I am locally building it by starting a development container with command "./setup_dev_env.sh  --pull -- -p 28000:28000" (I have mentioned it in the earlier image as well) as mentioned here: https://github.com/stratum/stratum

and then I try to build and run stratum as mentioned here: https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md



Now with the build-from-scratch using development container approach, I followed your steps, however, when I run ss -tnlp from the container (afterdocker exec -ti bash), I get below and listen on  127.0.0.1:28000<http://127.0.0.1:28000> is missing. I get only below.



tofino at 39e19c57ea27:/stratum$ ss -tlnp

State       Recv-Q Send-Q     Local Address:Port                    Peer Address:Port

LISTEN      0      128            127.0.0.1:56929<http://127.0.0.1:56929>                              *:*                   users:(("java",pid=21,fd=110))

LISTEN      0      1                      *:8008                               *:*                   users:(("stratum_bf",pid=310,fd=26))

Command to build Stratum is: bazel build //stratum/hal/bin/barefoot:stratum_bf --define phal_with_onlp=false --define sde_ver=8.9.2

Command to run Stratum is:

     ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
       --external_stratum_urls=0.0.0.0:28000<http://0.0.0.0:28000> \
       --grpc_max_recv_msg_size=256 \
       --bf_sde_install=$BF_SDE_INSTALL \
       --persistent_config_dir=/stratum/config/ \
       --forwarding_pipeline_configs_file=/stratum/config/p4_pipeline.pb.txt \
       --chassis_config_file=/stratum/config/chassis_config.pb.txt \
       --write_req_log_file=/stratum/config/p4_writes.pb.txt \
       --bf_sim




[Note: I had also tried the option of using pre-built docker container, with 8.9.1-3.16.56-OpenNetworkLinux, however, in this case I get error:

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json

I had reported that also and tried new container but didn't work]


Thanks,

Deval.


________________________________
From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Sunday, March 29, 2020 1:46:04 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>; Andreas Kassler
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

There are many things going on in your setup, let's do this step by step:

1. Port 8008 is NOT what you want for ONOS. I'm no Tofino expert, but this seems to be a separate endpoint for something else (debugging?). We always use port 28000.

2. 2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?
Depends. It's probably not good, but as long as you see this line in the Stratum logs, ONOS should be able to connect:
E0328 23:08:15.903065    13 hal.cc:234] Stratum external facing services are listening to 0.0.0.0:28000<http://0.0.0.0:28000>, localhost:28000...
Judging from the missing listening port, I'd say this could be the issue.

3. If you run ONOS in a container too, they have to reside in the same network and you have to figure out the docker-internal IP for the Stratum container:
# docker network ls
NETWORK ID          NAME                DRIVER              SCOPE
e737dd0dd90f        bridge              bridge              local
d2783152be24        host                host                local
7028e832e130        none                null                local

# docker network inspect bridge
[...]
"Containers": {
            "518c901167919d34205959f1105aedebbb99a9452d191409ccf71a3908e14e56": {
                "Name": "zen_jennings",
                "EndpointID": "a52025a671c9968372c52c7ed6b61df5a3168493466bd4b831c4728089b77163",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            }
        },
[...]

You could also try running them in the host network (--network=host), that should make them behave like native processes with fully exposed networking.

4. I used a wrong switch in my previous post, here's how it looks on a Tofino:

  *    ./start-stratum-container.sh (let it run and open new terminal tab)
  *   docker container ls
CONTAINER ID        IMAGE                                                      COMMAND                  CREATED             STATUS              PORTS                      NAMES
518c90116791        stratumproject/stratum-bf:9.1.0-4.14.49-OpenNetworkLinux   "/bin/sh -c /stratum…"   12 minutes ago      Up 12 minutes       0.0.0.0:28000->28000/tcp   zen_jennings
  *   ss -ltnp
LISTEN      0      128                    :::28000                              :::*                   users:(("docker-proxy",pid=1179,fd=4))
  *   docker exec -ti 518c90116791 bash (switch into the Stratum container)
  *   apt update && apt install iproute
  *   ss -tlnp
State       Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN      0      5                       *:9999                                *:*                   users:(("stratum_bf",pid=13,fd=27))
LISTEN      0      128                     *:28000                               *:*                   users:(("stratum_bf",pid=13,fd=40))
LISTEN      0      128             127.0.0.1:28000<http://127.0.0.1:28000>                               *:*                   users:(("stratum_bf",pid=13,fd=39))
LISTEN      0      1                       *:9001                                *:*                   users:(("stratum_bf",pid=13,fd=28))
  *   exit (leave container)
  *   docker run -ti debian:9 bash (Start new container to simulate ONOS)
  *   apt update && apt install netcat
  *   nc -v 172.17.0.2 28000
172.17.0.2<http://172.17.0.2>: inverse host lookup failed: Unknown host
(UNKNOWN) [172.17.0.2] 28000 (?) open

For reference, the used versions:

# docker images
REPOSITORY                  TAG                              IMAGE ID            CREATED             SIZE
stratumproject/stratum-bf   9.1.0-4.14.49-OpenNetworkLinux   e4615d64018f        2 weeks ago         214MB

For reference, these are the versions we use:
# docker version
Client: Docker Engine - Community
 Version:           19.03.2
 API version:       1.40
 Go version:        go1.12.8
 Git commit:        6a30dfca03
 Built:             Thu Aug 29 05:29:49 2019
 OS/Arch:           linux/amd64
 Experimental:      false

Server: Docker Engine - Community
 Engine:
  Version:          19.03.2
  API version:      1.40 (minimum version 1.12)
  Go version:       go1.12.8
  Git commit:       6a30dfca03
  Built:            Thu Aug 29 05:28:23 2019
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.2.6
  GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
 runc:
  Version:          1.0.0-rc8
  GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
 docker-init:
  Version:          0.18.0
  GitCommit:        fec3683

# uname -a
Linux Stordis 4.14.49-OpenNetworkLinux #1 SMP Thu Jul 18 08:52:25 UTC 2019 x86_64 GNU/Linux


Max

On Sat, Mar 28, 2020 at 7:31 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello again,


Since I could not any port activity on 28000 inside stratum and stratum logs shown only listen activity on 8008, I used following command to do explicitly map the IP/ports to host:


./setup_dev_env.sh  --pull --  -p 192.168.60.131:28008<http://192.168.60.131:28008>:8008


Then I tried to push the netcfg.json with following URL and this time the communication channel is established. Logs from ONOS and stratum are below (BOLD RED).


URL:


"managementAddress": "grpc://192.168.60.131:28008?device_id=0<http://192.168.60.131:28008?device_id=0>",


(I tired both deviceID 0 and 1, but it must be 0 as bf_shell and stratum Log both confirm: )



ONOS:


2020-03-28T13:49:46,158 | WARN  | onos-gdp-0       | PiPipeconfManager                | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Ignoring PortStatisticsDiscovery behaviour from pipeconf vepg-pipeconf, but using the one provided by stratum-tofino driver...

2020-03-28T13:49:46,184 | INFO  | onos-gdp-0       | GrpcChannelControllerImpl        | 230 - org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Creating new gRPC channel grpc://192.168.60.131:28008?device_id=0.<http://192.168.60.131:28008?device_id=0.>.. << #THERE IS SUCCESS HERE THIS TIME AS COMPARED TO PREVIOUS TIME


Stratum:


Tcl server: connection accepted on port 8008

Partial recv: 30 of 40 so far..  <<#STRATUM CONFIRMS IT



However, I am not sure, it is the correct entry point? The reason is ONOS still cannot find the device:tofino (highlighted Yellow RED)


2020-03-28T13:49:46,306 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Local role is MASTER for device:tofino

2020-03-28T13:49:46,311 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,313 | INFO  | onos-gdp-0       | GeneralDeviceProvider            | 235 - org.onosproject.onos-providers-general-device - 2.4.0.SNAPSHOT | Notifying role MASTER (preference 0) for term 1 to device:tofino

2020-03-28T13:49:46,315 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,316 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.    <<#STILL NO DEVICE FOUND. I TRIED BOTH ID 0 and 1 in the URL

2020-03-28T13:49:46,317 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-28T13:49:46,320 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-28T13:49:46,336 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=12233603415182, creationTime=1585403386336, computeCost=124274, clusters=0, devices=0, links=0} changed

2020-03-28T13:49:46,365 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered




Please confirm, is it in the right direction or port 8008 is completely different? What can be the reason for device:tofino not able to find?


Thank you,

Deval.


________________________________
From: stratum-dev <stratum-dev-bounces at lists.stratumproject.org<mailto:stratum-dev-bounces at lists.stratumproject.org>> on behalf of Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>>
Sent: Saturday, March 28, 2020 3:22:16 PM
To: Maximilian Pudelko
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0


Hello Maximilian,


Thank you for your reply and the useful suggestions. So as a first step I executed on switch ss -tnlp and below is the output. Surprisingly, there is no Stratum anywhere there, however statrum is also running in a container and the short logs are displayed below. I also executed ss command inside the container and those are also pasted below, if that may help.


ss -tnlp outputs in different times are as follows:


- from tofino, before anything is started:


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*



- from tofino after stratum container is started


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from tofino after stratum is running


tofino at localhost:~$ ss -tnlp

State      Recv-Q Send-Q                        Local Address:Port                          Peer Address:Port

LISTEN     0      128                                       *:17                                       *:*

LISTEN     0      128                                       *:22                                       *:*

LISTEN     0      128                                       *:23                                       *:*

LISTEN     0      128                          192.168.60.131:10010<http://192.168.60.131:10010>                                    *:*

LISTEN     0      128                                      :::22                                      :::*

LISTEN     0      128                                      :::28000                                   :::*



- from stratum container, after running it in background


tofino at ced0c4d7ef8f:/stratum$ ss -tnlp

State      Recv-Q Send-Q Local Address:Port                Peer Address:Port

LISTEN     0      1                  *:8008                           *:*                   users:(("stratum_bf",pid=323,fd=26)) << #IS this useful?

LISTEN     0      128        127.0.0.1:41418<http://127.0.0.1:41418>                          *:*                   users:(("java",pid=21,fd=110))


Why there is no 28000 port here in Stratum container SS output. Or should I bind 8008 to 28000 on switch?

As you have mentioned, I have already taken care of port mapping. So I run the container with -p28000:2000. It is verified in the outputs above as well.


- Docker output on switch


tofino at localhost:~$ docker ps

CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                      NAMES

ced0c4d7ef8f        stratum-dev         "bash"              16 minutes ago      Up 16 minutes       0.0.0.0:28000->28000/tcp   goofy_hamilton



- Stratum log output after it started.


bf_sysfs_fname /sys/class/bf/bf0/device/dev_add

Install dir: /stratum/bf-sde-8.9.0/install (0x7f876b794b60)

bf_switchd: system services initialized

bf_switchd: loading conf_file stratum/hal/bin/barefoot/tofino_skip_p4.conf...

bf_switchd: processing device configuration...

Configuration for dev_id 0

  Family        : Tofino

  pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0

  pci_domain    : 0

  pci_bus       : 5

  pci_fn        : 0

  pci_dev       : 0

  pci_int_mode  : 1

  sbus_master_fw: /stratum/bf-sde-8.9.0/install/

  pcie_fw       : /stratum/bf-sde-8.9.0/install/

  serdes_fw     : /stratum/bf-sde-8.9.0/install/

  sds_fw_path   : /stratum/bf-sde-8.9.0/install/

  microp_fw_path:

bf_switchd: processing P4 configuration...

P4 profile for dev_id 0

  p4_name: dummy

    libpd:

    libpdthrift:

    context:

    config:

  Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so

  diag:

  mavericks diag:

  non_default_port_ppgs: 0

  SAI default initialize: 1

bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so loaded

bf_switchd: agent[0] initialized

Tcl server started..

Tcl server: listen socket created

Tcl server: bind done on port 8008, listening...

Tcl server: waiting for incoming connections...

sh: 1: onie-syseeprom: not found

2020-03-28 13:06:53.584090 BF_PLTFM ERROR - Error in cp2112 initialization


2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init failed  #<<< CAN IT BE THE ISSUE?



Thank you.

Deval


________________________________
From: Maximilian Pudelko <max at opennetworking.org<mailto:max at opennetworking.org>>
Sent: Saturday, March 28, 2020 3:43:29 AM
To: Deval Bhamare
Cc: Yi Tseng; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

can you run this command on the switch: ss -tlnp
Should output something like this:
State      Recv-Q Send-Q      Local Address:Port                     Peer Address:Port
LISTEN     0      128                     *:22                                  *:*                   users:(("sshd",pid=4116,fd=3))
LISTEN     0      128                    :::22                                 :::*                   users:(("sshd",pid=4116,fd=4))
LISTEN     0      128      ::ffff:127.0.0.1:28000<http://127.0.0.1:28000>                              :::*                   users:(("stratum_bcm",pid=26872,fd=19))
LISTEN     0      128                    :::28001                              :::*                   users:(("stratum_bcm",pid=26872,fd=20))
LISTEN     0      128      ::ffff:127.0.0.1:28003<http://127.0.0.1:28003>                              :::*                   users:(("stratum_bcm",pid=26872,fd=6))

Also, do you have any logs from Stratum? Run with -v=1 -stderrthreshold=0

Since you're using docker, I assume there is some issue with port forwarding/mapping. Follow these steps to check the port mapping: https://docs.docker.com/engine/reference/commandline/port/
And these steps to fix it:
https://stackoverflow.com/questions/22111060/what-is-the-difference-between-expose-and-publish-in-docker
https://docs.docker.com/config/containers/container-networking/#published-ports

Max


On Thu, Mar 26, 2020 at 3:53 PM Deval Bhamare via stratum-dev <stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>> wrote:

Hello Yi,


I am running both ONOS and stratum container on the same machine, that is the tofino switch with public IP 192.168.60.131.


So I tried with grpc://192.168.60.131:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", as well now. This time message is connection refused and still no connectivity.




2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be MASTER role for device:tofino, but this node cannot reach the device.  Relinquishing role.

2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264511977012, creationTime=1585262479736, computeCost=117691, clusters=0, devices=0, links=0} changed

2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | device:tofino is unreachable (Connection refused: /192.168.60.131:28000<http://192.168.60.131:28000>)

2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264549921343, creationTime=1585262479774, computeCost=101378, clusters=0, devices=0, links=0} changed


With grpc://127.0.0.1:28000?device_id=1<http://192.168.0.101:28000/?device_id=1>", the error is


onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason


Also Stratum logs say


bf_switchd: processing P4 configuration...

P4 profile for dev_id 0


while starting, so I doubt device ID maybe 0 and hence tried with both device_id=1<http://192.168.0.101:28000/?device_id=1> and device_id=<http://192.168.0.101:28000/?device_id=1>0 but no luck.



Thanks,


Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 26, 2020 9:10:49 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

Where you are running the ONOS controller? If you are running the ONOS controller on a server, you need to set the management address to your switch IP address.

For example, you run the ONOS on a server with IP address 192.168.0.100 and running the Stratum on a switch with IP address 192.168.0.101. (And I assume that you have connectivity between the server and the switch)

The netcfg.json will look like:

{
  "devices": {
    "device:tofino": {
      "basic": {
        "managementAddress": "grpc://192.168.0.101:28000?device_id=1<http://192.168.0.101:28000?device_id=1>",
        "driver": "stratum-tofino",
        "pipeconf": "[your pipeconf name]"
       }
    }
   }
}

Please also note that the device ID is 1 in the Stratum

Yi


On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


We have received a reply from Stordis and as per their suggestion, we can ignore the syseeprom error


You see only syseeprom errorr please ignore that :
Tcl server: listen socket created
Tcl server: bind done on port 8008, listening...
Tcl server: waiting for incoming connections...
sh: 1: onie-syseeprom: not found <Ignore this error>
Health monitor started
Operational mode set to ASIC



So, now when I try to push the netcfg.json for our device to Onos, I get following message:


2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true, newElectionId=20, masterElectionId=null, sessionOpen=false

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 | ModelCache                       | 211 - org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID device:tofino not found as a UiDevice

2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452353961040, creationTime=1585173541276, computeCost=427068, clusters=0, devices=0, links=0} changed

2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager                    | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Device device:tofino registered

2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 | StreamClientImpl                 | 237 - org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for unknown reason

2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 | TopologyManager                  | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology DefaultTopology{time=20452397561034, creationTime=1585173541319, computeCost=112832, clusters=0, devices=0, links=0} changed



ONOS CLI show, device available=false.


tofino at root > devices                                                        21:58:49

id=device:tofino, available=false, local-status=disconnected 37s ago, role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum, serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf, locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0<http://127.0.0.1:28000?device_id=0>, name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI



Netcfg.json contents are:

{
        "devices": {
        "device:tofino": {
        "basic": {
        "managementAddress": "grpc://127.0.0.1?device_id=0<http://127.0.0.1?device_id=0>",
        "driver": "stratum-tofino",
        "pipeconf": "vepg-pipeconf"
        }
        }
        }
        }


Command is:


curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H 'Content-Type:application/json' 'http://localhost:8181/onos/v1/network/configuration' -d at ./netcfg.json



Any idea what may be the issue?


Thanks,

Deval.


________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Tuesday, March 24, 2020 3:25:06 PM
To: Deval Bhamare
Cc: stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

I am now working on updating the script to support the custom platform parameter<https://github.com/stratum/stratum/pull/150> since the Stratum cannot detect the platform without the ONLP.

Should be merged soon.

On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se<mailto:Deval.Bhamare at kau.se>> wrote:

Hello Yi,


I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux, however, the error still persists:


+ KERNEL_VERSION=3.16.64-OpenNetworkLinux

+ DOCKER_IMAGE=stratumproject/stratum-bf

+ DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux

++ uname -r

++ uname -r

+ docker run -it --privileged -v /dev:/dev -v /sys:/sys -v /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so -v /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1 -v /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so -v /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1 -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux

Use default flag file

Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json



I also had peek at the script start-stratum-container.sh and found an option of ONLP_ARG="--env WITH_ONLP=false"
. So I wanted to ask whether I can set this option with Docker to force BSP usage, let us say, by hard-coding it in the script itself (also similar approach to set PORT_MAP in stratume_entrypoint.sh). I tried this and the error message in this case is:


Use default flag file

Cannot find /usr/local/share/stratum/.json

Please suggest.

Thanks,
Deval.

________________________________
From: Yi Tseng <yi at opennetworking.org<mailto:yi at opennetworking.org>>
Sent: Thursday, March 12, 2020 6:57 AM
To: Deval Bhamare
Cc: Narada Hess; stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
Subject: Re: [stratum-dev] Update Bazel version to 2.2.0

Hi Deval,

We don't support Barefoot thrift APIs in Stratum. We support some Barefoot API like port API via gNMI and the chassis config.

For missing JSON file, I can confirm that our internal CI did not include the latest Stratum with kernel 3.16.56

I just rebuild it and uploaded the new container image to the Docker hub<https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>, feel free to let me know if the issue still exists.

About the missing library, can you run this command in your shell?

LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf

I think the system linker may have some issue to find the library.

The libavago.so.0 is a symbolic link to libavago.so. the libavago.so must also exists.
ls -al $BF_SDE_INSTALL/lib/libavago*
-rwxr-xr-x 1 root root 1185264 Mar 12 04:19 libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0 -> libavago.so
lrwxrwxrwx 1 root root      11 Mar 12 04:19 libavago.so.0.0.0 -> libavago.so




--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
_______________________________________________
stratum-dev mailing list
stratum-dev at lists.stratumproject.org<mailto:stratum-dev at lists.stratumproject.org>
https://lists.stratumproject.org/listinfo/stratum-dev


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/


--
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200420/623c0691/attachment-0001.html>

From yi at opennetworking.org  Mon Apr 20 17:06:48 2020
From: yi at opennetworking.org (Yi Tseng)
Date: Tue, 21 Apr 2020 01:06:48 +0800
Subject: [stratum-dev] Update Bazel version to 2.2.0
In-Reply-To: <f79a062822704b36883b51ff57d2dddd@kau.se>
References: <4497e28827f44eebbab214abfb0d0cfa@kau.se>
 <CAOyFVR26WzkbQJHqvXZa=_o58HQ-L_K6n-ajQjKSv4WssMK1dw@mail.gmail.com>
 <4c4e0a1056704cecac75294f81017fe0@kau.se>
 <CAOyFVR3wZVuHZcBJ9i3g2oB=aRCom9-F89M3ePyaDi=P0454OA@mail.gmail.com>
 <0101017187c6a088-c383d1d1-59af-4c92-8e14-305ed0ac43ef-000000@us-west-2.amazonses.com>
 <ba6c91b439bf4231818f53926615cb4d@kau.se>
 <f79a062822704b36883b51ff57d2dddd@kau.se>
Message-ID: <CAOyFVR2y9KcaP7rsDcmur8pFFqdV0o9YK+1OtGpomknMXnZo=A@mail.gmail.com>

Hi Deval,

Please check my comment *inline*

On Mon, Apr 20, 2020 at 5:27 PM Deval Bhamare <Deval.Bhamare at kau.se> wrote:

> Hello Team,
>
>
> We are waiting for your reply. We need to know *where we put updated JSON
> and CONFIG files on the local *machine, so that we get them in the docker
> container?
>
>
> (As I mentioned earlier, I have put updated json in *
> stratum/stratum/hal/bin/barefoot/platforms/x86-64-stordis-bf2556x-1t-r0.json*
> , but the docker container still shoes the old json)
>
We can't see any port, neither we get any traffic on the ports.
>
>
> Thanks,
>
>
> Deval.
>
>
>
>
> ------------------------------
> *From:* Deval Bhamare
> *Sent:* Friday, April 17, 2020 9:29 PM
> *To:* Yi Tseng
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
>
> Hi Yi,
>
>
> One more follow-up question:
>
>
> I can see in Dockerfile.runtime, the following command:
>
>
> cp $STRATUM_BF_BASE/platforms/*.json $OUTPUT_BASE/share/stratum/
>
>
> I assume it copies all needed json files to the* /usr/local/*
> *share/stratum/* directory *of container* from *local *
> *stratum/hal/bin/barefoot/**platforms directory*. Is it correct?
>
>
> because if I make any changes to the concerned json file, they are
> not getting reflected in docker container, nor in the stratum.  I still see
> the old original json in the container (using docker exec -ti command)
>
>
> Can you please explain how this docker runfile works? where should I place
> the modified exactly?
>
>
> *The docker file describes how the docker engine build the docker
container image.*

*To update the json file, not only place the new file to
stratum/hal/bin/barefoot/platforms, but also rebuild the container image so
the new json file will be placed into the container image.*


> Thanks,
>
> Deval.
>
>
> ------------------------------
> *From:* stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on
> behalf of Deval Bhamare via stratum-dev <
> stratum-dev at lists.stratumproject.org>
> *Sent:* Friday, April 17, 2020 1:54:33 PM
> *To:* Yi Tseng
> *Cc:* stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
>
> Ok, so it means standard pre-built container without ONL (with
> WITH_ONLP=false),  refers to
>
>
>
> *stratum/stratum/hal/bin/barefoot/platforms/x86-64-stordis-bf2556x-1t-r0.json*
> ???
>

*If you set environment variable "PLATFORM=x86-64-stordis-bf2556x-1t-r0".
The start-stratum-container.sh script will pass the platform name and
"WITH_ONLP=false" to the container. And the container entry point will pick
up x86-64-stordis-bf2556x-1t-r0.json file as the port map file.*


>
>
> Also, does it make use of *chasis_config.pb.txt* in /stratum/stratum/hal/config/x86-64-stordis-bf2556x-1t-r0
> as well?
>
>
>
*If you are using non-ONL system, you may also need to modify some
environment variables*
*https://github.com/stratum/stratum/tree/master/stratum/hal/bin/barefoot/docker#environment-variables-for-start-stratum-containersh
<https://github.com/stratum/stratum/tree/master/stratum/hal/bin/barefoot/docker#environment-variables-for-start-stratum-containersh>*


*For example, you need to tell where you want to place config files like
chassis config or phal config *
*https://github.com/stratum/stratum/tree/master/stratum/hal/bin/barefoot/docker#custom-configurations*
<https://github.com/stratum/stratum/tree/master/stratum/hal/bin/barefoot/docker#custom-configurations>

*By default, if the stratum entry point cannot find the chassis config
file, it will use a default empty chassis config*
<https://github.com/stratum/stratum/tree/master/stratum/hal/bin/barefoot/docker#custom-configurations>

>
> Because when Strarum starts and we try to check the port status with *bf-sde.pm
> <http://bf-sde.pm>> show*, we don't see any port.  we tried modifying the
> chasis_config for the below options as stated in the git.
>
>
> autoneg: TRI_STATE_TRUE
>     fec_mode: FEC_MODE_ON
>
> But it didn't work either.
>
> ------------------------------
> *From:* Yi Tseng <yi at opennetworking.org>
> *Sent:* Friday, April 17, 2020 9:51:35 AM
> *To:* Deval Bhamare
> *Cc:* max at opennetworking.org; stratum-dev at lists.stratumproject.org
> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>
> Hi Deval,
>
> The container script tells the container entry point to use the Stratum
> binary which doesn't link to ONLP library and uses a specific port map for
> the platform.
>
> To include the BSP to current container, you can modify the build script
> <https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/build-stratum-bf-container.sh>
> and the Dockerfile
> <https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/Dockerfile.builder#L39>
> to include the BSP option when it invokes the p4studio script.
>
> Yi
>
> On Thu, Apr 16, 2020 at 8:50 PM Deval Bhamare <Deval.Bhamare at kau.se>
> wrote:
>
>> Hello Yi and team,
>>
>>
>> With reference to your email below:
>>
>>
>> The current way to support Stratum + BSP is to build the SDE, BSP, and
>> Stratum on the switch
>>
>>
>> >> Does it mean, pre-built Stratum container cannot be used with BSP?
>> Then what is the meaning of below flag in the container start script?
>>
>>
>> ONLP_ARG="--env WITH_ONLP=false \ -
>> -env PLATFORM=x86-64-accton-wedge100bf-32x-r0"
>>
>> Isn't the above option mean stratum will use BSP?  If not, then with ONLP
>> false and without BSP, how will switch work? Is it by reading the JSON for
>> the specified platform above (x86-64-accton-wedge100bf-32x-r0)?
>>
>>
>> can you please explain?
>>
>>
>> Note: We still are facing errors when we tr yo build stratum with BSP.
>>
>>
>> Thanks,
>>
>>
>> Deval.
>> ------------------------------
>> *From:* Yi Tseng <yi at opennetworking.org>
>> *Sent:* Thursday, April 2, 2020 2:02:40 PM
>> *To:* Deval Bhamare
>> *Cc:* max at opennetworking.org; stratum-dev at lists.stratumproject.org
>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>
>> Hi Deval,
>>
>> The Stratum container image does not include the BSP library from each
>> vendor since the origin goal is to use a general open-source platform
>> library from ONL.
>>
>> The current way to support Stratum + BSP is to build the SDE, BSP, and
>> Stratum on the switch (you can also build it on the server and copy every
>> necessary libraries and files to the switch). Also, I believed that you can
>> build everything(SDE, BSP, Stratum) on a Ubuntu-based switch and run it.
>>
>> I've tested to build SDE, BSP, and Stratum on out BF2556X and I can
>> confirm that ONOS can connect to the Stratum.
>> Currently, we are using ONL-based OS in our lab. I can try re-installed
>> the switch to Ubuntu-based once I can access the hardware.
>>
>> Yi
>>
>>
>> On Mon, Mar 30, 2020 at 8:25 PM Deval Bhamare <Deval.Bhamare at kau.se>
>> wrote:
>>
>>> Hello again,
>>>
>>>
>>> So as per my understanding, when we use pre-built docker version of the
>>> Stratum, it doesn't refer to local locally built BSP and BF-SDE. Instead it
>>> uses its own pre-build BF-SDE and BSP. Is it correct?
>>>
>>>
>>> In that case, with reference to the email from Stordis-support below, I
>>> would like to confirm that below point have been taken care of while
>>> building the updated docker image.
>>>
>>>
>>> Stordis_support message:
>>>
>>>
>>> "*It is important that you build the BSP with the --with-tof-brgup-plat
>>> option that you can also pass through the p4studio_build script (see
>>> installation guide). Be sure to spell it correctly, or else p4studio_build
>>> will silently ignore the option and build the BSP incorrectly… (there will
>>> be just a log entry in the installation log saying that the option was
>>> unknown)*
>>>
>>> *Note too that there was a problem in the BSP zip file that is available
>>> on our FTP server – the bf-platforms.tgz in the packages directory was
>>> actually the reference BSP version. If you had used this tgz (instead of
>>> the bf-platforms directory that is present in the directory above), the BSP
>>> would have been built incorrectly too. In the meantime I have uploaded a
>>> corrected version of the zip file to our FTP server.*"
>>>
>>>
>>> Can you please confirm?
>>>
>>>
>>> Thanks,
>>>
>>>
>>> Deval.
>>> ------------------------------
>>> *From:* Yi Tseng <yi at opennetworking.org>
>>> *Sent:* Monday, March 30, 2020 7:32:05 AM
>>> *To:* Deval Bhamare
>>> *Cc:* max at opennetworking.org; stratum-dev at lists.stratumproject.org
>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>
>>> Hi Deval,
>>>
>>> We've updated the container image and the script to start the container:
>>>
>>> https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/docker/start-stratum-container.sh
>>>
>>> You can now try the following command to start the Stratum container
>>> with no ONLP support:
>>> *PLATFORM=x86-64-stordis-bf2556x-1t-r0 SDE_VERSION=8.9.2
>>> ./start-stratum-container.sh*
>>>
>>> For the "unimplemented" message you saw, the SDE 8.9.2 uses old version
>>> PI library which doesn't implement some features (reading default entry
>>> from a table).
>>> You can ignore that warning or use a newer version of Stratum (with SDE
>>> >= 9.0.0)
>>>
>>> Yi
>>>
>>>
>>> On Sun, Mar 29, 2020 at 8:31 PM Deval Bhamare <Deval.Bhamare at kau.se>
>>> wrote:
>>>
>>>> Hello again,
>>>>
>>>>
>>>>
>>>> Just don't want to overload with the information, but I wanted to
>>>> mention that, with the *pre-built docker image option*, I had a look a
>>>> the ./start-stratum-container.sh
>>>>
>>>>
>>>> Since I want to run Stratum with BSP, I made a change as:
>>>>
>>>>
>>>> ONLP_ARG="--env WITH_ONLP=false"
>>>>
>>>> Then I started the container 8.9.2-3.16.56-OpenNetworkLinux and it
>>>> executed the Stratum successfully. Stratum open bf-sde prompt.
>>>>
>>>>
>>>> *Also ss ouptput is: *
>>>>
>>>>
>>>> State      Recv-Q Send-Q          Local Address:Port
>>>>       Peer Address:Port
>>>>
>>>> LISTEN     0      128                         *:28000
>>>>                   *:*
>>>> users:(("stratum_bf_no_o",pid=10,fd=36))
>>>>
>>>> LISTEN     0      128                 127.0.0.1:28000
>>>>                   *:*
>>>> users:(("stratum_bf_no_o",pid=10,fd=35))
>>>>
>>>> LISTEN     0      128                 127.0.0.1:28003
>>>>                   *:*
>>>> users:(("stratum_bf_no_o",pid=10,fd=32))
>>>>
>>>> LISTEN     0      5                           *:9999
>>>>                   *:*
>>>> users:(("stratum_bf_no_o",pid=10,fd=27))
>>>>
>>>> I am getting following messages now:
>>>>
>>>>
>>>>  ONOS-CLI logs for the confirmation below:
>>>>
>>>>
>>>> tofino at root > devices
>>>>                                 22:02:35
>>>>
>>>> id=device:tofino, *available=true*, local-status=connected 4m52s ago,
>>>> role=MASTER, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum,
>>>> serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf,
>>>> locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=1,
>>>> name=device:tofino, p4DeviceId=1, protocol=P4Runtime, gNMI, gNOI
>>>>
>>>> Logs on stratum bf-sde are:
>>>>
>>>>
>>>> bf-sde.lld> E0329 22:01:52.649449   249 PI-device_mgr.cpp:0] Reading
>>>> default entry not supported yet
>>>>
>>>> E0329 22:01:52.649509   249 pi_node.cc:187] Return Error:
>>>> toUtilStatus(status, details) failed with generic::unimplemented:
>>>>
>>>> E0329 22:01:52.649549   249 p4_service.cc:307] Failed to read
>>>> forwarding entries from node 1:
>>>>
>>>> ONOS Logs:
>>>>
>>>>
>>>> 2020-03-29T22:08:22,649 | WARN  | grpc-default-executor-4 |
>>>> P4RuntimeClientImpl              | 230 -
>>>> org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | Error while
>>>> performing READ on device:tofino: UNIMPLEMENTED
>>>>
>>>>
>>>>
>>>> So, now ONOS can talk to Tofino through Stratum, but there are a few
>>>> errors. First of all, is it OK to explicitly use this option: "--env
>>>> WITH_ONLP=false" If yes, am I missing some steps here?  Any suggestion?
>>>>
>>>>
>>>>
>>>> (Note: If I use default value of ONLP_ARG as per the original script,
>>>> I get error as:
>>>>
>>>>
>>>> Use default flag file
>>>>
>>>> Cannot find /usr/local/lib/modules/bf_kdrv.ko, skip installing the
>>>> Kernel module
>>>>
>>>> /usr/local/bin/stratum_bf: symbol lookup error:
>>>> /usr/local/bin/stratum_bf: undefined symbol: onlp_sw_init
>>>> )
>>>>
>>>>
>>>>
>>>> Thank you,
>>>>
>>>>
>>>> Deval.
>>>>
>>>>
>>>> ------------------------------
>>>> *From:* Deval Bhamare
>>>> *Sent:* Sunday, March 29, 2020 12:20:10 PM
>>>> *To:* Maximilian Pudelko
>>>> *Cc:* Yi Tseng; stratum-dev at lists.stratumproject.org
>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>
>>>>
>>>> Hello Maximilian,
>>>>
>>>>
>>>> There is a littler confusion here. I am *not using pre-built
>>>> containerized version of Stratum*.
>>>>
>>>> However, I am locally *building it by starting a development container*
>>>> with command "*./setup_dev_env.sh  --pull -- -p 28000:28000*" (I have
>>>> mentioned it in the earlier image as well) as mentioned here:
>>>> https://github.com/stratum/stratum
>>>>
>>>> and then I try to build and run stratum as mentioned here:
>>>> https://github.com/stratum/stratum/blob/master/stratum/hal/bin/barefoot/README.md
>>>>
>>>>
>>>>
>>>> Now with the build-from-scratch using development container approach, I
>>>> followed your steps, however, when I run *ss -tnlp* from the container
>>>> (afterdocker exec -ti bash), I get below and listen on  127.0.0.1:28000
>>>> is *missing*. I get only below.
>>>>
>>>>
>>>>
>>>> tofino at 39e19c57ea27:/stratum$ ss -tlnp
>>>>
>>>> State       Recv-Q Send-Q     Local Address:Port                    Peer
>>>> Address:Port
>>>>
>>>> LISTEN      0      128            127.0.0.1:56929
>>>>         *:*                   users:(("java",pid=21,fd=110))
>>>>
>>>> LISTEN      0      1                      *:8008
>>>>         *:*                   users:(("stratum_bf",pid=310,fd=26))
>>>>
>>>> *Command to build Stratum is*: bazel build
>>>> //stratum/hal/bin/barefoot:stratum_bf --define phal_with_onlp=false
>>>> --define sde_ver=8.9.2
>>>>
>>>> *Command to run Stratum is*:
>>>>
>>>>      ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf \
>>>>        --external_stratum_urls=0.0.0.0:28000 \
>>>>        --grpc_max_recv_msg_size=256 \
>>>>        --bf_sde_install=$BF_SDE_INSTALL \
>>>>        --persistent_config_dir=/stratum/config/ \
>>>>
>>>>  --forwarding_pipeline_configs_file=/stratum/config/p4_pipeline.pb.txt \
>>>>        --chassis_config_file=/stratum/config/chassis_config.pb.txt \
>>>>        --write_req_log_file=/stratum/config/p4_writes.pb.txt \
>>>>        --bf_sim
>>>>
>>>>
>>>>
>>>>
>>>> [*Note*: I had also tried the option of using pre-built docker
>>>> container, with 8.9.1-3.16.56-OpenNetworkLinux, however, in this case I get
>>>> error:
>>>>
>>>> Cannot find /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json
>>>>
>>>> I had reported that also and tried new container but didn't work]
>>>>
>>>> Thanks,
>>>>
>>>> Deval.
>>>>
>>>>
>>>> ------------------------------
>>>> *From:* Maximilian Pudelko <max at opennetworking.org>
>>>> *Sent:* Sunday, March 29, 2020 1:46:04 AM
>>>> *To:* Deval Bhamare
>>>> *Cc:* Yi Tseng; stratum-dev at lists.stratumproject.org; Andreas Kassler
>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>
>>>> Hi Deval,
>>>>
>>>> There are many things going on in your setup, let's do this step by
>>>> step:
>>>>
>>>> 1. Port 8008 is NOT what you want for ONOS. I'm no Tofino expert, but
>>>> this seems to be a separate endpoint for something else (debugging?). We
>>>> always use port 28000.
>>>>
>>>> 2. *2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform
>>>> init failed  #<<< CAN IT BE THE ISSUE?*
>>>> Depends. It's probably not good, but as long as you see this line in
>>>> the Stratum logs, ONOS should be able to connect:
>>>> E0328 23:08:15.903065    13 hal.cc:234] Stratum external facing
>>>> services are listening to 0.0.0.0:28000, localhost:28000...
>>>> Judging from the missing listening port, I'd say this could be the
>>>> issue.
>>>>
>>>> 3. If you run ONOS in a container too, they have to reside in the same
>>>> network and you have to figure out the docker-internal IP for the Stratum
>>>> container:
>>>> # docker network ls
>>>> NETWORK ID          NAME                DRIVER              SCOPE
>>>> e737dd0dd90f        bridge              bridge              local
>>>> d2783152be24        host                host                local
>>>> 7028e832e130        none                null                local
>>>>
>>>> # docker network inspect bridge
>>>> [...]
>>>> "Containers": {
>>>>
>>>> "518c901167919d34205959f1105aedebbb99a9452d191409ccf71a3908e14e56": {
>>>>                 "Name": "zen_jennings",
>>>>                 "EndpointID":
>>>> "a52025a671c9968372c52c7ed6b61df5a3168493466bd4b831c4728089b77163",
>>>>                 "MacAddress": "02:42:ac:11:00:02",
>>>>                 "IPv4Address": "172.17.0.2/16",
>>>>                 "IPv6Address": ""
>>>>             }
>>>>         },
>>>> [...]
>>>>
>>>> You could also try running them in the host network (--network=host),
>>>> that should make them behave like native processes with fully exposed
>>>> networking.
>>>>
>>>> 4. I used a wrong switch in my previous post, here's how it looks on a
>>>> Tofino:
>>>>
>>>>    -  ./start-stratum-container.sh (let it run and open new terminal
>>>>    tab)
>>>>    - docker container ls
>>>>    CONTAINER ID        IMAGE
>>>>               COMMAND                  CREATED             STATUS
>>>>     PORTS                      NAMES
>>>>    518c90116791
>>>>     stratumproject/stratum-bf:9.1.0-4.14.49-OpenNetworkLinux   "/bin/sh -c
>>>>    /stratum…"   12 minutes ago      Up 12 minutes       0.0.0.0:28000
>>>>    ->28000/tcp   zen_jennings
>>>>    - ss -ltnp
>>>>    LISTEN      0      128                    :::28000
>>>>                 :::*                   users:(("docker-proxy",pid=1179,fd=4))
>>>>    - docker exec -ti 518c90116791 bash (switch into the Stratum
>>>>    container)
>>>>    - apt update && apt install iproute
>>>>    - ss -tlnp
>>>>    State       Recv-Q Send-Q      Local Address:Port
>>>>      Peer Address:Port
>>>>    LISTEN      0      5                       *:9999
>>>>                 *:*                   users:(("stratum_bf",pid=13,fd=27))
>>>>    LISTEN      0      128                     *:28000
>>>>                  *:*                   users:(("stratum_bf
>>>>    ",pid=13,fd=40))
>>>>    LISTEN      0      128             127.0.0.1:28000
>>>>                  *:*                   users:(("stratum_bf",pid=13,fd=39))
>>>>    LISTEN      0      1                       *:9001
>>>>                 *:*                   users:(("stratum_bf",pid=13,fd=28))
>>>>    - exit (leave container)
>>>>    - docker run -ti debian:9 bash (Start new container to simulate
>>>>    ONOS)
>>>>    - apt update && apt install netcat
>>>>    - nc -v 172.17.0.2 28000
>>>>    172.17.0.2: inverse host lookup failed: Unknown host
>>>>    (UNKNOWN) [172.17.0.2] 28000 (?) open
>>>>
>>>>
>>>> For reference, the used versions:
>>>>
>>>> # docker images
>>>> REPOSITORY                  TAG                              IMAGE ID
>>>>          CREATED             SIZE
>>>> stratumproject/stratum-bf   9.1.0-4.14.49-OpenNetworkLinux
>>>> e4615d64018f        2 weeks ago         214MB
>>>>
>>>> For reference, these are the versions we use:
>>>> # docker version
>>>> Client: Docker Engine - Community
>>>>  Version:           19.03.2
>>>>  API version:       1.40
>>>>  Go version:        go1.12.8
>>>>  Git commit:        6a30dfca03
>>>>  Built:             Thu Aug 29 05:29:49 2019
>>>>  OS/Arch:           linux/amd64
>>>>  Experimental:      false
>>>>
>>>> Server: Docker Engine - Community
>>>>  Engine:
>>>>   Version:          19.03.2
>>>>   API version:      1.40 (minimum version 1.12)
>>>>   Go version:       go1.12.8
>>>>   Git commit:       6a30dfca03
>>>>   Built:            Thu Aug 29 05:28:23 2019
>>>>   OS/Arch:          linux/amd64
>>>>   Experimental:     false
>>>>  containerd:
>>>>   Version:          1.2.6
>>>>   GitCommit:        894b81a4b802e4eb2a91d1ce216b8817763c29fb
>>>>  runc:
>>>>   Version:          1.0.0-rc8
>>>>   GitCommit:        425e105d5a03fabd737a126ad93d62a9eeede87f
>>>>  docker-init:
>>>>   Version:          0.18.0
>>>>   GitCommit:        fec3683
>>>>
>>>> # uname -a
>>>> Linux Stordis 4.14.49-OpenNetworkLinux #1 SMP Thu Jul 18 08:52:25 UTC
>>>> 2019 x86_64 GNU/Linux
>>>>
>>>>
>>>> Max
>>>>
>>>> On Sat, Mar 28, 2020 at 7:31 AM Deval Bhamare <Deval.Bhamare at kau.se>
>>>> wrote:
>>>>
>>>>> Hello again,
>>>>>
>>>>>
>>>>> Since I could not any port activity on 28000 inside stratum and
>>>>> stratum logs shown only listen activity on *8008*, I used following
>>>>> command to do explicitly map the IP/ports to host:
>>>>>
>>>>>
>>>>> *./setup_dev_env.sh  --pull --  -p 192.168.60.131:28008
>>>>> <http://192.168.60.131:28008>:8008*
>>>>>
>>>>>
>>>>> Then I tried to push the netcfg.json with following URL and this time
>>>>> the communication channel is established. Logs from ONOS and stratum are
>>>>> below (BOLD RED).
>>>>>
>>>>>
>>>>> *URL*:
>>>>>
>>>>>
>>>>> *"managementAddress": "grpc://192.168.60.131:28008?device_id=0
>>>>> <http://192.168.60.131:28008?device_id=0>",*
>>>>>
>>>>> (I tired both deviceID 0 and 1, but it must be 0 as bf_shell and
>>>>> stratum Log both confirm: )
>>>>>
>>>>>
>>>>>
>>>>> *ONOS*:
>>>>>
>>>>>
>>>>> 2020-03-28T13:49:46,158 | WARN  | onos-gdp-0       | PiPipeconfManager
>>>>>               | 193 - org.onosproject.onos-core-net - 2.4.0.SNAPSHOT
>>>>> | Ignoring PortStatisticsDiscovery behaviour from pipeconf vepg-pipeconf,
>>>>> but using the one provided by stratum-tofino driver...
>>>>>
>>>>> 2020-03-28T13:49:46,184 | INFO  | onos-gdp-0       |
>>>>> GrpcChannelControllerImpl        | 230 -
>>>>> org.onosproject.onos-protocols-grpc-ctl - 2.4.0.SNAPSHOT | *Creating
>>>>> new gRPC channel grpc://192.168.60.131:28008?device_id=0.
>>>>> <http://192.168.60.131:28008?device_id=0.>.. << #THERE IS SUCCESS HERE THIS
>>>>> TIME AS COMPARED TO PREVIOUS TIME *
>>>>>
>>>>> *Stratum*:
>>>>>
>>>>>
>>>>> *Tcl server: connection accepted on port 8008*
>>>>>
>>>>> *Partial recv: 30 of 40 so far..  <<#STRATUM CONFIRMS IT*
>>>>>
>>>>>
>>>>> However, I am not sure, it is the correct entry point? The reason is
>>>>> ONOS still cannot find the device:tofino (highlighted Yellow RED)
>>>>>
>>>>>
>>>>> 2020-03-28T13:49:46,306 | INFO  | onos-gdp-0       | DeviceManager
>>>>>                 | 193 - org.onosproject.onos-core-net -
>>>>> 2.4.0.SNAPSHOT | Local role is MASTER for device:tofino
>>>>>
>>>>> 2020-03-28T13:49:46,311 | WARN  | onos-event-dispatch-default0 |
>>>>> ModelCache                       | 211 -
>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>> device:tofino not found as a UiDevice
>>>>>
>>>>> 2020-03-28T13:49:46,313 | INFO  | onos-gdp-0       |
>>>>> GeneralDeviceProvider            | 235 -
>>>>> org.onosproject.onos-providers-general-device - 2.4.0.SNAPSHOT | Notifying
>>>>> role MASTER (preference 0) for term 1 to device:tofino
>>>>>
>>>>> 2020-03-28T13:49:46,315 | WARN  | onos-event-dispatch-default0 |
>>>>> ModelCache                       | 211 -
>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | *DeviceID
>>>>> device:tofino not found as a UiDevice*
>>>>>
>>>>> 2020-03-28T13:49:46,316 | WARN  | onos-device-manager-background |
>>>>> DeviceManager                    | 193 -
>>>>> org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | *Node was instructed
>>>>> to be MASTER role for device:tofino, but this node cannot reach the device.*
>>>>> Relinquishing role.    *<<#STILL NO DEVICE FOUND. I TRIED BOTH ID 0
>>>>> and 1 in the URL *
>>>>>
>>>>> 2020-03-28T13:49:46,317 | INFO  | onos-gdp-0       | StreamClientImpl
>>>>>               | 237 - org.onosproject.onos-protocols-p4runtime-ctl -
>>>>> 2.4.0.SNAPSHOT | Setting mastership on device:tofino... master=true,
>>>>> newElectionId=20, masterElectionId=null, sessionOpen=false
>>>>>
>>>>> 2020-03-28T13:49:46,320 | WARN  | onos-event-dispatch-default0 |
>>>>> ModelCache                       | 211 -
>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>> device:tofino not found as a UiDevice
>>>>>
>>>>> 2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 |
>>>>> ModelCache                       | 211 -
>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>> device:tofino not found as a UiDevice
>>>>>
>>>>> 2020-03-28T13:49:46,321 | WARN  | onos-event-dispatch-default0 |
>>>>> ModelCache                       | 211 -
>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>> device:tofino not found as a UiDevice
>>>>>
>>>>> 2020-03-28T13:49:46,336 | INFO  | onos-topo-build-1 | TopologyManager
>>>>>                 | 193 - org.onosproject.onos-core-net -
>>>>> 2.4.0.SNAPSHOT | Topology DefaultTopology{time=12233603415182,
>>>>> creationTime=1585403386336, computeCost=124274, clusters=0, devices=0,
>>>>> links=0} changed
>>>>>
>>>>> 2020-03-28T13:49:46,365 | INFO  | onos-gdp-0       | DeviceManager
>>>>>                 | 193 - org.onosproject.onos-core-net -
>>>>> 2.4.0.SNAPSHOT | Device device:tofino registered
>>>>>
>>>>>
>>>>>
>>>>>
>>>>> Please confirm, is it in the right direction or port 8008 is
>>>>> completely different? What can be the reason for device:tofino not able to
>>>>> find?
>>>>>
>>>>>
>>>>> Thank you,
>>>>>
>>>>> Deval.
>>>>>
>>>>>
>>>>> ------------------------------
>>>>> *From:* stratum-dev <stratum-dev-bounces at lists.stratumproject.org> on
>>>>> behalf of Deval Bhamare via stratum-dev <
>>>>> stratum-dev at lists.stratumproject.org>
>>>>> *Sent:* Saturday, March 28, 2020 3:22:16 PM
>>>>> *To:* Maximilian Pudelko
>>>>> *Cc:* stratum-dev at lists.stratumproject.org
>>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>>
>>>>>
>>>>> Hello Maximilian,
>>>>>
>>>>>
>>>>> Thank you for your reply and the useful suggestions. So as a first
>>>>> step I executed on switch ss -tnlp and below is the output. Surprisingly,
>>>>> there is *no Stratum anywhere there, however statrum is also running
>>>>> in a container* and the short logs are displayed below. I also
>>>>> executed ss command inside the container and those are also pasted below,
>>>>> if that may help.
>>>>>
>>>>>
>>>>> ss -tnlp outputs in different times are as follows:
>>>>>
>>>>>
>>>>> *- from tofino, before anything is started:*
>>>>>
>>>>>
>>>>> tofino at localhost:~$ ss -tnlp
>>>>>
>>>>> State      Recv-Q Send-Q                        Local Address:Port
>>>>>                       Peer Address:Port
>>>>>
>>>>> LISTEN     0      128                                       *:17
>>>>>                                   *:*
>>>>>
>>>>> LISTEN     0      128                                       *:22
>>>>>                                   *:*
>>>>>
>>>>> LISTEN     0      128                                       *:23
>>>>>                                   *:*
>>>>>
>>>>> LISTEN     0      128                          192.168.60.131:10010
>>>>>                                   *:*
>>>>>
>>>>> LISTEN     0      128                                      :::22
>>>>>                                 :::*
>>>>>
>>>>>
>>>>> *- from tofino after stratum container is started*
>>>>>
>>>>>
>>>>> tofino at localhost:~$ ss -tnlp
>>>>>
>>>>> State      Recv-Q Send-Q                        Local Address:Port
>>>>>                       Peer Address:Port
>>>>>
>>>>> LISTEN     0      128                                       *:17
>>>>>                                   *:*
>>>>>
>>>>> LISTEN     0      128                                       *:22
>>>>>                                   *:*
>>>>>
>>>>> LISTEN     0      128                                       *:23
>>>>>                                   *:*
>>>>>
>>>>> LISTEN     0      128                          192.168.60.131:10010
>>>>>                                   *:*
>>>>>
>>>>> LISTEN     0      128                                      :::22
>>>>>                                 :::*
>>>>>
>>>>> LISTEN     0      *128                                      :::28000 *
>>>>>                                 :::*
>>>>>
>>>>>
>>>>> *- from tofino after stratum is running *
>>>>>
>>>>>
>>>>> tofino at localhost:~$ ss -tnlp
>>>>>
>>>>> State      Recv-Q Send-Q                        Local Address:Port
>>>>>                       Peer Address:Port
>>>>>
>>>>> LISTEN     0      128                                       *:17
>>>>>                                   *:*
>>>>>
>>>>> LISTEN     0      128                                       *:22
>>>>>                                   *:*
>>>>>
>>>>> LISTEN     0      128                                       *:23
>>>>>                                   *:*
>>>>>
>>>>> LISTEN     0      128                          192.168.60.131:10010
>>>>>                                   *:*
>>>>>
>>>>> LISTEN     0      128                                      :::22
>>>>>                                 :::*
>>>>>
>>>>> LISTEN     0      128                                      :::28000
>>>>>                                 :::*
>>>>>
>>>>>
>>>>> *- from stratum container, after running it in background *
>>>>>
>>>>>
>>>>> tofino at ced0c4d7ef8f:/stratum$ ss -tnlp
>>>>>
>>>>> State      Recv-Q Send-Q Local Address:Port                Peer
>>>>> Address:Port
>>>>>
>>>>> LISTEN     *0      1                  *:8008
>>>>>   *:*                   users:(("stratum_bf",pid=323,fd=26)) << #IS this
>>>>> useful? *
>>>>>
>>>>> LISTEN     0      128        127.0.0.1:41418                          *:*
>>>>>                   users:(("java",pid=21,fd=110))
>>>>>
>>>>> Why there is no 28000 port here in Stratum container SS output. Or
>>>>> should I bind 8008 to 28000 on switch?
>>>>>
>>>>> As you have mentioned, I have already taken care of port mapping. So I
>>>>> run the container with -p28000:2000. It is verified in the outputs above as
>>>>> well.
>>>>>
>>>>>
>>>>> *- Docker output on switch *
>>>>>
>>>>>
>>>>> tofino at localhost:~$ docker ps
>>>>>
>>>>> CONTAINER ID        IMAGE               COMMAND             CREATED
>>>>>           STATUS              PORTS                      NAMES
>>>>>
>>>>> ced0c4d7ef8f        stratum-dev         "bash"              16
>>>>> minutes ago      Up 16 minutes       *0.0.0.0:28000->28000/tcp*
>>>>> goofy_hamilton
>>>>>
>>>>>
>>>>> *- Stratum log output after it started. *
>>>>>
>>>>>
>>>>> bf_sysfs_fname /sys/class/bf/bf0/device/dev_add
>>>>>
>>>>> Install dir: /stratum/bf-sde-8.9.0/install (0x7f876b794b60)
>>>>>
>>>>> bf_switchd: system services initialized
>>>>>
>>>>> bf_switchd: loading conf_file
>>>>> stratum/hal/bin/barefoot/tofino_skip_p4.conf...
>>>>>
>>>>> bf_switchd: processing device configuration...
>>>>>
>>>>> Configuration for dev_id 0
>>>>>
>>>>>   Family        : Tofino
>>>>>
>>>>>   pci_sysfs_str : /sys/devices/pci0000:00/0000:00:03.0/0000:05:00.0
>>>>>
>>>>>   pci_domain    : 0
>>>>>
>>>>>   pci_bus       : 5
>>>>>
>>>>>   pci_fn        : 0
>>>>>
>>>>>   pci_dev       : 0
>>>>>
>>>>>   pci_int_mode  : 1
>>>>>
>>>>>   sbus_master_fw: /stratum/bf-sde-8.9.0/install/
>>>>>
>>>>>   pcie_fw       : /stratum/bf-sde-8.9.0/install/
>>>>>
>>>>>   serdes_fw     : /stratum/bf-sde-8.9.0/install/
>>>>>
>>>>>   sds_fw_path   : /stratum/bf-sde-8.9.0/install/
>>>>>
>>>>>   microp_fw_path:
>>>>>
>>>>> bf_switchd: processing P4 configuration...
>>>>>
>>>>> P4 profile for dev_id 0
>>>>>
>>>>>   p4_name: dummy
>>>>>
>>>>>     libpd:
>>>>>
>>>>>     libpdthrift:
>>>>>
>>>>>     context:
>>>>>
>>>>>     config:
>>>>>
>>>>>   Agent[0]: /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
>>>>>
>>>>>   diag:
>>>>>
>>>>>   mavericks diag:
>>>>>
>>>>>   non_default_port_ppgs: 0
>>>>>
>>>>>   SAI default initialize: 1
>>>>>
>>>>> bf_switchd: library /stratum/bf-sde-8.9.0/install/lib/libpltfm_mgr.so
>>>>> loaded
>>>>>
>>>>> bf_switchd: agent[0] initialized
>>>>>
>>>>> Tcl server started..
>>>>>
>>>>> Tcl server: listen socket created
>>>>>
>>>>> Tcl server: bind done on port 8008, listening...
>>>>>
>>>>> Tcl server: waiting for incoming connections...
>>>>>
>>>>> sh: 1: onie-syseeprom: not found
>>>>>
>>>>> *2020-03-28 13:06:53.584090 BF_PLTFM ERROR - Error in cp2112
>>>>> initialization*
>>>>>
>>>>>
>>>>> *2020-03-28 13:06:53.584190 BF_PLTFM ERROR - pltfm_mgr: platform init
>>>>> failed  #<<< CAN IT BE THE ISSUE?*
>>>>>
>>>>>
>>>>> Thank you.
>>>>>
>>>>> Deval
>>>>>
>>>>>
>>>>> ------------------------------
>>>>> *From:* Maximilian Pudelko <max at opennetworking.org>
>>>>> *Sent:* Saturday, March 28, 2020 3:43:29 AM
>>>>> *To:* Deval Bhamare
>>>>> *Cc:* Yi Tseng; stratum-dev at lists.stratumproject.org
>>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>>
>>>>> Hi Deval,
>>>>>
>>>>> can you run this command on the switch: ss -tlnp
>>>>> Should output something like this:
>>>>> State      Recv-Q Send-Q      Local Address:Port
>>>>> Peer Address:Port
>>>>> LISTEN     0      128                     *:22
>>>>>          *:*                   users:(("sshd",pid=4116,fd=3))
>>>>> LISTEN     0      128                    :::22
>>>>>         :::*                   users:(("sshd",pid=4116,fd=4))
>>>>> LISTEN     0      128      ::ffff:127.0.0.1:28000
>>>>>          :::*                   users:(("stratum_bcm",pid=26872,fd=19))
>>>>> LISTEN     0      128                    :::28001
>>>>>          :::*                   users:(("stratum_bcm",pid=26872,fd=20))
>>>>> LISTEN     0      128      ::ffff:127.0.0.1:28003
>>>>>          :::*                   users:(("stratum_bcm",pid=26872,fd=6))
>>>>>
>>>>> Also, do you have any logs from Stratum? Run with -v=1
>>>>> -stderrthreshold=0
>>>>>
>>>>> Since you're using docker, I assume there is some issue with port
>>>>> forwarding/mapping. Follow these steps to check the port mapping:
>>>>> https://docs.docker.com/engine/reference/commandline/port/
>>>>> And these steps to fix it:
>>>>>
>>>>> https://stackoverflow.com/questions/22111060/what-is-the-difference-between-expose-and-publish-in-docker
>>>>>
>>>>> https://docs.docker.com/config/containers/container-networking/#published-ports
>>>>>
>>>>> Max
>>>>>
>>>>>
>>>>> On Thu, Mar 26, 2020 at 3:53 PM Deval Bhamare via stratum-dev <
>>>>> stratum-dev at lists.stratumproject.org> wrote:
>>>>>
>>>>>> Hello Yi,
>>>>>>
>>>>>>
>>>>>> I am running both ONOS and stratum container on the same machine,
>>>>>> that is the tofino switch with public IP 192.168.60.131.
>>>>>>
>>>>>>
>>>>>> So I tried with grpc://192.168.60.131:28000?device_id=1
>>>>>> <http://192.168.0.101:28000/?device_id=1>", as well now. This time
>>>>>> message is connection refused and still no connectivity.
>>>>>>
>>>>>>
>>>>>>
>>>>>>
>>>>>> 2020-03-26T22:41:19,713 | WARN  | onos-device-manager-background |
>>>>>> DeviceManager                    | 193 -
>>>>>> org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Node was instructed to be
>>>>>> MASTER role for device:tofino, but this node cannot reach the device.
>>>>>> Relinquishing role.
>>>>>>
>>>>>> 2020-03-26T22:41:19,716 | INFO  | onos-gdp-0       |
>>>>>> StreamClientImpl                 | 237 -
>>>>>> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting
>>>>>> mastership on device:tofino... master=true, newElectionId=20,
>>>>>> masterElectionId=null, sessionOpen=false
>>>>>>
>>>>>> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
>>>>>> ModelCache                       | 211 -
>>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>>> device:tofino not found as a UiDevice
>>>>>>
>>>>>> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
>>>>>> ModelCache                       | 211 -
>>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>>> device:tofino not found as a UiDevice
>>>>>>
>>>>>> 2020-03-26T22:41:19,718 | WARN  | onos-event-dispatch-default0 |
>>>>>> ModelCache                       | 211 -
>>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>>> device:tofino not found as a UiDevice
>>>>>>
>>>>>> 2020-03-26T22:41:19,737 | INFO  | onos-topo-build-1 | TopologyManager
>>>>>>                 | 193 - org.onosproject.onos-core-net -
>>>>>> 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264511977012,
>>>>>> creationTime=1585262479736, computeCost=117691, clusters=0, devices=0,
>>>>>> links=0} changed
>>>>>>
>>>>>> 2020-03-26T22:41:19,763 | INFO  | onos-gdp-0       | DeviceManager
>>>>>>                   | 193 - org.onosproject.onos-core-net -
>>>>>> 2.4.0.SNAPSHOT | Device device:tofino registered
>>>>>>
>>>>>> 2020-03-26T22:41:19,764 | WARN  | grpc-default-executor-0 |
>>>>>> StreamClientImpl                 | 237 -
>>>>>> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | *device:tofino
>>>>>> is unreachable (Connection refused: /192.168.60.131:28000
>>>>>> <http://192.168.60.131:28000>)*
>>>>>>
>>>>>> 2020-03-26T22:41:19,774 | INFO  | onos-topo-build-2 | TopologyManager
>>>>>>                 | 193 - org.onosproject.onos-core-net -
>>>>>> 2.4.0.SNAPSHOT | Topology DefaultTopology{time=2264549921343,
>>>>>> creationTime=1585262479774, computeCost=101378, clusters=0, devices=0,
>>>>>> links=0} changed
>>>>>>
>>>>>> With grpc://127.0.0.1:28000?device_id=1
>>>>>> <http://192.168.0.101:28000/?device_id=1>", the error is
>>>>>>
>>>>>>
>>>>>> *onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Error on
>>>>>> StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed for
>>>>>> unknown reason*
>>>>>>
>>>>>> Also Stratum logs say
>>>>>>
>>>>>>
>>>>>> bf_switchd: processing P4 configuration...
>>>>>>
>>>>>> *P4 profile for dev_id 0*
>>>>>>
>>>>>>
>>>>>> while starting, so I doubt device ID maybe 0 and hence tried with
>>>>>> both device_id=1 <http://192.168.0.101:28000/?device_id=1> and
>>>>>> device_id= <http://192.168.0.101:28000/?device_id=1>0 but no luck.
>>>>>>
>>>>>>
>>>>>>
>>>>>> Thanks,
>>>>>>
>>>>>>
>>>>>> Deval.
>>>>>> ------------------------------
>>>>>> *From:* Yi Tseng <yi at opennetworking.org>
>>>>>> *Sent:* Thursday, March 26, 2020 9:10:49 PM
>>>>>> *To:* Deval Bhamare
>>>>>> *Cc:* stratum-dev at lists.stratumproject.org
>>>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>>>
>>>>>> Hi Deval,
>>>>>>
>>>>>> Where you are running the ONOS controller? If you are running the
>>>>>> ONOS controller on a server, you need to set the management address to your
>>>>>> switch IP address.
>>>>>>
>>>>>> For example, you run the ONOS on a server with IP address
>>>>>> 192.168.0.100 and running the Stratum on a switch with IP address
>>>>>> 192.168.0.101. (And I assume that you have connectivity between the server
>>>>>> and the switch)
>>>>>>
>>>>>> The netcfg.json will look like:
>>>>>>
>>>>>> {
>>>>>>   "devices": {
>>>>>>     "device:tofino": {
>>>>>>       "basic": {
>>>>>>         "managementAddress": "grpc://192.168.0.101:28000?device_id=1
>>>>>> ",
>>>>>>         "driver": "stratum-tofino",
>>>>>>         "pipeconf": "[your pipeconf name]"
>>>>>>        }
>>>>>>     }
>>>>>>    }
>>>>>> }
>>>>>>
>>>>>> Please also note that the device ID is 1 in the Stratum
>>>>>>
>>>>>> Yi
>>>>>>
>>>>>>
>>>>>> On Thu, Mar 26, 2020 at 6:13 AM Deval Bhamare <Deval.Bhamare at kau.se>
>>>>>> wrote:
>>>>>>
>>>>>>> Hello Yi,
>>>>>>>
>>>>>>>
>>>>>>> We have received a reply from Stordis and as per their suggestion,
>>>>>>> we can ignore the syseeprom error
>>>>>>>
>>>>>>>
>>>>>>> *You see only syseeprom errorr please ignore that :*
>>>>>>> *Tcl server: listen socket created*
>>>>>>> *Tcl server: bind done on port 8008, listening...*
>>>>>>> *Tcl server: waiting for incoming connections...*
>>>>>>> *sh: 1: onie-syseeprom: not found <Ignore this error>*
>>>>>>> *Health monitor started *
>>>>>>> *Operational mode set to ASIC*
>>>>>>>
>>>>>>>
>>>>>>> So, now when I try to push the netcfg.json for our device to Onos, I
>>>>>>> get following message:
>>>>>>>
>>>>>>>
>>>>>>> 2020-03-25T21:59:01,255 | INFO  | onos-gdp-0       |
>>>>>>> StreamClientImpl                 | 237 -
>>>>>>> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT | Setting
>>>>>>> mastership on device:tofino... master=true, newElectionId=20,
>>>>>>> masterElectionId=null, sessionOpen=false
>>>>>>>
>>>>>>> 2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 |
>>>>>>> ModelCache                       | 211 -
>>>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>>>> device:tofino not found as a UiDevice
>>>>>>>
>>>>>>> 2020-03-25T21:59:01,258 | WARN  | onos-event-dispatch-default0 |
>>>>>>> ModelCache                       | 211 -
>>>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>>>> device:tofino not found as a UiDevice
>>>>>>>
>>>>>>> 2020-03-25T21:59:01,263 | WARN  | onos-event-dispatch-default0 |
>>>>>>> ModelCache                       | 211 -
>>>>>>> org.onosproject._onos-gui2-base-jar - 2.4.0.SNAPSHOT | DeviceID
>>>>>>> device:tofino not found as a UiDevice
>>>>>>>
>>>>>>> 2020-03-25T21:59:01,276 | INFO  | onos-topo-build-1 |
>>>>>>> TopologyManager                  | 193 -
>>>>>>> org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology
>>>>>>> DefaultTopology{time=20452353961040, creationTime=1585173541276,
>>>>>>> computeCost=427068, clusters=0, devices=0, links=0} changed
>>>>>>>
>>>>>>> 2020-03-25T21:59:01,308 | INFO  | onos-gdp-0       | DeviceManager
>>>>>>>                   | 193 - org.onosproject.onos-core-net -
>>>>>>> 2.4.0.SNAPSHOT |* Device device:tofino registered*
>>>>>>>
>>>>>>> 2020-03-25T21:59:01,317 | WARN  | grpc-default-executor-1 |
>>>>>>> StreamClientImpl                 | 237 -
>>>>>>> org.onosproject.onos-protocols-p4runtime-ctl - 2.4.0.SNAPSHOT |*
>>>>>>> Error on StreamChannel RPC for device:tofino: UNAVAILABLE: Network closed
>>>>>>> for unknown reason*
>>>>>>>
>>>>>>> 2020-03-25T21:59:01,319 | INFO  | onos-topo-build-2 |
>>>>>>> TopologyManager                  | 193 -
>>>>>>> org.onosproject.onos-core-net - 2.4.0.SNAPSHOT | Topology
>>>>>>> DefaultTopology{time=20452397561034, creationTime=1585173541319,
>>>>>>> computeCost=112832, clusters=0, devices=0, links=0} changed
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>> ONOS CLI show, device available=false.
>>>>>>>
>>>>>>>
>>>>>>> tofino at root > devices
>>>>>>>           21:58:49
>>>>>>>
>>>>>>> id=device:tofino, *available=false*, local-status=disconnected 37s
>>>>>>> ago, role=NONE, type=SWITCH, mfr=Barefoot Networks, hw=Tofino, sw=Stratum,
>>>>>>> serial=unknown, chassis=0, driver=stratum-tofino:vepg-pipeconf,
>>>>>>> locType=none, managementAddress=grpc://127.0.0.1:28000?device_id=0,
>>>>>>> name=device:tofino, p4DeviceId=0, protocol=P4Runtime, gNMI, gNOI
>>>>>>>
>>>>>>>
>>>>>>> Netcfg.json contents are:
>>>>>>>
>>>>>>> {
>>>>>>> "devices": {
>>>>>>> "device:tofino": {
>>>>>>> "basic": {
>>>>>>> "managementAddress": "grpc://127.0.0.1?device_id=0",
>>>>>>> "driver": "stratum-tofino",
>>>>>>> "pipeconf": "vepg-pipeconf"
>>>>>>> }
>>>>>>> }
>>>>>>> }
>>>>>>> }
>>>>>>>
>>>>>>> Command is:
>>>>>>>
>>>>>>>
>>>>>>> curl --fail -sSL --user onos:rocks --noproxy localhost -v -X POST -H
>>>>>>> 'Content-Type:application/json' '
>>>>>>> http://localhost:8181/onos/v1/network/configuration' -d@
>>>>>>> ./netcfg.json
>>>>>>>
>>>>>>>
>>>>>>>
>>>>>>> Any idea what may be the issue?
>>>>>>>
>>>>>>>
>>>>>>> Thanks,
>>>>>>>
>>>>>>> Deval.
>>>>>>>
>>>>>>>
>>>>>>> ------------------------------
>>>>>>> *From:* Yi Tseng <yi at opennetworking.org>
>>>>>>> *Sent:* Tuesday, March 24, 2020 3:25:06 PM
>>>>>>> *To:* Deval Bhamare
>>>>>>> *Cc:* stratum-dev at lists.stratumproject.org
>>>>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>>>>
>>>>>>> Hi Deval,
>>>>>>>
>>>>>>> I am now working on updating the script to support the custom platform
>>>>>>> parameter <https://github.com/stratum/stratum/pull/150> since the
>>>>>>> Stratum cannot detect the platform without the ONLP.
>>>>>>>
>>>>>>> Should be merged soon.
>>>>>>>
>>>>>>> On Sat, Mar 21, 2020 at 1:28 AM Deval Bhamare <Deval.Bhamare at kau.se>
>>>>>>> wrote:
>>>>>>>
>>>>>>>> Hello Yi,
>>>>>>>>
>>>>>>>>
>>>>>>>> I tried with the new image stratum-bf:8.9.1-3.16.56-OpenNetworkLinux,
>>>>>>>> however, the error still persists:
>>>>>>>>
>>>>>>>>
>>>>>>>> + KERNEL_VERSION=3.16.64-OpenNetworkLinux
>>>>>>>>
>>>>>>>> + DOCKER_IMAGE=stratumproject/stratum-bf
>>>>>>>>
>>>>>>>> + DOCKER_IMAGE_TAG=9.0.0-3.16.64-OpenNetworkLinux
>>>>>>>>
>>>>>>>> ++ uname -r
>>>>>>>>
>>>>>>>> ++ uname -r
>>>>>>>>
>>>>>>>> + docker run -it --privileged -v /dev:/dev -v /sys:/sys -v
>>>>>>>> /lib/modules/3.16.64-OpenNetworkLinux:/lib/modules/3.16.64-OpenNetworkLinux
>>>>>>>> -v
>>>>>>>> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so
>>>>>>>> -v
>>>>>>>> /lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1:/lib/x86_64-linux-gnu/libonlp-platform-defaults.so.1
>>>>>>>> -v
>>>>>>>> /lib/x86_64-linux-gnu/libonlp-platform.so:/lib/x86_64-linux-gnu/libonlp-platform.so
>>>>>>>> -v
>>>>>>>> /lib/x86_64-linux-gnu/libonlp-platform.so.1:/lib/x86_64-linux-gnu/libonlp-platform.so.1
>>>>>>>> -v /lib/x86_64-linux-gnu/libonlp.so:/lib/x86_64-linux-gnu/libonlp.so -v
>>>>>>>> /lib/x86_64-linux-gnu/libonlp.so.1:/lib/x86_64-linux-gnu/libonlp.so.1 -v
>>>>>>>> /lib/platform-config:/lib/platform-config -v /etc/onl:/etc/onl -p
>>>>>>>> 28000:28000 -v /root:/stratum_configs -v /var/log:/stratum_logs
>>>>>>>> stratumproject/stratum-bf:8.9.1-3.16.56-OpenNetworkLinux
>>>>>>>>
>>>>>>>> *Use default flag file*
>>>>>>>>
>>>>>>>> *Cannot find
>>>>>>>> /usr/local/share/stratum/x86-64-stordis-bf2556x-1t-r0.json*
>>>>>>>>
>>>>>>>>
>>>>>>>> I also had peek at the script *start-stratum-container.sh* and
>>>>>>>> found an option of *ONLP_ARG="--env WITH_ONLP=false"*
>>>>>>>> . So I wanted to ask whether I can set this option with Docker to
>>>>>>>> force BSP usage, let us say, by hard-coding it in the script itself (also
>>>>>>>> similar approach to set PORT_MAP in *stratume_entrypoint.sh*). I
>>>>>>>> tried this and the error message in this case is:
>>>>>>>>
>>>>>>>>
>>>>>>>> *Use default flag file*
>>>>>>>>
>>>>>>>> *Cannot find /usr/local/share/stratum/.json *
>>>>>>>>
>>>>>>>> Please suggest.
>>>>>>>>
>>>>>>>> Thanks,
>>>>>>>> Deval.
>>>>>>>>
>>>>>>>> ------------------------------
>>>>>>>> *From:* Yi Tseng <yi at opennetworking.org>
>>>>>>>> *Sent:* Thursday, March 12, 2020 6:57 AM
>>>>>>>> *To:* Deval Bhamare
>>>>>>>> *Cc:* Narada Hess; stratum-dev at lists.stratumproject.org
>>>>>>>> *Subject:* Re: [stratum-dev] Update Bazel version to 2.2.0
>>>>>>>>
>>>>>>>> Hi Deval,
>>>>>>>>
>>>>>>>> We don't support Barefoot thrift APIs in Stratum. We support some
>>>>>>>> Barefoot API like port API via gNMI and the chassis config.
>>>>>>>>
>>>>>>>> For missing JSON file, I can confirm that our internal CI did not
>>>>>>>> include the latest Stratum with kernel 3.16.56
>>>>>>>>
>>>>>>>> I just rebuild it and uploaded the new container image to the Docker
>>>>>>>> hub
>>>>>>>> <https://hub.docker.com/layers/stratumproject/stratum-bf/8.9.2-3.16.56-OpenNetworkLinux/images/sha256-c9d64c1a7c2853150532a5d3e14dac94aa79b63a4dffba16018322d971d65300?context=explore>,
>>>>>>>> feel free to let me know if the issue still exists.
>>>>>>>>
>>>>>>>> About the missing library, can you run this command in your shell?
>>>>>>>>
>>>>>>>> *LD_LIBRARY_PATH=$BF_SDE_INSTALL/lib ldd
>>>>>>>> ./bazel-bin/stratum/hal/bin/barefoot/stratum_bf*
>>>>>>>>
>>>>>>>> I think the system linker may have some issue to find the library.
>>>>>>>>
>>>>>>>> The *libavago.so.0 *is a symbolic link to *libavago.so*. the
>>>>>>>> libavago.so must also exists.
>>>>>>>>
>>>>>>>>
>>>>>>>>
>>>>>>>> *ls -al $BF_SDE_INSTALL/lib/libavago* -rwxr-xr-x 1 root root
>>>>>>>> 1185264 Mar 12 04:19 libavago.so lrwxrwxrwx 1 root root      11 Mar 12
>>>>>>>> 04:19 libavago.so.0 -> libavago.so lrwxrwxrwx 1 root root      11 Mar 12
>>>>>>>> 04:19 libavago.so.0.0.0 -> libavago.so*
>>>>>>>>
>>>>>>>>
>>>>>>>>
>>>>>>>
>>>>>>> --
>>>>>>> Yi Tseng
>>>>>>> Member of Technical Staff
>>>>>>> Open Networking Foundation
>>>>>>> https://www.opennetworking.org/
>>>>>>>
>>>>>>
>>>>>>
>>>>>> --
>>>>>> Yi Tseng
>>>>>> Member of Technical Staff
>>>>>> Open Networking Foundation
>>>>>> https://www.opennetworking.org/
>>>>>> _______________________________________________
>>>>>> stratum-dev mailing list
>>>>>> stratum-dev at lists.stratumproject.org
>>>>>> https://lists.stratumproject.org/listinfo/stratum-dev
>>>>>
>>>>>
>>>
>>> --
>>> Yi Tseng
>>> Member of Technical Staff
>>> Open Networking Foundation
>>> https://www.opennetworking.org/
>>>
>>
>>
>> --
>> Yi Tseng
>> Member of Technical Staff
>> Open Networking Foundation
>> https://www.opennetworking.org/
>>
>
>
> --
> Yi Tseng
> Member of Technical Staff
> Open Networking Foundation
> https://www.opennetworking.org/
>


-- 
Yi Tseng
Member of Technical Staff
Open Networking Foundation
https://www.opennetworking.org/
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200421/3cff888b/attachment-0001.html>

From carmelo at opennetworking.org  Wed Apr 22 20:09:56 2020
From: carmelo at opennetworking.org (Carmelo Cascone)
Date: Wed, 22 Apr 2020 13:09:56 -0700
Subject: [stratum-dev] [onos-dev] How to make one bmv2 switch send a
 packet_in to multiple controllers at the same time?
In-Reply-To: <81f428f8-9dc0-4ff9-8b16-4517cdc0fb14@onosproject.org>
References: <81f428f8-9dc0-4ff9-8b16-4517cdc0fb14@onosproject.org>
Message-ID: <43574387-51BE-44EF-861B-FB449ECD58B2@opennetworking.org>

Hi,

Hopefully this is not too late.

From the P4Runtime spec (section 5):
5. Master-Slave Arbitration and Controller Replication <https://p4.org/p4runtime/spec/master/P4Runtime-Spec.html#sec-master-slave-arbitration-and-controller-replication>

Streaming of notifications (e.g. digests) and packet I/O: The same streaming channel will be used for streaming notifications, as well as for packet-in and packet-out messages. Note that unless specified otherwise by the role definitions, only the master controller can participate in packet I/O. This feature is explained in more details in the Packet I/O section.

In other words, the spec doesn’t limit the possibility of sending packet-ins to multiple controllers, but you would have to define a “role” for that (see section 5.2. Role Config). However, none of the existing P4Runtime implementations that I’m aware of support any role other than the default one.

If you want to prototype this capability, your best option is to look at stratum_bmv2, specifically this part of p4_service.cc:
https://github.com/stratum/stratum/blob/e0f8b1fcc5d226cd7aef1837e673276721e9d6ba/stratum/hal/lib/common/p4_service.cc#L821

I might be wrong, but I think the P4Runtime southbound in ONOS doesn't enforce any mastership check on packet-ins, i.e., any switch could be sending paket-in messages to any controller instance, including slaves.

Carmelo

> On Apr 12, 2020, at 7:37 AM, chenyichientw at gmail.com wrote:
> 
> Hi all,
> 
> I am using ONOS 1.13 with P4Runtime and onos.py to create a cluster. I wonder how can I change ONOS code so that one bmv2 switch sends a packet_in message to two different controllers at the same time? I understand that the standard is a switch can have only one master controller. But, I am studying the case for a switch to have multiple controllers. I have already spent a lot of time tracing the code. I found that the doPacketIn() method inside P4RuntimeClientImpl.java is processed by the controller. However, it seems that at the time doPacketIn() is called, it is too late to make the switch sending the control message to a second (another) controller. So, I am wondering when and where the switch code sends a control message to its controller. I would like to change the code. Which java classes, methods, or maybe bmv2 code should I look into? Can anyone help?
> 
> Thanks!
> 
> -- 
> You received this message because you are subscribed to the Google Groups "ONOS Developers" group.
> To unsubscribe from this group and stop receiving emails from it, send an email to onos-dev+unsubscribe at onosproject.org <mailto:onos-dev+unsubscribe at onosproject.org>.
> To view this discussion on the web visit https://groups.google.com/a/onosproject.org/d/msgid/onos-dev/81f428f8-9dc0-4ff9-8b16-4517cdc0fb14%40onosproject.org <https://groups.google.com/a/onosproject.org/d/msgid/onos-dev/81f428f8-9dc0-4ff9-8b16-4517cdc0fb14%40onosproject.org?utm_medium=email&utm_source=footer>.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200422/696a4418/attachment.html>

From bocon at opennetworking.org  Thu Apr 23 17:08:31 2020
From: bocon at opennetworking.org (Brian O'Connor)
Date: Thu, 23 Apr 2020 10:08:31 -0700
Subject: [stratum-dev] 2020 elections process for Stratum
In-Reply-To: <CAGwvfZNUxN5R9nq+mjGq5uef4U9Mjy0D_1H=VkVJjGV033z2Vg@mail.gmail.com>
References: <CAGwvfZNUxN5R9nq+mjGq5uef4U9Mjy0D_1H=VkVJjGV033z2Vg@mail.gmail.com>
Message-ID: <CACKOpD=QiB+OJHs-AgmjBWF1iDCnZdSy0ePKxO5mLnb2AFqH1g@mail.gmail.com>

Please review the message from Jo. Sorry for the duplicate if you already
saw this.

Thanks!
Brian

---------- Forwarded message ---------
From: Jo Marcus <jo at opennetworking.org>
Date: Thu, Apr 23, 2020 at 10:02 AM
Subject: 2020 elections process for Stratum.

We are kicking off the 2020 elections process for Stratum.

First action you need to take is to make sure you are on the voting list.
The list is here:

https://github.com/stratum/stratum/wiki/Voting-List

If you are not on the list and have made contributions during 2019 or 2020,
or if the list has incorrect information about you, please let me
<jo at opennetworking.org> know.

Second action is to make nominations.

This year we need nominations for the following positions:

TST member - we have 3 positions

The last day to accept nominations will be May 8th.

Voting will take place from 5/11 - 5/22

Send your nominations directly to me: jo at opennetworking.org

For your reference

You can find Stratum governance here:

https://github.com/stratum/stratum/wiki/Governance


-- 
Jo Marcus
jo at opennetworking.org
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200423/28ba430f/attachment.html>

From chenyichientw at gmail.com  Sun Apr 26 08:26:14 2020
From: chenyichientw at gmail.com (=?UTF-8?B?6Zmz5a6c6KyZ?=)
Date: Sun, 26 Apr 2020 16:26:14 +0800
Subject: [stratum-dev] [onos-dev] How to make one bmv2 switch send a
 packet_in to multiple controllers at the same time?
In-Reply-To: <43574387-51BE-44EF-861B-FB449ECD58B2@opennetworking.org>
References: <81f428f8-9dc0-4ff9-8b16-4517cdc0fb14@onosproject.org>
 <43574387-51BE-44EF-861B-FB449ECD58B2@opennetworking.org>
Message-ID: <CAG85rJkxO6H09bEsejicKBj2F7bO931Zm9ynQeMqPdbpvj64HA@mail.gmail.com>

Thank you for your reply. I will look into it!

Carmelo Cascone <carmelo at opennetworking.org> 於 2020年4月23日 週四 上午4:10寫道：

> Hi,
>
> Hopefully this is not too late.
>
> From the P4Runtime spec (section 5):
> 5. Master-Slave Arbitration and Controller Replication
> <https://p4.org/p4runtime/spec/master/P4Runtime-Spec.html#sec-master-slave-arbitration-and-controller-replication>
>
> *Streaming of notifications (e.g. digests) and packet I/O: The same
> streaming channel will be used for streaming notifications, as well as for
> packet-in and packet-out messages. Note that unless specified otherwise by
> the role definitions, only the master controller can participate in packet
> I/O. This feature is explained in more details in the Packet I/O section.*
>
> In other words, the spec doesn’t limit the possibility of sending
> packet-ins to multiple controllers, but you would have to define a “role”
> for that (see section 5.2. Role Config). However, none of the existing
> P4Runtime implementations that I’m aware of support any role other than the
> default one.
>
> If you want to prototype this capability, your best option is to look at
> stratum_bmv2, specifically this part of p4_service.cc:
>
> https://github.com/stratum/stratum/blob/e0f8b1fcc5d226cd7aef1837e673276721e9d6ba/stratum/hal/lib/common/p4_service.cc#L821
>
> I might be wrong, but I think the P4Runtime southbound in ONOS doesn't
> enforce any mastership check on packet-ins, i.e., any switch could be
> sending paket-in messages to any controller instance, including slaves.
>
> Carmelo
>
> On Apr 12, 2020, at 7:37 AM, chenyichientw at gmail.com wrote:
>
> Hi all,
>
> I am using ONOS 1.13 with P4Runtime and onos.py to create a cluster. I
> wonder how can I change ONOS code so that one bmv2 switch sends a packet_in
> message to two different controllers at the same time? I understand that
> the standard is a switch can have only one master controller. But, I am
> studying the case for a switch to have multiple controllers. I have already
> spent a lot of time tracing the code. I found that the doPacketIn() method
> inside P4RuntimeClientImpl.java is processed by the controller. However, it
> seems that at the time doPacketIn() is called, it is too late to make the
> switch sending the control message to a second (another) controller. So, I
> am wondering when and where the switch code sends a control message to its
> controller. I would like to change the code. Which java classes, methods,
> or maybe bmv2 code should I look into? Can anyone help?
>
> Thanks!
>
> --
> You received this message because you are subscribed to the Google Groups
> "ONOS Developers" group.
> To unsubscribe from this group and stop receiving emails from it, send an
> email to onos-dev+unsubscribe at onosproject.org.
> To view this discussion on the web visit
> https://groups.google.com/a/onosproject.org/d/msgid/onos-dev/81f428f8-9dc0-4ff9-8b16-4517cdc0fb14%40onosproject.org
> <https://groups.google.com/a/onosproject.org/d/msgid/onos-dev/81f428f8-9dc0-4ff9-8b16-4517cdc0fb14%40onosproject.org?utm_medium=email&utm_source=footer>
> .
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://lists.stratumproject.org/archives/stratum-dev/attachments/20200426/d99c5a2f/attachment.html>

